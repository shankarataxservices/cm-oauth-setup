<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>ComplianceOS</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --font: "Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --mono: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --r-xs: 10px;
      --r-sm: 14px;
      --r-md: 18px;
      --r-lg: 24px;

      --s-1: 6px;
      --s-2: 10px;
      --s-3: 14px;
      --s-4: 18px;
      --s-5: 24px;
      --s-6: 32px;

      --bg0: #0b1020;
      --bg1: #0a1632;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --stroke2: rgba(255,255,255,.10);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --faint: rgba(255,255,255,.52);

      --brand: #7c3aed;
      --brand2:#22d3ee;
      --brand3:#60a5fa;

      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;

      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --shadow2: 0 10px 30px rgba(0,0,0,.22);

      --focus: 0 0 0 4px rgba(34,211,238,.20);
      --focus2: 0 0 0 4px rgba(124,58,237,.22);

      --topbarH: 64px;
      --railW: 86px;
      --panelW: 420px;

      --gridMax: 1260px;
    }

    body[data-theme="light"]{
      --bg0: #f6f8ff;
      --bg1: #eef2ff;
      --card: rgba(255,255,255,.70);
      --card2: rgba(255,255,255,.55);
      --stroke: rgba(17,24,39,.12);
      --stroke2: rgba(17,24,39,.08);

      --text: rgba(17,24,39,.92);
      --muted: rgba(17,24,39,.70);
      --faint: rgba(17,24,39,.52);

      --shadow: 0 20px 60px rgba(17,24,39,.12);
      --shadow2: 0 10px 30px rgba(17,24,39,.10);
      --focus: 0 0 0 4px rgba(34,211,238,.18);
      --focus2: 0 0 0 4px rgba(124,58,237,.18);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 10% 15%, rgba(124,58,237,.25), transparent 55%),
        radial-gradient(1200px 700px at 88% 20%, rgba(34,211,238,.18), transparent 55%),
        radial-gradient(900px 600px at 40% 90%, rgba(96,165,250,.14), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
  overflow-y:auto;
    }

    a{ color: inherit; }
    button,input,select,textarea{ font: inherit; }
    :focus-visible{ outline:none; box-shadow: var(--focus); border-color: rgba(34,211,238,.55)!important; }

    .srOnly{
      position:absolute!important;
      width:1px;height:1px;
      padding:0;margin:-1px;overflow:hidden;
      clip: rect(0,0,0,0);white-space:nowrap;border:0;
    }

    /* Layout */
    .app{
      height:100%;
      display:grid;
      grid-template-rows: var(--topbarH) 1fr;
    }

    .topbar{
      height: var(--topbarH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 var(--s-4);
      border-bottom: 1px solid var(--stroke2);
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    }

    body[data-theme="light"] .topbar{
      background: linear-gradient(180deg, rgba(255,255,255,.80), rgba(255,255,255,.55));
    }

    .brand{
      display:flex; align-items:center; gap: 12px; user-select:none;
      min-width: 240px;
    }
    .brandMark{
      width: 36px; height: 36px; border-radius: 14px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 14px 30px rgba(124,58,237,.20);
    }
    .brandText{
      display:flex; flex-direction:column; line-height:1.05;
    }
    .brandText b{ font-weight: 800; letter-spacing:.2px; }
    .brandText span{ font-size: 12px; color: var(--muted); font-weight: 700; }

    .topActions{
      display:flex; align-items:center; gap: 10px; flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border: 1px solid var(--stroke);
      background: var(--card2);
      color: var(--text);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 800;
      cursor:pointer;
      transition: transform .12s ease, background .18s ease, border-color .18s ease;
      box-shadow: none;
      display:inline-flex;
      align-items:center;
      gap: 10px;
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-1px); background: var(--card); }
    .btn:active{ transform: translateY(0px); }
    .btnPrimary{
      border-color: transparent;
      background: linear-gradient(135deg, var(--brand), var(--brand3));
      color: white;
      box-shadow: 0 18px 34px rgba(124,58,237,.18);
    }
    .btnDanger{
      border-color: transparent;
      background: linear-gradient(135deg, #ef4444, #fb7185);
      color: white;
    }
    .btnGhost{
      background: transparent;
      border-color: var(--stroke2);
    }
    .btnSmall{ padding: 8px 10px; font-size: 13px; }
    .btnIcon{
      width: 42px; height: 42px;
      justify-content:center;
      padding: 0;
    }
    .btnIcon.btnSmall{ width: 38px; height: 38px; }

    .chip{
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      padding: 8px 10px;
      font-weight: 800;
      font-size: 12px;
      color: var(--muted);
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    body[data-theme="light"] .chip{ background: rgba(255,255,255,.55); }

    .shell{
      height: calc(100vh - var(--topbarH));
      display:grid;
      grid-template-columns: var(--railW) 1fr;
      overflow:hidden;
    }

    .rail{
      border-right: 1px solid var(--stroke2);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      backdrop-filter: blur(12px);
      display:flex;
      flex-direction:column;
      align-items:center;
      padding: var(--s-3) var(--s-2);
      gap: 10px;
    }
    body[data-theme="light"] .rail{
      background: linear-gradient(180deg, rgba(255,255,255,.78), rgba(255,255,255,.50));
    }

    .railBtn{
      width: 54px; height: 54px;
      border-radius: 18px;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      cursor:pointer;
      display:grid;
      place-items:center;
      transition: transform .12s ease, background .18s ease, border-color .18s ease;
      position: relative;
    }
    .railBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); color: var(--text); border-color: var(--stroke); }
    .railBtn[aria-current="page"]{
      color: white;
      border-color: transparent;
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,211,238,.70));
      box-shadow: 0 16px 36px rgba(0,0,0,.25);
    }

    .railHint{
      margin-top: auto;
      width: 100%;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      padding-top: 6px;
    }

    .content{
      height: 100%;
      overflow:hidden;
      display:grid;
      grid-template-columns: 1fr;
    }

    /* Main view uses "split canvas": list/board + inspector panel (optional) */
    .canvas{
      height: 100%;
      overflow:hidden;
      display:grid;
      grid-template-columns: 1fr;
    }

    .view{
      height: 100%;
      overflow:auto;
      padding: var(--s-5);
      display:flex;
      justify-content:center;
    }

    .gridMax{
      width: min(var(--gridMax), 100%);
      display:flex;
      flex-direction:column;
      gap: var(--s-4);
    }

    .card{
      border: 1px solid var(--stroke2);
      background: var(--card);
      border-radius: var(--r-lg);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }

    .cardHead{
      padding: var(--s-4);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: var(--s-3);
      border-bottom: 1px solid var(--stroke2);
    }
    .cardHead h2{
      margin:0;
      font-size: 16px;
      font-weight: 850;
      letter-spacing:.2px;
    }
    .cardHead p{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
      font-weight: 650;
      line-height: 1.3;
    }
    .cardBody{ padding: var(--s-4); }

    .row{
      display:flex;
      gap: var(--s-3);
      flex-wrap:wrap;
      align-items:center;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
      min-width: 220px;
      flex: 1 1 220px;
    }
    .label{
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.18px;
      color: var(--muted);
    }
    .input, .select, .textarea{
      width:100%;
      border-radius: 16px;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 12px 12px;
      font-weight: 700;
      font-size: 14px;
      outline:none;
      transition: border-color .16s ease, background .16s ease, transform .12s ease;
    }
    body[data-theme="light"] .input,
    body[data-theme="light"] .select,
    body[data-theme="light"] .textarea{ background: rgba(255,255,255,.72); }

    .textarea{ min-height: 120px; resize: vertical; line-height:1.45; }
    .help{
      color: var(--faint);
      font-size: 12px;
      font-weight: 700;
      line-height: 1.35;
    }

    /* Dialogs */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index: 50;
      backdrop-filter: blur(2px);
    }
    .overlay.show{ display:block; }

    .dialog{
      position: fixed;
      inset: 0;
      display:none;
      z-index: 60;
      place-items:center;
      padding: var(--s-5);
    }
    .dialog.show{ display:grid; }

    .dialogPanel{
      width: min(900px, 96vw);
      max-height: min(86vh, 860px);
      overflow:hidden;
      border-radius: 28px;
      border: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--card) 90%, rgba(0,0,0,.18));
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
    }
    body[data-theme="light"] .dialogPanel{
      background: rgba(255,255,255,.92);
    }

    .dialogHead{
      padding: var(--s-4);
      border-bottom: 1px solid var(--stroke2);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: var(--s-3);
    }
    .dialogTitle{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .dialogTitle b{ font-weight: 900; letter-spacing:.2px; }
    .dialogTitle span{ color: var(--muted); font-weight: 700; font-size: 13px; }
    .dialogBody{
      padding: var(--s-4);
      overflow:auto;
    }
    .dialogFoot{
      padding: var(--s-4);
      border-top: 1px solid var(--stroke2);
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap:wrap;
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      z-index: 80;
      display:none;
      max-width: min(920px, 92vw);
      border-radius: 999px;
      border: 1px solid var(--stroke2);
      background: rgba(17,24,39,.92);
      color: white;
      padding: 10px 14px;
      font-weight: 850;
      font-size: 13px;
      box-shadow: var(--shadow2);
      word-break: break-word;
    }
    body[data-theme="light"] .toast{ background: rgba(17,24,39,.92); }
    .toast.show{ display:block; }

    /* Mobile */
    @media (max-width: 980px){
      .view{ padding: var(--s-4); }
      .brand{ min-width: 0; }
      .chip{ display:none; }
      .shell{ grid-template-columns: 1fr; }
      .rail{
        position: fixed;
        left: 0; right: 0; bottom: 0;
        height: 74px;
        z-index: 40;
        flex-direction: row;
        justify-content: space-around;
        border-right: none;
        border-top: 1px solid var(--stroke2);
        padding: 10px 12px;
      }
      .railHint{ display:none; }
      body{ overflow:hidden; }
      .content{ padding-bottom: 78px; }
    }
  </style>
</head>

<body data-theme="dark">
  <div class="app" id="appRoot" aria-live="polite">
    <header class="topbar">
      <div class="brand" role="banner">
        <div class="brandMark" aria-hidden="true"></div>
        <div class="brandText">
          <b>ComplianceOS</b>
          <span id="envHint">Tasks · Clients · Mail · Reports</span>
        </div>
      </div>

      <div class="topActions">
        <button class="btn btnSmall btnGhost" id="btnCmd" type="button" aria-haspopup="dialog" aria-controls="cmdDialog">
          Command
          <span class="chip" aria-hidden="true"><span style="font-family:var(--mono);font-weight:900">Ctrl</span>+<span style="font-family:var(--mono);font-weight:900">K</span></span>
        </button>

        <button class="btn btnSmall" id="btnTheme" type="button">
          Theme
        </button>

        <div class="chip" id="chipRole" title="Role">Signed out</div>

        <button class="btn btnSmall btnPrimary" id="btnAuth" type="button">
          Sign in
        </button>
      </div>
    </header>

    <div class="shell">
      <nav class="rail" aria-label="Primary">
        <button class="railBtn" id="navHome" type="button" aria-current="page" title="Overview" aria-label="Overview"></button>
        <button class="railBtn" id="navWork" type="button" title="Work Queue" aria-label="Work Queue"></button>
        <button class="railBtn" id="navCalendar" type="button" title="Timeline" aria-label="Timeline"></button>
        <button class="railBtn" id="navClients" type="button" title="Clients" aria-label="Clients"></button>
        <button class="railBtn" id="navStudio" type="button" title="Studio" aria-label="Studio"></button>
        <button class="railBtn" id="navOps" type="button" title="Ops & Reports" aria-label="Ops & Reports"></button>

        <div class="railHint">
          <button class="railBtn" id="navHelp" type="button" title="Help" aria-label="Help"></button>
        </div>
      </nav>

      <main class="content" role="main">
        <section class="canvas">
          <!-- Views are swapped by JS; each view is a full redesign with new flows -->
          <div class="view" id="viewMount">
            <div class="gridMax">

              <div class="card" id="signedOutCard">
                <div class="cardHead">
                  <div>
                    <h2>Welcome</h2>
                    <p>Sign in to manage tasks, client communication, offline updates, and reports. Timezone: <b>Asia/Kolkata</b>. Dates: <b>DD-MM-YYYY</b>.</p>
                  </div>
                  <div class="row">
                    <button class="btn btnPrimary" id="btnOpenAuth" type="button">Sign in</button>
                  </div>
                </div>
                <div class="cardBody">
                  <div class="row">
                    <div class="field">
                      <div class="label">Email</div>
                      <input class="input" id="authEmail" type="email" autocomplete="username" />
                      <div class="help">Use your firm email. Password reset is available from the sign-in dialog.</div>
                    </div>
                    <div class="field">
                      <div class="label">Password</div>
                      <input class="input" id="authPass" type="password" autocomplete="current-password" />
                      <div class="help">Minimum 6 characters (Firebase).</div>
                    </div>
                  </div>

                  <div class="row" style="margin-top:14px">
                    <button class="btn btnPrimary" id="btnQuickLogin" type="button">Sign in</button>
                    <button class="btn" id="btnQuickSignup" type="button">Create account</button>
                    <button class="btn btnGhost" id="btnQuickForgot" type="button">Forgot password</button>
                  </div>

                  <div class="help" style="margin-top:14px">
                    Productivity: use <span style="font-family:var(--mono);font-weight:900">Ctrl/Cmd + K</span> to jump to clients, tasks, exports, and reports instantly.
                  </div>
                </div>
              </div>

              <div class="card" id="signedInPlaceholder" style="display:none">
                <div class="cardHead">
                  <div>
                    <h2>Loading your workspace…</h2>
                    <p>Syncing clients, tasks, and settings.</p>
                  </div>
                </div>
                <div class="cardBody">
                  <div class="help">If this takes long, check network or refresh.</div>
                </div>
              </div>

            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <!-- Auth dialog -->
  <div class="dialog" id="authDialog" role="dialog" aria-modal="true" aria-labelledby="authTitle">
    <div class="dialogPanel">
      <div class="dialogHead">
        <div class="dialogTitle">
          <b id="authTitle">Account</b>
          <span id="authSub">Sign in, create account, or reset password.</span>
        </div>
        <button class="btn btnSmall btnGhost" id="authClose" type="button" aria-label="Close">Close</button>
      </div>
      <div class="dialogBody" id="authBody">
        <!-- filled by JS in Part 2/8 (no placeholders) -->
      </div>
      <div class="dialogFoot" id="authFoot">
        <!-- buttons rendered by JS -->
      </div>
    </div>
  </div>

  <!-- Command palette -->
  <div class="dialog" id="cmdDialog" role="dialog" aria-modal="true" aria-labelledby="cmdTitle">
    <div class="dialogPanel">
      <div class="dialogHead">
        <div class="dialogTitle">
          <b id="cmdTitle">Command</b>
          <span>Search tasks, clients, exports, reports. Keyboard-first.</span>
        </div>
        <button class="btn btnSmall btnGhost" id="cmdClose" type="button" aria-label="Close">Close</button>
      </div>
      <div class="dialogBody" id="cmdBody">
        <!-- filled by JS in Part 2/8 -->
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- Firebase compat (kept for drop-in hosting simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <script>
/* =========================
   ComplianceOS — Part 2/8
   Core runtime: config, theme, dialogs, routing, command palette, API layer
   ========================= */

(() => {
  'use strict';

  /* ---------- CONFIG ---------- */
  const BACKEND_BASE_URL = "https://graduated-seo-accepts-ribbon.trycloudflare.com.netlify/functions";
  const IST_TZ = "Asia/Kolkata";

  const firebaseConfig = {
    apiKey: "AIzaSyCnWS-V96J6YDBVYKOeL5p8aa45GPTdSEg",
    authDomain: "compliance-management-484405.firebaseapp.com",
    projectId: "compliance-management-484405",
    storageBucket: "compliance-management-484405.firebasestorage.app",
    messagingSenderId: "4348274796",
    appId: "1:4348274796:web:a9e1720c2ae223035bd049",
    measurementId: "G-06QR8MTCSR"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  /* ---------- DOM helpers ---------- */
  const $ = (id) => document.getElementById(id);
  const el = (tag, attrs = {}, children = []) => {
    const n = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs || {})) {
      if (k === 'class') n.className = v;
      else if (k === 'text') n.textContent = v;
      else if (k === 'html') n.innerHTML = v;
      else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
      else if (v === false || v === null || v === undefined) continue;
      else n.setAttribute(k, String(v));
    }
    for (const c of (children || [])) n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
    return n;
  };
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

  /* ---------- Toast ---------- */
  const toastNode = $('toast');
  let toastTimer = null;
  function toast(msg, ms = 2600) {
    if (!toastNode) return;
    toastNode.textContent = String(msg || '');
    toastNode.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toastNode.classList.remove('show'), ms);
  }

  /* ---------- Date helpers (IST) ---------- */
  function ymdInTZ(date, timeZone) {
    const parts = new Intl.DateTimeFormat('en-CA', {
      timeZone,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).formatToParts(date);
    const m = Object.fromEntries(parts.map(p => [p.type, p.value]));
    return `${m.year}-${m.month}-${m.day}`;
  }
  function todayYmdIST() { return ymdInTZ(new Date(), IST_TZ); }

  function dmyToYmd(dmy) {
    const s = String(dmy || '').trim();
    const m = /^(\d{2})-(\d{2})-(\d{4})$/.exec(s);
    if (!m) throw new Error(`Invalid date "${s}". Use DD-MM-YYYY`);
    return `${m[3]}-${m[2]}-${m[1]}`;
  }
  function ymdToDmy(ymd) {
    const s = String(ymd || '').trim();
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
    if (!m) return '';
    return `${m[3]}-${m[2]}-${m[1]}`;
  }
  function dateFromYmdIST(ymd) { return new Date(`${ymd}T00:00:00+05:30`); }
  function diffDaysIST(fromYmd, toYmd) {
    const a = dateFromYmdIST(fromYmd).getTime();
    const b = dateFromYmdIST(toYmd).getTime();
    return Math.floor((b - a) / (24 * 3600 * 1000));
  }

  /* ---------- Theme ---------- */
  const THEME_KEY = "cos_theme";     // "dark" | "light"
  const THEME_AUTO_KEY = "cos_theme_auto"; // "true" | "false"
  function applyTheme(t) {
    document.body.setAttribute('data-theme', t === 'light' ? 'light' : 'dark');
  }
  function applyAutoThemeIfEnabled() {
    const auto = (localStorage.getItem(THEME_AUTO_KEY) !== 'false'); // default true
    if (!auto) return;
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const t = prefersDark ? 'dark' : 'light';
    localStorage.setItem(THEME_KEY, t);
    applyTheme(t);
  }
  applyTheme(localStorage.getItem(THEME_KEY) || 'dark');
  applyAutoThemeIfEnabled();
  if (window.matchMedia) {
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyAutoThemeIfEnabled);
  }
  $('btnTheme')?.addEventListener('click', () => {
    localStorage.setItem(THEME_AUTO_KEY, 'false');
    const cur = document.body.getAttribute('data-theme') || 'dark';
    const next = (cur === 'dark') ? 'light' : 'dark';
    localStorage.setItem(THEME_KEY, next);
    applyTheme(next);
  });

  /* ---------- Dialog system (focus trap + ESC) ---------- */
  const overlay = $('overlay');
  const dialogs = {
    auth: $('authDialog'),
    cmd: $('cmdDialog')
  };

  let activeDialog = null;
  let lastFocus = null;

  function focusables(root) {
    const sel = [
      'a[href]',
      'button:not([disabled])',
      'input:not([disabled])',
      'select:not([disabled])',
      'textarea:not([disabled])',
      '[tabindex]:not([tabindex="-1"])'
    ].join(',');
    return Array.from(root.querySelectorAll(sel))
      .filter(n => n.offsetParent !== null && !n.hasAttribute('aria-hidden'));
  }

  function trapKeydown(e) {
    if (!activeDialog) return;
    if (e.key === 'Escape') {
      e.preventDefault();
      closeDialog(activeDialog);
      return;
    }
    if (e.key !== 'Tab') return;

    const nodes = focusables(activeDialog);
    if (!nodes.length) return;
    const first = nodes[0];
    const last = nodes[nodes.length - 1];

    if (e.shiftKey && document.activeElement === first) {
      e.preventDefault();
      last.focus();
    } else if (!e.shiftKey && document.activeElement === last) {
      e.preventDefault();
      first.focus();
    }
  }

  function openDialog(node, { initialFocusId } = {}) {
    if (!node) return;
    if (activeDialog) closeDialog(activeDialog);
    lastFocus = document.activeElement;
    activeDialog = node;
    overlay?.classList.add('show');
    node.classList.add('show');
    document.addEventListener('keydown', trapKeydown, true);

    const focusTarget = initialFocusId ? $(initialFocusId) : null;
    setTimeout(() => {
      const nodes = focusables(node);
      (focusTarget || nodes[0] || node).focus?.();
    }, 0);
  }

  function closeDialog(node) {
    if (!node) return;
    node.classList.remove('show');
    overlay?.classList.remove('show');
    document.removeEventListener('keydown', trapKeydown, true);
    activeDialog = null;
    setTimeout(() => lastFocus?.focus?.(), 0);
  }

  overlay?.addEventListener('click', () => {
    if (activeDialog) closeDialog(activeDialog);
  });

  $('authClose')?.addEventListener('click', () => closeDialog(dialogs.auth));
  $('cmdClose')?.addEventListener('click', () => closeDialog(dialogs.cmd));

  $('btnCmd')?.addEventListener('click', () => {
    openDialog(dialogs.cmd, { initialFocusId: 'cmdInput' });
  });

  document.addEventListener('keydown', (e) => {
    const k = e.key.toLowerCase();
    if ((e.ctrlKey || e.metaKey) && k === 'k') {
      e.preventDefault();
      openCmd();
    }
  }, { passive: false });

  /* ---------- API layer ---------- */
  function joinUrl(base, fnPath) {
    if (!fnPath) return base;
    return base + (fnPath.startsWith('/') ? fnPath : `/${fnPath}`);
  }

  async function apiJson(fnPath, bodyObj) {
    const user = auth.currentUser;
    if (!user) return { ok: false, error: 'Not signed in' };
    const token = await user.getIdToken();
    const res = await fetch(joinUrl(BACKEND_BASE_URL, fnPath), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(bodyObj || {})
    });
    const txt = await res.text();
    let data = null;
    try { data = JSON.parse(txt); } catch { data = { raw: txt }; }
    data.httpOk = res.ok;
    data.status = res.status;
    if (data.ok === undefined) data.ok = res.ok;
    return data;
  }

  async function apiForm(fnPath, formData) {
    const user = auth.currentUser;
    if (!user) return { ok: false, error: 'Not signed in' };
    const token = await user.getIdToken();
    const res = await fetch(joinUrl(BACKEND_BASE_URL, fnPath), {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` },
      body: formData
    });
    const txt = await res.text();
    let data = null;
    try { data = JSON.parse(txt); } catch { data = { raw: txt }; }
    data.httpOk = res.ok;
    data.status = res.status;
    if (data.ok === undefined) data.ok = res.ok;
    return data;
  }

  function downloadBase64({ fileName, base64, mime = 'application/octet-stream' }) {
    const bytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
    const blob = new Blob([bytes], { type: mime });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fileName || 'download.bin';
    a.click();
    setTimeout(() => URL.revokeObjectURL(a.href), 1200);
  }

  async function safeCopy(text) {
    const t = String(text ?? '');
    try {
      await navigator.clipboard.writeText(t);
      return true;
    } catch {
      const ta = document.createElement('textarea');
      ta.value = t;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      return true;
    }
  }

  /* ---------- App state ---------- */
  const state = {
    uid: null,
    email: null,
    role: 'ASSOCIATE',     // backend normalizes WORKER->ASSOCIATE
    displayName: '',
    isPartner: false,
    isManager: false,
    isAssociate: true,

    clients: [],
    tasks: [],
    settings: null,
    calendarSettings: null,

    // selection & context
    activeView: 'home',
    inspectorTaskId: null,

    // command palette cache
    cmd: {
      items: [],
      filtered: [],
      activeIndex: 0
    }
  };

  function normalizeRole(r) {
    const x = String(r || '').toUpperCase().trim();
    if (!x || x === 'WORKER') return 'ASSOCIATE';
    return x;
  }

  function setRole(role) {
    const r = normalizeRole(role);
    state.role = r;
    state.isPartner = (r === 'PARTNER');
    state.isManager = (r === 'MANAGER');
    state.isAssociate = (r === 'ASSOCIATE');
    $('chipRole').textContent = `${r}${state.email ? ` · ${state.email}` : ''}`;

    // Role-based rail controls:
    // - Clients/Ops are partner-first; managers get Ops; associates hidden
    $('navClients').style.display = state.isPartner ? '' : 'none';
    $('navOps').style.display = (state.isPartner || state.isManager) ? '' : 'none';
  }

  /* ---------- Navigation (new IA) ---------- */
  const nav = {
    home: $('navHome'),
    work: $('navWork'),
    calendar: $('navCalendar'),
    clients: $('navClients'),
    studio: $('navStudio'),
    ops: $('navOps'),
    help: $('navHelp')
  };

  function setRailIcon(btn, glyph) {
    if (!btn) return;
    btn.textContent = glyph;
    btn.style.fontSize = '18px';
    btn.style.fontWeight = '900';
  }
  // Distinct iconography (text glyphs for zero-dependency)
  setRailIcon(nav.home, '◈');
  setRailIcon(nav.work, '▦');
  setRailIcon(nav.calendar, '⌗');
  setRailIcon(nav.clients, '◎');
  setRailIcon(nav.studio, '✎');
  setRailIcon(nav.ops, '⟁');
  setRailIcon(nav.help, '?');

  function setActiveNav(key) {
    for (const [k, b] of Object.entries(nav)) {
      if (!b) continue;
      if (k === key) b.setAttribute('aria-current', 'page');
      else b.removeAttribute('aria-current');
    }
    state.activeView = key;
  }

  function routeTo(key) {
    setActiveNav(key);
    // Views are mounted in Part 3/8+ via mountView(key).
    window.__cos_mountView?.(key);
  }

  nav.home?.addEventListener('click', () => routeTo('home'));
  nav.work?.addEventListener('click', () => routeTo('work'));
  nav.calendar?.addEventListener('click', () => routeTo('calendar'));
  nav.clients?.addEventListener('click', () => routeTo('clients'));
  nav.studio?.addEventListener('click', () => routeTo('studio'));
  nav.ops?.addEventListener('click', () => routeTo('ops'));
  nav.help?.addEventListener('click', () => routeTo('help'));

  /* ---------- Auth dialog UI ---------- */
  const authBody = $('authBody');
  const authFoot = $('authFoot');

  function renderAuthDialog(mode = 'signin') {
    authBody.innerHTML = '';
    authFoot.innerHTML = '';

    const email = el('input', { class: 'input', id: 'dlgEmail', type: 'email', autocomplete: 'username', value: $('authEmail')?.value || '' });
    const pass = el('input', { class: 'input', id: 'dlgPass', type: 'password', autocomplete: mode === 'signup' ? 'new-password' : 'current-password', value: $('authPass')?.value || '' });

    const block = el('div', { class: 'card', style: 'border-radius:22px' }, [
      el('div', { class: 'cardBody' }, [
        el('div', { class: 'row' }, [
          el('div', { class: 'field' }, [
            el('div', { class: 'label', text: 'Email' }),
            email,
            el('div', { class: 'help', text: 'Use your firm email.' })
          ]),
          el('div', { class: 'field' }, [
            el('div', { class: 'label', text: mode === 'forgot' ? 'New password is set via email' : 'Password' }),
            pass,
            el('div', { class: 'help', text: mode === 'forgot' ? 'We will email you a reset link.' : 'Minimum 6 characters.' })
          ])
        ])
      ])
    ]);

    if (mode === 'forgot') pass.setAttribute('disabled', 'disabled');

    authBody.appendChild(block);

    const btnSignin = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Sign in' });
    const btnSignup = el('button', { class: 'btn', type: 'button', text: 'Create account' });
    const btnForgot = el('button', { class: 'btn btnGhost', type: 'button', text: 'Forgot password' });
    const btnLogout = el('button', { class: 'btn btnDanger', type: 'button', text: 'Sign out' });

    const btnResetSend = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Send reset email' });

    if (!auth.currentUser) {
      authFoot.appendChild(btnSignin);
      authFoot.appendChild(btnSignup);
      authFoot.appendChild(btnForgot);
    } else {
      authFoot.appendChild(btnLogout);
    }

    if (mode === 'forgot') {
      authFoot.innerHTML = '';
      authFoot.appendChild(btnResetSend);
      authFoot.appendChild(el('button', { class: 'btn btnGhost', type: 'button', text: 'Back to sign in', onclick: () => renderAuthDialog('signin') }));
    }

    btnSignin.onclick = async () => {
      const e = String(email.value || '').trim();
      const p = String(pass.value || '');
      if (!e || !p) return toast('Enter email and password', 3600);
      try {
        await auth.signInWithEmailAndPassword(e, p);
        toast('Signed in');
        closeDialog(dialogs.auth);
      } catch (err) {
        toast(`Sign in failed: ${err?.message || err?.code || String(err)}`, 7000);
      }
    };

    btnSignup.onclick = async () => {
      const e = String(email.value || '').trim();
      const p = String(pass.value || '');
      if (!e || !p) return toast('Enter email and password', 3600);
      try {
        const cred = await auth.createUserWithEmailAndPassword(e, p);
        // Create user doc (role defaults to ASSOCIATE, backend treats WORKER as ASSOCIATE anyway)
        const dn = e.split('@')[0] || e;
        await db.collection('users').doc(cred.user.uid).set({
          email: e,
          emailLower: e.toLowerCase(),
          displayName: dn,
          displayNameLower: dn.toLowerCase(),
          role: 'ASSOCIATE',
          active: true,
          managerEmail: null,
          managerUid: null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        toast('Account created');
        closeDialog(dialogs.auth);
      } catch (err) {
        toast(`Signup failed: ${err?.message || err?.code || String(err)}`, 8000);
      }
    };

    btnForgot.onclick = () => renderAuthDialog('forgot');

    btnResetSend.onclick = async () => {
      const e = String(email.value || '').trim();
      if (!e) return toast('Enter your email', 3600);
      try {
        await auth.sendPasswordResetEmail(e);
        toast('Reset email sent', 4500);
        renderAuthDialog('signin');
      } catch (err) {
        toast(`Reset failed: ${err?.message || err?.code || String(err)}`, 9000);
      }
    };

    btnLogout.onclick = async () => {
      try {
        await auth.signOut();
        toast('Signed out');
        closeDialog(dialogs.auth);
      } catch (err) {
        toast(`Sign out failed: ${err?.message || String(err)}`, 6000);
      }
    };

    // Autofocus
    setTimeout(() => (mode === 'forgot' ? email : (pass.value ? pass : email)).focus?.(), 0);
  }

  function openAuth() {
    renderAuthDialog('signin');
    openDialog(dialogs.auth, { initialFocusId: 'dlgEmail' });
  }

  $('btnAuth')?.addEventListener('click', () => {
    if (auth.currentUser) openAuth();
    else openAuth();
  });
  $('btnOpenAuth')?.addEventListener('click', openAuth);

  $('btnQuickLogin')?.addEventListener('click', async () => {
    const e = String($('authEmail')?.value || '').trim();
    const p = String($('authPass')?.value || '');
    if (!e || !p) return toast('Enter email and password', 3600);
    try {
      await auth.signInWithEmailAndPassword(e, p);
      toast('Signed in');
    } catch (err) {
      toast(`Sign in failed: ${err?.message || err?.code || String(err)}`, 8000);
    }
  });

  $('btnQuickSignup')?.addEventListener('click', async () => {
    const e = String($('authEmail')?.value || '').trim();
    const p = String($('authPass')?.value || '');
    if (!e || !p) return toast('Enter email and password', 3600);
    try {
      const cred = await auth.createUserWithEmailAndPassword(e, p);
      const dn = e.split('@')[0] || e;
      await db.collection('users').doc(cred.user.uid).set({
        email: e,
        emailLower: e.toLowerCase(),
        displayName: dn,
        displayNameLower: dn.toLowerCase(),
        role: 'ASSOCIATE',
        active: true,
        managerEmail: null,
        managerUid: null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      toast('Account created');
    } catch (err) {
      toast(`Signup failed: ${err?.message || err?.code || String(err)}`, 9000);
    }
  });

  $('btnQuickForgot')?.addEventListener('click', () => {
    openAuth();
    renderAuthDialog('forgot');
  });

  /* ---------- Command palette UI ---------- */
  const cmdBody = $('cmdBody');

  function buildCmdUI() {
    cmdBody.innerHTML = '';

    const input = el('input', {
      class: 'input',
      id: 'cmdInput',
      type: 'text',
      placeholder: 'Type to search… (tasks, clients, exports, reports)'
    });

    const list = el('div', { id: 'cmdList', style: 'display:flex;flex-direction:column;gap:10px;margin-top:14px' });

    const help = el('div', { class: 'help', html: `
      <div><b>Enter</b> to open · <b>↑/↓</b> to navigate · <b>Esc</b> to close</div>
      <div style="margin-top:8px">Power: type <span style="font-family:var(--mono);font-weight:900">export</span>, <span style="font-family:var(--mono);font-weight:900">pdf</span>, <span style="font-family:var(--mono);font-weight:900">update xlsx</span>, <span style="font-family:var(--mono);font-weight:900">client</span>.</div>
    ` });

    cmdBody.appendChild(el('div', { class: 'row' }, [input]));
    cmdBody.appendChild(list);
    cmdBody.appendChild(el('div', { style: 'margin-top:14px' }, [help]));

    input.addEventListener('input', () => filterCmd(input.value));
    input.addEventListener('keydown', (e) => onCmdKeydown(e));

    window.__cos_cmd = { input, list };
  }

  function cmdItemCard(item, isActive) {
    const meta = item.meta ? el('div', { class: 'help', text: item.meta }) : el('div', { class: 'help', text: '' });
    const title = el('div', { style: 'font-weight:900;letter-spacing:.2px', text: item.title });

    const badge = el('div', {
      class: 'chip',
      text: item.kind,
      style: `margin-left:auto; ${isActive ? 'border-color: rgba(34,211,238,.55);' : ''}`
    });

    const wrap = el('button', {
      class: 'btn btnGhost',
      type: 'button',
      style: `
        width:100%;
        border-radius: 18px;
        justify-content:flex-start;
        align-items:flex-start;
        gap: 12px;
        padding: 12px 12px;
        background: ${isActive ? 'rgba(34,211,238,.12)' : 'transparent'};
        border-color: ${isActive ? 'rgba(34,211,238,.45)' : 'var(--stroke2)'};
      `
    });

    const left = el('div', { style: 'display:flex;flex-direction:column;gap:6px;min-width:0;flex:1' }, [title, meta]);
    wrap.appendChild(left);
    wrap.appendChild(badge);

    wrap.addEventListener('click', () => {
      runCmd(item);
    });

    return wrap;
  }

  function buildCmdItems() {
    const items = [];

    // Navigation commands (always present)
    items.push(
      { kind: 'Go', title: 'Overview', meta: 'Dashboard & KPIs', run: () => routeTo('home') },
      { kind: 'Go', title: 'Work Queue', meta: 'Filters, bulk actions, approvals', run: () => routeTo('work') },
      { kind: 'Go', title: 'Timeline', meta: 'Calendar + agenda', run: () => routeTo('calendar') },
      ...(state.isPartner ? [{ kind: 'Go', title: 'Clients', meta: 'Create & edit clients, client exports', run: () => routeTo('clients') }] : []),
      { kind: 'Go', title: 'Studio', meta: 'Email templates + safe copy for Excel', run: () => routeTo('studio') },
      ...((state.isPartner || state.isManager) ? [{ kind: 'Go', title: 'Ops & Reports', meta: 'PDF/XLSX exports + offline update', run: () => routeTo('ops') }] : [])
    );

    // Action commands (depend on views / backend features)
    if (state.isPartner || state.isManager) {
      items.push(
        { kind: 'Export', title: 'Firm range — XLSX (with history)', meta: 'Pick date range in Ops', run: () => routeTo('ops') },
        { kind: 'Report', title: 'Firm range — PDF', meta: 'Pick date range in Ops', run: () => routeTo('ops') },
        { kind: 'Offline', title: 'Export tasks for update (XLSX)', meta: 'Download update file, edit offline, upload back', run: () => routeTo('ops') },
        { kind: 'Offline', title: 'Upload offline updates (XLSX)', meta: 'Bulk update existing tasks', run: () => routeTo('ops') }
      );
    }

    // Task hits
    const tdy = todayYmdIST();
    for (const t of (state.tasks || []).slice(0, 1200)) {
      const clientName = state.clientsById?.get(t.clientId)?.name || '';
      const due = t.dueDateYmd ? ymdToDmy(t.dueDateYmd) : '';
      const dd = t.dueDateYmd ? diffDaysIST(tdy, t.dueDateYmd) : null;
      const urgency = (t.status === 'COMPLETED') ? 'done' : (dd !== null && dd < 0 ? 'overdue' : (dd !== null && dd <= 3 ? 'soon' : ''));
      items.push({
        kind: 'Task',
        title: t.title || '(task)',
        meta: `${clientName}${due ? ` · Due ${due}` : ''}${t.status ? ` · ${t.status}` : ''}${urgency ? ` · ${urgency}` : ''}`,
        run: () => {
          routeTo('work');
          window.__cos_openTask?.(t.id);
        }
      });
    }

    // Client hits
    if (state.isPartner) {
      for (const c of (state.clients || []).slice(0, 700)) {
        items.push({
          kind: 'Client',
          title: c.name || '(client)',
          meta: c.primaryEmail || '',
          run: () => {
            routeTo('clients');
            window.__cos_openClient?.(c.id);
          }
        });
      }
    }

    state.cmd.items = items;
  }

  function filterCmd(query) {
    const q = String(query || '').trim().toLowerCase();
    buildCmdItems();

    const items = state.cmd.items;
    const filtered = !q ? items.slice(0, 24) : items.filter(it => {
      const hay = `${it.kind} ${it.title} ${it.meta || ''}`.toLowerCase();
      return hay.includes(q);
    }).slice(0, 40);

    state.cmd.filtered = filtered;
    state.cmd.activeIndex = 0;
    renderCmd();
  }

  function renderCmd() {
    const { list } = window.__cos_cmd || {};
    if (!list) return;
    list.innerHTML = '';

    if (!state.cmd.filtered.length) {
      list.appendChild(el('div', { class: 'help', text: 'No matches.' }));
      return;
    }

    state.cmd.filtered.forEach((it, idx) => {
      list.appendChild(cmdItemCard(it, idx === state.cmd.activeIndex));
    });
  }

  function onCmdKeydown(e) {
    if (!state.cmd.filtered.length) return;
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      state.cmd.activeIndex = clamp(state.cmd.activeIndex + 1, 0, state.cmd.filtered.length - 1);
      renderCmd();
    }
    if (e.key === 'ArrowUp') {
      e.preventDefault();
      state.cmd.activeIndex = clamp(state.cmd.activeIndex - 1, 0, state.cmd.filtered.length - 1);
      renderCmd();
    }
    if (e.key === 'Enter') {
      e.preventDefault();
      const it = state.cmd.filtered[state.cmd.activeIndex];
      if (it) runCmd(it);
    }
  }

  function runCmd(item) {
    try {
      item.run?.();
      closeDialog(dialogs.cmd);
    } catch (err) {
      toast(`Command failed: ${err?.message || String(err)}`, 6000);
    }
  }

  function openCmd() {
    buildCmdUI();
    filterCmd('');
    openDialog(dialogs.cmd, { initialFocusId: 'cmdInput' });
  }

  /* ---------- Data subscriptions (minimal; views render in Part 3/8+) ---------- */
  let unsubClients = null;
  let unsubTasks = null;

  function clearSubs() {
    try { unsubClients?.(); } catch {}
    try { unsubTasks?.(); } catch {}
    unsubClients = null;
    unsubTasks = null;
  }

  async function loadMyUserProfile(uid) {
    const snap = await db.collection('users').doc(uid).get();
    const u = snap.exists ? (snap.data() || {}) : {};
    state.displayName = u.displayName || '';
    setRole(u.role || 'ASSOCIATE');
  }

  function indexCaches() {
    state.clientsById = new Map((state.clients || []).map(c => [c.id, c]));
  }

  function subscribeClients() {
    if (!state.isPartner) {
      state.clients = [];
      indexCaches();
      return;
    }
    unsubClients = db.collection('clients')
      .orderBy('name', 'asc')
      .limit(1200)
      .onSnapshot((snap) => {
        state.clients = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        indexCaches();
        window.__cos_onData?.();
      });
  }

  function subscribeTasks() {
    const uid = state.uid;
    if (!uid) return;

    const q = (state.isPartner || state.isManager)
      ? db.collection('tasks')
      : db.collection('tasks').where('assignedToUid', '==', uid);

    unsubTasks = q.limit(2500).onSnapshot((snap) => {
      state.tasks = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      window.__cos_onData?.();
    });
  }

  /* ---------- Auth state ---------- */
  const signedOutCard = $('signedOutCard');
  const signedInPlaceholder = $('signedInPlaceholder');

  auth.onAuthStateChanged(async (user) => {
    clearSubs();

    if (!user) {
      state.uid = null;
      state.email = null;
      setRole('ASSOCIATE');
      $('btnAuth').textContent = 'Sign in';
      signedOutCard.style.display = '';
      signedInPlaceholder.style.display = 'none';
      routeTo('home');
      window.__cos_mountSignedOut?.();
      return;
    }

    state.uid = user.uid;
    state.email = user.email || '';
    $('btnAuth').textContent = 'Account';
    $('chipRole').textContent = `Loading… · ${state.email}`;

    signedOutCard.style.display = 'none';
    signedInPlaceholder.style.display = '';

    try {
      await loadMyUserProfile(user.uid);
    } catch (err) {
      setRole('ASSOCIATE');
      toast(`Profile read blocked: ${err?.message || String(err)}`, 6500);
    }

    subscribeClients();
    subscribeTasks();

    signedInPlaceholder.style.display = 'none';

    // Default to Work Queue after sign-in (new flow)
    routeTo('work');
  });

  /* ---------- Expose to later parts ---------- */
  window.__cos = {
    auth, db,
    state,
    apiJson, apiForm,
    downloadBase64,
    safeCopy,
    ymdToDmy, dmyToYmd, todayYmdIST, diffDaysIST,
    openAuth,
    toast
  };

  // Bootstrap command palette UI once
  buildCmdUI();
  filterCmd('');

})();
</script>
<script>
/* =========================
   ComplianceOS — Part 3/8
   View system + Overview + Work Queue (list + bulk + inspector launcher)
   ========================= */

(() => {
  'use strict';

  const {
    state,
    apiJson,
    downloadBase64,
    safeCopy,
    ymdToDmy,
    dmyToYmd,
    todayYmdIST,
    diffDaysIST,
    toast
  } = window.__cos;

  const mount = document.getElementById('viewMount');

  /* ---------- tiny render helpers ---------- */
  const el = (tag, attrs = {}, children = []) => {
    const n = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs || {})) {
      if (k === 'class') n.className = v;
      else if (k === 'text') n.textContent = v;
      else if (k === 'html') n.innerHTML = v;
      else if (k === 'style') n.setAttribute('style', String(v));
      else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
      else if (v === false || v === null || v === undefined) continue;
      else n.setAttribute(k, String(v));
    }
    for (const c of (children || [])) n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
    return n;
  };

  function card(title, subtitle, rightNode, bodyNode) {
    const head = el('div', { class: 'cardHead' }, [
      el('div', {}, [
        el('h2', { text: title }),
        subtitle ? el('p', { text: subtitle }) : el('p', { style: 'display:none' })
      ]),
      rightNode || el('div')
    ]);
    const body = el('div', { class: 'cardBody' }, [bodyNode || el('div')]);
    return el('div', { class: 'card' }, [head, body]);
  }

  function pill(text, tone) {
    const colors = {
      ok: 'border-color: rgba(34,197,94,.38); background: rgba(34,197,94,.12); color: var(--text);',
      warn: 'border-color: rgba(245,158,11,.42); background: rgba(245,158,11,.14); color: var(--text);',
      bad: 'border-color: rgba(239,68,68,.42); background: rgba(239,68,68,.14); color: var(--text);',
      info:'border-color: rgba(34,211,238,.42); background: rgba(34,211,238,.12); color: var(--text);',
      dim: 'border-color: var(--stroke2); background: rgba(255,255,255,.05); color: var(--muted);'
    };
    return el('span', {
      class: 'chip',
      style: `padding:6px 10px; font-size:12px; ${colors[tone||'dim']||colors.dim}`
    }, [text]);
  }

  function asEmailList(str) {
    return String(str || '')
      .split(/[;,:]/)
      .map(s => s.trim())
      .filter(Boolean);
  }

  function normalizeCategoryKey(x) {
    const u = String(x || '').trim().toUpperCase().replace(/\s+/g, '_');
    if (u === 'INCOME_TAX' || u === 'INCOME_TAX_RETURN' || u === 'INCOME') return 'INCOME_TAX';
    if (u === 'ACCOUNTING') return 'ACCOUNTING';
    if (u === 'AUDIT') return 'AUDIT';
    if (u === 'GST') return 'GST';
    if (u === 'TDS') return 'TDS';
    if (u === 'ROC') return 'ROC';
    return u || 'OTHER';
  }

  function urgencyForTask(t) {
    const tdy = todayYmdIST();
    if (t.status === 'COMPLETED') return { label: 'Done', tone: 'ok' };
    if (t.snoozedUntilYmd && t.snoozedUntilYmd > tdy) return { label: `Snoozed`, tone: 'dim' };
    const dd = t.dueDateYmd ? diffDaysIST(tdy, t.dueDateYmd) : null;
    if (dd === null) return { label: 'No due date', tone: 'dim' };
    if (dd < 0) return { label: 'Overdue', tone: 'bad' };
    if (dd === 0) return { label: 'Due today', tone: 'bad' };
    if (dd <= 3) return { label: 'Due soon', tone: 'warn' };
    if (dd <= 7) return { label: 'This week', tone: 'warn' };
    return { label: 'On track', tone: 'info' };
  }

  function canSeeAllTasks() {
    return state.isPartner || state.isManager;
  }

  /* ---------- Inspector (task drawer replacement) ----------
     Full inspector is built in Part 6/8.
     Here we only open it by calling window.__cos_openTask (provided later). */
  window.__cos_openTask = (taskId) => {
    state.inspectorTaskId = taskId;
    if (typeof window.__cos_openTaskInspector === 'function') {
      window.__cos_openTaskInspector(taskId);
    } else {
      toast('Inspector is loading…', 2200);
    }
  };

  /* ---------- View mount system ---------- */
  function clearMount() {
    mount.innerHTML = '';
  }

  function mountSignedOut() {
    // Signed-out UI is already in HTML (Part 1). Here we just ensure rail is neutral.
    clearMount();
    // Let the signed-out card show as part of base HTML (already visible).
  }
  window.__cos_mountSignedOut = mountSignedOut;

  function onDataRerender() {
    if (!state.uid) return;
    if (typeof window.__cos_mountView === 'function') window.__cos_mountView(state.activeView);
  }
  window.__cos_onData = onDataRerender;

  window.__cos_mountView = (key) => {
    clearMount();
    if (!state.uid) return;

    if (key === 'home') return mountOverview();
    if (key === 'work') return mountWorkQueue();
    if (key === 'calendar') {
      // Implemented in Part 4/8
      return (window.__cos_mountCalendar?.() || mountStub('Timeline', 'Calendar view loads in next part.'));
    }
    if (key === 'clients') {
      // Implemented in Part 5/8
      return (window.__cos_mountClients?.() || mountStub('Clients', 'Client workspace loads in next part.'));
    }
    if (key === 'studio') {
      // Implemented in Part 7/8
      return (window.__cos_mountStudio?.() || mountStub('Studio', 'Email drafting studio loads in next part.'));
    }
    if (key === 'ops') {
      // Implemented in Part 8/8
      return (window.__cos_mountOps?.() || mountStub('Ops & Reports', 'Exports, PDFs and offline updates load in next part.'));
    }
    if (key === 'help') return mountHelp();
    return mountOverview();
  };

  function mountStub(title, msg) {
    const body = el('div', {}, [
      el('div', { class: 'help', text: msg })
    ]);
    mount.appendChild(el('div', { class: 'gridMax' }, [
      card(title, 'Workspace', null, body)
    ]));
  }

  /* ---------- OVERVIEW (new dashboard) ---------- */
  function computeOverview() {
    const tdy = todayYmdIST();

    const visible = (state.tasks || []).slice();
    let total = visible.length;

    let overdue = 0, dueToday = 0, due7 = 0, appr = 0, snoozed = 0;
    let startToday = 0;

    const focus = [];

    for (const t of visible) {
      if (t.snoozedUntilYmd && t.snoozedUntilYmd > tdy && t.status !== 'COMPLETED') snoozed++;
      if (t.status === 'APPROVAL_PENDING') appr++;
      if (t.status !== 'COMPLETED' && t.startDateYmd === tdy) startToday++;

      if (!t.dueDateYmd) continue;
      const dd = diffDaysIST(tdy, t.dueDateYmd);

      if (t.status !== 'COMPLETED') {
        if (dd < 0) overdue++;
        if (dd === 0) dueToday++;
        if (dd >= 0 && dd <= 7) due7++;
      }

      const u = urgencyForTask(t);
      if (t.status !== 'COMPLETED' && (u.tone === 'bad' || u.tone === 'warn')) {
        focus.push(t);
      }
    }

    focus.sort((a, b) => String(a.dueDateYmd || '').localeCompare(String(b.dueDateYmd || '')));
    const top = focus.slice(0, 10);

    return { total, overdue, dueToday, due7, appr, snoozed, startToday, top };
  }

  function kpiTile(label, value, tone) {
    const box = el('div', {
      class: 'card',
      style: 'border-radius:22px; overflow:hidden;'
    }, [
      el('div', { class: 'cardBody', style: 'padding:16px' }, [
        el('div', { class: 'label', text: label }),
        el('div', {
          style: `
            margin-top:8px;
            font-size: 28px;
            font-weight: 900;
            letter-spacing: .2px;
            ${tone === 'bad' ? 'color: var(--bad);' : ''}
            ${tone === 'warn' ? 'color: var(--warn);' : ''}
            ${tone === 'ok' ? 'color: var(--ok);' : ''}
          `
        }, [String(value)])
      ])
    ]);
    return box;
  }

  function mountOverview() {
    const o = computeOverview();

    const headerRight = el('div', { class: 'row' }, [
      el('button', {
        class: 'btn btnSmall btnPrimary',
        type: 'button',
        text: 'New task',
        onclick: () => {
          // new task composer in Part 6/8 inspector (create mode)
          if (typeof window.__cos_openCreateTask === 'function') window.__cos_openCreateTask();
          else toast('Task composer is loading…', 2200);
        }
      }),
      el('button', {
        class: 'btn btnSmall',
        type: 'button',
        text: 'Jump to Work Queue',
        onclick: () => window.__cos_mountView('work')
      })
    ]);

    const kpis = el('div', {
      style: `
        display:grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 14px;
      `
    }, [
      el('div', { style: 'grid-column: span 3' }, [kpiTile('Total tasks', o.total, 'dim')]),
      el('div', { style: 'grid-column: span 3' }, [kpiTile('Overdue', o.overdue, 'bad')]),
      el('div', { style: 'grid-column: span 3' }, [kpiTile('Due today', o.dueToday, 'warn')]),
      el('div', { style: 'grid-column: span 3' }, [kpiTile('Due in 7 days', o.due7, 'info')]),
      el('div', { style: 'grid-column: span 3' }, [kpiTile('Start today', o.startToday, 'info')]),
      el('div', { style: 'grid-column: span 3' }, [kpiTile('Approval pending', o.appr, 'warn')]),
      el('div', { style: 'grid-column: span 3' }, [kpiTile('Snoozed', o.snoozed, 'dim')]),
      el('div', { style: 'grid-column: span 3' }, [kpiTile('Role', state.role, 'dim')])
    ]);

    // Mobile: stack grid columns
    const style = el('style', {
      html: `
        @media (max-width: 980px){
          .cosKpiGrid{ grid-template-columns: 1fr !important; }
          .cosKpiGrid > div{ grid-column: span 12 !important; }
        }
      `
    });
    kpis.classList.add('cosKpiGrid');

    const list = el('div', { style: 'display:flex; flex-direction:column; gap:10px' });
    if (!o.top.length) {
      list.appendChild(el('div', { class: 'help', text: 'No urgent items. Your queue looks clear.' }));
    } else {
      for (const t of o.top) {
        const clientName = state.clientsById?.get(t.clientId)?.name || '';
        const u = urgencyForTask(t);

        const row = el('button', {
          class: 'btn btnGhost',
          type: 'button',
          style: `
            width:100%;
            border-radius: 20px;
            justify-content:flex-start;
            padding: 12px 12px;
            gap: 12px;
            align-items:flex-start;
          `,
          onclick: () => window.__cos_openTask(t.id)
        }, [
          pill(u.label, u.tone),
          el('div', { style: 'display:flex; flex-direction:column; gap:6px; min-width:0; flex:1' }, [
            el('div', { style: 'font-weight:900; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;' }, [t.title || '(task)']),
            el('div', { class: 'help', text: `${clientName}${t.dueDateYmd ? ` · Due ${ymdToDmy(t.dueDateYmd)}` : ''}${t.status ? ` · ${t.status}` : ''}` })
          ]),
          el('div', { class: 'chip', text: (t.priority || 'MEDIUM') })
        ]);

        list.appendChild(row);
      }
    }

    mount.appendChild(style);
    mount.appendChild(el('div', { class: 'gridMax' }, [
      card('Overview', 'A focused snapshot of what needs attention — built for speed and clarity.', headerRight, kpis),
      card('Focus list', 'Top items that are overdue or due soon. Open one to update status, mail settings, comments, and attachments.', null, list)
    ]));
  }

  /* ---------- WORK QUEUE (new filtering + bulk ops) ---------- */
  const workState = {
    q: '',
    status: '',
    category: '',
    mode: 'ACTIVE',     // ACTIVE | ALL | SNOOZED | APPROVAL | COMPLETED
    dueFrom: '',
    dueTo: '',
    assignee: '',
    priority: '',
    clientId: '',
    needDays: 7,
    selected: new Set()
  };

  function allowedStatusesForBulk(role) {
    // Associates cannot set COMPLETED (backend enforces too)
    const base = ['PENDING', 'IN_PROGRESS', 'CLIENT_PENDING', 'APPROVAL_PENDING'];
    if (state.isPartner || state.isManager) base.push('COMPLETED');
    return base;
  }

  function filterWorkTasks() {
    const tdy = todayYmdIST();
    const q = String(workState.q || '').trim().toLowerCase();

    let fromY = '';
    let toY = '';
    try { if (workState.dueFrom) fromY = dmyToYmd(workState.dueFrom); } catch {}
    try { if (workState.dueTo) toY = dmyToYmd(workState.dueTo); } catch {}

    return (state.tasks || []).filter(t => {
      const client = state.clientsById?.get(t.clientId) || null;
      const clientName = (client?.name || '');

      // mode
      const snoozedNow = (t.snoozedUntilYmd && t.snoozedUntilYmd > tdy && t.status !== 'COMPLETED');
      if (workState.mode === 'ACTIVE') {
        if (t.status === 'COMPLETED') return false;
        if (snoozedNow) return false;
      }
      if (workState.mode === 'ALL') {
        // show all
      }
      if (workState.mode === 'SNOOZED' && !snoozedNow) return false;
      if (workState.mode === 'APPROVAL' && t.status !== 'APPROVAL_PENDING') return false;
      if (workState.mode === 'COMPLETED' && t.status !== 'COMPLETED') return false;

      if (workState.status && t.status !== workState.status) return false;
      if (workState.category && normalizeCategoryKey(t.category) !== normalizeCategoryKey(workState.category)) return false;
      if (workState.priority && String(t.priority || 'MEDIUM').toUpperCase() !== String(workState.priority).toUpperCase()) return false;
      if (workState.clientId && t.clientId !== workState.clientId) return false;

      if (workState.assignee) {
        const a = String(t.assignedToEmail || '').trim().toLowerCase();
        if (a !== String(workState.assignee).trim().toLowerCase()) return false;
      }

      if (fromY && String(t.dueDateYmd || '') < fromY) return false;
      if (toY && String(t.dueDateYmd || '') > toY) return false;

      if (q) {
        const hay = `${t.title || ''} ${t.type || ''} ${clientName} ${t.assignedToEmail || ''}`.toLowerCase();
        if (!hay.includes(q)) return false;
      }
      return true;
    }).sort((a, b) => String(a.dueDateYmd || '').localeCompare(String(b.dueDateYmd || '')));
  }

  async function bulkUpdate(op, payload) {
    const ids = Array.from(workState.selected);
    if (!ids.length) return toast('Select tasks first', 3200);

    const r = await apiJson('/tasks_bulkUpdate', { taskIds: ids, op, ...payload });
    if (!r.ok) return toast(`Bulk failed: ${r.error || JSON.stringify(r)}`, 9000);

    if (op === 'DELETE') toast(`Deleted ${r.deletedCount || 0} tasks`);
    else toast(`Updated ${r.updatedCount || 0} tasks`);

    workState.selected.clear();
    window.__cos_mountView('work');
  }

  function renderBulkBar() {
    const count = workState.selected.size;

    const bar = el('div', {
      class: 'card',
      style: `
        position: sticky;
        top: 0;
        z-index: 5;
        border-radius: 22px;
        display: ${count ? 'block' : 'none'};
      `
    }, [
      el('div', { class: 'cardBody', style: 'padding:14px' }, [
        el('div', { class: 'row', style: 'justify-content:space-between' }, [
          el('div', { class: 'row' }, [
            pill(`Selected: ${count}`, 'info'),
            el('button', { class: 'btn btnSmall btnGhost', type: 'button', text: 'Clear', onclick: () => {
              workState.selected.clear();
              window.__cos_mountView('work');
            }})
          ]),
          el('div', { class: 'row' }, [
            // Status
            (() => {
              const sel = el('select', { class: 'select', style: 'min-width:220px; border-radius:999px; padding:10px 12px' });
              sel.appendChild(el('option', { value: '', text: 'Change status…' }));
              for (const s of allowedStatusesForBulk(state.role)) sel.appendChild(el('option', { value: s, text: s }));
              const btn = el('button', { class: 'btn btnSmall btnPrimary', type: 'button', text: 'Apply', onclick: () => {
                if (!sel.value) return toast('Pick a status', 3200);
                bulkUpdate('STATUS', { newStatus: sel.value });
              }});
              return el('div', { class: 'row' }, [sel, btn]);
            })(),

            // Reassign (privileged)
            ...(canSeeAllTasks() ? [(() => {
              const inp = el('input', { class: 'input', placeholder: 'Reassign to email', style: 'min-width:240px; border-radius:999px; padding:10px 12px' });
              const btn = el('button', { class: 'btn btnSmall', type: 'button', text: 'Reassign', onclick: () => {
                const email = String(inp.value || '').trim();
                if (!email) return toast('Enter email', 3200);
                bulkUpdate('REASSIGN', { assignedToEmail: email });
              }});
              return el('div', { class: 'row' }, [inp, btn]);
            })()] : []),

            // Snooze
            (() => {
              const btn = el('button', { class: 'btn btnSmall', type: 'button', text: 'Snooze…', onclick: async () => {
                const dmy = prompt('Snooze until (DD-MM-YYYY):', '');
                if (!dmy) return;
                let ymd = '';
                try { ymd = dmyToYmd(dmy); } catch (e) { return toast(e.message, 6000); }
                bulkUpdate('SNOOZE', { snoozedUntilYmd: ymd });
              }});
              return btn;
            })(),

            // Delete
            el('button', { class: 'btn btnSmall btnDanger', type: 'button', text: 'Delete', onclick: () => {
              if (!confirm('Delete selected tasks?')) return;
              bulkUpdate('DELETE', {});
            }})
          ])
        ])
      ])
    ]);

    return bar;
  }

  function taskRow(t) {
    const clientName = state.clientsById?.get(t.clientId)?.name || '';
    const u = urgencyForTask(t);
    const checked = workState.selected.has(t.id);

    const left = el('div', { style: 'display:flex; align-items:flex-start; gap:12px; min-width:0; flex:1' }, [
      el('input', {
        type: 'checkbox',
        style: 'margin-top:4px; width:18px; height:18px;',
        checked,
        onchange: (e) => {
          if (e.target.checked) workState.selected.add(t.id);
          else workState.selected.delete(t.id);
          // soft update (don’t full rerender)
          window.__cos_mountView('work');
        }
      }),
      pill(u.label, u.tone),
      el('div', { style: 'min-width:0; flex:1; display:flex; flex-direction:column; gap:6px' }, [
        el('div', { style: 'font-weight:900; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;' }, [t.title || '(task)']),
        el('div', { class: 'help' }, [
          `${clientName || '—'}`,
          t.dueDateYmd ? ` · Due ${ymdToDmy(t.dueDateYmd)}` : '',
          t.status ? ` · ${t.status}` : '',
          t.assignedToEmail ? ` · ${t.assignedToEmail}` : ''
        ].filter(Boolean).join(''))
      ])
    ]);

    const right = el('div', { class: 'row', style: 'justify-content:flex-end; flex:0 0 auto' }, [
      el('span', { class: 'chip', text: String(t.priority || 'MEDIUM').toUpperCase() }),
      el('button', {
        class: 'btn btnSmall btnPrimary',
        type: 'button',
        text: 'Open',
        onclick: () => window.__cos_openTask(t.id)
      })
    ]);

    const row = el('div', {
      class: 'card',
      style: 'border-radius:22px;'
    }, [
      el('div', { class: 'cardBody', style: 'padding:14px' }, [
        el('div', { class: 'row', style: 'justify-content:space-between; align-items:flex-start' }, [
          left,
          right
        ])
      ])
    ]);

    return row;
  }

  function mountWorkQueue() {
    const list = filterWorkTasks();

    // Build filter panel
    const filters = el('div', { style: 'display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px;' });

    const field12 = (node) => el('div', { style: 'grid-column: span 12' }, [node]);
    const field6 = (node) => el('div', { style: 'grid-column: span 6' }, [node]);
    const field4 = (node) => el('div', { style: 'grid-column: span 4' }, [node]);
    const field3 = (node) => el('div', { style: 'grid-column: span 3' }, [node]);

    // Search
    const inpQ = el('input', { class: 'input', value: workState.q, placeholder: 'Search tasks, clients, assignees…' });
    inpQ.addEventListener('input', () => { workState.q = inpQ.value; window.__cos_mountView('work'); });

    // Mode
    const selMode = el('select', { class: 'select' });
    [
      ['ACTIVE', 'Active (hide snoozed & completed)'],
      ['ALL', 'All'],
      ['SNOOZED', 'Snoozed'],
      ['APPROVAL', 'Approval pending'],
      ['COMPLETED', 'Completed']
    ].forEach(([v, t]) => selMode.appendChild(el('option', { value: v, text: t })));
    selMode.value = workState.mode;
    selMode.addEventListener('change', () => { workState.mode = selMode.value; window.__cos_mountView('work'); });

    // Status
    const selStatus = el('select', { class: 'select' });
    selStatus.appendChild(el('option', { value: '', text: 'Any status' }));
    ['PENDING','IN_PROGRESS','CLIENT_PENDING','APPROVAL_PENDING','COMPLETED'].forEach(s => selStatus.appendChild(el('option', { value: s, text: s })));
    selStatus.value = workState.status;
    selStatus.addEventListener('change', () => { workState.status = selStatus.value; window.__cos_mountView('work'); });

    // Category
    const selCat = el('select', { class: 'select' });
    selCat.appendChild(el('option', { value: '', text: 'Any category' }));
    ['GST','TDS','INCOME_TAX','ROC','ACCOUNTING','AUDIT','OTHER'].forEach(c => selCat.appendChild(el('option', { value: c, text: c })));
    selCat.value = workState.category;
    selCat.addEventListener('change', () => { workState.category = selCat.value; window.__cos_mountView('work'); });

    // Priority
    const selPri = el('select', { class: 'select' });
    selPri.appendChild(el('option', { value: '', text: 'Any priority' }));
    ['HIGH','MEDIUM','LOW'].forEach(p => selPri.appendChild(el('option', { value: p, text: p })));
    selPri.value = workState.priority;
    selPri.addEventListener('change', () => { workState.priority = selPri.value; window.__cos_mountView('work'); });

    // Client (partner/manager only, because associates might not have clients loaded)
    const selClient = el('select', { class: 'select', disabled: (!state.isPartner) });
    selClient.appendChild(el('option', { value: '', text: state.isPartner ? 'Any client' : 'Client filter (Partner only)' }));
    if (state.isPartner) {
      for (const c of (state.clients || [])) selClient.appendChild(el('option', { value: c.id, text: c.name || c.id }));
    }
    selClient.value = workState.clientId;
    selClient.addEventListener('change', () => { workState.clientId = selClient.value; window.__cos_mountView('work'); });

    // Assignee (partner/manager only - associates already limited)
    const inpAssignee = el('input', { class: 'input', value: workState.assignee, placeholder: canSeeAllTasks() ? 'Assignee email (exact match)' : 'Assignee filter (not needed)' });
    inpAssignee.disabled = !canSeeAllTasks();
    inpAssignee.addEventListener('input', () => { workState.assignee = inpAssignee.value; window.__cos_mountView('work'); });

    // Due range
    const inpFrom = el('input', { class: 'input', value: workState.dueFrom, placeholder: 'Due from (DD-MM-YYYY)' });
    const inpTo = el('input', { class: 'input', value: workState.dueTo, placeholder: 'Due to (DD-MM-YYYY)' });
    inpFrom.addEventListener('input', () => { workState.dueFrom = inpFrom.value; window.__cos_mountView('work'); });
    inpTo.addEventListener('input', () => { workState.dueTo = inpTo.value; window.__cos_mountView('work'); });

    // Actions
    const btnReset = el('button', { class: 'btn btnSmall btnGhost', type: 'button', text: 'Reset filters', onclick: () => {
      workState.q = '';
      workState.status = '';
      workState.category = '';
      workState.mode = 'ACTIVE';
      workState.dueFrom = '';
      workState.dueTo = '';
      workState.assignee = '';
      workState.priority = '';
      workState.clientId = '';
      window.__cos_mountView('work');
    }});

    const btnNew = el('button', { class: 'btn btnSmall btnPrimary', type: 'button', text: 'New task', onclick: () => {
      if (typeof window.__cos_openCreateTask === 'function') window.__cos_openCreateTask();
      else toast('Task composer is loading…', 2200);
    }});

    filters.appendChild(field6(el('div', { class: 'field' }, [
      el('div', { class: 'label', text: 'Search' }),
      inpQ
    ])));

    filters.appendChild(field3(el('div', { class: 'field' }, [
      el('div', { class: 'label', text: 'Mode' }),
      selMode
    ])));

    filters.appendChild(field3(el('div', { class: 'field' }, [
      el('div', { class: 'label', text: 'Status' }),
      selStatus
    ])));

    filters.appendChild(field3(el('div', { class: 'field' }, [
      el('div', { class: 'label', text: 'Category' }),
      selCat
    ])));

    filters.appendChild(field3(el('div', { class: 'field' }, [
      el('div', { class: 'label', text: 'Priority' }),
      selPri
    ])));

    filters.appendChild(field6(el('div', { class: 'field' }, [
      el('div', { class: 'label', text: 'Client' }),
      selClient,
      el('div', { class: 'help', text: state.isPartner ? 'Client filtering is available for partners.' : 'Client list is hidden for your role by design.' })
    ])));

    filters.appendChild(field6(el('div', { class: 'field' }, [
      el('div', { class: 'label', text: 'Assignee email (exact match)' }),
      inpAssignee,
      el('div', { class: 'help', text: canSeeAllTasks() ? 'Tip: paste a full email to filter quickly.' : 'Associates see only their tasks.' })
    ])));

    filters.appendChild(field3(el('div', { class: 'field' }, [
      el('div', { class: 'label', text: 'Due from' }),
      inpFrom
    ])));

    filters.appendChild(field3(el('div', { class: 'field' }, [
      el('div', { class: 'label', text: 'Due to' }),
      inpTo
    ])));

    filters.appendChild(field6(el('div', { class: 'row', style: 'align-items:flex-end; justify-content:flex-end; height:100%' }, [
      btnReset,
      btnNew
    ])));

    const headerRight = el('div', { class: 'row' }, [
      pill(`${list.length} shown`, 'dim'),
      pill(canSeeAllTasks() ? 'Team view' : 'My tasks', 'info')
    ]);

    const listWrap = el('div', { style: 'display:flex; flex-direction:column; gap: 12px;' });

    listWrap.appendChild(renderBulkBar());

    if (!list.length) {
      listWrap.appendChild(el('div', { class: 'help', text: 'No tasks match your filters.' }));
    } else {
      // Select all toggle
      const selectAll = el('button', { class: 'btn btnSmall btnGhost', type: 'button', text: 'Select all shown', onclick: () => {
        list.forEach(t => workState.selected.add(t.id));
        window.__cos_mountView('work');
      }});
      const selectNone = el('button', { class: 'btn btnSmall btnGhost', type: 'button', text: 'Select none', onclick: () => {
        workState.selected.clear();
        window.__cos_mountView('work');
      }});
      listWrap.appendChild(el('div', { class: 'row', style: 'justify-content:flex-end' }, [selectAll, selectNone]));

      for (const t of list) listWrap.appendChild(taskRow(t));
    }

    // Mobile stacking for filter grid
    const style = el('style', {
      html: `
        @media (max-width: 980px){
          .cosFilterGrid{ grid-template-columns: 1fr !important; }
          .cosFilterGrid > div{ grid-column: span 12 !important; }
        }
      `
    });
    filters.classList.add('cosFilterGrid');

    mount.appendChild(style);
    mount.appendChild(el('div', { class: 'gridMax' }, [
      card('Work Queue', 'A modern queue: filter + bulk actions + open inspector to update status, mail settings, attachments, comments, and exports.', headerRight, filters),
      card('Results', 'Open a task to work. Bulk actions are available at the top once you select items.', null, listWrap)
    ]));
  }

  /* ---------- HELP ---------- */
  function mountHelp() {
    const body = el('div', { style: 'display:flex; flex-direction:column; gap: 12px' }, [
      el('div', { class: 'help', html: `
        <div style="font-weight:900; color: var(--text)">Keyboard</div>
        <div style="margin-top:6px">
          <span style="font-family:var(--mono);font-weight:900">Ctrl/Cmd + K</span> — Command palette<br>
          <span style="font-family:var(--mono);font-weight:900">Esc</span> — Close dialogs / inspector
        </div>
      `}),
      el('div', { class: 'help', html: `
        <div style="font-weight:900; color: var(--text)">Roles</div>
        <div style="margin-top:6px">
          <b>ASSOCIATE</b>: works on assigned tasks, updates statuses, snoozes, comments, uploads attachments.<br>
          <b>MANAGER / PARTNER</b>: edits task details, reassigns, completes tasks, runs exports/reports, offline updates.
        </div>
      `}),
      el('div', { class: 'help', html: `
        <div style="font-weight:900; color: var(--text)">Mail behavior</div>
        <div style="margin-top:6px">
          Start mail can be disabled per task. Completion mail is sent as a reply-all in the start thread when available.<br>
          Overrides: task can store To/CC/BCC for both start and completion.
        </div>
      `})
    ]);

    mount.appendChild(el('div', { class: 'gridMax' }, [
      card('Help', 'Production UX notes and shortcuts.', null, body)
    ]));
  }

  // If signed-in and no view mounted yet, mount current
  if (state.uid) window.__cos_mountView(state.activeView || 'work');

})();
</script>
<script>
/* =========================
   ComplianceOS — Part 4/8
   Timeline view (Calendar + Agenda) — fresh interaction model
   - Month heatmap (due-volume) + Day agenda drilldown
   - Uses existing task data (Firestore subscription from Part 2/8)
   ========================= */

(() => {
  'use strict';

  const { state, ymdToDmy, todayYmdIST, diffDaysIST, toast } = window.__cos;
  const mount = document.getElementById('viewMount');

  const el = (tag, attrs = {}, children = []) => {
    const n = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs || {})) {
      if (k === 'class') n.className = v;
      else if (k === 'text') n.textContent = v;
      else if (k === 'html') n.innerHTML = v;
      else if (k === 'style') n.setAttribute('style', String(v));
      else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
      else if (v === false || v === null || v === undefined) continue;
      else n.setAttribute(k, String(v));
    }
    for (const c of (children || [])) n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
    return n;
  };

  function card(title, subtitle, rightNode, bodyNode) {
    return el('div', { class: 'card' }, [
      el('div', { class: 'cardHead' }, [
        el('div', {}, [el('h2', { text: title }), el('p', { text: subtitle || '' })]),
        rightNode || el('div')
      ]),
      el('div', { class: 'cardBody' }, [bodyNode || el('div')])
    ]);
  }

  function pill(text, tone) {
    const colors = {
      ok: 'border-color: rgba(34,197,94,.38); background: rgba(34,197,94,.12);',
      warn: 'border-color: rgba(245,158,11,.42); background: rgba(245,158,11,.14);',
      bad: 'border-color: rgba(239,68,68,.42); background: rgba(239,68,68,.14);',
      info:'border-color: rgba(34,211,238,.42); background: rgba(34,211,238,.12);',
      dim: 'border-color: var(--stroke2); background: rgba(255,255,255,.05); color: var(--muted);'
    };
    return el('span', { class: 'chip', style: `padding:6px 10px; font-size:12px; ${colors[tone||'dim']||colors.dim}` }, [text]);
  }

  /* ---------- Calendar state ---------- */
  const calState = {
    cursor: (() => { const d = new Date(); d.setDate(1); d.setHours(12,0,0,0); return d; })(),
    selectedYmd: todayYmdIST(),
    view: 'MONTH', // MONTH | DAY | AGENDA
    showCompleted: false,
    hideSnoozed: true
  };

  function ymdFromDateIST(date) {
    const parts = new Intl.DateTimeFormat('en-CA', {
      timeZone: 'Asia/Kolkata',
      year: 'numeric', month: '2-digit', day: '2-digit'
    }).formatToParts(date);
    const m = Object.fromEntries(parts.map(p => [p.type, p.value]));
    return `${m.year}-${m.month}-${m.day}`;
  }

  function monthLabel(d) {
    return d.toLocaleString(undefined, { month: 'long', year: 'numeric' });
  }

  function tasksVisibleForTimeline() {
    const tdy = todayYmdIST();
    return (state.tasks || []).filter(t => {
      if (!t.dueDateYmd) return false;
      if (!calState.showCompleted && t.status === 'COMPLETED') return false;
      const snoozedNow = (t.snoozedUntilYmd && t.snoozedUntilYmd > tdy && t.status !== 'COMPLETED');
      if (calState.hideSnoozed && snoozedNow) return false;
      return true;
    });
  }

  function dueMap() {
    const map = new Map();
    for (const t of tasksVisibleForTimeline()) {
      if (!map.has(t.dueDateYmd)) map.set(t.dueDateYmd, []);
      map.get(t.dueDateYmd).push(t);
    }
    return map;
  }

  function intensity(count) {
    if (count <= 0) return 0;
    if (count === 1) return 1;
    if (count <= 3) return 2;
    if (count <= 6) return 3;
    return 4;
  }

  function urgencyTone(t) {
    const tdy = todayYmdIST();
    if (t.status === 'COMPLETED') return 'ok';
    const dd = diffDaysIST(tdy, t.dueDateYmd);
    if (dd < 0) return 'bad';
    if (dd === 0) return 'bad';
    if (dd <= 3) return 'warn';
    return 'info';
  }

  function mountMonthHeatmap() {
    const map = dueMap();
    const tdy = todayYmdIST();

    const head = el('div', { class: 'row', style: 'justify-content:space-between; align-items:center; flex-wrap:wrap' }, [
      el('div', { class: 'row' }, [
        el('button', { class: 'btn btnSmall btnGhost', type: 'button', text: 'Prev', onclick: () => { calState.cursor.setMonth(calState.cursor.getMonth() - 1); render(); } }),
        el('button', { class: 'btn btnSmall btnGhost', type: 'button', text: 'Today', onclick: () => { const d = new Date(); d.setDate(1); d.setHours(12,0,0,0); calState.cursor = d; calState.selectedYmd = todayYmdIST(); calState.view = 'DAY'; render(); } }),
        el('button', { class: 'btn btnSmall btnGhost', type: 'button', text: 'Next', onclick: () => { calState.cursor.setMonth(calState.cursor.getMonth() + 1); render(); } }),
        pill(monthLabel(calState.cursor), 'dim'),
      ]),
      el('div', { class: 'row' }, [
        el('label', { class: 'chip', style: 'gap:10px' }, [
          el('input', {
            type: 'checkbox',
            style: 'width:18px;height:18px',
            checked: calState.showCompleted,
            onchange: (e) => { calState.showCompleted = !!e.target.checked; render(); }
          }),
          el('span', { text: 'Show completed' })
        ]),
        el('label', { class: 'chip', style: 'gap:10px' }, [
          el('input', {
            type: 'checkbox',
            style: 'width:18px;height:18px',
            checked: calState.hideSnoozed,
            onchange: (e) => { calState.hideSnoozed = !!e.target.checked; render(); }
          }),
          el('span', { text: 'Hide snoozed' })
        ]),
        el('button', { class: 'btn btnSmall btnPrimary', type: 'button', text: 'Agenda', onclick: () => { calState.view = 'AGENDA'; render(); } })
      ])
    ]);

    const grid = el('div', {
      style: `
        margin-top: 14px;
        display:grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
      `
    });

    const dow = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    dow.forEach(d => grid.appendChild(el('div', { class: 'label', style: 'text-align:center; padding: 6px 0', text: d })));

    const first = new Date(calState.cursor);
    const month = first.getMonth();
    const firstDow = (first.getDay() + 6) % 7; // Mon=0
    const start = new Date(first);
    start.setDate(first.getDate() - firstDow);

    for (let i = 0; i < 42; i++) {
      const d = new Date(start);
      d.setDate(start.getDate() + i);
      const y = ymdFromDateIST(d);
      const list = map.get(y) || [];
      const i4 = intensity(list.length);
      const isToday = (y === tdy);
      const muted = (d.getMonth() !== month);

      // Determine if any overdue/due soon exists for color accent
      const hasBad = list.some(t => urgencyTone(t) === 'bad');
      const hasWarn = list.some(t => urgencyTone(t) === 'warn');

      const bg = i4 === 0 ? 'rgba(255,255,255,.03)' :
        i4 === 1 ? 'rgba(96,165,250,.14)' :
        i4 === 2 ? 'rgba(34,211,238,.16)' :
        i4 === 3 ? 'rgba(124,58,237,.18)' :
        'rgba(124,58,237,.26)';

      const border = hasBad ? 'rgba(239,68,68,.55)' : hasWarn ? 'rgba(245,158,11,.55)' : 'var(--stroke2)';
      const shadow = isToday ? 'box-shadow: var(--focus2);' : '';

      const cell = el('button', {
        class: 'btn btnGhost',
        type: 'button',
        style: `
          width:100%;
          min-height: 92px;
          border-radius: 20px;
          padding: 10px;
          justify-content:flex-start;
          align-items:flex-start;
          text-align:left;
          background: ${bg};
          border-color: ${border};
          opacity: ${muted ? 0.55 : 1};
          ${shadow}
        `,
        onclick: () => {
          calState.selectedYmd = y;
          calState.view = 'DAY';
          render();
        }
      }, [
        el('div', { style: 'display:flex; flex-direction:column; gap:8px; width:100%' }, [
          el('div', { style: 'display:flex; justify-content:space-between; align-items:center; gap:10px' }, [
            el('div', { style: 'font-weight:900' }, [String(d.getDate())]),
            list.length ? pill(String(list.length), 'dim') : el('div')
          ]),
          list.length ? el('div', { class: 'help', text: hasBad ? 'Overdue items' : hasWarn ? 'Due soon' : 'Due items' }) : el('div', { class: 'help', text: '—' })
        ])
      ]);

      grid.appendChild(cell);
    }

    const legend = el('div', { class: 'row', style: 'margin-top: 12px; justify-content:space-between; flex-wrap:wrap' }, [
      el('div', { class: 'row' }, [
        pill('Border: overdue', 'bad'),
        pill('Border: due soon', 'warn'),
        pill('Background: volume', 'info')
      ]),
      el('div', { class: 'help', text: 'Tap a day to see its agenda. Heatmap is based on due dates.' })
    ]);

    return el('div', {}, [head, grid, legend]);
  }

  function mountDayAgenda() {
    const map = dueMap();
    const list = (map.get(calState.selectedYmd) || []).slice();

    // Sort by urgency then client
    const tdy = todayYmdIST();
    list.sort((a, b) => {
      const da = diffDaysIST(tdy, a.dueDateYmd);
      const db = diffDaysIST(tdy, b.dueDateYmd);
      if (da !== db) return da - db;
      const ca = state.clientsById?.get(a.clientId)?.name || '';
      const cb = state.clientsById?.get(b.clientId)?.name || '';
      return ca.localeCompare(cb);
    });

    const top = el('div', { class: 'row', style: 'justify-content:space-between; align-items:center; flex-wrap:wrap' }, [
      el('div', { class: 'row' }, [
        el('button', { class: 'btn btnSmall btnGhost', type: 'button', text: 'Back', onclick: () => { calState.view = 'MONTH'; render(); } }),
        pill(`Day: ${ymdToDmy(calState.selectedYmd)}`, 'dim'),
        pill(`${list.length} tasks`, 'info')
      ]),
      el('div', { class: 'row' }, [
        el('button', { class: 'btn btnSmall btnPrimary', type: 'button', text: 'Open Work Queue', onclick: () => window.__cos_mountView('work') })
      ])
    ]);

    const wrap = el('div', { style: 'margin-top:14px; display:flex; flex-direction:column; gap: 12px' });

    if (!list.length) {
      wrap.appendChild(el('div', { class: 'help', text: 'No tasks due on this date (based on current filters for completed/snoozed).' }));
      return el('div', {}, [top, wrap]);
    }

    for (const t of list) {
      const clientName = state.clientsById?.get(t.clientId)?.name || '';
      const tone = urgencyTone(t);

      const row = el('button', {
        class: 'btn btnGhost',
        type: 'button',
        style: `
          width:100%;
          border-radius: 22px;
          padding: 12px 12px;
          justify-content:flex-start;
          align-items:flex-start;
          gap: 12px;
        `,
        onclick: () => window.__cos_openTask(t.id)
      }, [
        pill(t.status === 'COMPLETED' ? 'Done' : (tone === 'bad' ? 'Urgent' : tone === 'warn' ? 'Soon' : 'Planned'), tone),
        el('div', { style: 'min-width:0; flex:1; display:flex; flex-direction:column; gap:6px' }, [
          el('div', { style: 'font-weight:900; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis' }, [t.title || '(task)']),
          el('div', { class: 'help', text: `${clientName}${t.assignedToEmail ? ` · ${t.assignedToEmail}` : ''}${t.priority ? ` · ${String(t.priority).toUpperCase()}` : ''}` })
        ]),
        pill(ymdToDmy(t.dueDateYmd), 'dim')
      ]);

      wrap.appendChild(row);
    }

    return el('div', {}, [top, wrap]);
  }

  function mountAgenda() {
    const tasks = tasksVisibleForTimeline().slice();
    const tdy = todayYmdIST();
    tasks.sort((a, b) => String(a.dueDateYmd || '').localeCompare(String(b.dueDateYmd || '')));

    const top = el('div', { class: 'row', style: 'justify-content:space-between; align-items:center; flex-wrap:wrap' }, [
      el('div', { class: 'row' }, [
        el('button', { class: 'btn btnSmall btnGhost', type: 'button', text: 'Back to month', onclick: () => { calState.view = 'MONTH'; render(); } }),
        pill('Agenda', 'dim'),
        pill(`${tasks.length} tasks`, 'info')
      ]),
      el('div', { class: 'row' }, [
        el('button', { class: 'btn btnSmall btnPrimary', type: 'button', text: 'Work Queue', onclick: () => window.__cos_mountView('work') })
      ])
    ]);

    const wrap = el('div', { style: 'margin-top:14px; display:flex; flex-direction:column; gap: 10px' });

    if (!tasks.length) {
      wrap.appendChild(el('div', { class: 'help', text: 'No tasks to display.' }));
      return el('div', {}, [top, wrap]);
    }

    let last = '';
    for (const t of tasks.slice(0, 220)) {
      const due = t.dueDateYmd || '';
      if (due && due !== last) {
        last = due;
        wrap.appendChild(el('div', { class: 'label', style: 'margin-top: 10px' }, [ymdToDmy(due)]));
      }

      const clientName = state.clientsById?.get(t.clientId)?.name || '';
      const dd = diffDaysIST(tdy, t.dueDateYmd);
      const tone = t.status === 'COMPLETED' ? 'ok' : dd < 0 ? 'bad' : dd <= 3 ? 'warn' : 'info';

      wrap.appendChild(el('button', {
        class: 'btn btnGhost',
        type: 'button',
        style: `
          width:100%;
          border-radius: 18px;
          padding: 10px 12px;
          justify-content:flex-start;
          align-items:flex-start;
          gap: 12px;
        `,
        onclick: () => window.__cos_openTask(t.id)
      }, [
        pill(t.status || '—', tone),
        el('div', { style: 'min-width:0; flex:1; display:flex; flex-direction:column; gap:6px' }, [
          el('div', { style: 'font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis' }, [t.title || '(task)']),
          el('div', { class: 'help', text: `${clientName}${t.assignedToEmail ? ` · ${t.assignedToEmail}` : ''}` })
        ]),
        el('span', { class: 'chip', text: String(t.priority || 'MEDIUM').toUpperCase() })
      ]));
    }

    if (tasks.length > 220) {
      wrap.appendChild(el('div', { class: 'help', text: 'Agenda is limited to 220 rows for speed. Use Work Queue filters for deep review.' }));
    }

    return el('div', {}, [top, wrap]);
  }

  function render() {
    if (!state.uid) return;

    const viewNode =
      (calState.view === 'MONTH') ? mountMonthHeatmap()
      : (calState.view === 'DAY') ? mountDayAgenda()
      : mountAgenda();

    const right = el('div', { class: 'row' }, [
      pill(state.isPartner ? 'Partner timeline' : state.isManager ? 'Manager timeline' : 'My timeline', 'info')
    ]);

    const root = el('div', { class: 'gridMax' }, [
      card('Timeline', 'A new calendar experience: month heatmap + day agenda. Drill down by tapping a day.', right, viewNode)
    ]);

    mount.appendChild(root);
  }

  window.__cos_mountCalendar = () => render();

  // If current view is calendar, render now.
  if (state.uid && state.activeView === 'calendar') render();

})();
</script>

<script>
/* =========================
   ComplianceOS — Part 5/8
   Clients workspace (PARTNER only)
   - Client list + instant editor panel (no old UI patterns)
   - Client create
   - Client history exports: XLSX + PDF (backend endpoints)
   ========================= */

(() => {
  'use strict';

  const { state, apiJson, downloadBase64, ymdToDmy, dmyToYmd, toast } = window.__cos;
  const mount = document.getElementById('viewMount');

  const el = (tag, attrs = {}, children = []) => {
    const n = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs || {})) {
      if (k === 'class') n.className = v;
      else if (k === 'text') n.textContent = v;
      else if (k === 'html') n.innerHTML = v;
      else if (k === 'style') n.setAttribute('style', String(v));
      else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
      else if (v === false || v === null || v === undefined) continue;
      else n.setAttribute(k, String(v));
    }
    for (const c of (children || [])) n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
    return n;
  };

  function card(title, subtitle, rightNode, bodyNode) {
    return el('div', { class: 'card' }, [
      el('div', { class: 'cardHead' }, [
        el('div', {}, [el('h2', { text: title }), el('p', { text: subtitle || '' })]),
        rightNode || el('div')
      ]),
      el('div', { class: 'cardBody' }, [bodyNode || el('div')])
    ]);
  }

  function pill(text, tone) {
    const colors = {
      ok: 'border-color: rgba(34,197,94,.38); background: rgba(34,197,94,.12);',
      warn: 'border-color: rgba(245,158,11,.42); background: rgba(245,158,11,.14);',
      bad: 'border-color: rgba(239,68,68,.42); background: rgba(239,68,68,.14);',
      info:'border-color: rgba(34,211,238,.42); background: rgba(34,211,238,.12);',
      dim: 'border-color: var(--stroke2); background: rgba(255,255,255,.05); color: var(--muted);'
    };
    return el('span', { class: 'chip', style: `padding:6px 10px; font-size:12px; ${colors[tone||'dim']||colors.dim}` }, [text]);
  }

  function asEmailList(str) {
    return String(str || '')
      .split(/[;,:]/)
      .map(s => s.trim())
      .filter(Boolean);
  }

  function joinEmails(arr) {
    return Array.isArray(arr) ? arr.filter(Boolean).join('; ') : '';
  }

  const clientsState = {
    q: '',
    selectedId: null,
    rangeFrom: (() => {
      const d = new Date();
      d.setMonth(d.getMonth() - 1);
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = d.getFullYear();
      return `${dd}-${mm}-${yyyy}`;
    })(),
    rangeTo: (() => {
      const d = new Date();
      d.setMonth(d.getMonth() + 2);
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = d.getFullYear();
      return `${dd}-${mm}-${yyyy}`;
    })()
  };

  function mountLocked() {
    mount.innerHTML = '';
    mount.appendChild(el('div', { class: 'gridMax' }, [
      card('Clients', 'This area is available to PARTNER role only.', pill(state.role, 'info'), el('div', { class: 'help', html: `
        <div>Your current role is <b>${state.role}</b>.</div>
        <div style="margin-top:8px">If you should have access, ask a partner to update your role in Team settings (Ops area).</div>
      ` }))
    ]));
  }

  function clientById(id) {
    return (state.clients || []).find(c => c.id === id) || null;
  }

  function filteredClients() {
    const q = String(clientsState.q || '').trim().toLowerCase();
    const list = (state.clients || []).slice();
    if (!q) return list;
    return list.filter(c => {
      const hay = `${c.name || ''} ${c.primaryEmail || ''} ${c.pan || ''} ${c.gstin || ''}`.toLowerCase();
      return hay.includes(q);
    });
  }

  function clientListPane() {
    const q = el('input', { class: 'input', value: clientsState.q, placeholder: 'Search clients… (name, email, PAN, GSTIN)' });
    q.addEventListener('input', () => { clientsState.q = q.value; render(); });

    const list = el('div', { style: 'display:flex; flex-direction:column; gap: 10px; margin-top: 12px' });

    const rows = filteredClients().sort((a, b) => String(a.name || '').localeCompare(String(b.name || '')));
    if (!rows.length) {
      list.appendChild(el('div', { class: 'help', text: 'No clients found.' }));
    } else {
      for (const c of rows.slice(0, 250)) {
        const active = (clientsState.selectedId === c.id);
        const row = el('button', {
          class: 'btn btnGhost',
          type: 'button',
          style: `
            width:100%;
            border-radius: 22px;
            padding: 12px 12px;
            justify-content:flex-start;
            align-items:flex-start;
            gap: 12px;
            background: ${active ? 'rgba(34,211,238,.10)' : 'transparent'};
            border-color: ${active ? 'rgba(34,211,238,.45)' : 'var(--stroke2)'};
          `,
          onclick: () => {
            clientsState.selectedId = c.id;
            render();
          }
        }, [
          pill(active ? 'Selected' : 'Client', active ? 'info' : 'dim'),
          el('div', { style: 'min-width:0; flex:1; display:flex; flex-direction:column; gap:6px' }, [
            el('div', { style: 'font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis' }, [c.name || '(no name)']),
            el('div', { class: 'help', text: `${c.primaryEmail || '—'}${c.pan ? ` · PAN ${c.pan}` : ''}${c.gstin ? ` · GSTIN ${c.gstin}` : ''}` })
          ])
        ]);

        list.appendChild(row);
      }
      if (rows.length > 250) list.appendChild(el('div', { class: 'help', text: 'List limited to 250 for speed. Refine search to find a client.' }));
    }

    return el('div', {}, [
      el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Search' }), q]),
      list
    ]);
  }

  function clientCreatePane() {
    const f = (label, id, placeholder = '') => el('div', { class: 'field' }, [
      el('div', { class: 'label', text: label }),
      el('input', { class: 'input', id, placeholder })
    ]);

    const cc = el('input', { class: 'input', id: 'newCC', placeholder: 'cc1@x.com; cc2@y.com' });
    const bcc = el('input', { class: 'input', id: 'newBCC', placeholder: 'bcc1@x.com; bcc2@y.com' });

    const grid = el('div', {
      style: 'display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px;'
    }, [
      el('div', { style: 'grid-column: span 12' }, [f('Client name', 'newName', 'Example: ABC Pvt Ltd')]),
      el('div', { style: 'grid-column: span 6' }, [f('PAN', 'newPAN')]),
      el('div', { style: 'grid-column: span 6' }, [f('GSTIN', 'newGSTIN')]),
      el('div', { style: 'grid-column: span 6' }, [f('CIN', 'newCIN')]),
      el('div', { style: 'grid-column: span 6' }, [f('Assessment year (AY)', 'newAY', 'Example: 2025-26')]),
      el('div', { style: 'grid-column: span 12' }, [f('Engagement type', 'newEng', 'Example: GST + TDS')]),
      el('div', { style: 'grid-column: span 12' }, [f('Primary email', 'newEmail', 'client@example.com')]),
      el('div', { style: 'grid-column: span 6' }, [
        el('div', { class: 'field' }, [el('div', { class: 'label', text: 'CC emails' }), cc])
      ]),
      el('div', { style: 'grid-column: span 6' }, [
        el('div', { class: 'field' }, [el('div', { class: 'label', text: 'BCC emails' }), bcc])
      ]),
      el('div', { style: 'grid-column: span 12' }, [
        el('button', {
          class: 'btn btnPrimary',
          type: 'button',
          text: 'Create client',
          onclick: async () => {
            const payload = {
              name: String(document.getElementById('newName').value || '').trim(),
              pan: String(document.getElementById('newPAN').value || '').trim(),
              gstin: String(document.getElementById('newGSTIN').value || '').trim(),
              cin: String(document.getElementById('newCIN').value || '').trim(),
              assessmentYear: String(document.getElementById('newAY').value || '').trim(),
              engagementType: String(document.getElementById('newEng').value || '').trim(),
              primaryEmail: String(document.getElementById('newEmail').value || '').trim(),
              ccEmails: asEmailList(cc.value),
              bccEmails: asEmailList(bcc.value)
            };
            if (!payload.name) return toast('Client name is required', 3600);

            const r = await apiJson('/clients_create', payload);
            if (!r.ok) return toast(`Create failed: ${r.error || JSON.stringify(r)}`, 9000);

            toast('Client created');
            clientsState.selectedId = r.clientId || null;
          }
        }),
        el('div', { class: 'help', style: 'margin-top:10px', text: 'Tip: Keep client names stable to reduce accidental duplicate imports.' })
      ])
    ]);

    const style = el('style', { html: `
      @media (max-width: 980px){
        .cosClientCreateGrid{ grid-template-columns: 1fr !important; }
        .cosClientCreateGrid > div{ grid-column: span 12 !important; }
      }
    `});
    grid.classList.add('cosClientCreateGrid');

    return el('div', {}, [style, grid]);
  }

  function clientEditorPane(client) {
    if (!client) {
      return el('div', { class: 'help', html: `
        <div style="font-weight:900;color:var(--text)">No client selected</div>
        <div style="margin-top:8px">Choose a client from the list to view and edit details.</div>
      `});
    }

    const name = el('input', { class: 'input', value: client.name || '' });
    const pan = el('input', { class: 'input', value: client.pan || '' });
    const gstin = el('input', { class: 'input', value: client.gstin || '' });
    const cin = el('input', { class: 'input', value: client.cin || '' });
    const ay = el('input', { class: 'input', value: client.assessmentYear || '' });
    const eng = el('input', { class: 'input', value: client.engagementType || '' });

    const email = el('input', { class: 'input', value: client.primaryEmail || '' });
    const cc = el('input', { class: 'input', value: joinEmails(client.ccEmails), placeholder: 'a@x.com; b@y.com' });
    const bcc = el('input', { class: 'input', value: joinEmails(client.bccEmails), placeholder: 'a@x.com; b@y.com' });

    // History export range
    const from = el('input', { class: 'input', value: clientsState.rangeFrom, placeholder: 'DD-MM-YYYY' });
    const to = el('input', { class: 'input', value: clientsState.rangeTo, placeholder: 'DD-MM-YYYY' });

    from.addEventListener('input', () => { clientsState.rangeFrom = from.value; });
    to.addEventListener('input', () => { clientsState.rangeTo = to.value; });

    const saveBtn = el('button', {
      class: 'btn btnPrimary',
      type: 'button',
      text: 'Save client',
      onclick: async () => {
        const payload = {
          clientId: client.id,
          name: String(name.value || '').trim(),
          pan: String(pan.value || '').trim(),
          gstin: String(gstin.value || '').trim(),
          cin: String(cin.value || '').trim(),
          assessmentYear: String(ay.value || '').trim(),
          engagementType: String(eng.value || '').trim(),
          primaryEmail: String(email.value || '').trim(),
          ccEmails: asEmailList(cc.value),
          bccEmails: asEmailList(bcc.value)
        };
        if (!payload.name) return toast('Name is required', 3600);

        const r = await apiJson('/clients_update', payload);
        if (!r.ok) return toast(`Save failed: ${r.error || JSON.stringify(r)}`, 9000);
        toast('Client saved');
      }
    });

    async function runClientHistoryXlsx() {
      let fromY, toY;
      try { fromY = dmyToYmd(String(from.value || '').trim()); } catch (e) { return toast(e.message, 6000); }
      try { toY = dmyToYmd(String(to.value || '').trim()); } catch (e) { return toast(e.message, 6000); }

      const r = await apiJson('/exports_clientHistoryXlsx', {
        clientId: client.id,
        fromYmd: fromY,
        toYmd: toY
      });
      if (!r.ok) return toast(`Export failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({ fileName: r.fileName, base64: r.base64, mime: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      toast('XLSX downloaded');
    }

    async function runClientHistoryPdf() {
      let fromY, toY;
      try { fromY = dmyToYmd(String(from.value || '').trim()); } catch (e) { return toast(e.message, 6000); }
      try { toY = dmyToYmd(String(to.value || '').trim()); } catch (e) { return toast(e.message, 6000); }

      const r = await apiJson('/reports_clientHistoryPdf', {
        clientId: client.id,
        fromYmd: fromY,
        toYmd: toY
      });
      if (!r.ok) return toast(`PDF failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({ fileName: r.fileName, base64: r.base64, mime: r.mime || 'application/pdf' });
      toast('PDF downloaded');
    }

    const grid = el('div', { style: 'display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px;' }, [
      el('div', { style: 'grid-column: span 12' }, [
        el('div', { class: 'row', style: 'justify-content:space-between; align-items:center' }, [
          el('div', { style: 'display:flex; flex-direction:column; gap:6px' }, [
            el('div', { style: 'font-weight:900; letter-spacing:.2px' }, [client.name || '(client)']),
            el('div', { class: 'help', text: `Client ID is hidden in UI. Saved internally.` })
          ]),
          pill('Master profile', 'info')
        ])
      ]),

      el('div', { style: 'grid-column: span 12' }, [el('div', { class: 'label', text: 'Client name' }), name]),
      el('div', { style: 'grid-column: span 6' }, [el('div', { class: 'label', text: 'PAN' }), pan]),
      el('div', { style: 'grid-column: span 6' }, [el('div', { class: 'label', text: 'GSTIN' }), gstin]),
      el('div', { style: 'grid-column: span 6' }, [el('div', { class: 'label', text: 'CIN' }), cin]),
      el('div', { style: 'grid-column: span 6' }, [el('div', { class: 'label', text: 'Assessment year (AY)' }), ay]),
      el('div', { style: 'grid-column: span 12' }, [el('div', { class: 'label', text: 'Engagement type' }), eng]),

      el('div', { style: 'grid-column: span 12' }, [el('div', { class: 'label', text: 'Primary email' }), email]),
      el('div', { style: 'grid-column: span 6' }, [el('div', { class: 'label', text: 'CC emails' }), cc]),
      el('div', { style: 'grid-column: span 6' }, [el('div', { class: 'label', text: 'BCC emails' }), bcc]),

      el('div', { style: 'grid-column: span 12' }, [
        el('div', { class: 'row', style: 'justify-content:flex-end' }, [saveBtn])
      ]),

      el('div', { style: 'grid-column: span 12' }, [
        el('div', { class: 'card', style: 'border-radius:22px' }, [
          el('div', { class: 'cardHead' }, [
            el('div', {}, [
              el('h2', { text: 'Client history' }),
              el('p', { text: 'Download all tasks for this client with full fields. XLSX & PDF are both available.' })
            ]),
            pill('Exports', 'dim')
          ]),
          el('div', { class: 'cardBody' }, [
            el('div', { class: 'row' }, [
              el('div', { class: 'field' }, [el('div', { class: 'label', text: 'From' }), from]),
              el('div', { class: 'field' }, [el('div', { class: 'label', text: 'To' }), to])
            ]),
            el('div', { class: 'row', style: 'margin-top:12px; justify-content:flex-end' }, [
              el('button', { class: 'btn', type: 'button', text: 'Download XLSX', onclick: runClientHistoryXlsx }),
              el('button', { class: 'btn btnPrimary', type: 'button', text: 'Download PDF', onclick: runClientHistoryPdf })
            ]),
            el('div', { class: 'help', style: 'margin-top:10px', html: `
              Tip: History exports include mail flags, recipient overrides, thread IDs, completion settings, attachment links, and timestamps.
            ` })
          ])
        ])
      ])
    ]);

    const style = el('style', { html: `
      @media (max-width: 980px){
        .cosClientEditorGrid{ grid-template-columns: 1fr !important; }
        .cosClientEditorGrid > div{ grid-column: span 12 !important; }
      }
    `});
    grid.classList.add('cosClientEditorGrid');

    return el('div', {}, [style, grid]);
  }

  function render() {
    mount.innerHTML = '';

    if (!state.uid) return;
    if (!state.isPartner) return mountLocked();

    const left = clientListPane();

    const selected = clientById(clientsState.selectedId) || null;
    const right = el('div', { style: 'display:flex; flex-direction:column; gap:14px' }, [
      card('Create', 'Add a new client profile (partner-only).', pill('Partner', 'info'), clientCreatePane()),
      card('Edit', 'Edit full client profile. Saved fields are used as defaults for tasks unless overridden.', null, clientEditorPane(selected))
    ]);

    // 2-column layout using fresh split canvas
    const split = el('div', {
      style: `
        display:grid;
        grid-template-columns: minmax(320px, 1fr) minmax(520px, 1.6fr);
        gap: 14px;
        align-items:start;
      `
    }, [
      card('Clients', 'Search and select a client to edit. Client IDs are intentionally hidden in the UI.', pill(`${(state.clients || []).length}`, 'dim'), left),
      el('div', {}, [right])
    ]);

    const style = el('style', { html: `
      @media (max-width: 980px){
        .cosClientSplit{ grid-template-columns: 1fr !important; }
      }
    `});
    split.classList.add('cosClientSplit');

    mount.appendChild(el('div', { class: 'gridMax' }, [style, split]));
  }

  window.__cos_mountClients = render;

  // Allow command palette to open a client
  window.__cos_openClient = (clientId) => {
    clientsState.selectedId = clientId;
    render();
  };

  // If current view is clients, render now
  if (state.uid && state.activeView === 'clients') render();

})();
</script>

<script>
/* =========================
   ComplianceOS — Part 6/8
   Task Inspector (modern modal) + Create Task (same inspector in create-mode)
   - Status updates (tasks_updatestatus) with completion reply-all behaviour handled by backend
   - Attachments upload to Drive (tasks_uploadattachment)
   - Comments (tasks_addcomment) with @mentions + notifications
   - Edit task details (tasks_updatetask) for PARTNER/MANAGER
   - Delete task/series (tasks_delete)
   - Series tools (series_rebuild, series_reassign)
   - Task history exports: XLSX + PDF (exports_taskHistoryXlsx, reports_taskHistoryPdf)
   ========================= */

(() => {
  'use strict';

  const {
    state,
    apiJson,
    apiForm,
    downloadBase64,
    ymdToDmy,
    dmyToYmd,
    todayYmdIST,
    toast
  } = window.__cos;

  const overlay = document.getElementById('overlay');

  const el = (tag, attrs = {}, children = []) => {
    const n = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs || {})) {
      if (k === 'class') n.className = v;
      else if (k === 'text') n.textContent = v;
      else if (k === 'html') n.innerHTML = v;
      else if (k === 'style') n.setAttribute('style', String(v));
      else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
      else if (v === false || v === null || v === undefined) continue;
      else n.setAttribute(k, String(v));
    }
    for (const c of (children || [])) n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
    return n;
  };

  function chip(text, tone) {
    const colors = {
      ok: 'border-color: rgba(34,197,94,.38); background: rgba(34,197,94,.12);',
      warn: 'border-color: rgba(245,158,11,.42); background: rgba(245,158,11,.14);',
      bad: 'border-color: rgba(239,68,68,.42); background: rgba(239,68,68,.14);',
      info:'border-color: rgba(34,211,238,.42); background: rgba(34,211,238,.12);',
      dim: 'border-color: var(--stroke2); background: rgba(255,255,255,.05); color: var(--muted);'
    };
    return el('span', { class: 'chip', style: `padding:6px 10px; font-size:12px; ${colors[tone||'dim']||colors.dim}` }, [text]);
  }

  function asEmailList(str) {
    return String(str || '')
      .split(/[;,:]/)
      .map(s => s.trim())
      .filter(Boolean);
  }

  function joinEmails(arr) {
    return Array.isArray(arr) ? arr.filter(Boolean).join('; ') : '';
  }

  function roleCanEditDetails() {
    return state.isPartner || state.isManager;
  }

  function statusOptionsForRole() {
    const base = ['PENDING', 'IN_PROGRESS', 'CLIENT_PENDING', 'APPROVAL_PENDING'];
    if (roleCanEditDetails()) base.push('COMPLETED');
    return base;
  }

  function taskById(id) {
    return (state.tasks || []).find(t => t.id === id) || null;
  }

  function clientName(task) {
    const c = state.clientsById?.get(task.clientId);
    return c?.name || '';
  }

  /* ---------- Inspector modal (custom, not reusing cmd/auth dialogs) ---------- */
  const inspector = {
    root: el('div', {
      style: `
        position: fixed;
        inset: 0;
        z-index: 70;
        display:none;
        padding: 22px;
      `
    }),
    panel: null,
    mode: 'view', // view | create
    taskId: null
  };

  inspector.panel = el('div', {
    class: 'card',
    style: `
      width: min(1100px, 96vw);
      max-height: min(88vh, 980px);
      margin: 0 auto;
      overflow:hidden;
      border-radius: 28px;
      display:flex;
      flex-direction:column;
      box-shadow: var(--shadow);
      background: color-mix(in srgb, var(--card) 92%, rgba(0,0,0,.20));
    `
  });

  const head = el('div', { class: 'cardHead' });
  const headLeft = el('div', { style: 'display:flex; flex-direction:column; gap:6px; min-width:0' });
  const headTitle = el('h2', { text: 'Task' });
  const headSub = el('p', { text: '' });
  headLeft.appendChild(headTitle);
  headLeft.appendChild(headSub);

  const headRight = el('div', { class: 'row', style: 'justify-content:flex-end' });
  const btnClose = el('button', { class: 'btn btnSmall btnGhost', type: 'button', text: 'Close' });
  const btnFullscreen = el('button', { class: 'btn btnSmall', type: 'button', text: 'Expand' });
  headRight.appendChild(btnFullscreen);
  headRight.appendChild(btnClose);

  head.appendChild(headLeft);
  head.appendChild(headRight);

  const body = el('div', {
    class: 'cardBody',
    style: `
      overflow:auto;
      padding: 18px;
      display:grid;
      grid-template-columns: minmax(340px, 1fr) minmax(340px, 1fr);
      gap: 14px;
      align-items:start;
    `
  });

  const foot = el('div', {
    style: `
      border-top: 1px solid var(--stroke2);
      padding: 12px 18px;
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
    `
  });

  const footLeft = el('div', { class: 'row' });
  const footRight = el('div', { class: 'row', style: 'justify-content:flex-end' });
  foot.appendChild(footLeft);
  foot.appendChild(footRight);

  inspector.panel.appendChild(head);
  inspector.panel.appendChild(body);
  inspector.panel.appendChild(foot);
  inspector.root.appendChild(inspector.panel);
  document.body.appendChild(inspector.root);

  let fullscreen = false;
  function setFullscreen(on) {
    fullscreen = !!on;
    inspector.panel.style.width = fullscreen ? 'min(1400px, 99vw)' : 'min(1100px, 96vw)';
    inspector.panel.style.maxHeight = fullscreen ? '96vh' : 'min(88vh, 980px)';
    btnFullscreen.textContent = fullscreen ? 'Shrink' : 'Expand';
  }

  function showInspector() {
    inspector.root.style.display = 'block';
    overlay?.classList.add('show');
    // focus first button for accessibility
    setTimeout(() => btnClose.focus(), 0);
  }
  function hideInspector() {
    inspector.root.style.display = 'none';
    overlay?.classList.remove('show');
    inspector.taskId = null;
    inspector.mode = 'view';
    setFullscreen(false);
  }

  btnClose.addEventListener('click', hideInspector);
  btnFullscreen.addEventListener('click', () => setFullscreen(!fullscreen));

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (inspector.root.style.display === 'block') hideInspector();
    }
  });

  // overlay click should close inspector only if no other dialogs open
  overlay?.addEventListener('click', () => {
    if (inspector.root.style.display === 'block') hideInspector();
  });

  /* ---------- Firestore live reads for comments and timeline ---------- */
  let unsubComments = null;
  let unsubTimeline = null;

  function clearLive() {
    try { unsubComments?.(); } catch {}
    try { unsubTimeline?.(); } catch {}
    unsubComments = null;
    unsubTimeline = null;
  }

  function mountComments(taskId, host) {
    host.innerHTML = '';
    const list = el('div', { style: 'display:flex; flex-direction:column; gap: 10px; margin-top: 10px' });
    const input = el('textarea', { class: 'textarea', placeholder: 'Write a comment… Use @email or @Display Name to mention.', style: 'min-height: 90px' });
    const btn = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Add comment' });

    btn.onclick = async () => {
      const text = String(input.value || '').trim();
      if (!text) return toast('Write a comment first', 3200);

      const r = await apiJson('/tasks_addcomment', { taskId, text });
      if (!r.ok) return toast(`Comment failed: ${r.error || JSON.stringify(r)}`, 9000);

      input.value = '';
      toast(r.notificationsCreated ? `Comment added · mentions notified: ${r.notificationsCreated}` : 'Comment added');
    };

    host.appendChild(el('div', { class: 'row', style: 'justify-content:space-between; align-items:center' }, [
      el('div', { style: 'font-weight:900' }, ['Comments']),
      chip('Team thread', 'info')
    ]));
    host.appendChild(el('div', { class: 'help', text: 'Comments are stored per task. Mentions create notifications.' }));
    host.appendChild(list);
    host.appendChild(el('div', { style: 'margin-top:10px' }, [
      input,
      el('div', { class: 'row', style: 'margin-top:10px; justify-content:flex-end' }, [btn])
    ]));

    if (unsubComments) unsubComments();
    unsubComments = window.__cos.db.collection('tasks').doc(taskId).collection('comments')
      .orderBy('createdAt', 'asc')
      .limit(250)
      .onSnapshot((snap) => {
        list.innerHTML = '';
        if (snap.empty) {
          list.appendChild(el('div', { class: 'help', text: 'No comments yet.' }));
          return;
        }
        snap.docs.forEach(d => {
          const c = d.data() || {};
          const when = c.createdAt?.toDate?.() ? c.createdAt.toDate().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }) : '';
          const who = c.authorName || c.authorEmail || 'User';

          list.appendChild(el('div', { class: 'card', style: 'border-radius:20px; box-shadow:none' }, [
            el('div', { class: 'cardBody', style: 'padding:12px' }, [
              el('div', { class: 'row', style: 'justify-content:space-between; align-items:flex-start' }, [
                el('div', { style: 'font-weight:900' }, [who]),
                el('div', { class: 'help', text: when })
              ]),
              el('div', { class: 'help', style: 'margin-top:8px; white-space:pre-wrap; color: var(--text)' }, [String(c.text || '')])
            ])
          ]));
        });
      });
  }

  function mountTimeline(taskId, host) {
    host.innerHTML = '';
    const list = el('div', { style: 'display:flex; flex-direction:column; gap:10px; margin-top: 10px' });

    host.appendChild(el('div', { class: 'row', style: 'justify-content:space-between; align-items:center' }, [
      el('div', { style: 'font-weight:900' }, ['Timeline']),
      chip('Audit log', 'dim')
    ]));
    host.appendChild(el('div', { class: 'help', text: 'Status changes, edits, mails, uploads, offline updates.' }));
    host.appendChild(list);

    if (unsubTimeline) unsubTimeline();
    unsubTimeline = window.__cos.db.collection('auditLogs')
      .where('taskId', '==', taskId)
      .limit(250)
      .onSnapshot((snap) => {
        list.innerHTML = '';
        if (snap.empty) {
          list.appendChild(el('div', { class: 'help', text: 'No timeline entries yet.' }));
          return;
        }
        const items = snap.docs.map(d => d.data() || {});
        items.sort((a, b) => (a.timestamp?.toMillis?.() || 0) - (b.timestamp?.toMillis?.() || 0));

        for (const a of items) {
          const when = a.timestamp?.toDate?.() ? a.timestamp.toDate().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }) : '';
          list.appendChild(el('div', { class: 'card', style: 'border-radius:20px; box-shadow:none' }, [
            el('div', { class: 'cardBody', style: 'padding:12px' }, [
              el('div', { class: 'row', style: 'justify-content:space-between; align-items:flex-start' }, [
                el('div', { style: 'font-weight:900' }, [String(a.action || '')]),
                el('div', { class: 'help', text: when })
              ]),
              el('div', { class: 'help', style: 'margin-top:6px' }, [String(a.actorEmail || '')]),
              el('pre', {
                style: `
                  margin: 10px 0 0;
                  white-space: pre-wrap;
                  font-family: var(--mono);
                  font-size: 12px;
                  color: var(--muted);
                `
              }, [JSON.stringify(a.details || {}, null, 0)])
            ])
          ]));
        }
      });
  }

  /* ---------- Attachments ---------- */
  function mountAttachments(task, host) {
    host.innerHTML = '';

    const list = el('div', { style: 'display:flex; flex-direction:column; gap:10px; margin-top:10px' });

    const btnUpload = el('button', { class: 'btn', type: 'button', text: 'Upload file' });
    btnUpload.onclick = async () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.onchange = async () => {
        const file = input.files?.[0];
        if (!file) return;

        const type = prompt('Document type (CHALLAN / RETURN / ACK / OTHER):', 'ACK') || 'OTHER';
        const fd = new FormData();
        fd.append('taskId', task.id);
        fd.append('type', String(type || 'OTHER').toUpperCase().trim());
        fd.append('file', file, file.name);

        const r = await apiForm('/tasks_uploadattachment', fd);
        if (!r.ok) return toast(`Upload failed: ${r.error || JSON.stringify(r)}`, 9000);
        toast('Uploaded');
      };
      input.click();
    };

    host.appendChild(el('div', { class: 'row', style: 'justify-content:space-between; align-items:center' }, [
      el('div', { style: 'font-weight:900' }, ['Attachments']),
      btnUpload
    ]));

    if (!Array.isArray(task.attachments) || !task.attachments.length) {
      host.appendChild(el('div', { class: 'help', style: 'margin-top:10px', text: 'No attachments yet.' }));
      return;
    }

    const items = task.attachments.slice().reverse();
    for (const a of items) {
      const link = a.driveWebViewLink || '';
      list.appendChild(el('div', { class: 'card', style: 'border-radius:20px; box-shadow:none' }, [
        el('div', { class: 'cardBody', style: 'padding:12px' }, [
          el('div', { class: 'row', style: 'justify-content:space-between; align-items:flex-start' }, [
            el('div', { style: 'font-weight:900' }, [`${a.type || 'DOC'} · ${a.fileName || ''}`]),
            chip(a.mimeType ? String(a.mimeType).split('/')[1]?.toUpperCase() || 'FILE' : 'FILE', 'dim')
          ]),
          link ? el('a', { href: link, target: '_blank', rel: 'noopener', class: 'btn btnSmall btnGhost', style: 'margin-top:10px; width:max-content' }, ['Open']) : el('div', { class: 'help', text: 'No link available' })
        ])
      ]));
    }

    host.appendChild(list);
  }

  /* ---------- Exports per task ---------- */
  function mountTaskExports(task, host) {
    host.innerHTML = '';

    const btnX = el('button', { class: 'btn', type: 'button', text: 'History XLSX' });
    const btnP = el('button', { class: 'btn btnPrimary', type: 'button', text: 'History PDF' });

    btnX.onclick = async () => {
      const r = await apiJson('/exports_taskHistoryXlsx', { taskId: task.id });
      if (!r.ok) return toast(`XLSX failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({ fileName: r.fileName, base64: r.base64, mime: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      toast('Downloaded XLSX');
    };

    btnP.onclick = async () => {
      const r = await apiJson('/reports_taskHistoryPdf', { taskId: task.id });
      if (!r.ok) return toast(`PDF failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({ fileName: r.fileName, base64: r.base64, mime: r.mime || 'application/pdf' });
      toast('Downloaded PDF');
    };

    host.appendChild(el('div', { class: 'row', style: 'justify-content:space-between; align-items:center' }, [
      el('div', { style: 'font-weight:900' }, ['Exports']),
      chip('Task history', 'info')
    ]));
    host.appendChild(el('div', { class: 'help', style: 'margin-top:6px', text: 'Exports include audit logs, comments, and attachments.' }));
    host.appendChild(el('div', { class: 'row', style: 'margin-top:12px; justify-content:flex-end' }, [btnX, btnP]));
  }

  /* ---------- Status update ---------- */
  function mountStatusPanel(task, host) {
    host.innerHTML = '';

    const sel = el('select', { class: 'select' });
    sel.appendChild(el('option', { value: '', text: 'Select status…' }));
    for (const s of statusOptionsForRole()) sel.appendChild(el('option', { value: s, text: s }));
    sel.value = task.status || 'PENDING';

    const note = el('textarea', { class: 'textarea', placeholder: 'Status note (optional)', style: 'min-height: 90px' });
    note.value = task.statusNote || '';

    const delayReason = el('select', { class: 'select' }, [
      el('option', { value: '', text: '(no delay reason)' }),
      el('option', { value: 'CLIENT_DELAY', text: 'CLIENT_DELAY' }),
      el('option', { value: 'INTERNAL_DELAY', text: 'INTERNAL_DELAY' })
    ]);
    delayReason.value = task.delayReason || '';

    const delayNotes = el('textarea', { class: 'textarea', placeholder: 'Delay details (optional)', style: 'min-height: 70px' });
    delayNotes.value = task.delayNotes || '';

    const btnSave = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Save status' });
    btnSave.onclick = async () => {
      const newStatus = String(sel.value || '').trim();
      if (!newStatus) return toast('Pick a status', 3200);

      const r = await apiJson('/tasks_updatestatus', {
        taskId: task.id,
        newStatus,
        statusNote: note.value,
        delayReason: delayReason.value || null,
        delayNotes: delayNotes.value
      });

      if (!r.ok) return toast(`Save failed: ${r.error || JSON.stringify(r)}`, 9000);
      toast('Saved');
    };

    host.appendChild(el('div', { class: 'row', style: 'justify-content:space-between; align-items:center' }, [
      el('div', { style: 'font-weight:900' }, ['Status']),
      chip(roleCanEditDetails() ? 'Completion allowed' : 'No completion', roleCanEditDetails() ? 'info' : 'dim')
    ]));
    host.appendChild(el('div', { class: 'help', style: 'margin-top:6px', html: `
      Marking <b>COMPLETED</b> triggers a completion email (if enabled) as a reply-all in the start thread when available.
    ` }));

    host.appendChild(el('div', { class: 'field', style: 'margin-top:12px' }, [
      el('div', { class: 'label', text: 'New status' }),
      sel
    ]));
    host.appendChild(el('div', { class: 'field', style: 'margin-top:12px' }, [
      el('div', { class: 'label', text: 'Status note' }),
      note
    ]));
    host.appendChild(el('div', { class: 'field', style: 'margin-top:12px' }, [
      el('div', { class: 'label', text: 'Delay reason' }),
      delayReason
    ]));
    host.appendChild(el('div', { class: 'field', style: 'margin-top:12px' }, [
      el('div', { class: 'label', text: 'Delay details' }),
      delayNotes
    ]));

    host.appendChild(el('div', { class: 'row', style: 'margin-top:12px; justify-content:flex-end' }, [btnSave]));
  }

  /* ---------- Edit details + mail overrides (Partner/Manager) ---------- */
  function mountEditPanel(task, host) {
    host.innerHTML = '';

    if (!roleCanEditDetails()) {
      host.appendChild(el('div', { class: 'help', html: `
        <div style="font-weight:900;color:var(--text)">Details editing is restricted</div>
        <div style="margin-top:8px">Your role can update status, add comments, and upload attachments. Partner/Manager can edit task details and recipient settings.</div>
      ` }));
      return;
    }

    const applySeries = el('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    applySeries.checked = false;
    applySeries.disabled = !task.seriesId;

    const title = el('input', { class: 'input', value: task.title || '' });
    const category = el('select', { class: 'select' }, [
      el('option', { value: 'GST', text: 'GST' }),
      el('option', { value: 'TDS', text: 'TDS' }),
      el('option', { value: 'INCOME_TAX', text: 'INCOME_TAX' }),
      el('option', { value: 'ROC', text: 'ROC' }),
      el('option', { value: 'ACCOUNTING', text: 'ACCOUNTING' }),
      el('option', { value: 'AUDIT', text: 'AUDIT' }),
      el('option', { value: 'OTHER', text: 'OTHER' })
    ]);
    category.value = String(task.category || 'OTHER').toUpperCase().replace(/\s+/g, '_');

    const type = el('input', { class: 'input', value: task.type || '' });
    const priority = el('select', { class: 'select' }, [
      el('option', { value: 'HIGH', text: 'HIGH' }),
      el('option', { value: 'MEDIUM', text: 'MEDIUM' }),
      el('option', { value: 'LOW', text: 'LOW' })
    ]);
    priority.value = String(task.priority || 'MEDIUM').toUpperCase();

    const due = el('input', { class: 'input', value: task.dueDateYmd ? ymdToDmy(task.dueDateYmd) : '', placeholder: 'DD-MM-YYYY' });
    const trigger = el('input', { class: 'input', type: 'number', min: '0', value: String(task.triggerDaysBefore ?? 15) });

    const snooze = el('input', { class: 'input', value: task.snoozedUntilYmd ? ymdToDmy(task.snoozedUntilYmd) : '', placeholder: 'DD-MM-YYYY (optional)' });

    const assignee = el('input', { class: 'input', value: task.assignedToEmail || '', placeholder: 'assignee@firm.com' });

    // Start mail controls + overrides
    const sendStart = el('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    sendStart.checked = (task.sendClientStartMail !== false);

    const toStart = el('input', { class: 'input', value: joinEmails(task.clientToEmails), placeholder: 'a@client.com; b@client.com' });
    const ccStart = el('input', { class: 'input', value: joinEmails(task.clientCcEmails), placeholder: 'cc@firm.com' });
    const bccStart = el('input', { class: 'input', value: joinEmails(task.clientBccEmails), placeholder: 'bcc@firm.com' });

    const ccAssigneeStart = el('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    ccAssigneeStart.checked = (task.ccAssigneeOnClientStart === true);
    const ccManagerStart = el('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    ccManagerStart.checked = (task.ccManagerOnClientStart === true);

    const startSubject = el('input', { class: 'input', value: task.clientStartSubject || '' });
    const startBody = el('textarea', { class: 'textarea', style: 'min-height: 120px' });
    startBody.value = task.clientStartBody || '';

    // Completion mail controls + overrides
    const sendComp = el('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    sendComp.checked = (task.sendClientCompletionMail !== false);

    const toComp = el('input', { class: 'input', value: joinEmails(task.completionToEmails), placeholder: 'reply-all To override (optional)' });
    const ccComp = el('input', { class: 'input', value: joinEmails(task.completionCcEmails), placeholder: 'Completion CC override (optional)' });
    const bccComp = el('input', { class: 'input', value: joinEmails(task.completionBccEmails), placeholder: 'Completion BCC override (optional)' });

    const ccAssigneeComp = el('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    ccAssigneeComp.checked = (task.ccAssigneeOnCompletion === true);
    const ccManagerComp = el('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    ccManagerComp.checked = (task.ccManagerOnCompletion === true);

    const compSubject = el('input', { class: 'input', value: task.clientCompletionSubject || '' });
    const compBody = el('textarea', { class: 'textarea', style: 'min-height: 120px' });
    compBody.value = task.clientCompletionBody || '';

    const btnSave = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Save details' });
    btnSave.onclick = async () => {
      let dueYmd = null;
      const dueDmy = String(due.value || '').trim();
      if (dueDmy) {
        try { dueYmd = dmyToYmd(dueDmy); } catch (e) { return toast(e.message, 7000); }
      }

      let snoozeYmd = null;
      const snoozeDmy = String(snooze.value || '').trim();
      if (snoozeDmy) {
        try { snoozeYmd = dmyToYmd(snoozeDmy); } catch (e) { return toast(e.message, 7000); }
      }

      const payload = {
        taskId: task.id,
        applyToSeries: !!applySeries.checked,

        title: title.value,
        category: category.value,
        type: type.value,
        priority: priority.value,

        dueDateYmd: dueYmd, // backend ignores for series edits
        triggerDaysBefore: Number(trigger.value || 0),

        snoozedUntilYmd: snoozeYmd,
        assignedToEmail: String(assignee.value || '').trim(),

        // start mail
        sendClientStartMail: !!sendStart.checked,
        clientToEmails: asEmailList(toStart.value),
        clientCcEmails: asEmailList(ccStart.value),
        clientBccEmails: asEmailList(bccStart.value),
        ccAssigneeOnClientStart: !!ccAssigneeStart.checked,
        ccManagerOnClientStart: !!ccManagerStart.checked,
        clientStartSubject: startSubject.value,
        clientStartBody: startBody.value,

        // completion
        sendClientCompletionMail: !!sendComp.checked,
        completionToEmails: asEmailList(toComp.value),
        completionCcEmails: asEmailList(ccComp.value),
        completionBccEmails: asEmailList(bccComp.value),
        ccAssigneeOnCompletion: !!ccAssigneeComp.checked,
        ccManagerOnCompletion: !!ccManagerComp.checked,
        clientCompletionSubject: compSubject.value,
        clientCompletionBody: compBody.value
      };

      const r = await apiJson('/tasks_updatetask', payload);
      if (!r.ok) return toast(`Save failed: ${r.error || JSON.stringify(r)}`, 9000);
      toast(`Saved${payload.applyToSeries ? ' (series)' : ''}`);
    };

    // Delete actions
    const btnDeleteTask = el('button', { class: 'btn btnDanger', type: 'button', text: 'Delete task' });
    btnDeleteTask.onclick = async () => {
      if (!confirm('Delete this task?')) return;
      const r = await apiJson('/tasks_delete', { taskId: task.id, applyToSeries: false });
      if (!r.ok) return toast(`Delete failed: ${r.error || JSON.stringify(r)}`, 9000);
      toast('Deleted');
      hideInspector();
    };

    const btnDeleteSeries = el('button', { class: 'btn btnDanger', type: 'button', text: 'Delete series', disabled: !task.seriesId });
    btnDeleteSeries.onclick = async () => {
      if (!task.seriesId) return;
      if (!confirm('Delete entire series?')) return;
      const r = await apiJson('/tasks_delete', { taskId: task.id, applyToSeries: true });
      if (!r.ok) return toast(`Delete failed: ${r.error || JSON.stringify(r)}`, 9000);
      toast('Series deleted');
      hideInspector();
    };

    const seriesTools = el('div', { class: 'card', style: 'border-radius:22px; box-shadow:none' }, [
      el('div', { class: 'cardHead' }, [
        el('div', {}, [el('h2', { text: 'Series tools' }), el('p', { text: 'Extend series or reassign series to another user.' })]),
        chip(task.seriesId ? 'Series' : 'No series', task.seriesId ? 'info' : 'dim')
      ]),
      el('div', { class: 'cardBody' }, [
        (() => {
          if (!task.seriesId) return el('div', { class: 'help', text: 'This task is not part of a series.' });

          const addCount = el('input', { class: 'input', type: 'number', min: '1', value: '1' });
          const btnAdd = el('button', { class: 'btn', type: 'button', text: 'Add tasks' });
          btnAdd.onclick = async () => {
            const n = Math.max(1, Number(addCount.value || 1));
            const r = await apiJson('/series_rebuild', { seriesId: task.seriesId, addCount: n });
            if (!r.ok) return toast(`Series add failed: ${r.error || JSON.stringify(r)}`, 9000);
            toast(`Added ${r.created || 0} tasks`);
          };

          const assignEmail = el('input', { class: 'input', placeholder: 'assignee@firm.com', value: task.assignedToEmail || '' });
          const btnReassign = el('button', { class: 'btn', type: 'button', text: 'Reassign series' });
          btnReassign.onclick = async () => {
            const email = String(assignEmail.value || '').trim();
            if (!email) return toast('Enter email', 3200);
            const r = await apiJson('/series_reassign', { seriesId: task.seriesId, assignedToEmail: email });
            if (!r.ok) return toast(`Series reassign failed: ${r.error || JSON.stringify(r)}`, 9000);
            toast('Series reassigned');
          };

          return el('div', { style: 'display:flex; flex-direction:column; gap: 12px' }, [
            el('div', { class: 'row' }, [
              el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Add more tasks' }), addCount]),
              el('div', { class: 'row', style: 'align-items:flex-end' }, [btnAdd])
            ]),
            el('div', { class: 'row' }, [
              el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Reassign series to' }), assignEmail]),
              el('div', { class: 'row', style: 'align-items:flex-end' }, [btnReassign])
            ])
          ]);
        })()
      ])
    ]);

    const info = el('div', { class: 'help', html: `
      Available fields in templates: <span style="font-family:var(--mono)">{{clientName}}</span>
      <span style="font-family:var(--mono)">{{taskTitle}}</span>
      <span style="font-family:var(--mono)">{{startDate}}</span>
      <span style="font-family:var(--mono)">{{dueDate}}</span>
      <span style="font-family:var(--mono)">{{addToCalendarUrl}}</span>
      <span style="font-family:var(--mono)">{{completedAt}}</span>
    ` });

    // Layout
    host.appendChild(el('div', { class: 'row', style: 'justify-content:space-between; align-items:center' }, [
      el('div', { style: 'font-weight:900' }, ['Details & mail']),
      chip('Partner/Manager', 'info')
    ]));

    host.appendChild(el('div', { class: 'help', style: 'margin-top:6px', html: `
      Completion mail behaves as <b>reply-all</b> when a start thread exists. Overrides below let you control recipients for both start and completion.
    ` }));

    host.appendChild(el('div', { class: 'card', style: 'border-radius:22px; box-shadow:none; margin-top: 12px' }, [
      el('div', { class: 'cardBody', style: 'padding:12px' }, [
        el('label', { class: 'chip', style: `gap:10px; ${task.seriesId ? '' : 'opacity:.6'}` }, [
          applySeries,
          el('span', { text: 'Apply edits to entire series' })
        ])
      ])
    ]));

    const grid = el('div', {
      style: `
        margin-top: 12px;
        display:grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 14px;
      `
    });

    const col = (n, node) => el('div', { style: `grid-column: span ${n}` }, [node]);

    grid.appendChild(col(12, el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Title' }), title])));
    grid.appendChild(col(4, el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Category' }), category])));
    grid.appendChild(col(4, el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Type' }), type])));
    grid.appendChild(col(4, el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Priority' }), priority])));

    grid.appendChild(col(4, el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Due date (single task only)' }), due])));
    grid.appendChild(col(4, el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Trigger days before due' }), trigger])));
    grid.appendChild(col(4, el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Snoozed until (optional)' }), snooze])));

    grid.appendChild(col(12, el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Assignee email' }), assignee])));

    // Start mail section
    grid.appendChild(col(12, el('div', { class: 'card', style: 'border-radius:22px; box-shadow:none' }, [
      el('div', { class: 'cardHead' }, [
        el('div', {}, [el('h2', { text: 'Start email' }), el('p', { text: 'Send control + recipient overrides + internal CC toggles.' })]),
        el('label', { class: 'chip', style: 'gap:10px' }, [
          sendStart,
          el('span', { text: 'Send start email' })
        ])
      ]),
      el('div', { class: 'cardBody' }, [
        el('div', { style: 'display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px;' }, [
          el('div', { style: 'grid-column: span 4' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'To' }), toStart])]),
          el('div', { style: 'grid-column: span 4' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'CC' }), ccStart])]),
          el('div', { style: 'grid-column: span 4' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'BCC' }), bccStart])]),

          el('div', { style: 'grid-column: span 6' }, [
            el('label', { class: 'chip', style: 'gap:10px' }, [ccAssigneeStart, el('span', { text: 'CC assignee on start' })])
          ]),
          el('div', { style: 'grid-column: span 6' }, [
            el('label', { class: 'chip', style: 'gap:10px' }, [ccManagerStart, el('span', { text: 'CC manager on start' })])
          ]),

          el('div', { style: 'grid-column: span 12' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Subject' }), startSubject])]),
          el('div', { style: 'grid-column: span 12' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Body' }), startBody])])
        ])
      ])
    ])));

    // Completion mail section
    grid.appendChild(col(12, el('div', { class: 'card', style: 'border-radius:22px; box-shadow:none' }, [
      el('div', { class: 'cardHead' }, [
        el('div', {}, [el('h2', { text: 'Completion email' }), el('p', { text: 'Reply-all behaviour with recipient overrides for completion.' })]),
        el('label', { class: 'chip', style: 'gap:10px' }, [
          sendComp,
          el('span', { text: 'Send completion email' })
        ])
      ]),
      el('div', { class: 'cardBody' }, [
        el('div', { style: 'display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px;' }, [
          el('div', { style: 'grid-column: span 4' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'To (override)' }), toComp])]),
          el('div', { style: 'grid-column: span 4' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'CC (override)' }), ccComp])]),
          el('div', { style: 'grid-column: span 4' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'BCC (override)' }), bccComp])]),

          el('div', { style: 'grid-column: span 6' }, [
            el('label', { class: 'chip', style: 'gap:10px' }, [ccAssigneeComp, el('span', { text: 'CC assignee on completion' })])
          ]),
          el('div', { style: 'grid-column: span 6' }, [
            el('label', { class: 'chip', style: 'gap:10px' }, [ccManagerComp, el('span', { text: 'CC manager on completion' })])
          ]),

          el('div', { style: 'grid-column: span 12' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Subject' }), compSubject])]),
          el('div', { style: 'grid-column: span 12' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Body' }), compBody])]),
          el('div', { style: 'grid-column: span 12' }, [info])
        ])
      ])
    ])));

    host.appendChild(grid);

    host.appendChild(el('div', { class: 'row', style: 'margin-top:12px; justify-content:space-between; flex-wrap:wrap' }, [
      el('div', { class: 'row' }, [
        btnDeleteTask,
        btnDeleteSeries
      ]),
      el('div', { class: 'row' }, [btnSave])
    ]));

    host.appendChild(el('div', { style: 'margin-top:14px' }, [seriesTools]));

    // Mobile
    host.appendChild(el('style', { html: `
      @media (max-width: 980px){
        .cosInspectorBody{ grid-template-columns: 1fr !important; }
      }
    `}));
  }

  /* ---------- Create Task (createone) ---------- */
  function mountCreatePanel(host) {
    host.innerHTML = '';

    const cSelect = el('select', { class: 'select', disabled: !state.isPartner });
    cSelect.appendChild(el('option', { value: '', text: state.isPartner ? 'Select client…' : 'Client selection is partner-only' }));
    if (state.isPartner) {
      for (const c of (state.clients || []).slice().sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')))) {
        cSelect.appendChild(el('option', { value: c.id, text: c.name || c.id }));
      }
    }

    const clientNameFree = el('input', { class: 'input', placeholder: 'Client name (if not in list)' });
    const clientEmailFree = el('input', { class: 'input', placeholder: 'Client email (optional)' });

    const assignedToEmail = el('input', { class: 'input', placeholder: 'Assignee email (associates always assign to self)' });
    if (!roleCanEditDetails()) {
      assignedToEmail.value = state.email || '';
      assignedToEmail.disabled = true;
    }

    const title = el('input', { class: 'input', placeholder: 'Task title (example: GSTR-3B Filing)' });
    const category = el('select', { class: 'select' }, [
      el('option', { value: 'GST', text: 'GST' }),
      el('option', { value: 'TDS', text: 'TDS' }),
      el('option', { value: 'INCOME_TAX', text: 'INCOME_TAX' }),
      el('option', { value: 'ROC', text: 'ROC' }),
      el('option', { value: 'ACCOUNTING', text: 'ACCOUNTING' }),
      el('option', { value: 'AUDIT', text: 'AUDIT' }),
      el('option', { value: 'OTHER', text: 'OTHER' })
    ]);
    category.value = 'OTHER';

    const type = el('input', { class: 'input', placeholder: 'Type (FILING / REVIEW / PAYMENT / …)', value: 'FILING' });

    const priority = el('select', { class: 'select' }, [
      el('option', { value: 'HIGH', text: 'HIGH' }),
      el('option', { value: 'MEDIUM', text: 'MEDIUM' }),
      el('option', { value: 'LOW', text: 'LOW' })
    ]);
    priority.value = 'MEDIUM';

    const due = el('input', { class: 'input', placeholder: 'Due date (DD-MM-YYYY)' });
    const trigger = el('input', { class: 'input', type: 'number', min: '0', value: '15' });

    const recurrence = el('select', { class: 'select' }, [
      el('option', { value: 'AD_HOC', text: 'One-time' }),
      el('option', { value: 'DAILY', text: 'Daily' }),
      el('option', { value: 'WEEKLY', text: 'Weekly' }),
      el('option', { value: 'BIWEEKLY', text: 'Every 2 weeks' }),
      el('option', { value: 'MONTHLY', text: 'Monthly' }),
      el('option', { value: 'BIMONTHLY', text: 'Every 2 months' }),
      el('option', { value: 'QUARTERLY', text: 'Quarterly' }),
      el('option', { value: 'HALF_YEARLY', text: 'Half-yearly' }),
      el('option', { value: 'YEARLY', text: 'Yearly' })
    ]);
    recurrence.value = 'AD_HOC';

    const genCount = el('input', { class: 'input', type: 'number', min: '1', value: '1' });

    // Mail fields
    const sendStart = el('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    sendStart.checked = true;

    const toStart = el('input', { class: 'input', placeholder: 'Start To override (optional)' });
    const ccStart = el('input', { class: 'input', placeholder: 'Start CC override (optional)' });
    const bccStart = el('input', { class: 'input', placeholder: 'Start BCC override (optional)' });

    const ccAssigneeStart = el('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    const ccManagerStart = el('input', { type: 'checkbox', style: 'width:18px;height:18px' });

    const startSubject = el('input', { class: 'input', placeholder: 'Start email subject', value: 'We started {{taskTitle}}' });
    const startBody = el('textarea', { class: 'textarea', style: 'min-height:120px' });
    startBody.value = `Dear {{clientName}},\n\nWe started work on {{taskTitle}}.\nDue: {{dueDate}}\n\nAdd to calendar: {{addToCalendarUrl}}\n\nRegards,\nCompliance Team`;

    const sendComp = el('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    sendComp.checked = true;

    const toComp = el('input', { class: 'input', placeholder: 'Completion To override (optional)' });
    const ccComp = el('input', { class: 'input', placeholder: 'Completion CC override (optional)' });
    const bccComp = el('input', { class: 'input', placeholder: 'Completion BCC override (optional)' });

    const ccAssigneeComp = el('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    const ccManagerComp = el('input', { type: 'checkbox', style: 'width:18px;height:18px' });

    const compSubject = el('input', { class: 'input', placeholder: 'Completion subject', value: 'Completed: {{taskTitle}}' });
    const compBody = el('textarea', { class: 'textarea', style: 'min-height:120px' });
    compBody.value = `Dear {{clientName}},\n\nWe have completed {{taskTitle}}.\nCompleted at: {{completedAt}}\n\nRegards,\nCompliance Team`;

    const btnCreate = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Create task(s)' });
    btnCreate.onclick = async () => {
      let dueYmd = '';
      try { dueYmd = dmyToYmd(String(due.value || '').trim()); } catch (e) { return toast(e.message, 7000); }
      const payload = {
        clientId: state.isPartner ? (cSelect.value || null) : null,
        clientName: String(clientNameFree.value || '').trim() || null,
        clientEmail: String(clientEmailFree.value || '').trim() || null,
        assignedToEmail: String(assignedToEmail.value || '').trim() || null,

        title: String(title.value || '').trim(),
        category: category.value,
        type: String(type.value || '').trim() || 'FILING',
        priority: priority.value,

        dueDateYmd: dueYmd,
        triggerDaysBefore: Number(trigger.value || 15),
        recurrence: recurrence.value,
        generateCount: Number(genCount.value || 1),

        sendClientStartMail: !!sendStart.checked,
        clientToEmails: asEmailList(toStart.value),
        clientCcEmails: asEmailList(ccStart.value),
        clientBccEmails: asEmailList(bccStart.value),
        ccAssigneeOnClientStart: !!ccAssigneeStart.checked,
        ccManagerOnClientStart: !!ccManagerStart.checked,
        clientStartSubject: startSubject.value,
        clientStartBody: startBody.value,

        sendClientCompletionMail: !!sendComp.checked,
        completionToEmails: asEmailList(toComp.value),
        completionCcEmails: asEmailList(ccComp.value),
        completionBccEmails: asEmailList(bccComp.value),
        ccAssigneeOnCompletion: !!ccAssigneeComp.checked,
        ccManagerOnCompletion: !!ccManagerComp.checked,
        clientCompletionSubject: compSubject.value,
        clientCompletionBody: compBody.value
      };

      if (!payload.clientId && !payload.clientName) return toast('Select a client or type a client name', 5000);
      if (!payload.title) return toast('Title is required', 4000);

      const r = await apiJson('/tasks_createone', payload);
      if (!r.ok) return toast(`Create failed: ${r.error || JSON.stringify(r)}`, 9000);

      toast(`Created ${r.created || 0} task(s)`);
      hideInspector();
      window.__cos_mountView('work');
    };

    host.appendChild(el('div', { class: 'row', style: 'justify-content:space-between; align-items:center' }, [
      el('div', { style: 'font-weight:900' }, ['Create task']),
      chip(state.role, 'info')
    ]));
    host.appendChild(el('div', { class: 'help', style: 'margin-top:6px', text: 'Create one task or a repeating series. Start email may send immediately if the start date is today.' }));

    const grid = el('div', {
      style: `
        margin-top: 12px;
        display:grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 14px;
      `
    });

    const col = (n, node) => el('div', { style: `grid-column: span ${n}` }, [node]);

    grid.appendChild(col(6, el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Client (list)' }), cSelect])));
    grid.appendChild(col(6, el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Client name (if not in list)' }), clientNameFree])));
    grid.appendChild(col(6, el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Client email (optional)' }), clientEmailFree])));
    grid.appendChild(col(6, el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Assign to (email)' }), assignedToEmail])));

    grid.appendChild(col(12, el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Title' }), title])));
    grid.appendChild(col(4, el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Category' }), category])));
    grid.appendChild(col(4, el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Type' }), type])));
    grid.appendChild(col(4, el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Priority' }), priority])));

    grid.appendChild(col(4, el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Due date' }), due])));
    grid.appendChild(col(4, el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Trigger days' }), trigger])));
    grid.appendChild(col(4, el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Repeat' }), recurrence])));

    grid.appendChild(col(4, el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Generate count' }), genCount])));
    grid.appendChild(col(8, el('div', { class: 'help', style: 'align-self:end' }, [
      'Series generates future tasks by recurrence. Calendar event is created at the start date.'
    ])));

    // Start mail card
    grid.appendChild(col(12, el('div', { class: 'card', style: 'border-radius:22px; box-shadow:none' }, [
      el('div', { class: 'cardHead' }, [
        el('div', {}, [el('h2', { text: 'Start email' }), el('p', { text: 'Control sending and override recipients for this task.' })]),
        el('label', { class: 'chip', style: 'gap:10px' }, [sendStart, el('span', { text: 'Send start email' })])
      ]),
      el('div', { class: 'cardBody' }, [
        el('div', { style: 'display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px;' }, [
          el('div', { style: 'grid-column: span 4' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'To override' }), toStart])]),
          el('div', { style: 'grid-column: span 4' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'CC override' }), ccStart])]),
          el('div', { style: 'grid-column: span 4' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'BCC override' }), bccStart])]),
          el('div', { style: 'grid-column: span 6' }, [el('label', { class: 'chip', style: 'gap:10px' }, [ccAssigneeStart, el('span', { text: 'CC assignee' })])]),
          el('div', { style: 'grid-column: span 6' }, [el('label', { class: 'chip', style: 'gap:10px' }, [ccManagerStart, el('span', { text: 'CC manager' })])]),
          el('div', { style: 'grid-column: span 12' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Subject' }), startSubject])]),
          el('div', { style: 'grid-column: span 12' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Body' }), startBody])])
        ])
      ])
    ])));

    // Completion mail card
    grid.appendChild(col(12, el('div', { class: 'card', style: 'border-radius:22px; box-shadow:none' }, [
      el('div', { class: 'cardHead' }, [
        el('div', {}, [el('h2', { text: 'Completion email' }), el('p', { text: 'Sent when marked COMPLETED by Partner/Manager. Replies in same thread when possible.' })]),
        el('label', { class: 'chip', style: 'gap:10px' }, [sendComp, el('span', { text: 'Send completion email' })])
      ]),
      el('div', { class: 'cardBody' }, [
        el('div', { style: 'display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px;' }, [
          el('div', { style: 'grid-column: span 4' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'To override' }), toComp])]),
          el('div', { style: 'grid-column: span 4' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'CC override' }), ccComp])]),
          el('div', { style: 'grid-column: span 4' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'BCC override' }), bccComp])]),
          el('div', { style: 'grid-column: span 6' }, [el('label', { class: 'chip', style: 'gap:10px' }, [ccAssigneeComp, el('span', { text: 'CC assignee' })])]),
          el('div', { style: 'grid-column: span 6' }, [el('label', { class: 'chip', style: 'gap:10px' }, [ccManagerComp, el('span', { text: 'CC manager' })])]),
          el('div', { style: 'grid-column: span 12' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Subject' }), compSubject])]),
          el('div', { style: 'grid-column: span 12' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Body' }), compBody])])
        ])
      ])
    ])));

    host.appendChild(grid);

    host.appendChild(el('div', { class: 'row', style: 'margin-top:12px; justify-content:flex-end' }, [btnCreate]));

    host.appendChild(el('style', { html: `
      @media (max-width: 980px){
        .cosInspectorBody{ grid-template-columns: 1fr !important; }
      }
    `}));
  }

  /* ---------- Main inspector mount ---------- */
  function mountInspectorForTask(taskId) {
    clearLive();

    const task = taskById(taskId);
    if (!task) return toast('Task not found', 3500);

    inspector.mode = 'view';
    inspector.taskId = taskId;

    const cName = clientName(task);
    headTitle.textContent = task.title || 'Task';
    headSub.textContent = `${cName ? `Client: ${cName} · ` : ''}${task.status || ''}${task.dueDateYmd ? ` · Due ${ymdToDmy(task.dueDateYmd)}` : ''}`;

    body.classList.add('cosInspectorBody');
    body.innerHTML = '';
    footLeft.innerHTML = '';
    footRight.innerHTML = '';

    const leftCol = el('div', { style: 'display:flex; flex-direction:column; gap: 14px' });
    const rightCol = el('div', { style: 'display:flex; flex-direction:column; gap: 14px' });

    const boxStatus = el('div', { class: 'card', style: 'border-radius:22px; box-shadow:none' }, [el('div', { class: 'cardBody' })]);
    mountStatusPanel(task, boxStatus.firstChild);

    const boxExports = el('div', { class: 'card', style: 'border-radius:22px; box-shadow:none' }, [el('div', { class: 'cardBody' })]);
    mountTaskExports(task, boxExports.firstChild);

    const boxAttach = el('div', { class: 'card', style: 'border-radius:22px; box-shadow:none' }, [el('div', { class: 'cardBody' })]);
    mountAttachments(task, boxAttach.firstChild);

    const boxComments = el('div', { class: 'card', style: 'border-radius:22px; box-shadow:none' }, [el('div', { class: 'cardBody' })]);
    mountComments(taskId, boxComments.firstChild);

    const boxTimeline = el('div', { class: 'card', style: 'border-radius:22px; box-shadow:none' }, [el('div', { class: 'cardBody' })]);
    mountTimeline(taskId, boxTimeline.firstChild);

    const boxEdit = el('div', { class: 'card', style: 'border-radius:22px; box-shadow:none' }, [el('div', { class: 'cardBody' })]);
    mountEditPanel(task, boxEdit.firstChild);

    leftCol.appendChild(boxStatus);
    leftCol.appendChild(boxExports);
    leftCol.appendChild(boxAttach);

    rightCol.appendChild(boxEdit);
    rightCol.appendChild(boxComments);
    rightCol.appendChild(boxTimeline);

    body.appendChild(leftCol);
    body.appendChild(rightCol);

    // Footer quick info / thread info
    const thread = task.clientStartGmailThreadId ? 'Threaded' : 'No thread';
    const startSent = task.clientStartMailSent ? 'Start sent' : 'Start not sent';
    footLeft.appendChild(chip(`${startSent} · ${thread}`, task.clientStartMailSent ? 'ok' : 'dim'));

    if (task.calendarHtmlLink) {
      footRight.appendChild(el('a', { class: 'btn btnSmall btnGhost', href: task.calendarHtmlLink, target: '_blank', rel: 'noopener' }, ['Calendar']));
    }
    footRight.appendChild(el('button', {
      class: 'btn btnSmall btnGhost',
      type: 'button',
      text: 'Work Queue',
      onclick: () => { hideInspector(); window.__cos_mountView('work'); }
    }));

    showInspector();
  }

  function mountInspectorCreate() {
    clearLive();

    inspector.mode = 'create';
    inspector.taskId = null;

    headTitle.textContent = 'Create task';
    headSub.textContent = 'Create one task or a series with start/completion email settings.';

    body.classList.add('cosInspectorBody');
    body.innerHTML = '';
    footLeft.innerHTML = '';
    footRight.innerHTML = '';

    const panel = el('div', { class: 'card', style: 'border-radius:22px; box-shadow:none; grid-column: span 2' }, [
      el('div', { class: 'cardBody' })
    ]);
    mountCreatePanel(panel.firstChild);

    body.appendChild(panel);

    footLeft.appendChild(chip('Create mode', 'info'));
    footRight.appendChild(el('button', { class: 'btn btnSmall btnGhost', type: 'button', text: 'Close', onclick: hideInspector }));

    showInspector();
  }

  /* ---------- Expose openers to other parts ---------- */
  window.__cos_openTaskInspector = mountInspectorForTask;
  window.__cos_openCreateTask = mountInspectorCreate;

  // If a task is already selected when this part loads, open it
  if (state.uid && state.inspectorTaskId) {
    try { mountInspectorForTask(state.inspectorTaskId); } catch {}
  }

})();
</script>
<script>
/* =========================
   ComplianceOS — Part 7/8
   Studio (Email Drafting + Excel-safe copy) — new workflow
   - Insert fields (variables) via searchable palette inside Studio
   - Newline mode: TOKEN (\n) vs REAL lines
   - Copy subject/body in multiple formats
   ========================= */

(() => {
  'use strict';

  const { state, safeCopy, toast } = window.__cos;
  const mount = document.getElementById('viewMount');

  const el = (tag, attrs = {}, children = []) => {
    const n = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs || {})) {
      if (k === 'class') n.className = v;
      else if (k === 'text') n.textContent = v;
      else if (k === 'html') n.innerHTML = v;
      else if (k === 'style') n.setAttribute('style', String(v));
      else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
      else if (v === false || v === null || v === undefined) continue;
      else n.setAttribute(k, String(v));
    }
    for (const c of (children || [])) n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
    return n;
  };

  function card(title, subtitle, rightNode, bodyNode) {
    return el('div', { class: 'card' }, [
      el('div', { class: 'cardHead' }, [
        el('div', {}, [el('h2', { text: title }), el('p', { text: subtitle || '' })]),
        rightNode || el('div')
      ]),
      el('div', { class: 'cardBody' }, [bodyNode || el('div')])
    ]);
  }

  function chip(text, tone) {
    const colors = {
      ok: 'border-color: rgba(34,197,94,.38); background: rgba(34,197,94,.12);',
      warn: 'border-color: rgba(245,158,11,.42); background: rgba(245,158,11,.14);',
      bad: 'border-color: rgba(239,68,68,.42); background: rgba(239,68,68,.14);',
      info:'border-color: rgba(34,211,238,.42); background: rgba(34,211,238,.12);',
      dim: 'border-color: var(--stroke2); background: rgba(255,255,255,.05); color: var(--muted);'
    };
    return el('span', { class: 'chip', style: `padding:6px 10px; font-size:12px; ${colors[tone||'dim']||colors.dim}` }, [text]);
  }

  const VARS = [
    { name: 'Client name', key: '{{clientName}}', desc: 'Client name' },
    { name: 'Task title', key: '{{taskTitle}}', desc: 'Task title' },
    { name: 'Start date', key: '{{startDate}}', desc: 'Start date (DD-MM-YYYY)' },
    { name: 'Due date', key: '{{dueDate}}', desc: 'Due date (DD-MM-YYYY)' },
    { name: 'Add to calendar link', key: '{{addToCalendarUrl}}', desc: 'Google Calendar link' },
    { name: 'Completed time', key: '{{completedAt}}', desc: 'Completion time in IST' },
  ];

  function tokensToRealLines(s) { return String(s ?? '').replaceAll('\\n', '\n'); }
  function realLinesToTokens(s) { return String(s ?? '').replace(/\r?\n/g, '\\n'); }

  function sampleVars() {
    return {
      clientName: 'ABC Pvt Ltd',
      taskTitle: 'GSTR-3B Filing',
      startDate: '01-02-2026',
      dueDate: '20-02-2026',
      addToCalendarUrl: 'https://calendar.google.com/calendar/render?...',
      completedAt: new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })
    };
  }

  function replaceVars(text, vars) {
    let out = String(text || '');
    for (const [k, v] of Object.entries(vars || {})) out = out.replaceAll(`{{${k}}}`, String(v ?? ''));
    return out;
  }

  function insertAtCursor(input, str) {
    const start = input.selectionStart ?? input.value.length;
    const end = input.selectionEnd ?? input.value.length;
    input.value = input.value.slice(0, start) + str + input.value.slice(end);
    const pos = start + str.length;
    input.selectionStart = input.selectionEnd = pos;
    input.focus();
  }

  const studioState = {
    newlineMode: 'TOKEN', // TOKEN | REAL
    lastFocus: 'body'
  };

  function render() {
    mount.innerHTML = '';
    if (!state.uid) return;

    const subj = el('input', { class: 'input', id: 'stSubject', placeholder: 'Subject', value: 'We started {{taskTitle}}' });
    const body = el('textarea', { class: 'textarea', id: 'stBody', style: 'min-height: 240px' });
    body.value = 'Dear {{clientName}},\\n\\nWe started work on {{taskTitle}}.\\nDue: {{dueDate}}\\n\\nRegards,\\nCompliance Team';

    subj.addEventListener('focus', () => studioState.lastFocus = 'subject');
    body.addEventListener('focus', () => studioState.lastFocus = 'body');

    const mode = el('select', { class: 'select', style: 'border-radius:999px; padding:10px 12px; width:auto' }, [
      el('option', { value: 'TOKEN', text: 'Excel-safe (\\n tokens)' }),
      el('option', { value: 'REAL', text: 'Real line breaks' })
    ]);
    mode.value = studioState.newlineMode;
    mode.onchange = () => {
      studioState.newlineMode = mode.value;
      // Convert content between modes without losing meaning
      if (studioState.newlineMode === 'REAL') body.value = tokensToRealLines(body.value);
      else body.value = realLinesToTokens(body.value);
      updatePreview();
    };

    // When in TOKEN mode, Enter inserts \n unless Shift+Enter
    body.addEventListener('keydown', (e) => {
      if (e.key !== 'Enter') return;
      if (studioState.newlineMode !== 'TOKEN') return;
      if (e.shiftKey) return; // allow real newline with Shift+Enter for power users
      e.preventDefault();
      insertAtCursor(body, '\\n');
      updatePreview();
    });

    const varSearch = el('input', { class: 'input', placeholder: 'Search fields…', style: 'margin-top:10px' });
    const varList = el('div', { style: 'display:flex; flex-direction:column; gap:10px; margin-top:10px' });

    function renderVarList() {
      const q = String(varSearch.value || '').trim().toLowerCase();
      varList.innerHTML = '';
      const hits = VARS.filter(v =>
        !q ||
        v.name.toLowerCase().includes(q) ||
        v.key.toLowerCase().includes(q) ||
        v.desc.toLowerCase().includes(q)
      );

      if (!hits.length) {
        varList.appendChild(el('div', { class: 'help', text: 'No matches.' }));
        return;
      }

      hits.forEach(v => {
        const item = el('button', {
          class: 'btn btnGhost',
          type: 'button',
          style: 'border-radius:18px; justify-content:flex-start; align-items:flex-start; padding: 10px 12px; gap:12px;',
          onclick: () => {
            const target = (studioState.lastFocus === 'subject') ? subj : body;
            insertAtCursor(target, v.key);
            updatePreview();
          }
        }, [
          chip('Field', 'info'),
          el('div', { style: 'min-width:0; flex:1; display:flex; flex-direction:column; gap:6px; text-align:left' }, [
            el('div', { style: 'font-weight:900' }, [v.name]),
            el('div', { class: 'help' }, [`${v.key} · ${v.desc}`])
          ])
        ]);
        varList.appendChild(item);
      });
    }
    varSearch.addEventListener('input', renderVarList);

    const preview = el('div', { class: 'card', style: 'border-radius:22px; box-shadow:none' }, [
      el('div', { class: 'cardBody', style: 'padding:12px' }, [
        el('div', { class: 'label', text: 'Preview (sample values)' }),
        el('div', { class: 'help', id: 'stPreview', style: 'margin-top:10px; white-space:pre-wrap; color: var(--text)' })
      ])
    ]);

    function updatePreview() {
      const vars = sampleVars();
      const subjText = replaceVars(subj.value, vars);
      const bodyText = replaceVars(tokensToRealLines(body.value), vars);
      preview.querySelector('#stPreview').textContent = `Subject: ${subjText}\n\n${bodyText}`;
    }

    subj.addEventListener('input', updatePreview);
    body.addEventListener('input', updatePreview);

    const btnCopySubject = el('button', { class: 'btn btnSmall', type: 'button', text: 'Copy subject' });
    btnCopySubject.onclick = async () => {
      await safeCopy(subj.value || '');
      toast('Subject copied');
    };

    const btnCopyBodyExcel = el('button', { class: 'btn btnSmall btnPrimary', type: 'button', text: 'Copy body (for Excel)' });
    btnCopyBodyExcel.onclick = async () => {
      // Always copy token mode for Excel
      const excel = realLinesToTokens(tokensToRealLines(body.value));
      await safeCopy(excel);
      toast('Body copied (Excel-safe)');
    };

    const btnCopyBodyRaw = el('button', { class: 'btn btnSmall btnGhost', type: 'button', text: 'Copy body (raw)' });
    btnCopyBodyRaw.onclick = async () => {
      await safeCopy(tokensToRealLines(body.value));
      toast('Body copied (raw)');
    };

    const right = el('div', { class: 'row' }, [
      chip(state.role, 'info'),
      chip(studioState.newlineMode === 'TOKEN' ? 'Excel-safe mode' : 'Real lines', 'dim')
    ]);

    const layout = el('div', {
      style: `
        display:grid;
        grid-template-columns: minmax(340px, 1.2fr) minmax(320px, .8fr);
        gap: 14px;
        align-items:start;
      `
    });

    const leftPane = el('div', { style: 'display:flex; flex-direction:column; gap:14px' }, [
      el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Subject' }), subj]),
      el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Body' }), body]),
      el('div', { class: 'row', style: 'justify-content:space-between; align-items:center; flex-wrap:wrap' }, [
        el('div', { class: 'row' }, [
          chip('Newlines', 'dim'),
          mode
        ]),
        el('div', { class: 'row' }, [btnCopyBodyExcel, btnCopySubject, btnCopyBodyRaw])
      ]),
      preview
    ]);

    const rightPane = el('div', { style: 'display:flex; flex-direction:column; gap:14px' }, [
      el('div', { class: 'card', style: 'border-radius:22px; box-shadow:none' }, [
        el('div', { class: 'cardHead' }, [
          el('div', {}, [el('h2', { text: 'Insert fields' }), el('p', { text: 'Click a field to insert at cursor. Works for both subject and body.' })]),
          chip('Palette', 'info')
        ]),
        el('div', { class: 'cardBody' }, [
          varSearch,
          varList,
          el('div', { class: 'help', style: 'margin-top:12px', html: `
            Tip: In <b>Excel-safe</b> mode, press <span style="font-family:var(--mono);font-weight:900">Enter</span> to insert <span style="font-family:var(--mono);font-weight:900">\\n</span>. Use <span style="font-family:var(--mono);font-weight:900">Shift+Enter</span> for a real line break.
          ` })
        ])
      ]),
      el('div', { class: 'card', style: 'border-radius:22px; box-shadow:none' }, [
        el('div', { class: 'cardHead' }, [
          el('div', {}, [el('h2', { text: 'Where to use this' }), el('p', { text: 'Paste drafts into task creation, task editing, or Excel templates.' })]),
          chip('Workflow', 'dim')
        ]),
        el('div', { class: 'cardBody' }, [
          el('div', { class: 'help', html: `
            <div><b>Start email</b>: used when a task starts (immediate or scheduled).</div>
            <div style="margin-top:8px"><b>Completion email</b>: replies in the same thread (reply-all) when possible.</div>
            <div style="margin-top:8px"><b>Offline XLSX</b>: copy Excel-safe body to keep multi-line content inside one cell.</div>
          ` })
        ])
      ])
    ]);

    layout.appendChild(leftPane);
    layout.appendChild(rightPane);

    const style = el('style', { html: `
      @media (max-width: 980px){
        .cosStudioSplit{ grid-template-columns: 1fr !important; }
      }
    `});
    layout.classList.add('cosStudioSplit');

    renderVarList();
    updatePreview();

    mount.appendChild(el('div', { class: 'gridMax' }, [
      style,
      card('Studio', 'Draft client communication safely. Optimized for Excel + templates + consistent formatting.', right, layout)
    ]));
  }

  window.__cos_mountStudio = render;

  if (state.uid && state.activeView === 'studio') render();

})();
</script>

<script>
/* =========================
   ComplianceOS — Part 8/8
   Ops & Reports (Partner/Manager)
   - Import XLSX (tasks_bulkimportxlsx) + required OK modal via built-in dialog approach
   - Export firm range XLSX (exports_firmRangeWithHistoryXlsx)
   - Export quick XLSX (exports_quickXlsx)
   - Export for offline update XLSX (exports_tasksExportForUpdateXlsx)
   - Download update template XLSX (exports_tasksUpdateTemplateXlsx)
   - Upload offline updates XLSX (tasks_bulkupdate_from_xlsx)
   - PDFs: firm range / daily digest / monthly (reports_firmRangePdf, reports_dailyDigestPdf, reports_monthlyPdf)
   - Team & Settings management (Partner-only) — users_list, users_setrole, users_setmanager, users_setdisplayname, settings_get/update, settings_calendar_get/update, settings_workerImportPassword_set
   - Role migration helper: roles_migrate_worker_to_associate
   ========================= */

(() => {
  'use strict';

  const {
    state,
    apiJson,
    apiForm,
    downloadBase64,
    dmyToYmd,
    ymdToDmy,
    todayYmdIST,
    toast
  } = window.__cos;

  const mount = document.getElementById('viewMount');

  const el = (tag, attrs = {}, children = []) => {
    const n = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs || {})) {
      if (k === 'class') n.className = v;
      else if (k === 'text') n.textContent = v;
      else if (k === 'html') n.innerHTML = v;
      else if (k === 'style') n.setAttribute('style', String(v));
      else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
      else if (v === false || v === null || v === undefined) continue;
      else n.setAttribute(k, String(v));
    }
    for (const c of (children || [])) n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
    return n;
  };

  function card(title, subtitle, rightNode, bodyNode) {
    return el('div', { class: 'card' }, [
      el('div', { class: 'cardHead' }, [
        el('div', {}, [el('h2', { text: title }), el('p', { text: subtitle || '' })]),
        rightNode || el('div')
      ]),
      el('div', { class: 'cardBody' }, [bodyNode || el('div')])
    ]);
  }

  function chip(text, tone) {
    const colors = {
      ok: 'border-color: rgba(34,197,94,.38); background: rgba(34,197,94,.12);',
      warn: 'border-color: rgba(245,158,11,.42); background: rgba(245,158,11,.14);',
      bad: 'border-color: rgba(239,68,68,.42); background: rgba(239,68,68,.14);',
      info:'border-color: rgba(34,211,238,.42); background: rgba(34,211,238,.12);',
      dim: 'border-color: var(--stroke2); background: rgba(255,255,255,.05); color: var(--muted);'
    };
    return el('span', { class: 'chip', style: `padding:6px 10px; font-size:12px; ${colors[tone||'dim']||colors.dim}` }, [text]);
  }

  function asEmailList(str) {
    return String(str || '').split(/[;,:]/).map(s => s.trim()).filter(Boolean);
  }

  function mountLocked() {
    mount.innerHTML = '';
    mount.appendChild(el('div', { class: 'gridMax' }, [
      card('Ops & Reports', 'This area is available to PARTNER and MANAGER roles only.', chip(state.role, 'info'), el('div', { class: 'help', html: `
        <div>Your current role is <b>${state.role}</b>.</div>
        <div style="margin-top:8px">If you should have access, ask a partner to update your role.</div>
      ` }))
    ]));
  }

  /* ---------- Simple OK-required modal (fresh) ---------- */
  const okModal = (() => {
    const overlay = el('div', {
      style: `
        position: fixed; inset:0; z-index: 120;
        background: rgba(0,0,0,.55);
        display:none; place-items:center;
        padding: 22px;
      `
    });

    const panel = el('div', {
      class: 'card',
      style: `
        width: min(680px, 94vw);
        border-radius: 26px;
        box-shadow: var(--shadow);
        overflow:hidden;
      `
    });

    const head = el('div', { class: 'cardHead' }, [
      el('div', {}, [el('h2', { id: 'okTitle', text: 'Message' }), el('p', { id: 'okSub', text: '' })]),
      chip('OK required', 'info')
    ]);

    const body = el('div', { class: 'cardBody', id: 'okBody' });
    const foot = el('div', {
      style: 'border-top:1px solid var(--stroke2); padding: 12px 16px; display:flex; justify-content:flex-end; gap:10px'
    });

    const btn = el('button', { class: 'btn btnPrimary', type: 'button', text: 'OK' });
    foot.appendChild(btn);

    panel.appendChild(head);
    panel.appendChild(body);
    panel.appendChild(foot);
    overlay.appendChild(panel);
    document.body.appendChild(overlay);

    function show({ title, sub, bodyHtml }) {
      return new Promise((resolve) => {
        document.getElementById('okTitle').textContent = title || 'Message';
        document.getElementById('okSub').textContent = sub || '';
        document.getElementById('okBody').innerHTML = bodyHtml || '';
        overlay.style.display = 'grid';
        btn.onclick = () => {
          overlay.style.display = 'none';
          btn.onclick = null;
          resolve(true);
        };
        setTimeout(() => btn.focus(), 0);
      });
    }

    return { show };
  })();

  /* ---------- Ops state ---------- */
  const opsState = {
    from: '01-01-2026',
    to: '31-12-2026',
    includeAudit: true,

    workerImportPassword: '',

    monthYmd: todayYmdIST(),
    updateLimit: 600,

    // local cache
    team: [],
    settings: null,
    cal: null
  };

  function rangeControls() {
    const from = el('input', { class: 'input', value: opsState.from, placeholder: 'From (DD-MM-YYYY)' });
    const to = el('input', { class: 'input', value: opsState.to, placeholder: 'To (DD-MM-YYYY)' });
    const includeAudit = el('select', { class: 'select' }, [
      el('option', { value: 'true', text: 'Include history (AuditLogs)' }),
      el('option', { value: 'false', text: 'Tasks only' })
    ]);
    includeAudit.value = opsState.includeAudit ? 'true' : 'false';

    from.addEventListener('input', () => opsState.from = from.value);
    to.addEventListener('input', () => opsState.to = to.value);
    includeAudit.addEventListener('change', () => opsState.includeAudit = (includeAudit.value === 'true'));

    return { from, to, includeAudit };
  }

  /* ---------- IMPORT (XLSX) ---------- */
  function importPanel() {
    const btnTpl = el('button', { class: 'btn', type: 'button', text: 'Download Import Template (XLSX)' });
    btnTpl.onclick = async () => {
      const r = await apiJson('/exports_myClientsTemplateXlsx', {});
      if (!r.ok) return toast(`Template failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({ fileName: r.fileName || 'Client_Tasks_Import_Template.xlsx', base64: r.base64, mime: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      toast('Template downloaded');
    };

    const file = el('input', { class: 'input', type: 'file', accept: '.xlsx' });
    file.style.padding = '12px';

    const pwd = el('input', { class: 'input', type: 'password', placeholder: 'Import password (ASSOCIATE only, if enabled)' });
    pwd.addEventListener('input', () => opsState.workerImportPassword = pwd.value);

    const btnImport = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Import XLSX' });
    btnImport.onclick = async () => {
      const f = file.files?.[0];
      if (!f) return toast('Select an XLSX file', 3600);

      const fd = new FormData();
      fd.append('file', f, f.name);
      if (pwd.value.trim()) fd.append('importPassword', pwd.value.trim());

      const r = await apiForm('/tasks_bulkimportxlsx', fd);
      if (!r.ok) return toast(`Import failed: ${r.error || JSON.stringify(r)}`, 9000);

      // OK-required modal
      await okModal.show({
        title: 'Import complete',
        sub: 'Review your tasks',
        bodyHtml: `
          <div class="help">Created <b>${r.created || 0}</b> tasks.</div>
          <div class="help" style="margin-top:8px">Series created: <b>${r.seriesCreated || 0}</b>.</div>
        `
      });

      toast('Imported');
      window.__cos_mountView('work');
    };

    return el('div', { style: 'display:flex; flex-direction:column; gap: 12px' }, [
      el('div', { class: 'row', style: 'justify-content:space-between; align-items:center; flex-wrap:wrap' }, [
        chip('XLSX Import', 'info'),
        btnTpl
      ]),
      el('div', { class: 'help', html: `
        Upload an Excel file to create tasks. Start emails may send immediately if a task's start date is today; otherwise scheduled at 08:15.
      ` }),
      el('div', { class: 'field' }, [el('div', { class: 'label', text: 'XLSX file' }), file]),
      el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Import password (only if required)' }), pwd]),
      el('div', { class: 'row', style: 'justify-content:flex-end' }, [btnImport])
    ]);
  }

  /* ---------- EXPORTS ---------- */
  function exportsPanel() {
    const { from, to, includeAudit } = rangeControls();

    const btnFirmX = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Firm range XLSX' });
    btnFirmX.onclick = async () => {
      try { dmyToYmd(from.value.trim()); dmyToYmd(to.value.trim()); } catch (e) { return toast(e.message, 7000); }
      const r = await apiJson('/exports_firmRangeWithHistoryXlsx', {
        fromDmy: from.value.trim(),
        toDmy: to.value.trim(),
        includeAudit: includeAudit.value === 'true'
      });
      if (!r.ok) return toast(`Export failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({ fileName: r.fileName, base64: r.base64, mime: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      toast('Downloaded XLSX');
    };

    const btnFirmP = el('button', { class: 'btn', type: 'button', text: 'Firm range PDF' });
    btnFirmP.onclick = async () => {
      try { dmyToYmd(from.value.trim()); dmyToYmd(to.value.trim()); } catch (e) { return toast(e.message, 7000); }
      const r = await apiJson('/reports_firmRangePdf', {
        fromDmy: from.value.trim(),
        toDmy: to.value.trim()
      });
      if (!r.ok) return toast(`PDF failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({ fileName: r.fileName, base64: r.base64, mime: r.mime || 'application/pdf' });
      toast('Downloaded PDF');
    };

    async function quick(mode) {
      const r = await apiJson('/exports_quickXlsx', { mode });
      if (!r.ok) return toast(`Quick export failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({ fileName: r.fileName, base64: r.base64, mime: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      toast('Downloaded XLSX');
    }

    const btnQ7 = el('button', { class: 'btn btnSmall', type: 'button', text: 'Next 7 days', onclick: () => quick('NEXT_7') });
    const btnQ15 = el('button', { class: 'btn btnSmall', type: 'button', text: 'Next 15 days', onclick: () => quick('NEXT_15') });
    const btnQ30 = el('button', { class: 'btn btnSmall', type: 'button', text: 'Next 30 days', onclick: () => quick('NEXT_30') });
    const btnQOver = el('button', { class: 'btn btnSmall', type: 'button', text: 'Overdue', onclick: () => quick('OVERDUE') });
    const btnQAppr = el('button', { class: 'btn btnSmall', type: 'button', text: 'Approval pending', onclick: () => quick('APPROVAL_PENDING') });

    // PDFs: daily digest + monthly
    const btnDailyPdf = el('button', { class: 'btn', type: 'button', text: 'Daily digest PDF' });
    btnDailyPdf.onclick = async () => {
      const r = await apiJson('/reports_dailyDigestPdf', {});
      if (!r.ok) return toast(`Daily PDF failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({ fileName: r.fileName, base64: r.base64, mime: r.mime || 'application/pdf' });
      toast('Downloaded PDF');
    };

    const month = el('input', { class: 'input', value: opsState.monthYmd, placeholder: 'monthYmd (YYYY-MM-DD)' });
    month.addEventListener('input', () => opsState.monthYmd = month.value);

    const btnMonthlyPdf = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Monthly PDF' });
    btnMonthlyPdf.onclick = async () => {
      const r = await apiJson('/reports_monthlyPdf', { monthYmd: month.value.trim() || todayYmdIST() });
      if (!r.ok) return toast(`Monthly PDF failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({ fileName: r.fileName, base64: r.base64, mime: r.mime || 'application/pdf' });
      toast('Downloaded PDF');
    };

    return el('div', { style: 'display:flex; flex-direction:column; gap:12px' }, [
      chip('Exports & Reports', 'info'),
      el('div', { class: 'help', html: `
        Every report includes both Excel and PDF options. Firm range exports can include task history and audit logs.
      `}),
      el('div', {
        style: `
          display:grid;
          grid-template-columns: repeat(12, 1fr);
          gap: 14px;
        `
      }, [
        el('div', { style: 'grid-column: span 4' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'From' }), from])]),
        el('div', { style: 'grid-column: span 4' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'To' }), to])]),
        el('div', { style: 'grid-column: span 4' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'History' }), includeAudit])]),
        el('div', { style: 'grid-column: span 12' }, [
          el('div', { class: 'row', style: 'justify-content:flex-end' }, [btnFirmX, btnFirmP])
        ]),
        el('div', { style: 'grid-column: span 12' }, [
          el('div', { class: 'row', style: 'justify-content:flex-end; flex-wrap:wrap' }, [btnQ7, btnQ15, btnQ30, btnQOver, btnQAppr])
        ]),
        el('div', { style: 'grid-column: span 12' }, [el('div', { class: 'row', style: 'justify-content:flex-end; flex-wrap:wrap' }, [btnDailyPdf])]),
        el('div', { style: 'grid-column: span 6' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Month (any date in month)' }), month])]),
        el('div', { style: 'grid-column: span 6; display:flex; align-items:flex-end; justify-content:flex-end' }, [btnMonthlyPdf])
      ])
    ]);
  }

  /* ---------- OFFLINE UPDATE WORKFLOW ---------- */
  function offlineUpdatePanel() {
    const btnTemplate = el('button', { class: 'btn', type: 'button', text: 'Download Update Template (XLSX)' });
    btnTemplate.onclick = async () => {
      const r = await apiJson('/exports_tasksUpdateTemplateXlsx', {});
      if (!r.ok) return toast(`Template failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({ fileName: r.fileName || 'Tasks_Update_Template.xlsx', base64: r.base64, mime: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      toast('Template downloaded');
    };

    const btnExportForUpdate = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Export tasks for update (XLSX)' });
    btnExportForUpdate.onclick = async () => {
      const r = await apiJson('/exports_tasksExportForUpdateXlsx', { limitTasks: opsState.updateLimit });
      if (!r.ok) return toast(`Export failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({ fileName: r.fileName || 'tasks_export_for_update.xlsx', base64: r.base64, mime: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      toast('Exported');
    };

    const file = el('input', { class: 'input', type: 'file', accept: '.xlsx' });
    file.style.padding = '12px';

    const btnUpload = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Upload updates XLSX' });
    btnUpload.onclick = async () => {
      const f = file.files?.[0];
      if (!f) return toast('Select an XLSX file', 3600);

      const fd = new FormData();
      fd.append('file', f, f.name);

      const r = await apiForm('/tasks_bulkupdate_from_xlsx', fd);
      if (!r.ok) return toast(`Update upload failed: ${r.error || JSON.stringify(r)}`, 9000);

      const errList = (r.errors || []).slice(0, 50).map(e => `<div class="help">Row ${e.row}: ${e.taskId || ''} — ${e.error}</div>`).join('');
      await okModal.show({
        title: 'Offline update complete',
        sub: 'Results',
        bodyHtml: `
          <div class="help">Updated: <b>${r.updatedCount || 0}</b></div>
          <div class="help" style="margin-top:6px">Skipped: <b>${r.skippedCount || 0}</b></div>
          ${errList ? `<div style="margin-top:12px; font-weight:900">Errors (first 50)</div>${errList}` : `<div class="help" style="margin-top:10px">No errors.</div>`}
        `
      });

      toast('Updates applied');
      window.__cos_mountView('work');
    };

    const limit = el('input', { class: 'input', type: 'number', min: '10', max: '1200', value: String(opsState.updateLimit) });
    limit.addEventListener('input', () => opsState.updateLimit = Number(limit.value || 600));

    return el('div', { style: 'display:flex; flex-direction:column; gap:12px' }, [
      chip('Offline bulk update', 'info'),
      el('div', { class: 'help', html: `
        Workflow: Export tasks → edit offline → upload to update existing tasks. The XLSX contains TaskId (internal key) required for updates.
      `}),
      el('div', { class: 'row', style: 'justify-content:flex-end; flex-wrap:wrap' }, [
        btnTemplate,
        el('div', { class: 'field', style: 'min-width:180px' }, [el('div', { class: 'label', text: 'Export limit' }), limit]),
        btnExportForUpdate
      ]),
      el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Upload updates XLSX' }), file]),
      el('div', { class: 'row', style: 'justify-content:flex-end' }, [btnUpload]),
      el('div', { class: 'help', html: `
        Notes: completion emails are still governed by status-change logic. Offline updates record audit logs per task.
      `})
    ]);
  }

  /* ---------- SETTINGS + TEAM (Partner-only) ---------- */
  async function loadSettings() {
    const r = await apiJson('/settings_get', {});
    if (!r.ok) throw new Error(r.error || 'settings_get failed');
    opsState.settings = r.data || {};
  }
  async function loadCalendarSettings() {
    const r = await apiJson('/settings_calendar_get', {});
    if (!r.ok) throw new Error(r.error || 'settings_calendar_get failed');
    opsState.cal = r.data || {};
  }
  async function loadTeam() {
    const r = await apiJson('/users_list', {});
    if (!r.ok) throw new Error(r.error || 'users_list failed');
    opsState.team = r.users || [];
  }

  function partnerAdminPanel() {
    if (!state.isPartner) {
      return el('div', { class: 'help', html: `
        <div style="font-weight:900;color:var(--text)">Partner admin</div>
        <div style="margin-top:8px">Team & settings are partner-only. Managers can use exports and offline updates.</div>
      `});
    }

    const wrap = el('div', { style: 'display:flex; flex-direction:column; gap: 14px' });

    const btnReload = el('button', { class: 'btn btnSmall', type: 'button', text: 'Reload admin data' });
    btnReload.onclick = async () => {
      try {
        await Promise.all([loadSettings(), loadCalendarSettings(), loadTeam()]);
        toast('Admin data loaded');
        render();
      } catch (e) {
        toast(`Load failed: ${e.message || String(e)}`, 9000);
      }
    };

    // Digest settings
    const emails = el('textarea', { class: 'textarea', style: 'min-height:90px' });
    const windowDays = el('input', { class: 'input', type: 'number', min: '1', value: '30' });
    const sendToAssignees = el('select', { class: 'select' }, [
      el('option', { value: 'true', text: 'Send to assignees' }),
      el('option', { value: 'false', text: 'Do not send to assignees' })
    ]);
    const lastRun = el('input', { class: 'input', disabled: true });

    if (opsState.settings) {
      emails.value = (opsState.settings.dailyInternalEmails || []).join('; ');
      windowDays.value = String(opsState.settings.dailyWindowDays || 30);
      sendToAssignees.value = (opsState.settings.sendDailyToAssignees === false) ? 'false' : 'true';
      lastRun.value = opsState.settings.lastDailyRunYmd || '';
    }

    const btnSaveDigest = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Save digest settings' });
    btnSaveDigest.onclick = async () => {
      const r = await apiJson('/settings_update', {
        dailyInternalEmails: emails.value,
        dailyWindowDays: Number(windowDays.value || 30),
        sendDailyToAssignees: sendToAssignees.value === 'true'
      });
      if (!r.ok) return toast(`Save failed: ${r.error || JSON.stringify(r)}`, 9000);
      toast('Saved');
      await loadSettings();
      render();
    };

    const digestCard = card('Daily digest settings', 'Controls internal daily summary emails and firm window days.', btnReload, el('div', {}, [
      el('div', { style: 'display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px;' }, [
        el('div', { style: 'grid-column: span 12' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Internal emails' }), emails])]),
        el('div', { style: 'grid-column: span 4' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Window days' }), windowDays])]),
        el('div', { style: 'grid-column: span 4' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Assignees' }), sendToAssignees])]),
        el('div', { style: 'grid-column: span 4' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Last run' }), lastRun])]),
        el('div', { style: 'grid-column: span 12' }, [el('div', { class: 'row', style: 'justify-content:flex-end' }, [btnSaveDigest])])
      ])
    ]));

    // Calendar settings
    const startHH = el('input', { class: 'input', type: 'number', min: '0', max: '23' });
    const endHH = el('input', { class: 'input', type: 'number', min: '0', max: '23' });
    const tz = el('input', { class: 'input', value: 'Asia/Kolkata' });

    if (opsState.cal) {
      startHH.value = String(opsState.cal.startHH ?? 10);
      endHH.value = String(opsState.cal.endHH ?? 12);
      tz.value = opsState.cal.timeZone || 'Asia/Kolkata';
    }

    const btnSaveCal = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Save calendar settings' });
    btnSaveCal.onclick = async () => {
      const r = await apiJson('/settings_calendar_update', {
        startHH: Number(startHH.value || 10),
        endHH: Number(endHH.value || 12),
        timeZone: String(tz.value || 'Asia/Kolkata').trim()
      });
      if (!r.ok) return toast(`Save failed: ${r.error || JSON.stringify(r)}`, 9000);
      toast('Saved');
      await loadCalendarSettings();
      render();
    };

    const calCard = card('Calendar settings', 'Controls calendar event time window.', null, el('div', {}, [
      el('div', { style: 'display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px;' }, [
        el('div', { style: 'grid-column: span 4' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Start hour (0–23)' }), startHH])]),
        el('div', { style: 'grid-column: span 4' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'End hour (0–23)' }), endHH])]),
        el('div', { style: 'grid-column: span 4' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Timezone' }), tz])]),
        el('div', { style: 'grid-column: span 12' }, [el('div', { class: 'row', style: 'justify-content:flex-end' }, [btnSaveCal])])
      ])
    ]));

    // Worker/Associate import password
    const p1 = el('input', { class: 'input', type: 'password', placeholder: 'New password (leave empty to remove)' });
    const p2 = el('input', { class: 'input', type: 'password', placeholder: 'Confirm password' });

    const btnSavePass = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Save' });
    btnSavePass.onclick = async () => {
      if (p1.value !== p2.value) return toast('Passwords do not match', 6000);
      const r = await apiJson('/settings_workerImportPassword_set', { password: p1.value || '' });
      if (!r.ok) return toast(`Save failed: ${r.error || JSON.stringify(r)}`, 9000);
      toast(r.enabled ? 'Password enabled' : 'Password removed');
      p1.value = ''; p2.value = '';
    };

    const passCard = card('Associate import password', 'If enabled, associates must enter this to import XLSX. Stored as PBKDF2 hash.', null, el('div', {}, [
      el('div', { style: 'display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px;' }, [
        el('div', { style: 'grid-column: span 6' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Password' }), p1])]),
        el('div', { style: 'grid-column: span 6' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Confirm' }), p2])]),
        el('div', { style: 'grid-column: span 12' }, [el('div', { class: 'row', style: 'justify-content:flex-end' }, [btnSavePass])])
      ])
    ]));

    // Team management
    const table = el('div', { style: 'display:flex; flex-direction:column; gap:10px' });
    const btnReloadTeam = el('button', { class: 'btn btnSmall', type: 'button', text: 'Reload team' });
    btnReloadTeam.onclick = async () => {
      try { await loadTeam(); toast('Team loaded'); render(); }
      catch (e) { toast(`Team load failed: ${e.message || String(e)}`, 9000); }
    };

    function teamRow(u) {
      const name = el('input', { class: 'input', value: u.displayName || '', placeholder: 'Display name' });
      const role = el('select', { class: 'select' }, [
        el('option', { value: 'PARTNER', text: 'PARTNER' }),
        el('option', { value: 'MANAGER', text: 'MANAGER' }),
        el('option', { value: 'ASSOCIATE', text: 'ASSOCIATE' }),
      ]);
      role.value = (u.role || 'ASSOCIATE');

      const active = el('select', { class: 'select' }, [
        el('option', { value: 'true', text: 'active' }),
        el('option', { value: 'false', text: 'inactive' })
      ]);
      active.value = (u.active === false) ? 'false' : 'true';

      const mgr = el('input', { class: 'input', value: u.managerEmail || '', placeholder: 'manager@firm.com (optional)' });

      const btnSaveRole = el('button', { class: 'btn btnSmall btnPrimary', type: 'button', text: 'Save role' });
      btnSaveRole.onclick = async () => {
        const r = await apiJson('/users_setrole', {
          uid: u.uid,
          role: role.value,
          active: active.value === 'true'
        });
        if (!r.ok) return toast(`Save failed: ${r.error || JSON.stringify(r)}`, 9000);
        toast('Role saved');
        await loadTeam();
        render();
      };

      const btnSaveMgr = el('button', { class: 'btn btnSmall', type: 'button', text: 'Save manager' });
      btnSaveMgr.onclick = async () => {
        const r = await apiJson('/users_setmanager', { uid: u.uid, managerEmail: mgr.value.trim() });
        if (!r.ok) return toast(`Save failed: ${r.error || JSON.stringify(r)}`, 9000);
        toast('Manager saved');
        await loadTeam();
        render();
      };

      const btnSaveName = el('button', { class: 'btn btnSmall btnGhost', type: 'button', text: 'Save name' });
      btnSaveName.onclick = async () => {
        const r = await apiJson('/users_setdisplayname', { uid: u.uid, displayName: name.value.trim() });
        if (!r.ok) return toast(`Save failed: ${r.error || JSON.stringify(r)}`, 9000);
        toast('Name saved');
        await loadTeam();
        render();
      };

      return el('div', { class: 'card', style: 'border-radius:22px; box-shadow:none' }, [
        el('div', { class: 'cardBody', style: 'padding:12px' }, [
          el('div', { class: 'row', style: 'justify-content:space-between; align-items:flex-start' }, [
            el('div', { style: 'min-width:0; flex:1; display:flex; flex-direction:column; gap:6px' }, [
              el('div', { style: 'font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis' }, [u.email || u.uid]),
              el('div', { class: 'help', text: `UID is hidden in main UI; shown here only for admin operations.` })
            ]),
            chip(role.value, 'info')
          ]),
          el('div', { style: 'display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px; margin-top: 12px' }, [
            el('div', { style: 'grid-column: span 6' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Display name' }), name])]),
            el('div', { style: 'grid-column: span 3' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Role' }), role])]),
            el('div', { style: 'grid-column: span 3' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Active' }), active])]),
            el('div', { style: 'grid-column: span 12' }, [el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Manager email' }), mgr])]),
            el('div', { style: 'grid-column: span 12' }, [el('div', { class: 'row', style: 'justify-content:flex-end; flex-wrap:wrap' }, [btnSaveRole, btnSaveMgr, btnSaveName])])
          ])
        ])
      ]);
    }

    if (!opsState.team?.length) {
      table.appendChild(el('div', { class: 'help', text: 'No team data loaded yet. Click “Reload admin data”.' }));
    } else {
      opsState.team.forEach(u => table.appendChild(teamRow(u)));
    }

    const teamCard = card('Team', 'Manage roles, manager mapping, and display names.', btnReloadTeam, table);

    // Migration helper
    const btnDry = el('button', { class: 'btn btnSmall', type: 'button', text: 'Dry run migration (WORKER→ASSOCIATE)' });
    btnDry.onclick = async () => {
      const r = await apiJson('/roles_migrate_worker_to_associate', { dryRun: true, limit: 800 });
      if (!r.ok) return toast(`Migration dry-run failed: ${r.error || JSON.stringify(r)}`, 9000);
      await okModal.show({
        title: 'Migration dry run',
        sub: 'WORKER → ASSOCIATE',
        bodyHtml: `
          <div class="help">Found: <b>${r.found || 0}</b></div>
          <div class="help" style="margin-top:8px">Sample:</div>
          <pre style="white-space:pre-wrap; font-family: var(--mono); font-size:12px; color: var(--muted); margin:10px 0 0">${JSON.stringify(r.sample || [], null, 2)}</pre>
        `
      });
    };

    const btnRun = el('button', { class: 'btn btnSmall btnPrimary', type: 'button', text: 'Run migration' });
    btnRun.onclick = async () => {
      if (!confirm('Run migration? This will update users.role WORKER → ASSOCIATE.')) return;
      const r = await apiJson('/roles_migrate_worker_to_associate', { dryRun: false, limit: 800 });
      if (!r.ok) return toast(`Migration failed: ${r.error || JSON.stringify(r)}`, 9000);
      toast(`Migrated: ${r.updated || 0}`);
      await loadTeam();
      render();
    };

    const migCard = card('Role migration', 'One-time helper: convert legacy WORKER roles into ASSOCIATE.', null,
      el('div', { class: 'row', style: 'justify-content:flex-end; flex-wrap:wrap' }, [btnDry, btnRun])
    );

    wrap.appendChild(digestCard);
    wrap.appendChild(calCard);
    wrap.appendChild(passCard);
    wrap.appendChild(teamCard);
    wrap.appendChild(migCard);

    wrap.appendChild(el('style', { html: `
      @media (max-width: 980px){
        .cosOpsSplit{ grid-template-columns: 1fr !important; }
      }
    `}));

    return wrap;
  }

  /* ---------- Render ---------- */
  async function ensureAdminDataLoaded() {
    // Only load on demand; don’t hammer backend.
    if (state.isPartner) {
      if (!opsState.settings) { try { await loadSettings(); } catch {} }
      if (!opsState.cal) { try { await loadCalendarSettings(); } catch {} }
      if (!opsState.team?.length) { try { await loadTeam(); } catch {} }
    }
  }

  async function render() {
    mount.innerHTML = '';
    if (!state.uid) return;
    if (!(state.isPartner || state.isManager)) return mountLocked();

    await ensureAdminDataLoaded();

    const left = el('div', { style: 'display:flex; flex-direction:column; gap:14px' }, [
      card('Import', 'Create tasks from Excel with templates and validations.', chip(state.role, 'info'), importPanel()),
      card('Exports & Reports', 'XLSX + PDF options for all report screens.', null, exportsPanel()),
      card('Offline updates', 'Export → edit → upload to update tasks in bulk with audit logs.', null, offlineUpdatePanel())
    ]);

    const right = el('div', { style: 'display:flex; flex-direction:column; gap:14px' }, [
      card('Admin', 'Team + settings + migration tools (Partner-only).', state.isPartner ? chip('Partner', 'info') : chip('Manager', 'dim'), partnerAdminPanel())
    ]);

    const split = el('div', {
      style: `
        display:grid;
        grid-template-columns: minmax(340px, 1.05fr) minmax(340px, .95fr);
        gap: 14px;
        align-items:start;
      `
    }, [left, right]);

    split.classList.add('cosOpsSplit');

    mount.appendChild(el('div', { class: 'gridMax' }, [
      card('Ops & Reports', 'Exports, PDFs, offline updates, and administration. Built for production operations.', chip('Server exports', 'info'), split)
    ]));
  }

  window.__cos_mountOps = render;

  if (state.uid && state.activeView === 'ops') render();

})();
</script>

</body>
</html>