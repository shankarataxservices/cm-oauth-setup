<!-- =========================
ComplianceOS ‚Äî Part 1/8
UI Shell (OLD-UI look & feel)
- Windows 11 / glass cards
- Sticky header + sticky/collapsible sidebar (like old UI)
- Single-page scroll (fix nested scroll issues)
- Keeps ALL IDs/classes needed by your existing working backend JS (Parts 2‚Äì8)
========================= -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>ComplianceOS</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    /* ==========================================
       OLD UI palette (mapped to new code classes)
       Theme switch is driven by body[data-theme="light|dark"] (from Part 2 JS)
    ========================================== */
    :root{
      --font: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --radius-sm: 10px;
      --radius-md: 14px;
      --radius-lg: 18px;
      --radius-xl: 24px;

      --primary: #0078D4;
      --primary-hover: #006cc1;
      --danger: #ef4444;
      --warning: #f59e0b;
      --ok: #16a34a;

      /* light defaults */
      --bg-app: #f3f3f3;
      --bg0: #f3f3f3;
      --bg1: color-mix(in srgb, #f3f3f3 92%, #ffffff);

      --panelSolid: rgba(255,255,255,.92);
      --panel: rgba(255,255,255,.70);
      --panel2: rgba(255,255,255,.62);

      --text: #1b1b1b;
      --muted: #5d5d5d;

      --border: rgba(0,0,0,.06);
      --border2: rgba(0,0,0,.10);

      --shadow-sm: 0 2px 4px rgba(0,0,0,.04);
      --shadow-md: 0 8px 16px rgba(0,0,0,.06);
      --shadow-glass: 0 8px 32px rgba(31,38,135,.07);

      --backdrop-blur: blur(20px);
      --grad: linear-gradient(135deg, var(--primary), #5aa7ff 55%, #64d2ff);

      --headerH: 72px;
      --sidebarW: 290px;
      --sidebarWCollapsed: 78px;

      --noise: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
      --bgDecor:
        var(--noise),
        radial-gradient(900px 520px at 12% 10%, rgba(0,120,212,.14), transparent 55%),
        radial-gradient(900px 520px at 88% 15%, rgba(0,120,212,.10), transparent 55%),
        radial-gradient(900px 520px at 40% 92%, rgba(100,210,255,.10), transparent 60%);
      --focus: 0 0 0 4px color-mix(in srgb, var(--primary) 18%, transparent);
    }

    body[data-theme="dark"]{
      --bg-app: #0f0f10;
      --bg0: #0f0f10;
      --bg1: #0b0b0c;

      --panelSolid: #0f172a;
      --panel: rgba(25,25,28,.60);
      --panel2: rgba(255,255,255,.06);

      --text: #f4f4f5;
      --muted: #b6b6b6;

      --border: rgba(255,255,255,.10);
      --border2: rgba(255,255,255,.12);

      --shadow-glass: 0 8px 32px rgba(0,0,0,.35);

      --bgDecor:
        var(--noise),
        radial-gradient(1200px 600px at 10% 10%, rgba(0,120,212,.22), transparent 55%),
        radial-gradient(1000px 500px at 90% 20%, rgba(90,167,255,.18), transparent 55%),
        radial-gradient(900px 500px at 40% 90%, rgba(100,210,255,.14), transparent 60%);
    }

    *{ box-sizing: border-box; }
    html, body{ height: auto; min-height: 100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background: var(--bgDecor), linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x: hidden;
      overflow-y: auto; /* FIX: single page scroll */
      transition: background .25s ease, color .25s ease;
    }

    a{ color: inherit; }
    button, input, select, textarea{ font: inherit; }
    :focus-visible{ outline: none; box-shadow: var(--focus); }

/* ===== View accents (clear section/subsection color) ===== */
body[data-view="home"]{ --accent:#0ea5e9; }
body[data-view="work"]{ --accent:#8b5cf6; }
body[data-view="calendar"]{ --accent:#f97316; }
body[data-view="clients"]{ --accent:#22c55e; }
body[data-view="studio"]{ --accent:#06b6d4; }
body[data-view="ops"]{ --accent:#ef4444; }
body[data-view="help"]{ --accent:#a855f7; }

/* Accent line on card headers (subsection clarity) */
.cardHead{ position: relative; }
.cardHead::after{
  content:"";
  position:absolute;
  left:0;
  right:0;
  top:0;
  height: 3px;
  background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 78%, transparent), transparent 70%);
  pointer-events:none;
}

/* Global loading overlay + spinner */
.loadingOverlay{
  position: fixed;
  inset: 0;
  z-index: 240;
  display: none;
  place-items: center;
  background: rgba(0,0,0,.28);
  backdrop-filter: blur(6px);
}
.loadingOverlay.show{ display:grid; }
.spinner{
  width: 54px;
  height: 54px;
  border-radius: 999px;
  border: 5px solid color-mix(in srgb, #fff 25%, transparent);
  border-top-color: var(--accent);
  animation: spin .8s linear infinite;
  box-shadow: 0 10px 30px rgba(0,0,0,.18);
}
@keyframes spin{
  to { transform: rotate(360deg); }
}

    /* ==========================================
       App layout (old methodology)
       - Sticky header
       - Sticky sidebar with its own scroll
       - Main area uses page scroll (no nested scrollbars)
    ========================================== */
    .app{ min-height: 100vh; display:flex; flex-direction:column; }
    .topbar{
      height: var(--headerH);
      position: sticky;
      top: 0;
      z-index: 60;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 18px;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(12px);
      background: var(--panel);
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      user-select:none;
      min-width: 240px;
    }
    .brandMark{
      width: 42px; height: 42px;
      border-radius: 14px;
      background: var(--grad);
      box-shadow: 0 10px 24px rgba(0,120,212,.18);
      flex: 0 0 auto;
    }
    .brandText{
      display:flex; flex-direction:column;
      line-height: 1.1;
    }
    .brandText b{ font-weight: 900; letter-spacing: .2px; }
    .brandText span{ font-size: 12px; color: var(--muted); font-weight: 800; letter-spacing: .2px; }

    .topActions{ display:flex; align-items:center; gap: 10px; flex-wrap:wrap; justify-content:flex-end; }

    /* Buttons (mapped from new code classnames) */
    .btn{
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .12s ease, background .2s ease;
      font-weight: 850;
      display:inline-flex;
      align-items:center;
      gap: 10px;
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-1px); background: var(--panel); }
    .btn:active{ transform: translateY(0); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none !important; }
    .btnSmall{ padding: 8px 10px; border-radius: 10px; font-size: 13px; }
    .btnGhost{ background: transparent; border-color: var(--border); }
    .btnPrimary{
 background: var(--grad) !important;
 border-color: transparent !important;
 color: #fff !important;
}
    .btnDanger{ background: color-mix(in srgb, var(--danger) 85%, transparent); border-color: transparent; color:#fff; }
    .btnIcon{ width: 42px; height: 42px; padding:0; justify-content:center; border-radius: 12px; }

    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--panel2);
      font-weight: 900;
      font-size: 12px;
      color: var(--text);
      user-select: none;
    }

    .shell{
 display:flex;
 align-items:stretch;
 min-height: calc(100vh - var(--headerH));
 min-width: 0;
}

    /* Sidebar == .rail (keeps IDs used by new JS) */
    .rail{
      width: var(--sidebarW);
      padding: 14px;
      position: sticky;
      top: var(--headerH);
      height: calc(100vh - var(--headerH));
      overflow: auto;
      border-right: 1px solid var(--border);
      background: var(--panel);
      backdrop-filter: var(--backdrop-blur);
      box-shadow: var(--shadow-glass);
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    /* collapse/expand via body[data-rail] (your patch JS already toggles this) */
    /* collapse/expand via body[data-rail] */
body[data-rail="collapsed"] .rail{ width: var(--sidebarWCollapsed); padding: 14px 10px; }
body[data-rail="collapsed"] .railLbl{ display:none !important; }
body[data-rail="collapsed"] .railBtn{ justify-content:center; padding: 12px 10px; }
    /* Nav buttons styled like old "navItem" */
    .railBtn{
      width: 100%;
      height: 48px;
      border-radius: 14px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap: 10px;
      padding: 12px 12px;
      font-weight: 900;
      transition: background .18s ease, border-color .18s ease, transform .12s ease, color .18s ease;
      position: relative;
      text-align:left;
    }
    .railBtn:hover{
      transform: translateY(-1px);
      background: var(--panel2);
      color: var(--text);
      border-color: var(--border);
    }
    .railBtn[aria-current="page"]{
      background: color-mix(in srgb, var(--accent) 18%, transparent);
      border-color: color-mix(in srgb, var(--accent) 45%, transparent);
      color: var(--text);
    }

    /* Icon bubble (pseudo-element so Part 2 can still write btn.textContent safely) */
    .railBtn::before{
      content: "";
      width: 30px; height: 30px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--panel) 70%, transparent);
      color: var(--text);
      flex: 0 0 auto;
      font-size: 16px;
      font-weight: 900;
    }
    /* Assign icons by ID (matches old UI vibe) */
    /* Assign icons by ID (emoji icons) */
#railToggleBtn::before{ content: "‚ÜîÔ∏è"; }
#navHome::before{ content: "üè†"; }
#navWork::before{ content: "üìã"; }
#navQuickTask::before{ content: "+"; }
#navCalendar::before{ content: "üóìÔ∏è"; }
#navClients::before{ content: "üë•"; }
#navStudio::before{ content: "‚úçÔ∏è"; }
#navOps::before{ content: "‚öôÔ∏è"; }
#navHelp::before{ content: "‚ùì"; }

    /* The label span is injected by your patch JS (railLbl). Style it like old navText. */
    .railLbl{
      display:inline;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .railHint{ margin-top:auto; display:flex; flex-direction:column; gap:10px; }

    /* Main content */
    .content{ flex: 1; padding: 18px; min-width: 0; }
    .canvas{ display:block; }

    /* IMPORTANT: no inner scrolling containers */
    .view{ height:auto; overflow: visible; display:block; }
    .gridMax{ width: min(1260px, 100%); margin: 0 auto; display:flex; flex-direction:column; gap: 14px; }

    /* Cards (mapped to new code .card/.cardHead/.cardBody) */
    .card{
      border-radius: var(--radius-xl);
      border: 1px solid var(--border);
      border-top: 1px solid color-mix(in srgb, #fff 55%, transparent);
      background: var(--panel);
      backdrop-filter: var(--backdrop-blur);
      box-shadow: var(--shadow-glass);
      overflow: hidden;
    }
    body[data-theme="dark"] .card{
      border-top: 1px solid color-mix(in srgb, #fff 16%, transparent);
    }

    .cardHead{
      padding: 16px 16px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      border-bottom: 1px solid color-mix(in srgb, var(--border) 70%, transparent);
    }
    .cardHead h2{
      margin:0;
      font-size: 18px;
      font-weight: 950;
      letter-spacing:.2px;
    }
    .cardHead p{
      margin:6px 0 0;
      color: var(--muted);
      font-size: 13px;
      font-weight: 650;
      line-height: 1.35;
    }
    .cardBody{ padding: 16px; }

    .row{ display:flex; gap: 10px; flex-wrap:wrap; align-items:center; }
    .field{ display:flex; flex-direction:column; gap: 6px; min-width: 220px; flex: 1 1 220px; }
    .label{ font-size: 12px; color: var(--muted); font-weight: 900; letter-spacing: .2px; }
    .help{ color: var(--muted); font-size: 13px; font-weight: 650; line-height: 1.35; }

    .input,.select,.textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border2);
      background: color-mix(in srgb, var(--panelSolid) 92%, transparent);
      color: var(--text);
      outline:none;
      font-size: 14px;
      font-weight: 650;
    }
    body[data-theme="dark"] .input,
    body[data-theme="dark"] .select,
    body[data-theme="dark"] .textarea{
      background: color-mix(in srgb, #0b1220 70%, transparent);
      border-color: var(--border2);
    }
    .textarea{ min-height: 120px; resize: vertical; line-height: 1.45; }

    /* Dialogs (keep same IDs/classes used by Part 2 JS; styled closer to old cmdk/modal) */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      display:none;
      z-index: 90;
    }
    .overlay.show{ display:block; }

    .dialog{
      position: fixed;
      inset: 0;
      display:none;
      z-index: 100;
      place-items:center;
      padding: 18px;
    }
    .dialog.show{ display:grid; }

    .dialogPanel{
      width: min(900px, 96vw);
      max-height: min(86vh, 900px);
      overflow: hidden;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: var(--panelSolid);
      box-shadow: var(--shadow-glass);
      display:flex;
      flex-direction:column;
    }
    .dialogHead{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--border);
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:flex-start;
    }
    .dialogTitle b{ font-weight: 950; letter-spacing: .2px; }
    .dialogTitle span{ color: var(--muted); font-weight: 650; font-size: 13px; }
    .dialogBody{ padding: 14px; overflow: auto; }
    .dialogFoot{
      padding: 14px;
      border-top: 1px solid var(--border);
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap:wrap;
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      z-index: 200;
      display:none;
      max-width: min(920px, 92vw);
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(17,24,39,.95);
      color: #fff;
      padding: 10px 14px;
      font-weight: 850;
      font-size: 13px;
      box-shadow: var(--shadow-md);
      word-break: break-word;
    }
    .toast.show{ display:block; }

    /* Signed-out layout: centered card and hide sidebar (CSS hook; set by JS later if you want) */
    body[data-auth="out"] .rail{ display:none; }
    body[data-auth="out"] .content{ padding: 22px 16px; }
    body[data-auth="out"] .gridMax{ width: min(860px, 100%); }

    /* Mobile: sidebar becomes off-canvas like old UI */
    #btnMenu{ display:none; }
    @media (max-width: 980px){
      #btnMenu{ display:inline-flex; }
      .rail{
        position: fixed;
        left: 0;
        top: var(--headerH);
        height: calc(100vh - var(--headerH));
        transform: translateX(-105%);
        transition: transform .25s ease;
        z-index: 120;
      }
      body[data-sidebar="open"] .rail{ transform: translateX(0); }
      .content{ padding: 16px; }
    }

    /* Utility */
    .srOnly{
      position:absolute!important;
      width:1px;height:1px;
      padding:0;margin:-1px;overflow:hidden;
      clip: rect(0,0,0,0);white-space:nowrap;border:0;
    }
  </style>
</head>

<body data-theme="light" data-rail="expanded" data-auth="out" data-view="home">
  <div class="app" id="appRoot" aria-live="polite">
    <!-- Header -->
    <header class="topbar">
      <div class="brand" role="banner">
        <div class="brandMark" aria-hidden="true"></div>
        <div class="brandText">
          <b>ComplianceOS</b>
          <span id="envHint">Tasks ¬∑ Calendar ¬∑ Reminders</span>
        </div>
      </div>

      <div class="topActions">
        <!-- Mobile menu (pure UI helper; doesn‚Äôt touch backend) -->
        <button class="btn btnSmall" id="btnMenu" type="button" aria-label="Menu">Menu</button>

        <!-- IDs expected by your working JS (Part 2) -->
        <button class="btn btnSmall btnGhost" id="btnCmd" type="button" aria-haspopup="dialog" aria-controls="cmdDialog">
          Search
          <span class="chip" aria-hidden="true"><span style="font-family:var(--mono);font-weight:900">Ctrl</span>+<span style="font-family:var(--mono);font-weight:900">K</span></span>
        </button>

        <button class="btn btnSmall" id="btnTheme" type="button">Theme</button>

        <div class="chip" id="chipRole" title="Role">Signed out</div>

        <button class="btn btnSmall btnPrimary" id="btnAuth" type="button">Sign in</button>
      </div>
    </header>

    <div class="shell">
      <!-- Sidebar / Nav (IDs expected by your working JS) -->
      <nav class="rail" aria-label="Primary">
 <button class="railBtn" id="railToggleBtn" type="button" title="Expand / collapse" aria-label="Expand / collapse">
  <span class="railLbl">Collapse</span>
 </button>

 <button class="railBtn" id="navHome" type="button" aria-current="page" title="Overview" aria-label="Overview">
  <span class="railLbl">Overview</span>
 </button>

 <button class="railBtn" id="navWork" type="button" title="Work Queue" aria-label="Work Queue">
  <span class="railLbl">Work Queue</span>
 </button>

 <!-- Quick one-task create (LEFT sidebar) -->
 <button class="railBtn" id="navQuickTask" type="button" title="Quick task" aria-label="Quick task">
  <span class="railLbl">Quick task</span>
 </button>

 <button class="railBtn" id="navCalendar" type="button" title="Timeline" aria-label="Timeline">
  <span class="railLbl">Timeline</span>
 </button>

 <button class="railBtn" id="navClients" type="button" title="Clients" aria-label="Clients">
  <span class="railLbl">Clients</span>
 </button>

 <button class="railBtn" id="navStudio" type="button" title="Studio" aria-label="Studio">
  <span class="railLbl">Studio</span>
 </button>

 <button class="railBtn" id="navOps" type="button" title="Ops & Reports" aria-label="Ops & Reports">
  <span class="railLbl">Ops & Reports</span>
 </button>

 <div class="railHint">
  <button class="railBtn" id="navHelp" type="button" title="Help" aria-label="Help">
   <span class="railLbl">Help</span>
  </button>
 </div>
</nav>

      <!-- Main -->
      <main class="content" role="main">
        <section class="canvas">

          <!-- Signed-out card (kept OUTSIDE viewMount so it won‚Äôt be deleted by view re-renders) -->
          <div class="view" id="signedOutCard">
            <div class="gridMax">
              <div class="card">
                <div class="cardHead">
                  <div>
                    <h2>Sign in</h2>
                    <p>Timezone: <b>Asia/Kolkata (IST)</b>. Dates: <b>DD-MM-YYYY</b>.</p>
                  </div>
                  <div class="row">
                    <button class="btn btnSmall btnPrimary" id="btnOpenAuth" type="button">Sign in</button>
                  </div>
                </div>
                <div class="cardBody">
                  <div class="row">
                    <div class="field">
                      <div class="label">Email</div>
                      <input class="input" id="authEmail" type="email" autocomplete="username" placeholder="name@firm.com" />
                      <div class="help">Use your firm email.</div>
                    </div>
                    <div class="field">
                      <div class="label">Password</div>
                      <input class="input" id="authPass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                      <div class="help">Minimum 6 characters (Firebase).</div>
                    </div>
                  </div>

                  <div class="row" style="margin-top:12px">
                    <button class="btn btnPrimary" id="btnQuickLogin" type="button">Sign in</button>
                    <button class="btn" id="btnQuickSignup" type="button">Create account</button>
                    <button class="btn btnGhost" id="btnQuickForgot" type="button">Forgot password</button>
                  </div>

                  <div class="help" style="margin-top:12px">
                    Tip: Press <span style="font-family:var(--mono);font-weight:900">Ctrl/Cmd + K</span> to search quickly.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Signed-in placeholder (also outside viewMount) -->
          <div class="view" id="signedInPlaceholder" style="display:none">
            <div class="gridMax">
              <div class="card">
                <div class="cardHead">
                  <div>
                    <h2>Loading your workspace‚Ä¶</h2>
                    <p>Syncing clients, tasks, and settings.</p>
                  </div>
                </div>
                <div class="cardBody">
                  <div class="help">If this takes long, check network or refresh.</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Actual view mount target (Parts 3‚Äì8 render into this) -->
          <div class="view" id="viewMount"></div>

        </section>
      </main>
    </div>
  </div>

  <!-- Overlay (shared by dialogs + inspector in your JS) -->
  <div class="overlay" id="overlay"></div>

  <!-- Auth dialog (required by your Part 2 JS) -->
  <div class="dialog" id="authDialog" role="dialog" aria-modal="true" aria-labelledby="authTitle">
    <div class="dialogPanel">
      <div class="dialogHead">
        <div class="dialogTitle">
          <b id="authTitle">Account</b>
          <span id="authSub">Sign in, create account, or reset password.</span>
        </div>
        <button class="btn btnSmall btnGhost" id="authClose" type="button" aria-label="Close">Close</button>
      </div>
      <div class="dialogBody" id="authBody"></div>
      <div class="dialogFoot" id="authFoot"></div>
    </div>
  </div>

  <!-- Command palette dialog (required by your Part 2 JS) -->
  <div class="dialog" id="cmdDialog" role="dialog" aria-modal="true" aria-labelledby="cmdTitle">
    <div class="dialogPanel">
      <div class="dialogHead">
        <div class="dialogTitle">
          <b id="cmdTitle">Search</b>
          <span>Search tasks, clients, exports, reports. Keyboard-first.</span>
        </div>
        <button class="btn btnSmall btnGhost" id="cmdClose" type="button" aria-label="Close">Close</button>
      </div>
      <div class="dialogBody" id="cmdBody"></div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- Global loading overlay (shown for ALL network ops) -->
  <div class="loadingOverlay" id="loadingOverlay" aria-hidden="true">
    <div class="spinner" role="status" aria-live="polite" aria-label="Loading">
      <span class="srOnly">Loading‚Ä¶</span>
    </div>
  </div>

  <!-- Firebase scripts (Parts 2‚Äì8 expect these) -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <!-- Tiny UI-only helpers (does NOT touch backend) -->
  <script>
(function () {
  // Mobile menu toggle (old UI style)
  const btnMenu = document.getElementById('btnMenu');
  if (btnMenu) {
    btnMenu.addEventListener('click', () => {
      const open = document.body.getAttribute('data-sidebar') === 'open';
      document.body.setAttribute('data-sidebar', open ? 'closed' : 'open');
    });

    // close sidebar when clicking outside (mobile)
    document.addEventListener('click', (e) => {
      const isMobile = window.matchMedia && window.matchMedia('(max-width: 980px)').matches;
      if (!isMobile) return;
      if (document.body.getAttribute('data-sidebar') !== 'open') return;
      const rail = document.querySelector('.rail');
      const inRail = rail && rail.contains(e.target);
      const inBtn = btnMenu.contains(e.target);
      if (!inRail && !inBtn) document.body.setAttribute('data-sidebar', 'closed');
    });
  }

  // Sidebar expand/collapse
  const RAIL_KEY = 'cos_rail_state'; // 'expanded' | 'collapsed'
  const toggle = document.getElementById('railToggleBtn');

  function isMobile() {
    return window.matchMedia && window.matchMedia('(max-width: 980px)').matches;
  }

  function applyRail(state) {
    // On mobile we keep it expanded (titles are useful) but you can force collapsed if you want
    const next = (state === 'collapsed') ? 'collapsed' : 'expanded';
    document.body.setAttribute('data-rail', next);
    localStorage.setItem(RAIL_KEY, next);

    if (toggle) {
      const lbl = toggle.querySelector('.railLbl');
      if (lbl) lbl.textContent = (next === 'expanded') ? 'Collapse' : 'Expand';
    }
  }

  if (toggle) {
    toggle.addEventListener('click', () => {
      const cur = localStorage.getItem(RAIL_KEY) || document.body.getAttribute('data-rail') || 'expanded';
      applyRail(cur === 'expanded' ? 'collapsed' : 'expanded');
    });
  }

  // init
  applyRail(localStorage.getItem(RAIL_KEY) || document.body.getAttribute('data-rail') || 'expanded');

  // if resize crosses mobile, keep state consistent
  window.addEventListener('resize', () => {
    applyRail(localStorage.getItem(RAIL_KEY) || 'expanded');
  });
})();
</script>

  <script>
/* =========================
 ComplianceOS ‚Äî Part 2/8 (OLD-UI feel, NEW backend/runtime)
 Core runtime: config, theme, dialogs, routing, command palette, API layer
 - Works with Part 1/8 IDs/classes you now have
 - Avoids overwriting sidebar button contents (so labels injected later won‚Äôt break)
 ========================= */
(() => {
  'use strict';

  /* ---------- CONFIG ---------- */
  // Set this to your live Functions base (same as your working backend setup)
  const BACKEND_BASE_URL = "https://graduated-seo-accepts-ribbon.trycloudflare.com/.netlify/functions";
  const IST_TZ = "Asia/Kolkata";

  const firebaseConfig = {
    apiKey: "AIzaSyCnWS-V96J6YDBVYKOeL5p8aa45GPTdSEg",
    authDomain: "compliance-management-484405.firebaseapp.com",
    projectId: "compliance-management-484405",
    storageBucket: "compliance-management-484405.firebasestorage.app",
    messagingSenderId: "4348274796",
    appId: "1:4348274796:web:a9e1720c2ae223035bd049",
    measurementId: "G-06QR8MTCSR"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  /* ---------- DOM helpers ---------- */
  const $ = (id) => document.getElementById(id);
  const el = (tag, attrs = {}, children = []) => {
    const n = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs || {})) {
      if (k === 'class') n.className = v;
      else if (k === 'text') n.textContent = v;
      else if (k === 'html') n.innerHTML = v;
      else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
      else if (v === false || v === null || v === undefined) continue;
      else n.setAttribute(k, String(v));
    }
    for (const c of (children || [])) n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
    return n;
  };
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

  /* ---------- Toast ---------- */
  const toastNode = $('toast');
  let toastTimer = null;
  function toast(msg, ms = 2600) {
    if (!toastNode) return;
    toastNode.textContent = String(msg || '');
    toastNode.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toastNode.classList.remove('show'), ms);
  }

  /* ---------- Global loading spinner (ALL network ops) ---------- */
  const loadingOverlay = $('loadingOverlay');
  let loadingCount = 0;
  function loadingStart() {
    loadingCount++;
    if (loadingOverlay) loadingOverlay.classList.add('show');
  }
  function loadingStop() {
    loadingCount = Math.max(0, loadingCount - 1);
    if (!loadingCount && loadingOverlay) loadingOverlay.classList.remove('show');
  }

  /* ---------- Date helpers (IST) ---------- */
  function ymdInTZ(date, timeZone) {
    const parts = new Intl.DateTimeFormat('en-CA', {
      timeZone,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).formatToParts(date);
    const m = Object.fromEntries(parts.map(p => [p.type, p.value]));
    return `${m.year}-${m.month}-${m.day}`;
  }
  function todayYmdIST() { return ymdInTZ(new Date(), IST_TZ); }
  function dmyToYmd(dmy) {
    const s = String(dmy || '').trim();
    const m = /^(\d{2})-(\d{2})-(\d{4})$/.exec(s);
    if (!m) throw new Error(`Invalid date "${s}". Use DD-MM-YYYY`);
    return `${m[3]}-${m[2]}-${m[1]}`;
  }
  function ymdToDmy(ymd) {
    const s = String(ymd || '').trim();
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
    if (!m) return '';
    return `${m[3]}-${m[2]}-${m[1]}`;
  }
  function dateFromYmdIST(ymd) { return new Date(`${ymd}T00:00:00+05:30`); }
  function diffDaysIST(fromYmd, toYmd) {
    const a = dateFromYmdIST(fromYmd).getTime();
    const b = dateFromYmdIST(toYmd).getTime();
    return Math.floor((b - a) / (24 * 3600 * 1000));
  }

  /* ---------- Theme (old UI feel; uses body[data-theme]) ---------- */
  const THEME_KEY = "cos_theme";        // "dark" | "light"
  const THEME_AUTO_KEY = "cos_theme_auto"; // "true" | "false"

  function applyTheme(t) {
    document.body.setAttribute('data-theme', (t === 'dark') ? 'dark' : 'light');
  }
  function applyAutoThemeIfEnabled() {
    const auto = (localStorage.getItem(THEME_AUTO_KEY) !== 'false'); // default true
    if (!auto) return;
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const t = prefersDark ? 'dark' : 'light';
    localStorage.setItem(THEME_KEY, t);
    applyTheme(t);
  }

  applyTheme(localStorage.getItem(THEME_KEY) || 'light');
  applyAutoThemeIfEnabled();

  if (window.matchMedia) {
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyAutoThemeIfEnabled);
  }

  $('btnTheme')?.addEventListener('click', () => {
    localStorage.setItem(THEME_AUTO_KEY, 'false');
    const cur = document.body.getAttribute('data-theme') || 'light';
    const next = (cur === 'dark') ? 'light' : 'dark';
    localStorage.setItem(THEME_KEY, next);
    applyTheme(next);
  });

  /* ---------- Mobile sidebar (UI only) ---------- */
  function closeSidebarIfMobile() {
    const isMobile = window.matchMedia && window.matchMedia('(max-width: 980px)').matches;
    if (!isMobile) return;
    document.body.setAttribute('data-sidebar', 'closed');
  }

  /* ---------- Dialog system (focus trap + ESC) ---------- */
  const overlay = $('overlay');
  const dialogs = {
    auth: $('authDialog'),
    cmd: $('cmdDialog')
  };
  let activeDialog = null;
  let lastFocus = null;

  function focusables(root) {
    const sel = [
      'a[href]',
      'button:not([disabled])',
      'input:not([disabled])',
      'select:not([disabled])',
      'textarea:not([disabled])',
      '[tabindex]:not([tabindex="-1"])'
    ].join(',');
    return Array.from(root.querySelectorAll(sel))
      .filter(n => n.offsetParent !== null && !n.hasAttribute('aria-hidden'));
  }

  function trapKeydown(e) {
    if (!activeDialog) return;
    if (e.key === 'Escape') {
      e.preventDefault();
      closeDialog(activeDialog);
      return;
    }
    if (e.key !== 'Tab') return;
    const nodes = focusables(activeDialog);
    if (!nodes.length) return;
    const first = nodes[0];
    const last = nodes[nodes.length - 1];
    if (e.shiftKey && document.activeElement === first) {
      e.preventDefault();
      last.focus();
    } else if (!e.shiftKey && document.activeElement === last) {
      e.preventDefault();
      first.focus();
    }
  }

  function openDialog(node, { initialFocusId } = {}) {
    if (!node) return;
    if (activeDialog) closeDialog(activeDialog);
    lastFocus = document.activeElement;
    activeDialog = node;
    overlay?.classList.add('show');
    node.classList.add('show');
    document.addEventListener('keydown', trapKeydown, true);
    const focusTarget = initialFocusId ? $(initialFocusId) : null;
    setTimeout(() => {
      const nodes = focusables(node);
      (focusTarget || nodes[0] || node).focus?.();
    }, 0);
  }

  function closeDialog(node) {
    if (!node) return;
    node.classList.remove('show');
    overlay?.classList.remove('show');
    document.removeEventListener('keydown', trapKeydown, true);
    activeDialog = null;
    setTimeout(() => lastFocus?.focus?.(), 0);
  }

  overlay?.addEventListener('click', () => {
    // If inspector is open (Part 6), it also uses the same overlay.
    // Dialog close is safe here because Part 6 adds its own guard.
    if (activeDialog) closeDialog(activeDialog);
  });

  $('authClose')?.addEventListener('click', () => closeDialog(dialogs.auth));
  $('cmdClose')?.addEventListener('click', () => closeDialog(dialogs.cmd));

  /* ---------- API layer ---------- */
  function joinUrl(base, fnPath) {
    if (!fnPath) return base;
    return base + (fnPath.startsWith('/') ? fnPath : `/${fnPath}`);
  }

  async function apiJson(fnPath, bodyObj) {
    const user = auth.currentUser;
    if (!user) return { ok: false, error: 'Not signed in' };

    loadingStart();
    try {
      const token = await user.getIdToken();
      const res = await fetch(joinUrl(BACKEND_BASE_URL, fnPath), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(bodyObj || {})
      });
      const txt = await res.text();
      let data = null;
      try { data = JSON.parse(txt); } catch { data = { raw: txt }; }
      data.httpOk = res.ok;
      data.status = res.status;
      if (data.ok === undefined) data.ok = res.ok;
      return data;
    } finally {
      loadingStop();
    }
  }

  async function apiForm(fnPath, formData) {
    const user = auth.currentUser;
    if (!user) return { ok: false, error: 'Not signed in' };

    loadingStart();
    try {
      const token = await user.getIdToken();
      const res = await fetch(joinUrl(BACKEND_BASE_URL, fnPath), {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData
      });
      const txt = await res.text();
      let data = null;
      try { data = JSON.parse(txt); } catch { data = { raw: txt }; }
      data.httpOk = res.ok;
      data.status = res.status;
      if (data.ok === undefined) data.ok = res.ok;
      return data;
    } finally {
      loadingStop();
    }
  }

  function downloadBase64({ fileName, base64, mime = 'application/octet-stream' }) {
    const bytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
    const blob = new Blob([bytes], { type: mime });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fileName || 'download.bin';
    a.click();
    setTimeout(() => URL.revokeObjectURL(a.href), 1200);
  }

  async function safeCopy(text) {
    const t = String(text ?? '');
    try {
      await navigator.clipboard.writeText(t);
      return true;
    } catch {
      const ta = document.createElement('textarea');
      ta.value = t;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      return true;
    }
  }

  /* ---------- App state ---------- */
  const state = {
    uid: null,
    email: null,
    role: 'ASSOCIATE',
    displayName: '',
    isPartner: false,
    isManager: false,
    isAssociate: true,
    clients: [],
    tasks: [],
    settings: null,
    calendarSettings: null,

    activeView: 'home',
    inspectorTaskId: null,

    cmd: {
      items: [],
      filtered: [],
      activeIndex: 0
    }
  };

  function normalizeRole(r) {
    const x = String(r || '').toUpperCase().trim();
    if (!x || x === 'WORKER') return 'ASSOCIATE';
    return x;
  }

  function setRole(role) {
    const r = normalizeRole(role);
    state.role = r;
    state.isPartner = (r === 'PARTNER');
    state.isManager = (r === 'MANAGER');
    state.isAssociate = (r === 'ASSOCIATE');

    $('chipRole').textContent = `${r}${state.email ? ` ¬∑ ${state.email}` : ''}`;

    // Role-based nav visibility (same logic as your working backend build)
    if ($('navClients')) $('navClients').style.display = state.isPartner ? '' : 'none';
    if ($('navOps')) $('navOps').style.display = (state.isPartner || state.isManager) ? '' : 'none';
  }

  /* ---------- Navigation ---------- */
  const nav = {
    home: $('navHome'),
    work: $('navWork'),
    calendar: $('navCalendar'),
    clients: $('navClients'),
    studio: $('navStudio'),
    ops: $('navOps'),
    help: $('navHelp')
  };

  function setActiveNav(key) {
    for (const [k, b] of Object.entries(nav)) {
      if (!b) continue;
      if (k === key) b.setAttribute('aria-current', 'page');
      else b.removeAttribute('aria-current');
    }
    state.activeView = key;
  }

  function routeTo(key) {
    closeSidebarIfMobile();
    document.body.setAttribute('data-view', key); // accent changes by section
    setActiveNav(key);
    window.__cos_mountView?.(key);
  }

  nav.home?.addEventListener('click', () => routeTo('home'));
  nav.work?.addEventListener('click', () => routeTo('work'));

  // Quick one-task create (no navigation needed)
  $('navQuickTask')?.addEventListener('click', () => {
    closeSidebarIfMobile();
    if (typeof window.__cos_openCreateOneTask === 'function') window.__cos_openCreateOneTask();
    else toast('Task composer is loading‚Ä¶', 2200);
  });

  nav.calendar?.addEventListener('click', () => routeTo('calendar'));
  nav.clients?.addEventListener('click', () => routeTo('clients'));
  nav.studio?.addEventListener('click', () => routeTo('studio'));
  nav.ops?.addEventListener('click', () => routeTo('ops'));
  nav.help?.addEventListener('click', () => routeTo('help'));

  /* ---------- Auth dialog UI ---------- */
  const authBody = $('authBody');
  const authFoot = $('authFoot');

  function renderAuthDialog(mode = 'signin') {
    authBody.innerHTML = '';
    authFoot.innerHTML = '';

    const email = el('input', {
      class: 'input',
      id: 'dlgEmail',
      type: 'email',
      autocomplete: 'username',
      value: $('authEmail')?.value || ''
    });

    const pass = el('input', {
      class: 'input',
      id: 'dlgPass',
      type: 'password',
      autocomplete: mode === 'signup' ? 'new-password' : 'current-password',
      value: $('authPass')?.value || ''
    });

    const block = el('div', { class: 'card', style: 'border-radius:16px; box-shadow:none' }, [
      el('div', { class: 'cardBody' }, [
        el('div', { class: 'row' }, [
          el('div', { class: 'field' }, [
            el('div', { class: 'label', text: 'Email' }),
            email,
            el('div', { class: 'help', text: 'Use your firm email.' })
          ]),
          el('div', { class: 'field' }, [
            el('div', { class: 'label', text: mode === 'forgot' ? 'New password is set via email' : 'Password' }),
            pass,
            el('div', { class: 'help', text: mode === 'forgot' ? 'We will email you a reset link.' : 'Minimum 6 characters.' })
          ])
        ])
      ])
    ]);

    if (mode === 'forgot') pass.setAttribute('disabled', 'disabled');
    authBody.appendChild(block);

    const btnSignin = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Sign in' });
    const btnSignup = el('button', { class: 'btn', type: 'button', text: 'Create account' });
    const btnForgot = el('button', { class: 'btn btnGhost', type: 'button', text: 'Forgot password' });
    const btnLogout = el('button', { class: 'btn btnDanger', type: 'button', text: 'Sign out' });
    const btnResetSend = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Send reset email' });

    if (!auth.currentUser) {
      authFoot.appendChild(btnSignin);
      authFoot.appendChild(btnSignup);
      authFoot.appendChild(btnForgot);
    } else {
      authFoot.appendChild(btnLogout);
    }

    if (mode === 'forgot') {
      authFoot.innerHTML = '';
      authFoot.appendChild(btnResetSend);
      authFoot.appendChild(el('button', { class: 'btn btnGhost', type: 'button', text: 'Back to sign in', onclick: () => renderAuthDialog('signin') }));
    }

    btnSignin.onclick = async () => {
      const e = String(email.value || '').trim();
      const p = String(pass.value || '');
      if (!e || !p) return toast('Enter email and password', 3600);
      try {
        await auth.signInWithEmailAndPassword(e, p);
        toast('Signed in');
        closeDialog(dialogs.auth);
      } catch (err) {
        toast(`Sign in failed: ${err?.message || err?.code || String(err)}`, 7000);
      }
    };

    btnSignup.onclick = async () => {
      const e = String(email.value || '').trim();
      const p = String(pass.value || '');
      if (!e || !p) return toast('Enter email and password', 3600);
      try {
        const cred = await auth.createUserWithEmailAndPassword(e, p);
        const dn = e.split('@')[0] || e;

        // Create/merge user profile via backend (Admin SDK) ‚Äî permanent fix for rules issues
        const r = await apiJson('/users_initself', { displayName: dn });
        if (!r.ok) toast(`Account created, but profile init failed: ${r.error || JSON.stringify(r)}`, 9000);
        else toast('Account created');

        closeDialog(dialogs.auth);
      } catch (err) {
        toast(`Signup failed: ${err?.message || err?.code || String(err)}`, 8000);
      }
    };

    btnForgot.onclick = () => renderAuthDialog('forgot');

    btnResetSend.onclick = async () => {
      const e = String(email.value || '').trim();
      if (!e) return toast('Enter your email', 3600);
      try {
        await auth.sendPasswordResetEmail(e);
        toast('Reset email sent', 4500);
        renderAuthDialog('signin');
      } catch (err) {
        toast(`Reset failed: ${err?.message || err?.code || String(err)}`, 9000);
      }
    };

    btnLogout.onclick = async () => {
      try {
        await auth.signOut();
        toast('Signed out');
        closeDialog(dialogs.auth);
      } catch (err) {
        toast(`Sign out failed: ${err?.message || String(err)}`, 6000);
      }
    };

    setTimeout(() => (mode === 'forgot' ? email : (pass.value ? pass : email)).focus?.(), 0);
  }

  function openAuth() {
    renderAuthDialog('signin');
    openDialog(dialogs.auth, { initialFocusId: 'dlgEmail' });
  }

  $('btnAuth')?.addEventListener('click', openAuth);
  $('btnOpenAuth')?.addEventListener('click', openAuth);

  $('btnQuickLogin')?.addEventListener('click', async () => {
    const e = String($('authEmail')?.value || '').trim();
    const p = String($('authPass')?.value || '');
    if (!e || !p) return toast('Enter email and password', 3600);
    try {
      await auth.signInWithEmailAndPassword(e, p);
      toast('Signed in');
    } catch (err) {
      toast(`Sign in failed: ${err?.message || err?.code || String(err)}`, 8000);
    }
  });

  $('btnQuickSignup')?.addEventListener('click', async () => {
    const e = String($('authEmail')?.value || '').trim();
    const p = String($('authPass')?.value || '');
    if (!e || !p) return toast('Enter email and password', 3600);
    try {
      const cred = await auth.createUserWithEmailAndPassword(e, p);
      const dn = e.split('@')[0] || e;

      const r = await apiJson('/users_initself', { displayName: dn });
      if (!r.ok) toast(`Account created, but profile init failed: ${r.error || JSON.stringify(r)}`, 9000);
      else toast('Account created');
    } catch (err) {
      toast(`Signup failed: ${err?.message || err?.code || String(err)}`, 9000);
    }
  });

  $('btnQuickForgot')?.addEventListener('click', () => {
    openAuth();
    renderAuthDialog('forgot');
  });

  /* ---------- Command palette UI ---------- */
  const cmdBody = $('cmdBody');

  function buildCmdUI() {
    cmdBody.innerHTML = '';
    const input = el('input', {
      class: 'input',
      id: 'cmdInput',
      type: 'text',
      placeholder: 'Type to search‚Ä¶ (tasks, clients, exports, reports)'
    });

    const list = el('div', { id: 'cmdList', style: 'display:flex;flex-direction:column;gap:10px;margin-top:12px' });

    const help = el('div', {
      class: 'help',
      html: `
        <div><b>Enter</b> to open ¬∑ <b>‚Üë/‚Üì</b> to navigate ¬∑ <b>Esc</b> to close</div>
        <div style="margin-top:8px">Try: <span style="font-family:var(--mono);font-weight:900">export</span>, <span style="font-family:var(--mono);font-weight:900">pdf</span>, <span style="font-family:var(--mono);font-weight:900">update xlsx</span>, <span style="font-family:var(--mono);font-weight:900">client</span>.</div>
      `
    });

    cmdBody.appendChild(input);
    cmdBody.appendChild(list);
    cmdBody.appendChild(el('div', { style: 'margin-top:12px' }, [help]));

    input.addEventListener('input', () => filterCmd(input.value));
    input.addEventListener('keydown', (e) => onCmdKeydown(e));

    window.__cos_cmd = { input, list };
  }

  function cmdItemCard(item, isActive) {
    const title = el('div', { style: 'font-weight:950;letter-spacing:.2px', text: item.title });
    const meta = el('div', { class: 'help', text: item.meta || '' });

    const badge = el('div', { class: 'chip', text: item.kind, style: 'margin-left:auto' });

    const wrap = el('button', {
      class: 'btn btnGhost',
      type: 'button',
      style: `
        width:100%;
        justify-content:flex-start;
        align-items:flex-start;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 14px;
        background: ${isActive ? 'color-mix(in srgb, var(--primary) 12%, transparent)' : 'transparent'};
        border-color: ${isActive ? 'color-mix(in srgb, var(--primary) 35%, transparent)' : 'var(--border)'};
      `
    });

    wrap.appendChild(el('div', { style: 'display:flex;flex-direction:column;gap:6px;min-width:0;flex:1;text-align:left' }, [title, meta]));
    wrap.appendChild(badge);
    wrap.addEventListener('click', () => runCmd(item));
    return wrap;
  }

  function buildCmdItems() {
    const items = [];

    items.push(
      { kind: 'Go', title: 'Overview', meta: 'Dashboard & KPIs', run: () => routeTo('home') },
      { kind: 'Go', title: 'Work Queue', meta: 'Filters, bulk actions, approvals', run: () => routeTo('work') },
      { kind: 'Go', title: 'Timeline', meta: 'Calendar + agenda', run: () => routeTo('calendar') },
      ...(state.isPartner ? [{ kind: 'Go', title: 'Clients', meta: 'Create & edit clients, exports', run: () => routeTo('clients') }] : []),
      { kind: 'Go', title: 'Studio', meta: 'Email templates + Excel-safe copy', run: () => routeTo('studio') },
      ...((state.isPartner || state.isManager) ? [{ kind: 'Go', title: 'Ops & Reports', meta: 'PDF/XLSX exports + offline update', run: () => routeTo('ops') }] : [])
    );

    if (state.isPartner || state.isManager) {
      items.push(
        { kind: 'Export', title: 'Firm range ‚Äî XLSX (with history)', meta: 'Pick date range in Ops', run: () => routeTo('ops') },
        { kind: 'Report', title: 'Firm range ‚Äî PDF', meta: 'Pick date range in Ops', run: () => routeTo('ops') },
        { kind: 'Offline', title: 'Export tasks for update (XLSX)', meta: 'Download update file, edit offline, upload back', run: () => routeTo('ops') },
        { kind: 'Offline', title: 'Upload offline updates (XLSX)', meta: 'Bulk update existing tasks', run: () => routeTo('ops') }
      );
    }

    const tdy = todayYmdIST();
    for (const t of (state.tasks || []).slice(0, 1200)) {
      const clientName = state.clientsById?.get(t.clientId)?.name || '';
      const due = t.dueDateYmd ? ymdToDmy(t.dueDateYmd) : '';
      const dd = t.dueDateYmd ? diffDaysIST(tdy, t.dueDateYmd) : null;
      const urgency =
        (t.status === 'COMPLETED') ? 'done' :
        (dd !== null && dd < 0 ? 'overdue' : (dd !== null && dd <= 3 ? 'soon' : ''));

      items.push({
        kind: 'Task',
        title: t.title || '(task)',
        meta: `${clientName}${due ? ` ¬∑ Due ${due}` : ''}${t.status ? ` ¬∑ ${t.status}` : ''}${urgency ? ` ¬∑ ${urgency}` : ''}`,
        run: () => {
          routeTo('work');
          window.__cos_openTask?.(t.id);
        }
      });
    }

    if (state.isPartner) {
      for (const c of (state.clients || []).slice(0, 700)) {
        items.push({
          kind: 'Client',
          title: c.name || '(client)',
          meta: c.primaryEmail || '',
          run: () => {
            routeTo('clients');
            window.__cos_openClient?.(c.id);
          }
        });
      }
    }

    state.cmd.items = items;
  }

  function filterCmd(query) {
    const q = String(query || '').trim().toLowerCase();
    buildCmdItems();
    const items = state.cmd.items;
    const filtered = !q ? items.slice(0, 24) : items.filter(it => {
      const hay = `${it.kind} ${it.title} ${it.meta || ''}`.toLowerCase();
      return hay.includes(q);
    }).slice(0, 40);
    state.cmd.filtered = filtered;
    state.cmd.activeIndex = 0;
    renderCmd();
  }

  function renderCmd() {
    const { list } = window.__cos_cmd || {};
    if (!list) return;
    list.innerHTML = '';
    if (!state.cmd.filtered.length) {
      list.appendChild(el('div', { class: 'help', text: 'No matches.' }));
      return;
    }
    state.cmd.filtered.forEach((it, idx) => list.appendChild(cmdItemCard(it, idx === state.cmd.activeIndex)));
  }

  function onCmdKeydown(e) {
    if (!state.cmd.filtered.length) return;
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      state.cmd.activeIndex = clamp(state.cmd.activeIndex + 1, 0, state.cmd.filtered.length - 1);
      renderCmd();
    }
    if (e.key === 'ArrowUp') {
      e.preventDefault();
      state.cmd.activeIndex = clamp(state.cmd.activeIndex - 1, 0, state.cmd.filtered.length - 1);
      renderCmd();
    }
    if (e.key === 'Enter') {
      e.preventDefault();
      const it = state.cmd.filtered[state.cmd.activeIndex];
      if (it) runCmd(it);
    }
  }

  function runCmd(item) {
    try {
      item.run?.();
      closeDialog(dialogs.cmd);
    } catch (err) {
      toast(`Command failed: ${err?.message || String(err)}`, 6000);
    }
  }

  function openCmd() {
    buildCmdUI();
    filterCmd('');
    openDialog(dialogs.cmd, { initialFocusId: 'cmdInput' });
  }

  $('btnCmd')?.addEventListener('click', () => openCmd());

  document.addEventListener('keydown', (e) => {
    const k = e.key.toLowerCase();
    if ((e.ctrlKey || e.metaKey) && k === 'k') {
      e.preventDefault();
      openCmd();
    }
  }, { passive: false });

  /* ---------- Data subscriptions ---------- */
  let unsubClients = null;
  let unsubTasks = null;

  function clearSubs() {
    try { unsubClients?.(); } catch {}
    try { unsubTasks?.(); } catch {}
    unsubClients = null;
    unsubTasks = null;
  }

  async function loadMyUserProfile(uid) {
    const snap = await db.collection('users').doc(uid).get();
    const u = snap.exists ? (snap.data() || {}) : {};
    state.displayName = u.displayName || '';
    setRole(u.role || 'ASSOCIATE');
  }

  function indexCaches() {
    state.clientsById = new Map((state.clients || []).map(c => [c.id, c]));
  }

  function subscribeClients() {
    if (!state.isPartner) {
      state.clients = [];
      indexCaches();
      return;
    }
    unsubClients = db.collection('clients')
      .orderBy('name', 'asc')
      .limit(1200)
      .onSnapshot((snap) => {
        state.clients = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        indexCaches();
        window.__cos_onData?.();
      });
  }

  function subscribeTasks() {
    const uid = state.uid;
    if (!uid) return;
    const q = (state.isPartner || state.isManager)
      ? db.collection('tasks')
      : db.collection('tasks').where('assignedToUid', '==', uid);

    unsubTasks = q.limit(2500).onSnapshot((snap) => {
      state.tasks = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      window.__cos_onData?.();
    });
  }

  /* ---------- Auth state ---------- */
  const signedOutCard = $('signedOutCard');
  const signedInPlaceholder = $('signedInPlaceholder');

  auth.onAuthStateChanged(async (user) => {
    clearSubs();

    if (!user) {
      state.uid = null;
      state.email = null;
      setRole('ASSOCIATE');

      $('btnAuth').textContent = 'Sign in';
      $('chipRole').textContent = 'Signed out';

      document.body.setAttribute('data-auth', 'out');
      signedOutCard && (signedOutCard.style.display = '');
      signedInPlaceholder && (signedInPlaceholder.style.display = 'none');

      routeTo('home');
      window.__cos_mountSignedOut?.();
      return;
    }

    state.uid = user.uid;
    state.email = user.email || '';

    $('btnAuth').textContent = 'Account';
    $('chipRole').textContent = `Loading‚Ä¶ ¬∑ ${state.email}`;

    document.body.setAttribute('data-auth', 'in');
    signedOutCard && (signedOutCard.style.display = 'none');
    signedInPlaceholder && (signedInPlaceholder.style.display = '');

    // Ensure user profile exists (permanent fix)
    try { await apiJson('/users_initself', {}); } catch {}

    // Now read profile
    try {
      await loadMyUserProfile(user.uid);
    } catch (err) {
      setRole('ASSOCIATE');
      toast(`Profile read blocked: ${err?.message || String(err)}`, 6500);
    }

    subscribeClients();
    subscribeTasks();

    signedInPlaceholder && (signedInPlaceholder.style.display = 'none');

    // Default after sign-in: Work Queue (same as your working new build)
    routeTo('work');
  });

  /* ---------- Expose to later parts ---------- */
  window.__cos = {
    auth, db,
    state,
    apiJson, apiForm,
    downloadBase64,
    safeCopy,
    ymdToDmy, dmyToYmd, todayYmdIST, diffDaysIST,
    openAuth,
    toast
  };

  // Bootstrap cmd UI once (dialog body is re-built when opened)
  buildCmdUI();
  filterCmd('');
})();
</script>
<script>
/* =========================
 ComplianceOS ‚Äî Part 3/8 (OLD-UI methodology)
 View system + Overview (Dashboard) + Work Queue (Tasks table + bulk bar)

 Notes:
 - Uses Part 1 old-style shell (sticky header + sidebar + cards + table feel)
 - Uses Part 2 backend/runtime exactly (window.__cos)
 - Keeps scrolling sane: whole page scroll; tables only scroll horizontally if needed
 ========================= */
(() => {
  'use strict';

  const {
    state,
    ymdToDmy,
    dmyToYmd,
    todayYmdIST,
    diffDaysIST,
    apiJson,
    toast
  } = window.__cos;

  const mount = document.getElementById('viewMount');

  /* ---------- Old-UI table/grid CSS (injected once) ---------- */
  const STYLE_ID = 'cosOldUiPart3Style';
  if (!document.getElementById(STYLE_ID)) {
    const st = document.createElement('style');
    st.id = STYLE_ID;
    st.textContent = `
      /* 12-col grid like the old UI */
      .cosGrid{ display:grid; grid-template-columns: repeat(12, minmax(0, 1fr)); gap: 14px; }
      .cosCol12{ grid-column: span 12; }
      .cosCol6{ grid-column: span 6; }
      .cosCol4{ grid-column: span 4; }
      .cosCol3{ grid-column: span 3; }
      .cosCol2{ grid-column: span 2; }
      @media (max-width: 980px){
        .cosCol6,.cosCol4,.cosCol3,.cosCol2{ grid-column: span 12; }
      }
      /* Allow grid items to shrink (prevents clipping/truncation in narrow columns) */
.cosGrid .field{ min-width: 0 !important; }
.cosGrid > div{ min-width: 0 !important; }
      /* Table shell (horizontal scroll only; no nested vertical scrolling) */
      .tableWrap{
        overflow-x: auto;
        overflow-y: hidden;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: color-mix(in srgb, var(--panel2) 75%, transparent);
      }
      table{ width:100%; border-collapse: collapse; min-width: 980px; }
      th, td{
        padding: 12px 12px;
        border-bottom: 1px solid color-mix(in srgb, var(--border) 70%, transparent);
        font-size: 13px;
        vertical-align: top;
        font-weight: 650;
      }
      th{
        text-align:left;
        font-weight: 950;
        color: var(--text);
        background: color-mix(in srgb, var(--panelSolid) 92%, transparent);
      }
      tr.cosRow:hover td{
        background: color-mix(in srgb, var(--primary) 6%, transparent);
      }

      /* Pills like old UI */
      .pill{
        display:inline-flex;
        align-items:center;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--border) 85%, transparent);
        background: var(--panel2);
        font-size: 12px;
        font-weight: 950;
        white-space:nowrap;
      }
      .pill.danger{
        border-color: color-mix(in srgb, var(--danger) 55%, transparent);
        background: color-mix(in srgb, var(--danger) 18%, transparent);
      }
      .pill.warn{
        border-color: color-mix(in srgb, var(--warning) 55%, transparent);
        background: color-mix(in srgb, var(--warning) 18%, transparent);
      }
      .pill.ok{
        border-color: color-mix(in srgb, var(--ok) 55%, transparent);
        background: color-mix(in srgb, var(--ok) 18%, transparent);
      }
      .pill.dim{
        color: var(--muted);
      }

      .pill.cat{ border-color: transparent; color: #0b1220; }
      body[data-theme="dark"] .pill.cat{ color: #0b1220; } /* keep readable */
      .pill.cat.gst{ background: rgba(34,197,94,.25); }
      .pill.cat.tds{ background: rgba(59,130,246,.25); }
      .pill.cat.income_tax{ background: rgba(168,85,247,.25); }
      .pill.cat.roc{ background: rgba(245,158,11,.25); }
      .pill.cat.accounting{ background: rgba(20,184,166,.25); }
      .pill.cat.audit{ background: rgba(244,63,94,.20); }
      .pill.cat.other{ background: rgba(148,163,184,.25); }

      /* Bulk bar (sticky, like old UI) */
      .bulkBar{
        position: sticky;
        top: calc(var(--headerH) + 10px);
        z-index: 30;
        margin-bottom: 12px;
        border-radius: 16px;
        border: 1px solid var(--border);
        background: color-mix(in srgb, var(--panelSolid) 86%, transparent);
        backdrop-filter: blur(10px);
        box-shadow: var(--shadow-sm);
        padding: 10px;
        display:none;
        gap: 10px;
        align-items:center;
        justify-content:space-between;
        flex-wrap:wrap;
      }
      .bulkBar.show{ display:flex; }
      .bulkLeft{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

      /* Small KPI number */
      .kpiNum{
        font-size: 28px;
        font-weight: 950;
        background: var(--grad);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
      }

      /* Empty state */
      .emptyState{
        padding: 18px;
        border-radius: 16px;
        border: 1px dashed color-mix(in srgb, var(--border) 75%, transparent);
        background: color-mix(in srgb, var(--panel2) 75%, transparent);
        display:flex;
        gap:14px;
        align-items:flex-start;
      }
      .emptyArt{
        width: 48px; height: 48px;
        border-radius: 16px;
        background:
          radial-gradient(circle at 30% 30%, rgba(0,120,212,.35), transparent 55%),
          radial-gradient(circle at 70% 70%, rgba(100,210,255,.28), transparent 55%),
          color-mix(in srgb, var(--panel) 75%, transparent);
        border: 1px solid var(--border);
        flex: 0 0 auto;
      }
      .emptyTitle{ font-weight: 950; margin:0; }
      .emptyText{ margin-top:6px; color: var(--muted); font-weight: 700; font-size: 13px; }
    `;
    document.head.appendChild(st);
  }

  /* ---------- tiny render helpers ---------- */
  const el = (tag, attrs = {}, children = []) => {
    const n = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs || {})) {
      if (k === 'class') n.className = v;
      else if (k === 'text') n.textContent = v;
      else if (k === 'html') n.innerHTML = v;
      else if (k === 'style') n.setAttribute('style', String(v));
      else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
      else if (v === false || v === null || v === undefined) continue;
      else n.setAttribute(k, String(v));
    }
    for (const c of (children || [])) n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
    return n;
  };

  function card(title, subtitle, rightNode, bodyNode) {
    return el('div', { class: 'card' }, [
      el('div', { class: 'cardHead' }, [
        el('div', {}, [
          el('h2', { text: title }),
          subtitle ? el('p', { text: subtitle }) : el('p', { style: 'display:none' })
        ]),
        rightNode || el('div')
      ]),
      el('div', { class: 'cardBody' }, [bodyNode || el('div')])
    ]);
  }

  function pill(text, tone) {
    const cls =
      tone === 'danger' ? 'pill danger' :
      tone === 'warn' ? 'pill warn' :
      tone === 'ok' ? 'pill ok' :
      tone === 'dim' ? 'pill dim' : 'pill';
    return el('span', { class: cls }, [text]);
  }

  function normalizeCategoryKey(x) {
    const u = String(x || '').trim().toUpperCase().replace(/\s+/g, '_');
    if (u === 'INCOME_TAX' || u === 'INCOME_TAX_RETURN' || u === 'INCOME') return 'INCOME_TAX';
    if (u === 'ACCOUNTING') return 'ACCOUNTING';
    if (u === 'AUDIT') return 'AUDIT';
    if (u === 'GST') return 'GST';
    if (u === 'TDS') return 'TDS';
    if (u === 'ROC') return 'ROC';
    return u || 'OTHER';
  }

  function categoryCssClass(cat) {
    const c = normalizeCategoryKey(cat);
    if (c === 'GST') return 'gst';
    if (c === 'TDS') return 'tds';
    if (c === 'INCOME_TAX') return 'income_tax';
    if (c === 'ROC') return 'roc';
    if (c === 'ACCOUNTING') return 'accounting';
    if (c === 'AUDIT') return 'audit';
    return 'other';
  }

  function categoryPill(cat) {
    const key = normalizeCategoryKey(cat);
    const cls = categoryCssClass(key);
    const label = (key || 'OTHER').replaceAll('_', ' ');
    return el('span', { class: `pill cat ${cls}` }, [label]);
  }

  function isSnoozedNow(t) {
    const tdy = todayYmdIST();
    return !!(t.snoozedUntilYmd && t.snoozedUntilYmd > tdy && t.status !== 'COMPLETED');
  }

  function alertPillForTask(t) {
    const tdy = todayYmdIST();
    if (t.status === 'COMPLETED') return pill('DONE', 'ok');
    if (!t.dueDateYmd) return pill('NO DUE', 'dim');

    const dd = diffDaysIST(tdy, t.dueDateYmd);
    const sd = t.startDateYmd ? diffDaysIST(tdy, t.startDateYmd) : null;

    if (dd < 0) return pill('OVERDUE', 'danger');
    if (dd === 0) return pill('DUE TODAY', 'danger');
    if (dd <= 3) {
      if (sd !== null && sd > 0) return pill('HIGH ALERT', 'danger');
      return pill('DUE SOON', 'warn');
    }
    if (sd !== null && sd === 0) return pill('START TODAY', 'warn');
    if (dd <= 7) return pill('THIS WEEK', 'warn');
    return pill('OK', 'dim');
  }

  function canSeeAllTasks() {
    return state.isPartner || state.isManager;
  }

  /* ---------- Inspector launcher (Part 6 provides real inspector) ---------- */
  window.__cos_openTask = (taskId) => {
    state.inspectorTaskId = taskId;
    if (typeof window.__cos_openTaskInspector === 'function') {
      window.__cos_openTaskInspector(taskId);
    } else {
      toast('Inspector is loading‚Ä¶', 2200);
    }
  };

  /* ---------- View mount system ---------- */
  function clearMount() {
    if (mount) mount.innerHTML = '';
  }

  function mountSignedOut() {
    clearMount();
  }
  window.__cos_mountSignedOut = mountSignedOut;

  function onDataRerender() {
    if (!state.uid) return;
    window.__cos_mountView?.(state.activeView);
  }
  window.__cos_onData = onDataRerender;

  window.__cos_mountView = (key) => {
    clearMount();
    if (!state.uid) return;

    if (key === 'home') return mountOverview();
    if (key === 'work') return mountWorkQueue();

    if (key === 'calendar') return (window.__cos_mountCalendar?.());
    if (key === 'clients') return (window.__cos_mountClients?.());
    if (key === 'studio') return (window.__cos_mountStudio?.());
    if (key === 'ops') return (window.__cos_mountOps?.());
    if (key === 'help') return mountHelp();

    return mountOverview();
  };

  function mountStub(title, msg) {
    mount.appendChild(el('div', { class: 'gridMax' }, [
      card(title, 'Workspace', null, el('div', { class: 'help', text: msg }))
    ]));
  }

  /* ---------- OVERVIEW (old dashboard feel) ---------- */
  function computeOverview() {
    const tdy = todayYmdIST();
    const visible = (state.tasks || []).slice();

    let total = visible.length;
    let overdue = 0, dueToday = 0, due7 = 0, appr = 0, snoozed = 0, startToday = 0;

    const focus = [];
    for (const t of visible) {
      if (isSnoozedNow(t)) snoozed++;
      if (t.status === 'APPROVAL_PENDING') appr++;
      if (t.status !== 'COMPLETED' && t.startDateYmd === tdy) startToday++;

      if (!t.dueDateYmd) continue;
      const dd = diffDaysIST(tdy, t.dueDateYmd);
      if (t.status !== 'COMPLETED') {
        if (dd < 0) overdue++;
        if (dd === 0) dueToday++;
        if (dd >= 0 && dd <= 7) due7++;
      }

      if (t.status !== 'COMPLETED') {
        const a = alertPillForTask(t);
        // focus: overdue / due today / due soon
        if (dd < 0 || dd === 0 || (dd >= 0 && dd <= 3)) focus.push(t);
      }
    }

    focus.sort((a, b) => String(a.dueDateYmd || '').localeCompare(String(b.dueDateYmd || '')));
    return { total, overdue, dueToday, due7, appr, snoozed, startToday, focus: focus.slice(0, 25) };
  }

  function mountOverview() {
    const o = computeOverview();

    const topActions = el('div', { class: 'row' }, [
      el('button', {
        class: 'btn btnSmall btnPrimary',
        type: 'button',
        text: 'New task',
        onclick: () => {
          if (typeof window.__cos_openCreateTask === 'function') window.__cos_openCreateTask();
          else toast('Task composer is loading‚Ä¶', 2200);
        }
      }),
      el('button', {
        class: 'btn btnSmall',
        type: 'button',
        text: 'Open Work Queue',
        onclick: () => document.getElementById('navWork')?.click()
      })
    ]);

    const kpiGrid = el('div', { class: 'cosGrid' }, [
      el('div', { class: 'cosCol4 card', style: 'border-radius:16px; box-shadow:none' }, [
        el('div', { class: 'cardBody' }, [
          el('div', { class: 'label', text: 'Starting today' }),
          el('div', { class: 'kpiNum', text: String(o.startToday) })
        ])
      ]),
      el('div', { class: 'cosCol4 card', style: 'border-radius:16px; box-shadow:none' }, [
        el('div', { class: 'cardBody' }, [
          el('div', { class: 'label', text: 'Due today' }),
          el('div', { class: 'kpiNum', text: String(o.dueToday) })
        ])
      ]),
      el('div', { class: 'cosCol4 card', style: 'border-radius:16px; box-shadow:none' }, [
        el('div', { class: 'cardBody' }, [
          el('div', { class: 'label', text: 'Due in next 7 days' }),
          el('div', { class: 'kpiNum', text: String(o.due7) })
        ])
      ]),
      el('div', { class: 'cosCol4 card', style: 'border-radius:16px; box-shadow:none' }, [
        el('div', { class: 'cardBody' }, [
          el('div', { class: 'label', text: 'Overdue' }),
          el('div', { class: 'kpiNum', text: String(o.overdue) })
        ])
      ]),
      el('div', { class: 'cosCol4 card', style: 'border-radius:16px; box-shadow:none' }, [
        el('div', { class: 'cardBody' }, [
          el('div', { class: 'label', text: 'Approval pending' }),
          el('div', { class: 'kpiNum', text: String(o.appr) })
        ])
      ]),
      el('div', { class: 'cosCol4 card', style: 'border-radius:16px; box-shadow:none' }, [
        el('div', { class: 'cardBody' }, [
          el('div', { class: 'label', text: 'Snoozed' }),
          el('div', { class: 'kpiNum', text: String(o.snoozed) })
        ])
      ])
    ]);

    const focusTableBody = el('tbody');
    if (!o.focus.length) {
      focusTableBody.appendChild(el('tr', {}, [
        el('td', { html: `<div class="emptyState"><div class="emptyArt"></div><div><div class="emptyTitle">No urgent tasks</div><div class="emptyText">You‚Äôre clear for now. Use Work Queue for the full list.</div></div></div>`, style: 'padding:14px', colspan: '7' })
      ]));
    } else {
      for (const t of o.focus) {
        const clientName = state.clientsById?.get(t.clientId)?.name || '‚Äî';
        const tr = el('tr', { class: 'cosRow', style: 'cursor:pointer' });
        tr.appendChild(el('td', {}, [alertPillForTask(t)]));
        tr.appendChild(el('td', { text: clientName }));
        tr.appendChild(el('td', { html: `<div style="font-weight:950">${(t.title || '').replaceAll('<','&lt;')}</div><div class="help" style="margin-top:6px">${(t.type || '').replaceAll('<','&lt;')}</div>` }));
        tr.appendChild(el('td', { text: t.startDateYmd ? ymdToDmy(t.startDateYmd) : '' }));
        tr.appendChild(el('td', { text: t.dueDateYmd ? ymdToDmy(t.dueDateYmd) : '' }));
        tr.appendChild(el('td', { text: t.status || '' }));
        tr.appendChild(el('td', { text: t.assignedToEmail || '' }));
        tr.addEventListener('click', () => window.__cos_openTask(t.id));
        focusTableBody.appendChild(tr);
      }
    }

    const focusTable = el('div', { class: 'tableWrap' }, [
      el('table', {}, [
        el('thead', {}, [
          el('tr', {}, [
            el('th', { text: 'Alert' }),
            el('th', { text: 'Client' }),
            el('th', { text: 'Task' }),
            el('th', { text: 'Start' }),
            el('th', { text: 'Due' }),
            el('th', { text: 'Status' }),
            el('th', { text: 'Assignee' })
          ])
        ]),
        focusTableBody
      ])
    ]);

    mount.appendChild(el('div', { class: 'gridMax' }, [
      card('Dashboard', 'A fast snapshot of today + due soon (old UI feel, new backend).', topActions, el('div', {}, [
        kpiGrid,
        el('div', { style: 'height:12px' }),
        focusTable
      ]))
    ]));
  }

  /* ---------- WORK QUEUE (old tasks table feel) ---------- */
  const workState = {
    q: '',
    status: '',
    category: '',
    mode: 'ACTIVE',        // ACTIVE | ALL | SNOOZED | APPROVAL | COMPLETED
    dueFrom: '',
    dueTo: '',
    assignee: '',
    priority: '',
    clientId: '',
    selected: new Set()
  };

  function allowedStatusesForBulk() {
   // Everyone can set COMPLETED for tasks they are allowed to edit (backend enforces ownership)
   return ['PENDING', 'IN_PROGRESS', 'CLIENT_PENDING', 'APPROVAL_PENDING', 'COMPLETED'];
  }

  function filterWorkTasks() {
    const tdy = todayYmdIST();
    const q = String(workState.q || '').trim().toLowerCase();

    let fromY = '', toY = '';
    try { if (workState.dueFrom) fromY = dmyToYmd(workState.dueFrom); } catch {}
    try { if (workState.dueTo) toY = dmyToYmd(workState.dueTo); } catch {}

    return (state.tasks || []).filter(t => {
      const snoozedNow = isSnoozedNow(t);

      if (workState.mode === 'ACTIVE') {
        if (t.status === 'COMPLETED') return false;
        if (snoozedNow) return false;
      }
      if (workState.mode === 'SNOOZED' && !snoozedNow) return false;
      if (workState.mode === 'APPROVAL' && t.status !== 'APPROVAL_PENDING') return false;
      if (workState.mode === 'COMPLETED' && t.status !== 'COMPLETED') return false;

      if (workState.status && t.status !== workState.status) return false;
      if (workState.category && normalizeCategoryKey(t.category) !== normalizeCategoryKey(workState.category)) return false;
      if (workState.priority && String(t.priority || 'MEDIUM').toUpperCase() !== String(workState.priority).toUpperCase()) return false;
      if (workState.clientId && t.clientId !== workState.clientId) return false;

      if (workState.assignee) {
        const a = String(t.assignedToEmail || '').trim().toLowerCase();
        if (a !== String(workState.assignee).trim().toLowerCase()) return false;
      }

      if (fromY && String(t.dueDateYmd || '') < fromY) return false;
      if (toY && String(t.dueDateYmd || '') > toY) return false;

      if (q) {
        const clientName = state.clientsById?.get(t.clientId)?.name || '';
        const hay = `${t.title || ''} ${t.type || ''} ${clientName} ${t.assignedToEmail || ''}`.toLowerCase();
        if (!hay.includes(q)) return false;
      }
      return true;
    }).sort((a, b) => String(a.dueDateYmd || '').localeCompare(String(b.dueDateYmd || '')));
  }

  async function bulkUpdate(op, payload) {
    const ids = Array.from(workState.selected);
    if (!ids.length) return toast('Select tasks first', 3200);
    const r = await apiJson('/tasks_bulkUpdate', { taskIds: ids, op, ...(payload || {}) });
    if (!r.ok) return toast(`Bulk failed: ${r.error || JSON.stringify(r)}`, 9000);
    if (op === 'DELETE') toast(`Deleted ${r.deletedCount || 0} tasks`);
    else toast(`Updated ${r.updatedCount || 0} tasks`);
    workState.selected.clear();
    window.__cos_mountView('work');
  }

  function renderBulkBar() {
    const count = workState.selected.size;

    const bar = el('div', { class: `bulkBar ${count ? 'show' : ''}` }, [
      el('div', { class: 'bulkLeft' }, [
        el('span', { class: 'chip' }, [`Selected: ${count}`]),
        el('button', {
          class: 'btn btnSmall btnGhost',
          type: 'button',
          text: 'Clear',
          onclick: () => { workState.selected.clear(); window.__cos_mountView('work'); }
        })
      ]),
      el('div', { class: 'row', style: 'justify-content:flex-end' }, [
        (() => {
          const sel = el('select', { class: 'select', style: 'width:auto; padding:8px 10px; border-radius:10px' });
          sel.appendChild(el('option', { value: '', text: 'Change status‚Ä¶' }));
          for (const s of allowedStatusesForBulk()) sel.appendChild(el('option', { value: s, text: s }));
          const btn = el('button', {
            class: 'btn btnSmall btnPrimary',
            type: 'button',
            text: 'Apply',
            onclick: () => {
              if (!sel.value) return toast('Pick a status', 3200);
              bulkUpdate('STATUS', { newStatus: sel.value });
            }
          });
          return el('div', { class: 'row' }, [sel, btn]);
        })(),

        ...(canSeeAllTasks() ? [(() => {
          const inp = el('input', {
            class: 'input',
            placeholder: 'Reassign to email',
            style: 'width:240px; padding:8px 10px; border-radius:10px'
          });
          const btn = el('button', {
            class: 'btn btnSmall',
            type: 'button',
            text: 'Reassign',
            onclick: () => {
              const email = String(inp.value || '').trim();
              if (!email) return toast('Enter email', 3200);
              bulkUpdate('REASSIGN', { assignedToEmail: email });
            }
          });
          return el('div', { class: 'row' }, [inp, btn]);
        })()] : []),

        el('button', {
          class: 'btn btnSmall',
          type: 'button',
          text: 'Snooze',
          onclick: async () => {
            const dmy = prompt('Snooze until (DD-MM-YYYY):', '');
            if (!dmy) return;
            let ymd = '';
            try { ymd = dmyToYmd(dmy); } catch (e) { return toast(e.message, 6000); }
            bulkUpdate('SNOOZE', { snoozedUntilYmd: ymd });
          }
        }),

        el('button', {
          class: 'btn btnSmall btnDanger',
          type: 'button',
          text: 'Delete',
          onclick: () => {
            if (!confirm('Delete selected tasks?')) return;
            bulkUpdate('DELETE', {});
          }
        })
      ])
    ]);

    return bar;
  }

  function mountWorkQueue() {
    const list = filterWorkTasks();

    const headerRight = el('div', { class: 'row' }, [
      pill(`${list.length} shown`, 'dim'),
      pill(canSeeAllTasks() ? 'Team view' : 'My tasks', 'dim'),
      el('button', {
        class: 'btn btnSmall btnPrimary',
        type: 'button',
        text: 'New task',
        onclick: () => {
          if (typeof window.__cos_openCreateTask === 'function') window.__cos_openCreateTask();
          else toast('Task composer is loading‚Ä¶', 2200);
        }
      })
    ]);

    /* Filters (old UI: card with grid of inputs) */
    const filtersGrid = el('div', { class: 'cosGrid' });

    const inpQ = el('input', { class: 'input', value: workState.q, placeholder: 'Search task, client, assignee‚Ä¶' });
    inpQ.addEventListener('input', () => { workState.q = inpQ.value; window.__cos_mountView('work'); });

    const selMode = el('select', { class: 'select' }, [
      el('option', { value: 'ACTIVE', text: 'Active (hide snoozed & completed)' }),
      el('option', { value: 'ALL', text: 'All' }),
      el('option', { value: 'SNOOZED', text: 'Snoozed' }),
      el('option', { value: 'APPROVAL', text: 'Approval pending' }),
      el('option', { value: 'COMPLETED', text: 'Completed' })
    ]);
    selMode.value = workState.mode;
    selMode.addEventListener('change', () => { workState.mode = selMode.value; window.__cos_mountView('work'); });

    const selStatus = el('select', { class: 'select' }, [
      el('option', { value: '', text: 'All statuses' }),
      ...['PENDING', 'IN_PROGRESS', 'CLIENT_PENDING', 'APPROVAL_PENDING', 'COMPLETED'].map(s => el('option', { value: s, text: s }))
    ]);
    selStatus.value = workState.status;
    selStatus.addEventListener('change', () => { workState.status = selStatus.value; window.__cos_mountView('work'); });

    const selCat = el('select', { class: 'select' }, [
      el('option', { value: '', text: 'All categories' }),
      ...['GST','TDS','INCOME_TAX','ROC','ACCOUNTING','AUDIT','OTHER'].map(c => el('option', { value: c, text: c }))
    ]);
    selCat.value = workState.category;
    selCat.addEventListener('change', () => { workState.category = selCat.value; window.__cos_mountView('work'); });

    const selPri = el('select', { class: 'select' }, [
      el('option', { value: '', text: 'All priorities' }),
      ...['HIGH','MEDIUM','LOW'].map(p => el('option', { value: p, text: p }))
    ]);
    selPri.value = workState.priority;
    selPri.addEventListener('change', () => { workState.priority = selPri.value; window.__cos_mountView('work'); });

    const inpFrom = el('input', { class: 'input', value: workState.dueFrom, placeholder: 'DD-MM-YYYY' });
    const inpTo = el('input', { class: 'input', value: workState.dueTo, placeholder: 'DD-MM-YYYY' });
    inpFrom.addEventListener('input', () => { workState.dueFrom = inpFrom.value; window.__cos_mountView('work'); });
    inpTo.addEventListener('input', () => { workState.dueTo = inpTo.value; window.__cos_mountView('work'); });

    const selClient = el('select', { class: 'select', disabled: (!state.isPartner) });
    selClient.appendChild(el('option', { value: '', text: state.isPartner ? 'All clients' : 'Client filter (Partner only)' }));
    if (state.isPartner) {
      for (const c of (state.clients || [])) selClient.appendChild(el('option', { value: c.id, text: c.name || c.id }));
    }
    selClient.value = workState.clientId;
    selClient.addEventListener('change', () => { workState.clientId = selClient.value; window.__cos_mountView('work'); });

    const inpAssignee = el('input', {
      class: 'input',
      value: workState.assignee,
      placeholder: canSeeAllTasks() ? 'Assignee email (exact match)' : 'Assignee filter (not needed)'
    });
    inpAssignee.disabled = !canSeeAllTasks();
    inpAssignee.addEventListener('input', () => { workState.assignee = inpAssignee.value; window.__cos_mountView('work'); });

    const btnReset = el('button', {
      class: 'btn btnSmall btnGhost',
      type: 'button',
      text: 'Reset',
      onclick: () => {
        workState.q = '';
        workState.status = '';
        workState.category = '';
        workState.mode = 'ACTIVE';
        workState.dueFrom = '';
        workState.dueTo = '';
        workState.assignee = '';
        workState.priority = '';
        workState.clientId = '';
        window.__cos_mountView('work');
      }
    });

    filtersGrid.appendChild(el('div', { class: 'cosCol6 field' }, [el('div', { class: 'label', text: 'Search' }), inpQ]));
    filtersGrid.appendChild(el('div', { class: 'cosCol3 field' }, [el('div', { class: 'label', text: 'Mode' }), selMode]));
    filtersGrid.appendChild(el('div', { class: 'cosCol3 field' }, [el('div', { class: 'label', text: 'Status' }), selStatus]));
    filtersGrid.appendChild(el('div', { class: 'cosCol3 field' }, [el('div', { class: 'label', text: 'Category' }), selCat]));
    filtersGrid.appendChild(el('div', { class: 'cosCol3 field' }, [el('div', { class: 'label', text: 'Priority' }), selPri]));
    filtersGrid.appendChild(el('div', { class: 'cosCol6 field' }, [
      el('div', { class: 'label', text: 'Client' }),
      selClient,
      el('div', { class: 'help', text: state.isPartner ? 'Client filtering is available for partners.' : 'Client list is hidden for your role by design.' })
    ]));
    filtersGrid.appendChild(el('div', { class: 'cosCol6 field' }, [
      el('div', { class: 'label', text: 'Assignee' }),
      inpAssignee,
      el('div', { class: 'help', text: canSeeAllTasks() ? 'Paste an exact email to filter quickly.' : 'Associates see only their tasks.' })
    ]));
    filtersGrid.appendChild(el('div', { class: 'cosCol3 field' }, [el('div', { class: 'label', text: 'Due from' }), inpFrom]));
    filtersGrid.appendChild(el('div', { class: 'cosCol3 field' }, [el('div', { class: 'label', text: 'Due to' }), inpTo]));
    filtersGrid.appendChild(el('div', { class: 'cosCol6 row', style: 'align-items:flex-end; justify-content:flex-end' }, [btnReset]));

    /* Results table */
    const tbody = el('tbody');
    if (!list.length) {
      const tr = el('tr', {}, [
        el('td', {
          colspan: '11',
          style: 'padding:14px',
          html: `<div class="emptyState"><div class="emptyArt"></div><div><div class="emptyTitle">No tasks found</div><div class="emptyText">Try changing filters or create a new task.</div></div></div>`
        })
      ]);
      tbody.appendChild(tr);
    } else {
      for (const t of list) {
        const clientName = state.clientsById?.get(t.clientId)?.name || '‚Äî';
        const checked = workState.selected.has(t.id);

        const tr = el('tr', { class: 'cosRow', style: 'cursor:pointer' });

        const chk = el('input', { type: 'checkbox' });
        chk.checked = checked;
        chk.addEventListener('click', (e) => e.stopPropagation());
        chk.addEventListener('change', () => {
          if (chk.checked) workState.selected.add(t.id);
          else workState.selected.delete(t.id);
          // Light re-render (simple + consistent)
          window.__cos_mountView('work');
        });

        tr.appendChild(el('td', { style: 'width:44px' }, [chk]));
        tr.appendChild(el('td', {}, [alertPillForTask(t)]));
        tr.appendChild(el('td', { text: clientName }));
        tr.appendChild(el('td', { html: `<div style="font-weight:950">${(t.title || '').replaceAll('<','&lt;')}</div><div class="help" style="margin-top:6px">${(t.type || '').replaceAll('<','&lt;')}</div>` }));
        tr.appendChild(el('td', {}, [categoryPill(t.category)]));
        tr.appendChild(el('td', {}, [pill(String(t.priority || 'MEDIUM').toUpperCase(), (String(t.priority||'MEDIUM').toUpperCase()==='HIGH')?'danger':(String(t.priority||'MEDIUM').toUpperCase()==='LOW')?'ok':'warn')]));
        tr.appendChild(el('td', { text: t.startDateYmd ? ymdToDmy(t.startDateYmd) : '' }));
        tr.appendChild(el('td', { text: t.dueDateYmd ? ymdToDmy(t.dueDateYmd) : '' }));
        tr.appendChild(el('td', { text: t.status || '' }));
        tr.appendChild(el('td', { text: t.assignedToEmail || '' }));
        tr.appendChild(el('td', { style: 'white-space:nowrap' }, [
          el('button', {
            class: 'btn btnSmall btnPrimary',
            type: 'button',
            text: 'Open',
            onclick: (e) => { e.stopPropagation(); window.__cos_openTask(t.id); }
          })
        ]));

        tr.addEventListener('click', () => window.__cos_openTask(t.id));
        tbody.appendChild(tr);
      }
    }

    const table = el('div', { class: 'tableWrap' }, [
      el('table', {}, [
        el('thead', {}, [
          el('tr', {}, [
            el('th', { style: 'width:44px', html: '' }),
            el('th', { text: 'Alert' }),
            el('th', { text: 'Client' }),
            el('th', { text: 'Task' }),
            el('th', { text: 'Category' }),
            el('th', { text: 'Priority' }),
            el('th', { text: 'Start' }),
            el('th', { text: 'Due' }),
            el('th', { text: 'Status' }),
            el('th', { text: 'Assignee' }),
            el('th', { text: '' })
          ])
        ]),
        tbody
      ])
    ]);

    const selectAllRow = el('div', { class: 'row', style: 'justify-content:flex-end; margin-bottom: 10px' }, [
      el('button', {
        class: 'btn btnSmall btnGhost',
        type: 'button',
        text: 'Select all shown',
        onclick: () => { list.forEach(t => workState.selected.add(t.id)); window.__cos_mountView('work'); }
      }),
      el('button', {
        class: 'btn btnSmall btnGhost',
        type: 'button',
        text: 'Select none',
        onclick: () => { workState.selected.clear(); window.__cos_mountView('work'); }
      })
    ]);

    mount.appendChild(el('div', { class: 'gridMax' }, [
      card('Work Queue', 'Old table workflow: filter ‚Üí select ‚Üí bulk actions ‚Üí open inspector.', headerRight, filtersGrid),
      card('Tasks', 'Click a row to open. Use checkboxes for bulk actions.', null, el('div', {}, [
        renderBulkBar(),
        selectAllRow,
        table
      ]))
    ]));
  }

  /* ---------- HELP (minimal; keep same route) ---------- */
  function mountHelp() {
    mount.appendChild(el('div', { class: 'gridMax' }, [
      card('Help', 'Shortcuts + role behavior.', null, el('div', { class: 'help', html: `
        <div style="font-weight:950; color: var(--text)">Keyboard</div>
        <div style="margin-top:6px">
          <span style="font-family:var(--mono);font-weight:900">Ctrl/Cmd + K</span> ‚Äî Search<br>
          <span style="font-family:var(--mono);font-weight:900">Esc</span> ‚Äî Close dialogs / inspector
        </div>
        <div style="margin-top:14px; font-weight:950; color: var(--text)">Roles</div>
        <div style="margin-top:6px">
          <b>ASSOCIATE</b>: update statuses (including <b>COMPLETED</b> for tasks assigned to you), add comments, upload attachments.<br>
          <b>MANAGER / PARTNER</b>: edit task details, reassign, exports/reports.
        </div>
      ` }))
    ]));
  }

  // If already signed-in and view not mounted yet
  if (state.uid) window.__cos_mountView(state.activeView || 'work');
})();
</script>
<script>
/* =========================
 ComplianceOS ‚Äî Part 4/8 (OLD-UI methodology)
 Timeline (Calendar) ‚Äî Month / Week / Day / Agenda
 - Old UI interaction model (tabs + month grid + agenda cards)
 - Uses existing task data from Part 2 subscriptions (state.tasks)
 - No nested vertical scrollbars (page scroll only)
 ========================= */
(() => {
  'use strict';

  const { state, ymdToDmy, todayYmdIST, diffDaysIST, toast } = window.__cos;
  const mount = document.getElementById('viewMount');

  /* ---------- CSS (calendar components like old UI) ---------- */
  const STYLE_ID = 'cosOldUiPart4Style';
  if (!document.getElementById(STYLE_ID)) {
    const st = document.createElement('style');
    st.id = STYLE_ID;
    st.textContent = `
      .calTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
      .calTabs{ display:flex; gap:8px; flex-wrap:wrap; }

      .cosTabActive{
        background: color-mix(in srgb, var(--primary) 18%, transparent) !important;
        border-color: color-mix(in srgb, var(--primary) 35%, transparent) !important;
        color: var(--text) !important;
      }

      .calGrid{
        margin-top: 12px;
        display:grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
      }
      .calDow{
        font-size: 12px;
        color: var(--muted);
        font-weight: 900;
        padding: 8px 6px;
        text-align:center;
      }

      .calCell{
        border: 1px solid var(--border);
        background: color-mix(in srgb, var(--panel2) 75%, transparent);
        border-radius: 14px;
        min-height: 92px;
        padding: 10px;
        cursor:pointer;
        position: relative;
        text-align:left;
        transition: transform .12s ease, background .2s ease, border-color .2s ease;
      }
      .calCell:hover{
        transform: translateY(-1px);
        background: color-mix(in srgb, var(--panel) 70%, transparent);
      }
      .calCell.muted{ opacity: .55; }
      .calCell.today{
        border-color: color-mix(in srgb, var(--primary) 55%, transparent);
        box-shadow: 0 0 0 4px color-mix(in srgb, var(--primary) 16%, transparent);
      }

      .calDayNum{ font-weight: 950; }

      .calDotRow{
        position:absolute;
        left:10px; bottom:10px; right:10px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap: 10px;
      }
      .calDots{ display:flex; gap:6px; }
      .dot{
        width: 8px; height: 8px;
        border-radius:999px;
        background: color-mix(in srgb, var(--muted) 50%, transparent);
      }
      .dot.warn{ background: var(--warning); }
      .dot.danger{ background: var(--danger); }
      .dot.ok{ background: var(--ok); }

      .calCount{
        font-size: 12px;
        font-weight: 950;
        color: var(--muted);
        white-space:nowrap;
      }

      .agendaList{ display:flex; flex-direction:column; gap:10px; margin-top:12px; }
      .agendaItem{
        padding: 12px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: color-mix(in srgb, var(--panel2) 75%, transparent);
        cursor:pointer;
        transition: transform .12s ease, background .2s ease;
      }
      .agendaItem:hover{ transform: translateY(-1px); background: color-mix(in srgb, var(--panel) 65%, transparent); }
      .agendaTop{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
      .agendaTitle{ font-weight: 950; }
      .agendaMeta{ margin-top: 6px; color: var(--muted); font-size: 12px; font-weight: 800; line-height:1.35; }

      .weekGrid{
        margin-top: 12px;
        display:grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 12px;
      }
      @media (max-width: 980px){
        .weekGrid{ grid-template-columns: 1fr; }
      }

      .weekColHead{
        display:flex;
        justify-content:space-between;
        gap:10px;
        align-items:center;
        margin-bottom: 10px;
      }
      .weekColHead .t{ font-weight: 950; }
      .weekColHead .pill{
        display:inline-flex; align-items:center;
        padding:4px 10px; border-radius:999px;
        border:1px solid color-mix(in srgb, var(--border) 85%, transparent);
        background: var(--panel2);
        font-size:12px; font-weight:950;
        color: var(--muted);
      }

      /* Reuse emptyState styles from Part 3 if present; provide fallback */
      .emptyStateFallback{
        padding: 18px;
        border-radius: 16px;
        border: 1px dashed color-mix(in srgb, var(--border) 75%, transparent);
        background: color-mix(in srgb, var(--panel2) 75%, transparent);
        color: var(--muted);
        font-weight: 750;
      }
    `;
    document.head.appendChild(st);
  }

  /* ---------- helpers ---------- */
  const el = (tag, attrs = {}, children = []) => {
    const n = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs || {})) {
      if (k === 'class') n.className = v;
      else if (k === 'text') n.textContent = v;
      else if (k === 'html') n.innerHTML = v;
      else if (k === 'style') n.setAttribute('style', String(v));
      else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
      else if (v === false || v === null || v === undefined) continue;
      else n.setAttribute(k, String(v));
    }
    for (const c of (children || [])) n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
    return n;
  };

  function card(title, subtitle, rightNode, bodyNode) {
    return el('div', { class: 'card' }, [
      el('div', { class: 'cardHead' }, [
        el('div', {}, [
          el('h2', { text: title }),
          el('p', { text: subtitle || '' })
        ]),
        rightNode || el('div')
      ]),
      el('div', { class: 'cardBody' }, [bodyNode || el('div')])
    ]);
  }

  function pill(text, tone) {
    const base = 'pill';
    const cls =
      tone === 'danger' ? `${base} danger` :
      tone === 'warn' ? `${base} warn` :
      tone === 'ok' ? `${base} ok` : base;
    return el('span', { class: cls }, [text]);
  }

  function ymdFromDateIST(date) {
    const parts = new Intl.DateTimeFormat('en-CA', {
      timeZone: 'Asia/Kolkata',
      year: 'numeric', month: '2-digit', day: '2-digit'
    }).formatToParts(date);
    const m = Object.fromEntries(parts.map(p => [p.type, p.value]));
    return `${m.year}-${m.month}-${m.day}`;
  }

  function monthLabel(d) {
    return d.toLocaleString(undefined, { month: 'long', year: 'numeric' });
  }

  function tasksByDueDateMap() {
    const map = new Map();
    for (const t of (state.tasks || [])) {
      if (!t.dueDateYmd) continue;
      if (!map.has(t.dueDateYmd)) map.set(t.dueDateYmd, []);
      map.get(t.dueDateYmd).push(t);
    }
    return map;
  }

  function clientNameById(clientId) {
    return state.clientsById?.get(clientId)?.name || '';
  }

  function alertToneForTask(t) {
    const tdy = todayYmdIST();
    if (t.status === 'COMPLETED') return 'ok';
    if (!t.dueDateYmd) return '';
    const dd = diffDaysIST(tdy, t.dueDateYmd);
    if (dd < 0) return 'danger';
    if (dd === 0) return 'danger';
    if (dd <= 3) return 'warn';
    return '';
  }

  /* ---------- Calendar state (persists in this closure) ---------- */
  const DOW = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const calState = {
    cursor: (() => { const d = new Date(); d.setDate(1); d.setHours(12,0,0,0); return d; })(),
    view: 'MONTH',        // MONTH | WEEK | DAY | AGENDA
    selectedYmd: todayYmdIST()
  };

  function setView(v) {
    calState.view = v;
    render();
  }

  /* ---------- Month view ---------- */
  function renderMonth() {
    const map = tasksByDueDateMap();
    const tdy = todayYmdIST();

    const header = el('div', { class: 'calTop' }, [
      el('div', { class: 'row' }, [
        el('button', { class: 'btn btnSmall btnGhost', type: 'button', text: 'Prev', onclick: () => { calState.cursor.setMonth(calState.cursor.getMonth() - 1); render(); } }),
        el('button', { class: 'btn btnSmall btnGhost', type: 'button', text: 'Today', onclick: () => {
          const d = new Date(); d.setDate(1); d.setHours(12,0,0,0);
          calState.cursor = d;
          calState.selectedYmd = todayYmdIST();
          calState.view = 'DAY';
          render();
        }}),
        el('button', { class: 'btn btnSmall btnGhost', type: 'button', text: 'Next', onclick: () => { calState.cursor.setMonth(calState.cursor.getMonth() + 1); render(); } }),
        el('span', { class: 'chip', text: monthLabel(calState.cursor) })
      ]),
      el('div', { class: 'calTabs' }, [
        el('button', { class: `btn btnSmall btnGhost ${calState.view==='MONTH'?'cosTabActive':''}`, type: 'button', text: 'Month', onclick: () => setView('MONTH') }),
        el('button', { class: `btn btnSmall btnGhost ${calState.view==='WEEK'?'cosTabActive':''}`, type: 'button', text: 'Week', onclick: () => setView('WEEK') }),
        el('button', { class: `btn btnSmall btnGhost ${calState.view==='DAY'?'cosTabActive':''}`, type: 'button', text: 'Day', onclick: () => setView('DAY') }),
        el('button', { class: `btn btnSmall btnGhost ${calState.view==='AGENDA'?'cosTabActive':''}`, type: 'button', text: 'Agenda', onclick: () => setView('AGENDA') })
      ])
    ]);

    const grid = el('div', { class: 'calGrid' });

    for (const d of DOW) grid.appendChild(el('div', { class: 'calDow', text: d }));

    const first = new Date(calState.cursor);
    const month = first.getMonth();
    const firstDow = (first.getDay() + 6) % 7; // Mon=0
    const start = new Date(first);
    start.setDate(first.getDate() - firstDow);

    for (let i = 0; i < 42; i++) {
      const d = new Date(start);
      d.setDate(start.getDate() + i);
      const y = ymdFromDateIST(d);

      const list = map.get(y) || [];
      const muted = (d.getMonth() !== month);
      const isToday = (y === tdy);

      const hasOverdue = list.some(t => t.status !== 'COMPLETED' && diffDaysIST(tdy, t.dueDateYmd) < 0);
      const hasDueSoon = list.some(t => t.status !== 'COMPLETED' && diffDaysIST(tdy, t.dueDateYmd) >= 0 && diffDaysIST(tdy, t.dueDateYmd) <= 3);
      const hasDone = list.some(t => t.status === 'COMPLETED');

      const cell = el('div', {
        class: `calCell${muted ? ' muted' : ''}${isToday ? ' today' : ''}`,
        onclick: () => {
          calState.selectedYmd = y;
          calState.view = 'DAY';
          render();
        }
      }, [
        el('div', { class: 'calDayNum', text: String(d.getDate()) }),
        el('div', { class: 'calDotRow' }, [
          el('div', { class: 'calDots' }, [
            el('div', { class: `dot ${hasOverdue ? 'danger' : ''}` }),
            el('div', { class: `dot ${hasDueSoon ? 'warn' : ''}` }),
            el('div', { class: `dot ${hasDone ? 'ok' : ''}` })
          ]),
          el('div', { class: 'calCount', text: list.length ? `${list.length} tasks` : '' })
        ])
      ]);

      grid.appendChild(cell);
    }

    const note = el('div', { class: 'help', style: 'margin-top:10px' }, [
      'Dots: overdue / due soon / done. Click a day to open Day view.'
    ]);

    return el('div', {}, [header, grid, note]);
  }

  /* ---------- Week view ---------- */
  function renderWeek() {
    const map = tasksByDueDateMap();

    const base = (() => {
      const y = calState.selectedYmd || todayYmdIST();
      // parse in IST-friendly way
      return new Date(`${y}T12:00:00+05:30`);
    })();

    const dow = (base.getDay() + 6) % 7; // Mon=0
    const monday = new Date(base);
    monday.setDate(base.getDate() - dow);

    const days = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(monday);
      d.setDate(monday.getDate() + i);
      days.push(d);
    }

    const header = el('div', { class: 'calTop' }, [
      el('div', { class: 'row' }, [
        el('span', { class: 'chip', text: `Week of ${ymdToDmy(ymdFromDateIST(monday))}` }),
        el('button', { class: 'btn btnSmall btnGhost', type: 'button', text: 'This week', onclick: () => { calState.selectedYmd = todayYmdIST(); render(); } })
      ]),
      el('div', { class: 'calTabs' }, [
        el('button', { class: `btn btnSmall btnGhost ${calState.view==='MONTH'?'cosTabActive':''}`, type: 'button', text: 'Month', onclick: () => setView('MONTH') }),
        el('button', { class: `btn btnSmall btnGhost ${calState.view==='WEEK'?'cosTabActive':''}`, type: 'button', text: 'Week', onclick: () => setView('WEEK') }),
        el('button', { class: `btn btnSmall btnGhost ${calState.view==='DAY'?'cosTabActive':''}`, type: 'button', text: 'Day', onclick: () => setView('DAY') }),
        el('button', { class: `btn btnSmall btnGhost ${calState.view==='AGENDA'?'cosTabActive':''}`, type: 'button', text: 'Agenda', onclick: () => setView('AGENDA') })
      ])
    ]);

    const grid = el('div', { class: 'weekGrid' });

    days.forEach((d) => {
      const y = ymdFromDateIST(d);
      const list = (map.get(y) || []).slice().sort((a,b) => String(a.status||'').localeCompare(String(b.status||'')));

      const col = el('div', { class: 'card', style: 'border-radius:16px; box-shadow:none' }, [
        el('div', { class: 'cardBody', style: 'padding:12px' }, [
          el('div', { class: 'weekColHead' }, [
            el('div', { class: 't', text: `${DOW[(d.getDay()+6)%7]} ${d.getDate()}` }),
            el('div', { class: 'pill', text: `${list.length}` })
          ]),
          list.length ? el('div', { class: 'agendaList', style: 'margin-top:0' }, list.slice(0, 8).map(t => {
            const cn = clientNameById(t.clientId);
            const tone = alertToneForTask(t);
            return el('div', {
              class: 'agendaItem',
              onclick: () => window.__cos_openTask(t.id)
            }, [
              el('div', { class: 'agendaTop' }, [
                el('div', {}, [
                  el('div', { class: 'agendaTitle', text: t.title || '(task)' }),
                  el('div', { class: 'agendaMeta', text: `${cn || '‚Äî'} ‚Ä¢ ${t.status || '‚Äî'} ‚Ä¢ ${t.assignedToEmail || ''}`.trim() })
                ]),
                (tone ? pill(tone === 'danger' ? 'URGENT' : 'SOON', tone) : el('div'))
              ])
            ]);
          })) : el('div', { class: 'help', text: 'No tasks due.' })
        ])
      ]);

      // Clicking the column header should go to day view
      col.addEventListener('dblclick', () => {
        calState.selectedYmd = y;
        calState.view = 'DAY';
        render();
      });

      grid.appendChild(col);
    });

    const note = el('div', { class: 'help', style: 'margin-top:10px' }, [
      'Tip: Double-click a day column to open Day view.'
    ]);

    return el('div', {}, [header, grid, note]);
  }

  /* ---------- Day view ---------- */
  function renderDay() {
    const y = calState.selectedYmd || todayYmdIST();
    const list = (state.tasks || [])
      .filter(t => t.dueDateYmd === y)
      .slice()
      .sort((a,b) => String(a.status||'').localeCompare(String(b.status||'')));

    const header = el('div', { class: 'calTop' }, [
      el('div', { class: 'row' }, [
        el('button', { class: 'btn btnSmall btnGhost', type: 'button', text: 'Back to month', onclick: () => { calState.view = 'MONTH'; render(); } }),
        el('span', { class: 'chip', text: `Day: ${ymdToDmy(y)}` }),
        el('span', { class: 'chip', text: `${list.length} tasks` })
      ]),
      el('div', { class: 'calTabs' }, [
        el('button', { class: `btn btnSmall btnGhost ${calState.view==='MONTH'?'cosTabActive':''}`, type: 'button', text: 'Month', onclick: () => setView('MONTH') }),
        el('button', { class: `btn btnSmall btnGhost ${calState.view==='WEEK'?'cosTabActive':''}`, type: 'button', text: 'Week', onclick: () => setView('WEEK') }),
        el('button', { class: `btn btnSmall btnGhost ${calState.view==='DAY'?'cosTabActive':''}`, type: 'button', text: 'Day', onclick: () => setView('DAY') }),
        el('button', { class: `btn btnSmall btnGhost ${calState.view==='AGENDA'?'cosTabActive':''}`, type: 'button', text: 'Agenda', onclick: () => setView('AGENDA') })
      ])
    ]);

    const wrap = el('div', { class: 'agendaList' });

    if (!list.length) {
      wrap.appendChild(el('div', { class: 'emptyStateFallback' }, [
        'No tasks due on this date.'
      ]));
    } else {
      list.forEach(t => {
        const cn = clientNameById(t.clientId);
        const tone = alertToneForTask(t);
        wrap.appendChild(el('div', {
          class: 'agendaItem',
          onclick: () => window.__cos_openTask(t.id)
        }, [
          el('div', { class: 'agendaTop' }, [
            el('div', {}, [
              el('div', { class: 'agendaTitle', text: t.title || '(task)' }),
              el('div', { class: 'agendaMeta', text: `${cn || '‚Äî'} ‚Ä¢ Start ${t.startDateYmd ? ymdToDmy(t.startDateYmd) : '‚Äî'} ‚Ä¢ ${t.status || '‚Äî'} ‚Ä¢ ${t.assignedToEmail || ''}` })
            ]),
            (tone ? pill(t.status === 'COMPLETED' ? 'DONE' : (tone === 'danger' ? 'URGENT' : 'SOON'), tone) : el('div'))
          ])
        ]));
      });
    }

    return el('div', {}, [header, wrap]);
  }

  /* ---------- Agenda view ---------- */
  function renderAgenda() {
    const tasks = (state.tasks || []).filter(t => !!t.dueDateYmd).slice();
    tasks.sort((a,b) => String(a.dueDateYmd || '').localeCompare(String(b.dueDateYmd || '')));

    const header = el('div', { class: 'calTop' }, [
      el('div', { class: 'row' }, [
        el('span', { class: 'chip', text: 'Agenda' }),
        el('span', { class: 'chip', text: `${tasks.length} tasks` })
      ]),
      el('div', { class: 'calTabs' }, [
        el('button', { class: `btn btnSmall btnGhost ${calState.view==='MONTH'?'cosTabActive':''}`, type: 'button', text: 'Month', onclick: () => setView('MONTH') }),
        el('button', { class: `btn btnSmall btnGhost ${calState.view==='WEEK'?'cosTabActive':''}`, type: 'button', text: 'Week', onclick: () => setView('WEEK') }),
        el('button', { class: `btn btnSmall btnGhost ${calState.view==='DAY'?'cosTabActive':''}`, type: 'button', text: 'Day', onclick: () => setView('DAY') }),
        el('button', { class: `btn btnSmall btnGhost ${calState.view==='AGENDA'?'cosTabActive':''}`, type: 'button', text: 'Agenda', onclick: () => setView('AGENDA') })
      ])
    ]);

    const wrap = el('div', { class: 'agendaList' });

    if (!tasks.length) {
      wrap.appendChild(el('div', { class: 'emptyStateFallback' }, ['No tasks to show.']));
      return el('div', {}, [header, wrap]);
    }

    let lastY = '';
    tasks.slice(0, 220).forEach(t => {
      const y = t.dueDateYmd || '';
      if (y && y !== lastY) {
        lastY = y;
        wrap.appendChild(el('div', { class: 'label', style: 'margin-top:10px' }, [ymdToDmy(y)]));
      }
      const cn = clientNameById(t.clientId);
      const tone = alertToneForTask(t);
      wrap.appendChild(el('div', {
        class: 'agendaItem',
        onclick: () => window.__cos_openTask(t.id)
      }, [
        el('div', { class: 'agendaTop' }, [
          el('div', {}, [
            el('div', { class: 'agendaTitle', text: t.title || '(task)' }),
            el('div', { class: 'agendaMeta', text: `${cn || '‚Äî'} ‚Ä¢ ${t.status || '‚Äî'} ‚Ä¢ ${t.assignedToEmail || ''}` })
          ]),
          (tone ? pill(t.status === 'COMPLETED' ? 'DONE' : (tone === 'danger' ? 'URGENT' : 'SOON'), tone) : el('div'))
        ])
      ]));
    });

    if (tasks.length > 220) {
      wrap.appendChild(el('div', { class: 'help' }, [
        'Agenda is limited to 220 rows for speed. Use Work Queue filters for deeper review.'
      ]));
    }

    return el('div', {}, [header, wrap]);
  }

  /* ---------- Render mount ---------- */
  function render() {
 if (!state.uid) return;
 if (!mount) return;

 // FIX: replace existing calendar instead of appending
 mount.innerHTML = '';

 const bodyNode =
 (calState.view === 'MONTH') ? renderMonth() :
 (calState.view === 'WEEK') ? renderWeek() :
 (calState.view === 'DAY') ? renderDay() :
 renderAgenda();

 const right = el('div', { class: 'row' }, [
  el('span', { class: 'chip', text: state.isPartner ? 'Partner timeline' : state.isManager ? 'Manager timeline' : 'My timeline' })
 ]);

 mount.appendChild(el('div', { class: 'gridMax' }, [
  card('Timeline', 'Old UI calendar: Month / Week / Day / Agenda. Click items to open inspector.', right, bodyNode)
 ]));
}

  window.__cos_mountCalendar = () => render();

  // If currently on calendar, render immediately
  if (state.uid && state.activeView === 'calendar') render();
})();
</script>
<script>
/* =========================
 ComplianceOS ‚Äî Part 5/8 (OLD-UI methodology)
 Clients workspace (PARTNER only)
 - Old UI layout: Create Client card + Clients table + Selected client editor
 - Client history exports (XLSX + PDF) using new backend endpoints
 ========================= */
(() => {
  'use strict';

  const { state, apiJson, downloadBase64, dmyToYmd, ymdToDmy, toast } = window.__cos;
  const mount = document.getElementById('viewMount');

  /* ---------- CSS helpers (only if Part 3 didn't inject) ---------- */
  const STYLE_ID = 'cosOldUiPart5Style';
  if (!document.getElementById(STYLE_ID)) {
    const st = document.createElement('style');
    st.id = STYLE_ID;
    st.textContent = `
      /* If Part 3 already injected these, duplicates are harmless */
      .cosGrid{ display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px; }
      .cosCol12{ grid-column: span 12; }
      .cosCol6{ grid-column: span 6; }
      .cosCol4{ grid-column: span 4; }
      .cosCol3{ grid-column: span 3; }
      @media (max-width: 980px){
        .cosCol6,.cosCol4,.cosCol3{ grid-column: span 12; }
      }
      .tableWrap{
        overflow-x: auto;
        overflow-y: hidden;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: color-mix(in srgb, var(--panel2) 75%, transparent);
      }
      table{ width:100%; border-collapse: collapse; min-width: 980px; }
      th, td{
        padding: 12px 12px;
        border-bottom: 1px solid color-mix(in srgb, var(--border) 70%, transparent);
        font-size: 13px;
        vertical-align: top;
        font-weight: 650;
      }
      th{
        text-align:left;
        font-weight: 950;
        color: var(--text);
        background: color-mix(in srgb, var(--panelSolid) 92%, transparent);
      }
      tr.cosRow:hover td{
        background: color-mix(in srgb, var(--primary) 6%, transparent);
      }
      .pill{
        display:inline-flex; align-items:center;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--border) 85%, transparent);
        background: var(--panel2);
        font-size: 12px;
        font-weight: 950;
        color: var(--muted);
        white-space: nowrap;
      }
    `;
    document.head.appendChild(st);
  }

  /* ---------- DOM helpers ---------- */
  const el = (tag, attrs = {}, children = []) => {
    const n = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs || {})) {
      if (k === 'class') n.className = v;
      else if (k === 'text') n.textContent = v;
      else if (k === 'html') n.innerHTML = v;
      else if (k === 'style') n.setAttribute('style', String(v));
      else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
      else if (v === false || v === null || v === undefined) continue;
      else n.setAttribute(k, String(v));
    }
    for (const c of (children || [])) n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
    return n;
  };

  function card(title, subtitle, rightNode, bodyNode) {
    return el('div', { class: 'card' }, [
      el('div', { class: 'cardHead' }, [
        el('div', {}, [
          el('h2', { text: title }),
          el('p', { text: subtitle || '' })
        ]),
        rightNode || el('div')
      ]),
      el('div', { class: 'cardBody' }, [bodyNode || el('div')])
    ]);
  }

  function chip(text) {
    return el('span', { class: 'chip', text: String(text || '') });
  }

  function asEmailList(str) {
    return String(str || '')
      .split(/[;,:]/)
      .map(s => s.trim())
      .filter(Boolean);
  }

  function joinEmails(arr) {
    return Array.isArray(arr) ? arr.filter(Boolean).join('; ') : '';
  }

  /* ---------- Local view state ---------- */
  const clientsState = {
    q: '',
    selectedId: null,
    rangeFrom: (() => {
      const d = new Date();
      d.setMonth(d.getMonth() - 1);
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = d.getFullYear();
      return `${dd}-${mm}-${yyyy}`;
    })(),
    rangeTo: (() => {
      const d = new Date();
      d.setMonth(d.getMonth() + 2);
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = d.getFullYear();
      return `${dd}-${mm}-${yyyy}`;
    })()
  };

  function mountLocked() {
    mount.innerHTML = '';
    mount.appendChild(el('div', { class: 'gridMax' }, [
      card('Clients', 'This area is available to PARTNER role only.', chip(state.role), el('div', { class: 'help', html: `
        <div>Your current role is <b>${state.role}</b>.</div>
        <div style="margin-top:8px">If you should have access, ask a partner to update your role in Ops & Reports ‚Üí Admin.</div>
      ` }))
    ]));
  }

  function filteredClients() {
    const q = String(clientsState.q || '').trim().toLowerCase();
    const list = (state.clients || []).slice();
    if (!q) return list;
    return list.filter(c => {
      const hay = `${c.name || ''} ${c.primaryEmail || ''} ${c.pan || ''} ${c.gstin || ''} ${c.cin || ''}`.toLowerCase();
      return hay.includes(q);
    });
  }

  function getClientById(id) {
    if (!id) return null;
    return (state.clients || []).find(c => c.id === id) || null;
  }

  /* ---------- Panels ---------- */
  function createClientPanel() {
    const name = el('input', { class: 'input', placeholder: 'ABC Pvt Ltd' });
    const pan = el('input', { class: 'input' });
    const gstin = el('input', { class: 'input' });
    const cin = el('input', { class: 'input' });
    const ay = el('input', { class: 'input', placeholder: '2025-26' });
    const eng = el('input', { class: 'input', placeholder: 'GST + TDS' });
    const email = el('input', { class: 'input', placeholder: 'client@example.com' });
    const cc = el('input', { class: 'input', placeholder: 'a@x.com; b@y.com' });
    const bcc = el('input', { class: 'input', placeholder: 'a@x.com; b@y.com' });

    const btn = el('button', {
      class: 'btn btnPrimary',
      type: 'button',
      text: 'Create Client',
      onclick: async () => {
        const payload = {
          name: String(name.value || '').trim(),
          pan: String(pan.value || '').trim(),
          gstin: String(gstin.value || '').trim(),
          cin: String(cin.value || '').trim(),
          assessmentYear: String(ay.value || '').trim(),
          engagementType: String(eng.value || '').trim(),
          primaryEmail: String(email.value || '').trim(),
          ccEmails: asEmailList(cc.value),
          bccEmails: asEmailList(bcc.value)
        };
        if (!payload.name) return toast('Client name is required', 4000);

        const r = await apiJson('/clients_create', payload);
        if (!r.ok) return toast(`Create failed: ${r.error || JSON.stringify(r)}`, 9000);

        toast('Client created');
        clientsState.selectedId = r.clientId || clientsState.selectedId;
      }
    });

    const grid = el('div', { class: 'cosGrid' }, [
      el('div', { class: 'cosCol12 field' }, [el('div', { class: 'label', text: 'Client name' }), name]),
      el('div', { class: 'cosCol6 field' }, [el('div', { class: 'label', text: 'PAN' }), pan]),
      el('div', { class: 'cosCol6 field' }, [el('div', { class: 'label', text: 'GSTIN' }), gstin]),
      el('div', { class: 'cosCol6 field' }, [el('div', { class: 'label', text: 'CIN' }), cin]),
      el('div', { class: 'cosCol6 field' }, [el('div', { class: 'label', text: 'Assessment Year (AY)' }), ay]),
      el('div', { class: 'cosCol12 field' }, [el('div', { class: 'label', text: 'Engagement type' }), eng]),
      el('div', { class: 'cosCol12 field' }, [el('div', { class: 'label', text: 'Primary email' }), email]),
      el('div', { class: 'cosCol6 field' }, [el('div', { class: 'label', text: 'CC emails' }), cc]),
      el('div', { class: 'cosCol6 field' }, [el('div', { class: 'label', text: 'BCC emails' }), bcc]),
      el('div', { class: 'cosCol12 row', style: 'justify-content:flex-end' }, [btn]),
      el('div', { class: 'cosCol12 help' }, ['Tip: Keep client names stable to avoid accidental duplicates.'])
    ]);

    return grid;
  }

  function clientsTablePanel() {
    const q = el('input', { class: 'input', value: clientsState.q, placeholder: 'Search clients‚Ä¶ (name, email, PAN, GSTIN)' });
    q.addEventListener('input', () => { clientsState.q = q.value; render(); });

    const rows = filteredClients().slice().sort((a,b) => String(a.name||'').localeCompare(String(b.name||'')));

    const tbody = el('tbody');
    if (!rows.length) {
      tbody.appendChild(el('tr', {}, [
        el('td', { colspan: '6', style: 'padding:14px', html: `
          <div class="help">
            No clients found.
          </div>
        `})
      ]));
    } else {
      rows.slice(0, 600).forEach(c => {
        const tr = el('tr', {
          class: 'cosRow',
          style: `cursor:pointer; ${clientsState.selectedId === c.id ? 'outline: 2px solid color-mix(in srgb, var(--primary) 35%, transparent); outline-offset:-2px;' : ''}`
        });
        tr.appendChild(el('td', { html: `<b>${(c.name||'').replaceAll('<','&lt;')}</b>` }));
        tr.appendChild(el('td', { text: c.primaryEmail || '' }));
        tr.appendChild(el('td', { text: c.pan || '' }));
        tr.appendChild(el('td', { text: c.gstin || '' }));
        tr.appendChild(el('td', { text: c.engagementType || '' }));
        tr.appendChild(el('td', { html: `<span class="pill">${clientsState.selectedId === c.id ? 'Selected' : 'Open'}</span>` }));

        tr.addEventListener('click', () => {
          clientsState.selectedId = c.id;
          render();
        });

        tbody.appendChild(tr);
      });

      if (rows.length > 600) {
        tbody.appendChild(el('tr', {}, [
          el('td', { colspan: '6', class: 'help', style: 'padding:14px', text: 'List limited to 600. Refine search to find a client.' })
        ]));
      }
    }

    const table = el('div', { class: 'tableWrap', style: 'margin-top:12px' }, [
      el('table', {}, [
        el('thead', {}, [
          el('tr', {}, [
            el('th', { text: 'Name' }),
            el('th', { text: 'Email' }),
            el('th', { text: 'PAN' }),
            el('th', { text: 'GSTIN' }),
            el('th', { text: 'Engagement' }),
            el('th', { text: '' })
          ])
        ]),
        tbody
      ])
    ]);

    return el('div', {}, [
      el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Search' }), q]),
      table
    ]);
  }

  function selectedClientEditorPanel(client) {
    if (!client) {
      return el('div', { class: 'help', html: `
        <div style="font-weight:950;color:var(--text)">No client selected</div>
        <div style="margin-top:8px">Click a client row to edit details and download history.</div>
      `});
    }

    const name = el('input', { class: 'input', value: client.name || '' });
    const pan = el('input', { class: 'input', value: client.pan || '' });
    const gstin = el('input', { class: 'input', value: client.gstin || '' });
    const cin = el('input', { class: 'input', value: client.cin || '' });
    const ay = el('input', { class: 'input', value: client.assessmentYear || '' });
    const eng = el('input', { class: 'input', value: client.engagementType || '' });
    const email = el('input', { class: 'input', value: client.primaryEmail || '' });
    const cc = el('input', { class: 'input', value: joinEmails(client.ccEmails), placeholder: 'a@x.com; b@y.com' });
    const bcc = el('input', { class: 'input', value: joinEmails(client.bccEmails), placeholder: 'a@x.com; b@y.com' });

    const from = el('input', { class: 'input', value: clientsState.rangeFrom, placeholder: 'DD-MM-YYYY' });
    const to = el('input', { class: 'input', value: clientsState.rangeTo, placeholder: 'DD-MM-YYYY' });
    from.addEventListener('input', () => { clientsState.rangeFrom = from.value; });
    to.addEventListener('input', () => { clientsState.rangeTo = to.value; });

    const btnSave = el('button', {
      class: 'btn btnPrimary',
      type: 'button',
      text: 'Save changes',
      onclick: async () => {
        const payload = {
          clientId: client.id,
          name: String(name.value || '').trim(),
          pan: String(pan.value || '').trim(),
          gstin: String(gstin.value || '').trim(),
          cin: String(cin.value || '').trim(),
          assessmentYear: String(ay.value || '').trim(),
          engagementType: String(eng.value || '').trim(),
          primaryEmail: String(email.value || '').trim(),
          ccEmails: asEmailList(cc.value),
          bccEmails: asEmailList(bcc.value)
        };
        if (!payload.name) return toast('Name is required', 4000);

        const r = await apiJson('/clients_update', payload);
        if (!r.ok) return toast(`Save failed: ${r.error || JSON.stringify(r)}`, 9000);
        toast('Client saved');
      }
    });

    async function exportXlsx() {
      let fromYmd, toYmd;
      try { fromYmd = dmyToYmd(from.value.trim()); } catch (e) { return toast(e.message, 6500); }
      try { toYmd = dmyToYmd(to.value.trim()); } catch (e) { return toast(e.message, 6500); }

      const r = await apiJson('/exports_clientHistoryXlsx', { clientId: client.id, fromYmd, toYmd });
      if (!r.ok) return toast(`Export failed: ${r.error || JSON.stringify(r)}`, 9000);

      downloadBase64({
        fileName: r.fileName,
        base64: r.base64,
        mime: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      });
      toast('XLSX downloaded');
    }

    async function exportPdf() {
      let fromYmd, toYmd;
      try { fromYmd = dmyToYmd(from.value.trim()); } catch (e) { return toast(e.message, 6500); }
      try { toYmd = dmyToYmd(to.value.trim()); } catch (e) { return toast(e.message, 6500); }

      const r = await apiJson('/reports_clientHistoryPdf', { clientId: client.id, fromYmd, toYmd });
      if (!r.ok) return toast(`PDF failed: ${r.error || JSON.stringify(r)}`, 9000);

      downloadBase64({ fileName: r.fileName, base64: r.base64, mime: r.mime || 'application/pdf' });
      toast('PDF downloaded');
    }

    const grid = el('div', { class: 'cosGrid' }, [
      el('div', { class: 'cosCol12 help', html: `<div style="font-weight:950;color:var(--text)">${(client.name || '(client)').replaceAll('<','&lt;')}</div><div style="margin-top:6px">Editing master profile used as defaults for tasks.</div>` }),

      el('div', { class: 'cosCol12 field' }, [el('div', { class: 'label', text: 'Client name' }), name]),
      el('div', { class: 'cosCol6 field' }, [el('div', { class: 'label', text: 'PAN' }), pan]),
      el('div', { class: 'cosCol6 field' }, [el('div', { class: 'label', text: 'GSTIN' }), gstin]),
      el('div', { class: 'cosCol6 field' }, [el('div', { class: 'label', text: 'CIN' }), cin]),
      el('div', { class: 'cosCol6 field' }, [el('div', { class: 'label', text: 'Assessment year (AY)' }), ay]),
      el('div', { class: 'cosCol12 field' }, [el('div', { class: 'label', text: 'Engagement type' }), eng]),
      el('div', { class: 'cosCol12 field' }, [el('div', { class: 'label', text: 'Primary email' }), email]),
      el('div', { class: 'cosCol6 field' }, [el('div', { class: 'label', text: 'CC emails' }), cc]),
      el('div', { class: 'cosCol6 field' }, [el('div', { class: 'label', text: 'BCC emails' }), bcc]),

      el('div', { class: 'cosCol12 row', style: 'justify-content:flex-end' }, [btnSave]),

      el('div', { class: 'cosCol12', style: 'margin-top:6px' }, [
        el('div', { class: 'card', style: 'border-radius:16px; box-shadow:none' }, [
          el('div', { class: 'cardHead' }, [
            el('div', {}, [
              el('h2', { text: 'Client history exports' }),
              el('p', { text: 'Download tasks for this client with full fields (XLSX + PDF).' })
            ]),
            chip('Exports')
          ]),
          el('div', { class: 'cardBody' }, [
            el('div', { class: 'cosGrid' }, [
              el('div', { class: 'cosCol6 field' }, [el('div', { class: 'label', text: 'From' }), from]),
              el('div', { class: 'cosCol6 field' }, [el('div', { class: 'label', text: 'To' }), to]),
              el('div', { class: 'cosCol12 row', style: 'justify-content:flex-end' }, [
                el('button', { class: 'btn', type: 'button', text: 'Download XLSX', onclick: exportXlsx }),
                el('button', { class: 'btn btnPrimary', type: 'button', text: 'Download PDF', onclick: exportPdf })
              ]),
              el('div', { class: 'cosCol12 help', html: 'Tip: History includes mail flags, recipient overrides, thread IDs, attachments, comments, and audit logs.' })
            ])
          ])
        ])
      ])
    ]);

    return grid;
  }

  /* ---------- Render ---------- */
  function render() {
    if (!mount) return;
    mount.innerHTML = '';
    if (!state.uid) return;
    if (!state.isPartner) return mountLocked();

    const selected = getClientById(clientsState.selectedId);

    const rightHeader = el('div', { class: 'row' }, [
      chip(`${(state.clients || []).length} clients`)
    ]);

    mount.appendChild(el('div', { class: 'gridMax' }, [
      card('Clients', 'Old UI workflow: create ‚Üí list ‚Üí select ‚Üí edit / export.', rightHeader,
        el('div', { class: 'cosGrid' }, [
          el('div', { class: 'cosCol12' }, [
            card('Create Client', 'Add a new client profile (partner-only).', null, createClientPanel())
          ]),
          el('div', { class: 'cosCol12' }, [
            card('Clients', 'Click a row to select. Search helps narrow large lists.', null, clientsTablePanel())
          ]),
          el('div', { class: 'cosCol12' }, [
            card('Selected client', 'Edit details and run exports for a specific client.', null, selectedClientEditorPanel(selected))
          ])
        ])
      )
    ]));
  }

  window.__cos_mountClients = render;

  // Command palette helper
  window.__cos_openClient = (clientId) => {
    clientsState.selectedId = clientId;
    render();
  };

  // Render if already on Clients view
  if (state.uid && state.activeView === 'clients') render();
})();
</script>
<script>
/* =========================
 ComplianceOS ‚Äî Part 6/8 (OLD-UI methodology)
 Task Drawer (right-side) + Create Task (same drawer)
 - OLD feel: overlay + right drawer + sections (Quick Info / Status / Edit / Comments / Timeline / Attachments)
 - NEW backend calls preserved:
   /tasks_updatestatus, /tasks_updatetask, /tasks_delete
   /tasks_uploadattachment (form)
   /tasks_addcomment
   /series_rebuild, /series_reassign
   /exports_taskHistoryXlsx, /reports_taskHistoryPdf
   /tasks_createone
   /tasks_bulkUpdate (used for Snooze single-task, works like bulk)
 - Live reads: comments subcollection + auditLogs (Firestore)
 ========================= */
(() => {
  'use strict';

  const {
    state,
    db,
    apiJson,
    apiForm,
    downloadBase64,
    ymdToDmy,
    dmyToYmd,
    toast
  } = window.__cos;

  const overlay = document.getElementById('overlay');

  /* ---------- Drawer CSS (inject once) ---------- */
  const STYLE_ID = 'cosOldUiDrawerStyle';
  if (!document.getElementById(STYLE_ID)) {
    const st = document.createElement('style');
    st.id = STYLE_ID;
    st.textContent = `
      .cosDrawer{
        position: fixed;
        top: 0;
        right: 0;
        height: 100vh;
        width: min(760px, 94vw);
        z-index: 110;
        transform: translateX(102%);
        transition: transform .2s ease;
        box-shadow: var(--shadow-md);
        border-left: 1px solid var(--border);
        background: var(--panelSolid);
        display:flex;
        flex-direction:column;
      }
      body[data-theme="dark"] .cosDrawer{ background: var(--panelSolid); }
      .cosDrawer.show{ transform: translateX(0); }
      .cosDrawer.fullscreen{
        width: 100vw !important;
        max-width: none !important;
        border-left: none;
      }
      .cosDrawerHead{
        padding: 14px;
        border-bottom: 1px solid var(--border);
        display:flex;
        justify-content:space-between;
        gap: 10px;
        align-items:flex-start;
        background: color-mix(in srgb, var(--panelSolid) 92%, transparent);
        backdrop-filter: blur(8px);
      }
      .cosDrawerTitle{ font-weight: 950; font-size: 16px; letter-spacing:.2px; }
      .cosDrawerSub{ margin-top: 6px; color: var(--muted); font-size: 12px; font-weight: 750; line-height: 1.35; }
      .cosDrawerBody{
        padding: 14px;
        overflow:auto; /* allowed inner scroll */
        flex:1;
      }

      /* Old UI card spacing inside drawer */
      .cosDrawerBody .card{ border-radius: 16px; box-shadow: none; }
      .cosDrawerBody .card + .card{ margin-top: 12px; }
      .cosDrawerBody .cardHead{ padding: 12px 12px 10px; }
      .cosDrawerBody .cardBody{ padding: 12px; }

      .cosTwoCol{ display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px; }

/* Dropdown width/overflow fix (prevents long client/type/status from stretching UI) */
.cosDrawerBody .field{ align-items:flex-start; }
.cosDrawerBody select.select{
 width: min(520px, 100%);
 max-width: 100%;
 white-space: nowrap;
 overflow: hidden;
 text-overflow: ellipsis;
}
      .cosCol12{ grid-column: span 12; }
      .cosCol6{ grid-column: span 6; }
      .cosCol4{ grid-column: span 4; }
      .cosCol3{ grid-column: span 3; }
      @media (max-width: 980px){
        .cosCol6,.cosCol4,.cosCol3{ grid-column: span 12; }
      }

      .cosMiniPill{
        display:inline-flex; align-items:center;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--border) 85%, transparent);
        background: var(--panel2);
        font-size: 12px;
        font-weight: 950;
        color: var(--muted);
        white-space: nowrap;
      }
      .cosMiniPill.ok{
        border-color: color-mix(in srgb, var(--ok) 55%, transparent);
        background: color-mix(in srgb, var(--ok) 18%, transparent);
        color: var(--text);
      }
      .cosMiniPill.warn{
        border-color: color-mix(in srgb, var(--warning) 55%, transparent);
        background: color-mix(in srgb, var(--warning) 18%, transparent);
        color: var(--text);
      }
      .cosMiniPill.bad{
        border-color: color-mix(in srgb, var(--danger) 55%, transparent);
        background: color-mix(in srgb, var(--danger) 18%, transparent);
        color: var(--text);
      }

      .cosPre{
        white-space: pre-wrap;
        font-family: var(--mono);
        font-size: 12px;
        color: var(--muted);
        margin: 10px 0 0;
      }
    `;
    document.head.appendChild(st);
  }

  /* ---------- DOM helpers ---------- */
  const h = (tag, attrs = {}, children = []) => {
    const n = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs || {})) {
      if (k === 'class') n.className = v;
      else if (k === 'text') n.textContent = v;
      else if (k === 'html') n.innerHTML = v;
      else if (k === 'style') n.setAttribute('style', String(v));
      else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
      else if (v === false || v === null || v === undefined) continue;
      else n.setAttribute(k, String(v));
    }
    for (const c of (children || [])) n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
    return n;
  };

  function card(title, subtitle, rightNode, bodyNode) {
    return h('div', { class: 'card' }, [
      h('div', { class: 'cardHead' }, [
        h('div', {}, [
          h('h2', { text: title }),
          subtitle ? h('p', { text: subtitle }) : h('p', { style: 'display:none' })
        ]),
        rightNode || h('div')
      ]),
      h('div', { class: 'cardBody' }, [bodyNode || h('div')])
    ]);
  }

  function pill(text, tone) {
    const cls = tone === 'ok' ? 'cosMiniPill ok' : tone === 'warn' ? 'cosMiniPill warn' : tone === 'bad' ? 'cosMiniPill bad' : 'cosMiniPill';
    return h('span', { class: cls, text: String(text || '') });
  }

  function asEmailList(str) {
    return String(str || '')
      .split(/[;,:]/)
      .map(s => s.trim())
      .filter(Boolean);
  }
  function joinEmails(arr) {
    return Array.isArray(arr) ? arr.filter(Boolean).join('; ') : '';
  }

  function roleCanEditDetails() {
    return state.isPartner || state.isManager;
  }
  function statusOptionsForRole() {
   // Everyone can mark COMPLETED (backend enforces "must be assignee" for associates)
   return ['PENDING', 'IN_PROGRESS', 'CLIENT_PENDING', 'APPROVAL_PENDING', 'COMPLETED'];
  }

  function taskById(id) {
    return (state.tasks || []).find(t => t.id === id) || null;
  }
  function clientName(task) {
    return state.clientsById?.get(task.clientId)?.name || '';
  }

  /* ---------- Drawer DOM ---------- */
  const drawer = h('div', { class: 'cosDrawer', id: 'cosDrawer' });
  const head = h('div', { class: 'cosDrawerHead' });
  const headLeft = h('div', { style: 'min-width:0' });
  const dTitle = h('div', { class: 'cosDrawerTitle', id: 'cosDTitle', text: 'Task' });
  const dSub = h('div', { class: 'cosDrawerSub', id: 'cosDSub', text: '‚Äî' });
  headLeft.appendChild(dTitle);
  headLeft.appendChild(dSub);

  const headRight = h('div', { class: 'row', style: 'justify-content:flex-end' });

  const btnPrint = h('button', { class: 'btn btnSmall', type: 'button', text: 'Print' });
  const btnExpand = h('button', { class: 'btn btnSmall', type: 'button', text: 'Expand' });
  const btnClose = h('button', { class: 'btn btnSmall btnGhost', type: 'button', text: 'Close' });

  headRight.appendChild(btnPrint);
  headRight.appendChild(btnExpand);
  headRight.appendChild(btnClose);

  head.appendChild(headLeft);
  head.appendChild(headRight);

  const body = h('div', { class: 'cosDrawerBody', id: 'cosDBody' });

  drawer.appendChild(head);
  drawer.appendChild(body);
  document.body.appendChild(drawer);

  let drawerFullscreen = false;
  let currentTaskId = null;
  let drawerMode = 'task'; // 'task' | 'create'

  function anyDialogOpen() {
    return !!document.querySelector('.dialog.show');
  }

  function setFullscreen(on) {
    drawerFullscreen = !!on;
    drawer.classList.toggle('fullscreen', drawerFullscreen);
    btnExpand.textContent = drawerFullscreen ? 'Shrink' : 'Expand';
  }

  function openDrawer() {
    overlay?.classList.add('show');
    drawer.classList.add('show');
    // Focus close for accessibility
    setTimeout(() => btnClose.focus(), 0);
  }

  function closeDrawer() {
    currentTaskId = null;
    drawerMode = 'task';
    drawer.classList.remove('show');
    setFullscreen(false);
    // only hide overlay if no dialog is open
    if (!anyDialogOpen()) overlay?.classList.remove('show');
  }

  btnClose.addEventListener('click', closeDrawer);
  btnExpand.addEventListener('click', () => setFullscreen(!drawerFullscreen));
  btnPrint.addEventListener('click', () => window.print());

  // Overlay click: close drawer only if no dialog open (dialog closes first)
  overlay?.addEventListener('click', () => {
    if (anyDialogOpen()) return;
    if (drawer.classList.contains('show')) closeDrawer();
  }, true);

  // ESC: close drawer only when no dialog is open
  document.addEventListener('keydown', (e) => {
    if (e.key !== 'Escape') return;
    if (anyDialogOpen()) return;
    if (drawer.classList.contains('show')) closeDrawer();
  });

  /* ---------- Live subscriptions (comments + timeline) ---------- */
  let unsubComments = null;
  let unsubTimeline = null;

  function clearLive() {
    try { unsubComments?.(); } catch {}
    try { unsubTimeline?.(); } catch {}
    unsubComments = null;
    unsubTimeline = null;
  }

  function mountComments(taskId) {
    const list = h('div', { style: 'display:flex; flex-direction:column; gap:10px; margin-top:10px' });
    const input = h('textarea', { class: 'textarea', placeholder: 'Write a comment‚Ä¶ Use @email or @Display Name to mention.', style: 'min-height: 90px' });
    const btn = h('button', { class: 'btn btnPrimary', type: 'button', text: 'Add comment' });

    btn.onclick = async () => {
      const text = String(input.value || '').trim();
      if (!text) return toast('Write a comment first', 3200);
      const r = await apiJson('/tasks_addcomment', { taskId, text });
      if (!r.ok) return toast(`Comment failed: ${r.error || JSON.stringify(r)}`, 9000);
      input.value = '';
      toast(r.notificationsCreated ? `Comment added ¬∑ mentions notified: ${r.notificationsCreated}` : 'Comment added');
    };

    if (unsubComments) unsubComments();
    unsubComments = db.collection('tasks').doc(taskId).collection('comments')
      .orderBy('createdAt', 'asc')
      .limit(250)
      .onSnapshot((snap) => {
        list.innerHTML = '';
        if (snap.empty) {
          list.appendChild(h('div', { class: 'help', text: 'No comments yet.' }));
          return;
        }
        snap.docs.forEach(d => {
          const c = d.data() || {};
          const when = c.createdAt?.toDate?.() ? c.createdAt.toDate().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }) : '';
          const who = c.authorName || c.authorEmail || 'User';

          list.appendChild(h('div', { class: 'card' }, [
            h('div', { class: 'cardBody' }, [
              h('div', { class: 'row', style: 'justify-content:space-between; align-items:flex-start' }, [
                h('div', { style: 'font-weight:950' }, [who]),
                h('div', { class: 'help', text: when })
              ]),
              h('div', { class: 'help', style: 'margin-top:8px; white-space:pre-wrap; color: var(--text)' }, [String(c.text || '')])
            ])
          ]));
        });
      });

    return h('div', {}, [
      h('div', { class: 'help', text: 'Comments are stored per task. Mentions create notifications.' }),
      list,
      h('div', { style: 'margin-top:10px' }, [
        input,
        h('div', { class: 'row', style: 'margin-top:10px; justify-content:flex-end' }, [btn])
      ])
    ]);
  }

  function mountTimeline(taskId) {
    const list = h('div', { style: 'display:flex; flex-direction:column; gap:10px; margin-top:10px' });

    if (unsubTimeline) unsubTimeline();
    unsubTimeline = db.collection('auditLogs')
      .where('taskId', '==', taskId)
      .limit(250)
      .onSnapshot((snap) => {
        list.innerHTML = '';
        if (snap.empty) {
          list.appendChild(h('div', { class: 'help', text: 'No timeline entries yet.' }));
          return;
        }
        const items = snap.docs.map(d => d.data() || {});
        items.sort((a, b) => (a.timestamp?.toMillis?.() || 0) - (b.timestamp?.toMillis?.() || 0));

        for (const a of items) {
          const when = a.timestamp?.toDate?.() ? a.timestamp.toDate().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }) : '';
          list.appendChild(h('div', { class: 'card' }, [
            h('div', { class: 'cardBody' }, [
              h('div', { class: 'row', style: 'justify-content:space-between; align-items:flex-start' }, [
                h('div', { style: 'font-weight:950' }, [String(a.action || '')]),
                h('div', { class: 'help', text: when })
              ]),
              h('div', { class: 'help', style: 'margin-top:6px' }, [String(a.actorEmail || '')]),
              h('pre', { class: 'cosPre' }, [JSON.stringify(a.details || {}, null, 0)])
            ])
          ]));
        }
      });

    return h('div', {}, [
      h('div', { class: 'help', text: 'Status changes, edits, mails, uploads, offline updates.' }),
      list
    ]);
  }

  /* ---------- Attachments ---------- */
  function mountAttachments(task) {
    const list = h('div', { style: 'display:flex; flex-direction:column; gap:10px; margin-top:10px' });

    const btnUpload = h('button', { class: 'btn', type: 'button', text: 'Upload document' });
    btnUpload.onclick = async () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.onchange = async () => {
        const file = input.files?.[0];
        if (!file) return;
        const type = prompt('Document type (CHALLAN / RETURN / ACK / OTHER):', 'ACK') || 'OTHER';

        const fd = new FormData();
        fd.append('taskId', task.id);
        fd.append('type', String(type || 'OTHER').toUpperCase().trim());
        fd.append('file', file, file.name);

        const r = await apiForm('/tasks_uploadattachment', fd);
        if (!r.ok) return toast(`Upload failed: ${r.error || JSON.stringify(r)}`, 9000);
        toast('Uploaded');
      };
      input.click();
    };

    const items = Array.isArray(task.attachments) ? task.attachments.slice().reverse() : [];
    if (!items.length) {
      list.appendChild(h('div', { class: 'help', text: 'No attachments yet.' }));
    } else {
      for (const a of items) {
        list.appendChild(h('div', { class: 'card' }, [
          h('div', { class: 'cardBody' }, [
            h('div', { class: 'row', style: 'justify-content:space-between; align-items:flex-start' }, [
              h('div', { style: 'font-weight:950' }, [`${a.type || 'DOC'} ¬∑ ${a.fileName || ''}`]),
              pill(a.mimeType ? (String(a.mimeType).split('/')[1]?.toUpperCase() || 'FILE') : 'FILE')
            ]),
            a.driveWebViewLink
              ? h('a', { class: 'btn btnSmall btnGhost', href: a.driveWebViewLink, target: '_blank', rel: 'noopener', style: 'margin-top:10px; width:max-content' }, ['Open'])
              : h('div', { class: 'help', style: 'margin-top:10px', text: 'No link available' })
          ])
        ]));
      }
    }

    return h('div', {}, [
      h('div', { class: 'row', style: 'justify-content:flex-end' }, [btnUpload]),
      list
    ]);
  }

  /* ---------- Exports per task ---------- */
  function mountTaskExports(task) {
    const btnX = h('button', { class: 'btn', type: 'button', text: 'History XLSX' });
    const btnP = h('button', { class: 'btn btnPrimary', type: 'button', text: 'History PDF' });

    btnX.onclick = async () => {
      const r = await apiJson('/exports_taskHistoryXlsx', { taskId: task.id });
      if (!r.ok) return toast(`XLSX failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({
        fileName: r.fileName,
        base64: r.base64,
        mime: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      });
      toast('Downloaded XLSX');
    };

    btnP.onclick = async () => {
      const r = await apiJson('/reports_taskHistoryPdf', { taskId: task.id });
      if (!r.ok) return toast(`PDF failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({ fileName: r.fileName, base64: r.base64, mime: r.mime || 'application/pdf' });
      toast('Downloaded PDF');
    };

    return h('div', { class: 'row', style: 'justify-content:flex-end; flex-wrap:wrap' }, [btnX, btnP]);
  }

  /* ---------- Status update (everyone; completion restricted by backend) ---------- */
  function mountStatusPanel(task) {
    const sel = h('select', { class: 'select' });
    sel.appendChild(h('option', { value: '', text: 'Select status‚Ä¶' }));
    for (const s of statusOptionsForRole()) sel.appendChild(h('option', { value: s, text: s }));
    sel.value = task.status || 'PENDING';

    const note = h('textarea', { class: 'textarea', placeholder: 'Status note (optional)', style: 'min-height: 90px' });
    note.value = task.statusNote || '';

    const delayReason = h('select', { class: 'select' }, [
      h('option', { value: '', text: '(no delay reason)' }),
      h('option', { value: 'CLIENT_DELAY', text: 'CLIENT_DELAY' }),
      h('option', { value: 'INTERNAL_DELAY', text: 'INTERNAL_DELAY' })
    ]);
    delayReason.value = task.delayReason || '';

    const delayNotes = h('textarea', { class: 'textarea', placeholder: 'Delay details (optional)', style: 'min-height: 70px' });
    delayNotes.value = task.delayNotes || '';

    const btnSave = h('button', { class: 'btn btnPrimary', type: 'button', text: 'Save status' });
    btnSave.onclick = async () => {
      const newStatus = String(sel.value || '').trim();
      if (!newStatus) return toast('Pick a status', 3200);

      const r = await apiJson('/tasks_updatestatus', {
        taskId: task.id,
        newStatus,
        statusNote: note.value,
        delayReason: delayReason.value || null,
        delayNotes: delayNotes.value
      });

      if (!r.ok) return toast(`Save failed: ${r.error || JSON.stringify(r)}`, 9000);
      toast('Saved');
    };

    // Snooze shortcut (old UI had this)
    const btnSnooze = h('button', { class: 'btn', type: 'button', text: 'Snooze' });
    btnSnooze.onclick = async () => {
      const dmy = prompt('Snooze until (DD-MM-YYYY):', task.snoozedUntilYmd ? ymdToDmy(task.snoozedUntilYmd) : '');
      if (!dmy) return;
      let ymd = '';
      try { ymd = dmyToYmd(dmy); } catch (e) { return toast(e.message, 7000); }

      const r = await apiJson('/tasks_bulkUpdate', { taskIds: [task.id], op: 'SNOOZE', snoozedUntilYmd: ymd });
      if (!r.ok) return toast(`Snooze failed: ${r.error || JSON.stringify(r)}`, 9000);
      toast('Snoozed');
    };

    // Delete
    const btnDeleteOne = h('button', { class: 'btn btnDanger', type: 'button', text: 'Delete task' });
    btnDeleteOne.onclick = async () => {
      if (!confirm('Delete this task?')) return;
      const r = await apiJson('/tasks_delete', { taskId: task.id, applyToSeries: false });
      if (!r.ok) return toast(`Delete failed: ${r.error || JSON.stringify(r)}`, 9000);
      toast('Deleted');
      closeDrawer();
    };

    return h('div', {}, [
      h('div', { class: 'help', html: `Marking <b>COMPLETED</b> triggers a completion email (if enabled) as a reply-all when a start thread exists.` }),
      h('div', { class: 'field', style: 'margin-top:10px' }, [h('div', { class: 'label', text: 'New status' }), sel]),
      h('div', { class: 'field', style: 'margin-top:10px' }, [h('div', { class: 'label', text: 'Status note' }), note]),
      h('div', { class: 'field', style: 'margin-top:10px' }, [h('div', { class: 'label', text: 'Delay reason' }), delayReason]),
      h('div', { class: 'field', style: 'margin-top:10px' }, [h('div', { class: 'label', text: 'Delay details' }), delayNotes]),
      h('div', { class: 'row', style: 'margin-top:10px; justify-content:flex-end; flex-wrap:wrap' }, [
        btnSnooze,
        btnDeleteOne,
        btnSave
      ])
    ]);
  }

  /* ---------- Partner/Manager: edit details + mail overrides + series tools ---------- */
  function mountEditPanel(task) {
    if (!roleCanEditDetails()) {
      return h('div', { class: 'help', html: `
        <div style="font-weight:950;color:var(--text)">Details editing is restricted</div>
        <div style="margin-top:8px">Your role can update status, add comments, and upload attachments. Partner/Manager can edit task details and recipient settings.</div>
      `});
    }

    const applySeries = h('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    applySeries.checked = false;
    applySeries.disabled = !task.seriesId;

    const title = h('input', { class: 'input', value: task.title || '' });

    const category = h('select', { class: 'select' }, [
      h('option', { value: 'GST', text: 'GST' }),
      h('option', { value: 'TDS', text: 'TDS' }),
      h('option', { value: 'INCOME_TAX', text: 'INCOME_TAX' }),
      h('option', { value: 'ROC', text: 'ROC' }),
      h('option', { value: 'ACCOUNTING', text: 'ACCOUNTING' }),
      h('option', { value: 'AUDIT', text: 'AUDIT' }),
      h('option', { value: 'OTHER', text: 'OTHER' })
    ]);
    category.value = String(task.category || 'OTHER').toUpperCase().replace(/\s+/g,'_');

    const type = h('input', { class: 'input', value: task.type || '' });

    const priority = h('select', { class: 'select' }, [
      h('option', { value: 'HIGH', text: 'HIGH' }),
      h('option', { value: 'MEDIUM', text: 'MEDIUM' }),
      h('option', { value: 'LOW', text: 'LOW' })
    ]);
    priority.value = String(task.priority || 'MEDIUM').toUpperCase();

    const due = h('input', { class: 'input', value: task.dueDateYmd ? ymdToDmy(task.dueDateYmd) : '', placeholder: 'DD-MM-YYYY (one task only)' });
    const trigger = h('input', { class: 'input', type: 'number', min: '0', value: String(task.triggerDaysBefore ?? 15) });
    const snooze = h('input', { class: 'input', value: task.snoozedUntilYmd ? ymdToDmy(task.snoozedUntilYmd) : '', placeholder: 'DD-MM-YYYY (optional)' });
    const assignee = h('input', { class: 'input', value: task.assignedToEmail || '', placeholder: 'assignee@firm.com' });

    // Start mail controls + overrides
    const sendStart = h('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    sendStart.checked = (task.sendClientStartMail !== false);

    const toStart = h('input', { class: 'input', value: joinEmails(task.clientToEmails), placeholder: 'a@client.com; b@client.com' });
    const ccStart = h('input', { class: 'input', value: joinEmails(task.clientCcEmails), placeholder: 'cc@firm.com' });
    const bccStart = h('input', { class: 'input', value: joinEmails(task.clientBccEmails), placeholder: 'bcc@firm.com' });

    const ccAssigneeStart = h('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    ccAssigneeStart.checked = (task.ccAssigneeOnClientStart === true);

    const ccManagerStart = h('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    ccManagerStart.checked = (task.ccManagerOnClientStart === true);

    const startSubject = h('input', { class: 'input', value: task.clientStartSubject || '' });
    const startBody = h('textarea', { class: 'textarea', style: 'min-height: 120px' });
    startBody.value = task.clientStartBody || '';

    // Completion mail controls + overrides
    const sendComp = h('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    sendComp.checked = (task.sendClientCompletionMail !== false);

    const toComp = h('input', { class: 'input', value: joinEmails(task.completionToEmails), placeholder: 'To override (optional)' });
    const ccComp = h('input', { class: 'input', value: joinEmails(task.completionCcEmails), placeholder: 'CC override (optional)' });
    const bccComp = h('input', { class: 'input', value: joinEmails(task.completionBccEmails), placeholder: 'BCC override (optional)' });

    const ccAssigneeComp = h('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    ccAssigneeComp.checked = (task.ccAssigneeOnCompletion === true);

    const ccManagerComp = h('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    ccManagerComp.checked = (task.ccManagerOnCompletion === true);

    const compSubject = h('input', { class: 'input', value: task.clientCompletionSubject || '' });
    const compBody = h('textarea', { class: 'textarea', style: 'min-height: 120px' });
    compBody.value = task.clientCompletionBody || '';

    const btnSave = h('button', { class: 'btn btnPrimary', type: 'button', text: 'Save details' });
    btnSave.onclick = async () => {
      let dueYmd = null;
      const dueDmy = String(due.value || '').trim();
      if (dueDmy) {
        try { dueYmd = dmyToYmd(dueDmy); } catch (e) { return toast(e.message, 7000); }
      }

      let snoozeYmd = null;
      const snoozeDmy = String(snooze.value || '').trim();
      if (snoozeDmy) {
        try { snoozeYmd = dmyToYmd(snoozeDmy); } catch (e) { return toast(e.message, 7000); }
      }

      const payload = {
        taskId: task.id,
        applyToSeries: !!applySeries.checked,
        title: title.value,
        category: category.value,
        type: type.value,
        priority: priority.value,
        dueDateYmd: dueYmd, // backend ignores due changes for series edits
        triggerDaysBefore: Number(trigger.value || 0),
        snoozedUntilYmd: snoozeYmd,
        assignedToEmail: String(assignee.value || '').trim(),

        // start mail
        sendClientStartMail: !!sendStart.checked,
        clientToEmails: asEmailList(toStart.value),
        clientCcEmails: asEmailList(ccStart.value),
        clientBccEmails: asEmailList(bccStart.value),
        ccAssigneeOnClientStart: !!ccAssigneeStart.checked,
        ccManagerOnClientStart: !!ccManagerStart.checked,
        clientStartSubject: startSubject.value,
        clientStartBody: startBody.value,

        // completion mail
        sendClientCompletionMail: !!sendComp.checked,
        completionToEmails: asEmailList(toComp.value),
        completionCcEmails: asEmailList(ccComp.value),
        completionBccEmails: asEmailList(bccComp.value),
        ccAssigneeOnCompletion: !!ccAssigneeComp.checked,
        ccManagerOnCompletion: !!ccManagerComp.checked,
        clientCompletionSubject: compSubject.value,
        clientCompletionBody: compBody.value
      };

      const r = await apiJson('/tasks_updatetask', payload);
      if (!r.ok) return toast(`Save failed: ${r.error || JSON.stringify(r)}`, 9000);
      toast(`Saved${payload.applyToSeries ? ' (series)' : ''}`);
    };

    const btnDeleteSeries = h('button', { class: 'btn btnDanger', type: 'button', text: 'Delete series', disabled: !task.seriesId });
    btnDeleteSeries.onclick = async () => {
      if (!task.seriesId) return;
      if (!confirm('Delete entire series?')) return;
      const r = await apiJson('/tasks_delete', { taskId: task.id, applyToSeries: true });
      if (!r.ok) return toast(`Delete failed: ${r.error || JSON.stringify(r)}`, 9000);
      toast('Series deleted');
      closeDrawer();
    };

    // Series tools
    const seriesTools = (() => {
      if (!task.seriesId) return h('div', { class: 'help', text: 'This task is not part of a series.' });

      const addCount = h('input', { class: 'input', type: 'number', min: '1', value: '1' });
      const btnAdd = h('button', { class: 'btn', type: 'button', text: 'Add tasks' });
      btnAdd.onclick = async () => {
        const n = Math.max(1, Number(addCount.value || 1));
        const r = await apiJson('/series_rebuild', { seriesId: task.seriesId, addCount: n });
        if (!r.ok) return toast(`Series add failed: ${r.error || JSON.stringify(r)}`, 9000);
        toast(`Added ${r.created || 0} tasks`);
      };

      const assignEmail = h('input', { class: 'input', placeholder: 'assignee@firm.com', value: task.assignedToEmail || '' });
      const btnReassign = h('button', { class: 'btn', type: 'button', text: 'Reassign series' });
      btnReassign.onclick = async () => {
        const email = String(assignEmail.value || '').trim();
        if (!email) return toast('Enter email', 3200);
        const r = await apiJson('/series_reassign', { seriesId: task.seriesId, assignedToEmail: email });
        if (!r.ok) return toast(`Series reassign failed: ${r.error || JSON.stringify(r)}`, 9000);
        toast('Series reassigned');
      };

      return h('div', { class: 'cosTwoCol' }, [
        h('div', { class: 'cosCol6 field' }, [h('div', { class: 'label', text: 'Add more tasks' }), addCount]),
        h('div', { class: 'cosCol6 row', style: 'align-items:flex-end; justify-content:flex-end' }, [btnAdd]),
        h('div', { class: 'cosCol6 field' }, [h('div', { class: 'label', text: 'Reassign series to' }), assignEmail]),
        h('div', { class: 'cosCol6 row', style: 'align-items:flex-end; justify-content:flex-end' }, [btnReassign])
      ]);
    })();

    const grid = h('div', { class: 'cosTwoCol' }, [
      h('div', { class: 'cosCol12' }, [
        h('label', { class: 'chip', style: `gap:10px; ${task.seriesId ? '' : 'opacity:.6'}` }, [
          applySeries,
          h('span', { text: 'Apply edits to entire series' })
        ])
      ]),

      h('div', { class: 'cosCol12 field' }, [h('div', { class: 'label', text: 'Title' }), title]),
      h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'Category' }), category]),
      h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'Type' }), type]),
      h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'Priority' }), priority]),

      h('div', { class: 'cosCol6 field' }, [h('div', { class: 'label', text: 'Due date (one task only)' }), due]),
      h('div', { class: 'cosCol3 field' }, [h('div', { class: 'label', text: 'Trigger days' }), trigger]),
      h('div', { class: 'cosCol3 field' }, [h('div', { class: 'label', text: 'Snoozed until' }), snooze]),

      h('div', { class: 'cosCol12 field' }, [h('div', { class: 'label', text: 'Assignee email' }), assignee]),

      h('div', { class: 'cosCol12' }, [
        h('div', { class: 'card', style: 'border-radius:16px; box-shadow:none' }, [
          h('div', { class: 'cardHead' }, [
            h('div', {}, [
              h('h2', { text: 'Start email' }),
              h('p', { text: 'Control sending + recipient overrides.' })
            ]),
            h('label', { class: 'chip', style: 'gap:10px' }, [
              sendStart, h('span', { text: 'Send start email' })
            ])
          ]),
          h('div', { class: 'cardBody' }, [
            h('div', { class: 'cosTwoCol' }, [
              h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'To' }), toStart]),
              h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'CC' }), ccStart]),
              h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'BCC' }), bccStart]),
              h('div', { class: 'cosCol6' }, [
                h('label', { class: 'chip', style: 'gap:10px' }, [ccAssigneeStart, h('span', { text: 'CC assignee on start' })])
              ]),
              h('div', { class: 'cosCol6' }, [
                h('label', { class: 'chip', style: 'gap:10px' }, [ccManagerStart, h('span', { text: 'CC manager on start' })])
              ]),
              h('div', { class: 'cosCol12 field' }, [h('div', { class: 'label', text: 'Subject' }), startSubject]),
              h('div', { class: 'cosCol12 field' }, [h('div', { class: 'label', text: 'Body' }), startBody])
            ])
          ])
        ])
      ]),

      h('div', { class: 'cosCol12' }, [
        h('div', { class: 'card', style: 'border-radius:16px; box-shadow:none' }, [
          h('div', { class: 'cardHead' }, [
            h('div', {}, [
              h('h2', { text: 'Completion email' }),
              h('p', { text: 'Replies in the same thread when possible. Overrides available.' })
            ]),
            h('label', { class: 'chip', style: 'gap:10px' }, [
              sendComp, h('span', { text: 'Send completion email' })
            ])
          ]),
          h('div', { class: 'cardBody' }, [
            h('div', { class: 'cosTwoCol' }, [
              h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'To (override)' }), toComp]),
              h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'CC (override)' }), ccComp]),
              h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'BCC (override)' }), bccComp]),
              h('div', { class: 'cosCol6' }, [
                h('label', { class: 'chip', style: 'gap:10px' }, [ccAssigneeComp, h('span', { text: 'CC assignee on completion' })])
              ]),
              h('div', { class: 'cosCol6' }, [
                h('label', { class: 'chip', style: 'gap:10px' }, [ccManagerComp, h('span', { text: 'CC manager on completion' })])
              ]),
              h('div', { class: 'cosCol12 field' }, [h('div', { class: 'label', text: 'Subject' }), compSubject]),
              h('div', { class: 'cosCol12 field' }, [h('div', { class: 'label', text: 'Body' }), compBody]),
              h('div', { class: 'cosCol12 help', html: `
                Available fields: <span style="font-family:var(--mono);font-weight:900">{{clientName}}</span>
                <span style="font-family:var(--mono);font-weight:900">{{taskTitle}}</span>
                <span style="font-family:var(--mono);font-weight:900">{{startDate}}</span>
                <span style="font-family:var(--mono);font-weight:900">{{dueDate}}</span>
                <span style="font-family:var(--mono);font-weight:900">{{addToCalendarUrl}}</span>
                <span style="font-family:var(--mono);font-weight:900">{{completedAt}}</span>
              ` }
              )
            ])
          ])
        ])
      ]),

      h('div', { class: 'cosCol12 row', style: 'justify-content:space-between; flex-wrap:wrap' }, [
        h('div', { class: 'row' }, [btnDeleteSeries]),
        h('div', { class: 'row' }, [btnSave])
      ]),

      h('div', { class: 'cosCol12' }, [
        card('Series tools', 'Extend or reassign the series.', pill(task.seriesId ? 'Series' : 'No series'), seriesTools)
      ])
    ]);

    return grid;
  }

  /* ---------- Create Task panel (old UI form in drawer) ---------- */
  function mountCreatePanel({ oneOnly = false } = {}) {
    const canPickClient = state.isPartner;

    const clientSelect = h('select', { class: 'select', disabled: !canPickClient });
    clientSelect.appendChild(h('option', { value: '', text: canPickClient ? '(select client)' : 'Client list is partner-only' }));
    if (canPickClient) {
      for (const c of (state.clients || []).slice().sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')))) {
        clientSelect.appendChild(h('option', { value: c.id, text: c.name || c.id }));
      }
    }

    const clientNameFree = h('input', { class: 'input', placeholder: 'Client name (if not in list)' });
    const clientEmailFree = h('input', { class: 'input', placeholder: 'Client email (optional)' });

    const assignedToEmail = h('input', { class: 'input', placeholder: 'Assignee email' });
    if (!roleCanEditDetails()) {
      assignedToEmail.value = state.email || '';
      assignedToEmail.disabled = true;
    }

    const title = h('input', { class: 'input', placeholder: 'Task title (example: GSTR-3B Filing)' });

    const category = h('select', { class: 'select' }, [
      h('option', { value: 'GST', text: 'GST' }),
      h('option', { value: 'TDS', text: 'TDS' }),
      h('option', { value: 'INCOME_TAX', text: 'INCOME_TAX' }),
      h('option', { value: 'ROC', text: 'ROC' }),
      h('option', { value: 'ACCOUNTING', text: 'ACCOUNTING' }),
      h('option', { value: 'AUDIT', text: 'AUDIT' }),
      h('option', { value: 'OTHER', text: 'OTHER' })
    ]);
    category.value = 'OTHER';

    const type = h('input', { class: 'input', placeholder: 'Type (FILING / REVIEW / ‚Ä¶)', value: 'FILING' });

    const priority = h('select', { class: 'select' }, [
      h('option', { value: 'HIGH', text: 'HIGH' }),
      h('option', { value: 'MEDIUM', text: 'MEDIUM' }),
      h('option', { value: 'LOW', text: 'LOW' })
    ]);
    priority.value = 'MEDIUM';

    const due = h('input', { class: 'input', placeholder: 'Due date (DD-MM-YYYY)' });
    const trigger = h('input', { class: 'input', type: 'number', min: '0', value: '15' });

    const recurrence = h('select', { class: 'select' }, [
      h('option', { value: 'AD_HOC', text: 'One-time' }),
      h('option', { value: 'DAILY', text: 'Daily' }),
      h('option', { value: 'WEEKLY', text: 'Weekly' }),
      h('option', { value: 'BIWEEKLY', text: 'Every 2 weeks' }),
      h('option', { value: 'MONTHLY', text: 'Monthly' }),
      h('option', { value: 'BIMONTHLY', text: 'Every 2 months' }),
      h('option', { value: 'QUARTERLY', text: 'Quarterly' }),
      h('option', { value: 'HALF_YEARLY', text: 'Half-yearly' }),
      h('option', { value: 'YEARLY', text: 'Yearly' })
    ]);
    recurrence.value = 'AD_HOC';

    const genCount = h('input', { class: 'input', type: 'number', min: '1', value: '1' });

if (oneOnly) {
  recurrence.value = 'AD_HOC';
  recurrence.disabled = true;
  genCount.value = '1';
  genCount.disabled = true;
}

    // Mail fields
    const sendStart = h('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    sendStart.checked = true;

    const toStart = h('input', { class: 'input', placeholder: 'Start To override (optional)' });
    const ccStart = h('input', { class: 'input', placeholder: 'Start CC override (optional)' });
    const bccStart = h('input', { class: 'input', placeholder: 'Start BCC override (optional)' });

    const ccAssigneeStart = h('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    const ccManagerStart = h('input', { type: 'checkbox', style: 'width:18px;height:18px' });

    const startSubject = h('input', { class: 'input', placeholder: 'Start email subject', value: 'We started {{taskTitle}}' });
    const startBody = h('textarea', { class: 'textarea', style: 'min-height:120px' });
    startBody.value = `Dear {{clientName}},\n\nWe started work on {{taskTitle}}.\nDue: {{dueDate}}\n\nAdd to calendar: {{addToCalendarUrl}}\n\nRegards,\nCompliance Team`;

    const sendComp = h('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    sendComp.checked = true;

    const toComp = h('input', { class: 'input', placeholder: 'Completion To override (optional)' });
    const ccComp = h('input', { class: 'input', placeholder: 'Completion CC override (optional)' });
    const bccComp = h('input', { class: 'input', placeholder: 'Completion BCC override (optional)' });

    const ccAssigneeComp = h('input', { type: 'checkbox', style: 'width:18px;height:18px' });
    const ccManagerComp = h('input', { type: 'checkbox', style: 'width:18px;height:18px' });

    const compSubject = h('input', { class: 'input', placeholder: 'Completion subject', value: 'Completed: {{taskTitle}}' });
    const compBody = h('textarea', { class: 'textarea', style: 'min-height:120px' });
    compBody.value = `Dear {{clientName}},\n\nWe have completed {{taskTitle}}.\nCompleted at: {{completedAt}}\n\nRegards,\nCompliance Team`;

    const btnCreate = h('button', { class: 'btn btnPrimary', type: 'button', text: 'Create task(s)' });
    btnCreate.onclick = async () => {
      let dueYmd = '';
      try { dueYmd = dmyToYmd(String(due.value || '').trim()); } catch (e) { return toast(e.message, 7000); }

      const payload = {
        clientId: canPickClient ? (clientSelect.value || null) : null,
        clientName: String(clientNameFree.value || '').trim() || null,
        clientEmail: String(clientEmailFree.value || '').trim() || null,
        assignedToEmail: String(assignedToEmail.value || '').trim() || null,

        title: String(title.value || '').trim(),
        category: category.value,
        type: String(type.value || '').trim() || 'FILING',
        priority: priority.value,

        dueDateYmd: dueYmd,
        triggerDaysBefore: Number(trigger.value || 15),

        recurrence: oneOnly ? 'AD_HOC' : recurrence.value,
        generateCount: oneOnly ? 1 : Number(genCount.value || 1),

        sendClientStartMail: !!sendStart.checked,
        clientToEmails: asEmailList(toStart.value),
        clientCcEmails: asEmailList(ccStart.value),
        clientBccEmails: asEmailList(bccStart.value),
        ccAssigneeOnClientStart: !!ccAssigneeStart.checked,
        ccManagerOnClientStart: !!ccManagerStart.checked,
        clientStartSubject: startSubject.value,
        clientStartBody: startBody.value,

        sendClientCompletionMail: !!sendComp.checked,
        completionToEmails: asEmailList(toComp.value),
        completionCcEmails: asEmailList(ccComp.value),
        completionBccEmails: asEmailList(bccComp.value),
        ccAssigneeOnCompletion: !!ccAssigneeComp.checked,
        ccManagerOnCompletion: !!ccManagerComp.checked,
        clientCompletionSubject: compSubject.value,
        clientCompletionBody: compBody.value
      };

      if (!payload.clientId && !payload.clientName) return toast('Select a client or type a client name', 5000);
      if (!payload.title) return toast('Title is required', 4000);

      const r = await apiJson('/tasks_createone', payload);
      if (!r.ok) return toast(`Create failed: ${r.error || JSON.stringify(r)}`, 9000);

      toast(`Created ${r.created || 0} task(s)`);
      closeDrawer();
      window.__cos_mountView?.('work');
    };

    return h('div', { class: 'cosTwoCol' }, [
      h('div', { class: 'cosCol6 field' }, [h('div', { class: 'label', text: 'Client (list)' }), clientSelect]),
      h('div', { class: 'cosCol6 field' }, [h('div', { class: 'label', text: 'Client name (if not in list)' }), clientNameFree]),
      h('div', { class: 'cosCol6 field' }, [h('div', { class: 'label', text: 'Client email (optional)' }), clientEmailFree]),
      h('div', { class: 'cosCol6 field' }, [h('div', { class: 'label', text: 'Assign to (email)' }), assignedToEmail]),
      h('div', { class: 'cosCol12 field' }, [h('div', { class: 'label', text: 'Title' }), title]),
      h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'Category' }), category]),
      h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'Type' }), type]),
      h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'Priority' }), priority]),
      h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'Due date' }), due]),
      h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'Trigger days' }), trigger]),
      h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'Repeat' }), recurrence]),
      h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'Generate count' }), genCount]),
      h('div', { class: 'cosCol12 help' }, ['Series generates future tasks by recurrence. Calendar event is created at start date.']),

      h('div', { class: 'cosCol12' }, [
        card('Start email', 'Control sending and override recipients.', h('label', { class: 'chip', style: 'gap:10px' }, [sendStart, h('span', { text: 'Send start email' })]),
          h('div', { class: 'cosTwoCol' }, [
            h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'To override' }), toStart]),
            h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'CC override' }), ccStart]),
            h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'BCC override' }), bccStart]),
            h('div', { class: 'cosCol6' }, [h('label', { class: 'chip', style: 'gap:10px' }, [ccAssigneeStart, h('span', { text: 'CC assignee' })])]),
            h('div', { class: 'cosCol6' }, [h('label', { class: 'chip', style: 'gap:10px' }, [ccManagerStart, h('span', { text: 'CC manager' })])]),
            h('div', { class: 'cosCol12 field' }, [h('div', { class: 'label', text: 'Subject' }), startSubject]),
            h('div', { class: 'cosCol12 field' }, [h('div', { class: 'label', text: 'Body' }), startBody])
          ])
        )
      ]),

      h('div', { class: 'cosCol12' }, [
        card('Completion email', 'Sent when marked COMPLETED by Partner/Manager. Replies in same thread when possible.',
          h('label', { class: 'chip', style: 'gap:10px' }, [sendComp, h('span', { text: 'Send completion email' })]),
          h('div', { class: 'cosTwoCol' }, [
            h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'To override' }), toComp]),
            h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'CC override' }), ccComp]),
            h('div', { class: 'cosCol4 field' }, [h('div', { class: 'label', text: 'BCC override' }), bccComp]),
            h('div', { class: 'cosCol6' }, [h('label', { class: 'chip', style: 'gap:10px' }, [ccAssigneeComp, h('span', { text: 'CC assignee' })])]),
            h('div', { class: 'cosCol6' }, [h('label', { class: 'chip', style: 'gap:10px' }, [ccManagerComp, h('span', { text: 'CC manager' })])]),
            h('div', { class: 'cosCol12 field' }, [h('div', { class: 'label', text: 'Subject' }), compSubject]),
            h('div', { class: 'cosCol12 field' }, [h('div', { class: 'label', text: 'Body' }), compBody])
          ])
        )
      ]),

      h('div', { class: 'cosCol12 row', style: 'justify-content:flex-end; margin-top: 6px' }, [btnCreate])
    ]);
  }

  /* ---------- Main drawer mount functions ---------- */
  function renderTaskDrawer(taskId, { keepScroll = false } = {}) {
    clearLive();

    const task = taskById(taskId);
    if (!task) return toast('Task not found', 3500);

    const prevScroll = keepScroll ? body.scrollTop : 0;

    drawerMode = 'task';
    currentTaskId = taskId;

    const cn = clientName(task);
    dTitle.textContent = task.title || 'Task';
    dSub.textContent = `${cn ? `Client: ${cn} ‚Ä¢ ` : ''}${task.status || ''}${task.dueDateYmd ? ` ‚Ä¢ Due ${ymdToDmy(task.dueDateYmd)}` : ''}`;

    body.innerHTML = '';

    // Quick info card (old drawer style)
    const infoLines = [];
    infoLines.push(`<div><b>Start:</b> ${task.startDateYmd ? ymdToDmy(task.startDateYmd) : '‚Äî'} ‚Ä¢ <b>Due:</b> ${task.dueDateYmd ? ymdToDmy(task.dueDateYmd) : '‚Äî'}</div>`);
    infoLines.push(`<div><b>Status:</b> ${task.status || '‚Äî'} ‚Ä¢ <b>Assignee:</b> ${task.assignedToEmail || '‚Äî'}</div>`);
    infoLines.push(`<div style="margin-top:6px" class="help"><b>Start email sent:</b> ${task.clientStartMailSent ? 'Yes' : 'No'} ‚Ä¢ <b>Thread:</b> ${task.clientStartGmailThreadId ? 'Yes' : 'No'}</div>`);

    const quickBtns = h('div', { class: 'row', style: 'margin-top:10px; flex-wrap:wrap' }, []);
    if (task.calendarHtmlLink) {
      quickBtns.appendChild(h('a', { class: 'btn btnSmall', href: task.calendarHtmlLink, target: '_blank', rel: 'noopener' }, ['Open Calendar Event']));
    }
    quickBtns.appendChild(h('button', {
      class: 'btn btnSmall btnGhost',
      type: 'button',
      text: 'Work Queue',
      onclick: () => { closeDrawer(); document.getElementById('navWork')?.click(); }
    }));

    body.appendChild(card('Quick info', 'Fast context + links.', pill(task.clientStartMailSent ? 'Start sent' : 'Start not sent', task.clientStartMailSent ? 'ok' : ''), h('div', {}, [
      h('div', { class: 'help', html: infoLines.join('') }),
      quickBtns
    ])));

    // Status
    body.appendChild(card('Update status', 'Change status, add notes, delay reason.', pill(state.role, ''), mountStatusPanel(task)));

    // Exports
    body.appendChild(card('Exports', 'Download task history (XLSX / PDF).', pill('History', ''), mountTaskExports(task)));

    // Edit details (partner/manager)
    body.appendChild(card('Edit details', 'Task fields + email overrides + series tools.', pill(roleCanEditDetails() ? 'Partner/Manager' : 'Restricted', roleCanEditDetails() ? '' : 'warn'), mountEditPanel(task)));

    // Comments (live)
    body.appendChild(card('Comments', 'Discuss progress and mention teammates.', pill('Team', ''), mountComments(taskId)));

    // Timeline (live)
    body.appendChild(card('Timeline', 'Audit log entries for this task.', pill('Audit', ''), mountTimeline(taskId)));

    // Attachments (uses current task snapshot; will update when tasks subscription updates)
    body.appendChild(card('Attachments', 'Uploaded documents live on the task.', pill('Docs', ''), mountAttachments(task)));

    openDrawer();

    if (keepScroll) body.scrollTop = prevScroll;
  }

  function renderCreateDrawer({ oneOnly = false } = {}) {
   clearLive();
   drawerMode = 'create';
   currentTaskId = null;

   dTitle.textContent = oneOnly ? 'Create ONE task' : 'Create task';
   dSub.textContent = oneOnly
     ? 'Quick create: exactly one task (associates supported).'
     : 'Create one task or a repeating series (old UI form, new backend).';

   body.innerHTML = '';
   body.appendChild(
     card(
       oneOnly ? 'Create ONE task' : 'Create task',
       oneOnly ? 'One-time task only.' : 'Fill details, set emails, then create.',
       pill(state.role, ''),
       mountCreatePanel({ oneOnly })
     )
   );
   openDrawer();
  }

  /* ---------- Expose openers to other parts ---------- */
  window.__cos_openTaskInspector = (taskId) => renderTaskDrawer(taskId);
  window.__cos_openCreateTask = () => renderCreateDrawer({ oneOnly: false });
  window.__cos_openCreateOneTask = () => renderCreateDrawer({ oneOnly: true });

  /* ---------- Keep drawer in sync with live task updates ---------- */
  const prevOnData = window.__cos_onData;
  window.__cos_onData = () => {
    try { prevOnData && prevOnData(); } finally {
      if (drawer.classList.contains('show') && drawerMode === 'task' && currentTaskId) {
        // re-render to reflect attachments/status changes; keep scroll position
        try { renderTaskDrawer(currentTaskId, { keepScroll: true }); } catch {}
      }
    }
  };

  // If a task was selected before this part loaded, open it.
  if (state.uid && state.inspectorTaskId) {
    try { renderTaskDrawer(state.inspectorTaskId); } catch {}
  }
})();
</script>
<script>
/* =========================
 ComplianceOS ‚Äî Part 7/8 (OLD-UI methodology)
 Studio (Email Drafts + Excel-safe copy)
 - Old UI feel: ‚ÄúInsert a field‚Äù dropdown, toolbar, preview card
 - New backend/runtime: uses window.__cos.safeCopy + toast
 ========================= */
(() => {
  'use strict';

  const { state, safeCopy, toast } = window.__cos;
  const mount = document.getElementById('viewMount');

  /* ---------- CSS (dropdown + studio layout) ---------- */
  const STYLE_ID = 'cosOldUiPart7Style';
  if (!document.getElementById(STYLE_ID)) {
    const st = document.createElement('style');
    st.id = STYLE_ID;
    st.textContent = `
      .draftToolbar{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        align-items:center;
        justify-content:space-between;
        margin-bottom: 10px;
      }
      .draftLeft{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
      .mono{ font-family: var(--mono); }

      .draftVarMenu{ position: relative; display:inline-block; }
      .varDropdown{
        position:absolute;
        top: 44px;
        left: 0;
        width: min(520px, 86vw);
        max-height: 360px;
        overflow:auto;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: var(--panelSolid);
        box-shadow: var(--shadow-md);
        display:none;
        z-index: 300;
        padding: 10px;
      }
      .varDropdown.show{ display:block; }
      .varSearch{ margin-bottom:10px; }

      .varItem{
        padding: 10px;
        border-radius: 12px;
        border: 1px solid transparent;
        cursor:pointer;
        background: transparent;
      }
      .varItem:hover{
        border-color: var(--border);
        background: var(--panel2);
      }
      .varTop{
        display:flex;
        justify-content:space-between;
        gap: 10px;
        align-items:flex-start;
      }
      .varName{ font-weight: 950; font-size: 13px; }
      .varKey{ font-weight: 950; font-size: 12px; color: var(--primary); font-family: var(--mono); }
      .varDesc{ margin-top: 6px; color: var(--muted); font-size: 12px; font-weight: 650; line-height: 1.35; }

      .draftEditor{
        border-radius: 16px;
        border: 1px solid var(--border);
        background: color-mix(in srgb, var(--panel2) 75%, transparent);
        padding: 12px;
      }
      .draftEditor textarea{
        min-height: 220px;
        resize: vertical;
        font-family: var(--mono);
        line-height: 1.45;
      }

      /* Two-pane layout */
      .cosStudioSplit{
        display:grid;
        grid-template-columns: minmax(360px, 1.2fr) minmax(320px, .8fr);
        gap: 14px;
        align-items:start;
      }
      @media (max-width: 980px){
        .cosStudioSplit{ grid-template-columns: 1fr; }
      }

      .kbd{
        font-family: var(--mono);
        border: 1px solid var(--border);
        background: var(--panel2);
        border-radius: 8px;
        padding: 2px 6px;
        font-size: 12px;
        font-weight: 900;
      }
    `;
    document.head.appendChild(st);
  }

  /* ---------- helpers ---------- */
  const el = (tag, attrs = {}, children = []) => {
    const n = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs || {})) {
      if (k === 'class') n.className = v;
      else if (k === 'text') n.textContent = v;
      else if (k === 'html') n.innerHTML = v;
      else if (k === 'style') n.setAttribute('style', String(v));
      else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
      else if (v === false || v === null || v === undefined) continue;
      else n.setAttribute(k, String(v));
    }
    for (const c of (children || [])) n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
    return n;
  };

  function card(title, subtitle, rightNode, bodyNode) {
    return el('div', { class: 'card' }, [
      el('div', { class: 'cardHead' }, [
        el('div', {}, [
          el('h2', { text: title }),
          el('p', { text: subtitle || '' })
        ]),
        rightNode || el('div')
      ]),
      el('div', { class: 'cardBody' }, [bodyNode || el('div')])
    ]);
  }

  const VARS = [
    { name: 'Client name', key: '{{clientName}}', desc: 'Client name' },
    { name: 'Task title', key: '{{taskTitle}}', desc: 'Task title' },
    { name: 'Start date', key: '{{startDate}}', desc: 'Start date (DD-MM-YYYY)' },
    { name: 'Due date', key: '{{dueDate}}', desc: 'Due date (DD-MM-YYYY)' },
    { name: 'Add to calendar link', key: '{{addToCalendarUrl}}', desc: 'Google Calendar link' },
    { name: 'Completed time', key: '{{completedAt}}', desc: 'Completion time in IST' },
  ];

  function tokensToRealLines(s) { return String(s ?? '').replaceAll('\\n', '\n'); }
  function realLinesToTokens(s) { return String(s ?? '').replace(/\r?\n/g, '\\n'); }

  function sampleVars() {
    return {
      clientName: 'ABC Pvt Ltd',
      taskTitle: 'GSTR-3B Filing',
      startDate: '01-02-2026',
      dueDate: '20-02-2026',
      addToCalendarUrl: 'https://calendar.google.com/calendar/render?...',
      completedAt: new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })
    };
  }

  function replaceVars(text, vars) {
    let out = String(text || '');
    for (const [k, v] of Object.entries(vars || {})) {
      out = out.replaceAll(`{{${k}}}`, String(v ?? ''));
    }
    return out;
  }

  function insertAtCursor(input, str) {
    const start = input.selectionStart ?? input.value.length;
    const end = input.selectionEnd ?? input.value.length;
    input.value = input.value.slice(0, start) + str + input.value.slice(end);
    const pos = start + str.length;
    input.selectionStart = input.selectionEnd = pos;
    input.focus();
  }

  /* ---------- Local Studio state ---------- */
  const studioState = {
    newlineMode: 'TOKEN', // TOKEN | REAL
    lastFocus: 'body'
  };

  function render() {
    if (!mount) return;
    mount.innerHTML = '';
    if (!state.uid) return;

    /* Toolbar + variable dropdown */
    const btnVarMenu = el('button', { class: 'btn', type: 'button', text: 'Insert a field' });
    const dd = el('div', { class: 'varDropdown', id: 'varDropdown' });
    const search = el('input', { class: 'input varSearch', placeholder: 'Search fields‚Ä¶' });
    const list = el('div', { id: 'varList', style: 'display:flex; flex-direction:column; gap:8px;' });

    dd.appendChild(search);
    dd.appendChild(list);
    dd.appendChild(el('div', { class: 'help', style: 'margin-top:8px' }, [
      'Tip: Click a field to insert it at the cursor.'
    ]));

    const varMenu = el('div', { class: 'draftVarMenu' }, [btnVarMenu, dd]);

    const mode = el('select', {
      class: 'select',
      style: 'width:auto; padding:6px 8px; border-radius:10px'
    }, [
      el('option', { value: 'TOKEN', text: 'Keep in one cell (\\n tokens)' }),
      el('option', { value: 'REAL', text: 'Use real lines' })
    ]);
    mode.value = studioState.newlineMode;

    const modeChip = el('span', { class: 'chip' }, [
      'Excel mode:',
      mode
    ]);

    const subj = el('input', { class: 'input', placeholder: 'Subject', value: 'We started {{taskTitle}}' });
    const body = el('textarea', { class: 'textarea', placeholder: 'Type your email body here...', style: 'min-height: 260px' });
    body.value = 'Dear {{clientName}},\\n\\nWe started work on {{taskTitle}}.\\nDue: {{dueDate}}\\n\\nRegards,\\nCompliance Team';

    subj.addEventListener('focus', () => studioState.lastFocus = 'subject');
    body.addEventListener('focus', () => studioState.lastFocus = 'body');

    function renderVarList() {
      const q = String(search.value || '').trim().toLowerCase();
      list.innerHTML = '';
      const hits = VARS.filter(v =>
        !q ||
        v.name.toLowerCase().includes(q) ||
        v.key.toLowerCase().includes(q) ||
        v.desc.toLowerCase().includes(q)
      );
      if (!hits.length) {
        list.appendChild(el('div', { class: 'help', text: 'No matches.' }));
        return;
      }
      hits.forEach(v => {
        const item = el('div', { class: 'varItem' });
        item.innerHTML = `
          <div class="varTop">
            <div class="varName">${v.name}</div>
            <div class="varKey">${v.key}</div>
          </div>
          <div class="varDesc">${v.desc}</div>
        `;
        item.addEventListener('click', () => {
          const target = (studioState.lastFocus === 'subject') ? subj : body;
          insertAtCursor(target, v.key);
          dd.classList.remove('show');
          updatePreview();
        });
        list.appendChild(item);
      });
    }

    function updatePreview() {
      const vars = sampleVars();
      const subjText = replaceVars(subj.value, vars);
      const bodyText = replaceVars(tokensToRealLines(body.value), vars);
      previewText.textContent = `Subject: ${subjText}\n\n${bodyText}`;
    }

    search.addEventListener('input', renderVarList);
    btnVarMenu.addEventListener('click', () => {
      dd.classList.toggle('show');
      if (dd.classList.contains('show')) setTimeout(() => search.focus(), 0);
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!varMenu.contains(e.target)) dd.classList.remove('show');
    });

    // Newline mode conversion
    mode.addEventListener('change', () => {
      studioState.newlineMode = mode.value;
      if (studioState.newlineMode === 'REAL') body.value = tokensToRealLines(body.value);
      else body.value = realLinesToTokens(body.value);
      updatePreview();
    });

    // In TOKEN mode: Enter inserts \n unless Shift+Enter
    body.addEventListener('keydown', (e) => {
      if (e.key !== 'Enter') return;
      if (studioState.newlineMode !== 'TOKEN') return;
      if (e.shiftKey) return;
      e.preventDefault();
      insertAtCursor(body, '\\n');
      updatePreview();
    });

    subj.addEventListener('input', updatePreview);
    body.addEventListener('input', updatePreview);

    const btnCopyBodyExcel = el('button', { class: 'btn btnSmall btnPrimary', type: 'button', text: 'Copy Body (for Excel)' });
    btnCopyBodyExcel.addEventListener('click', async () => {
      const excel = realLinesToTokens(tokensToRealLines(body.value));
      await safeCopy(excel);
      toast('Copied (Excel-safe)');
    });

    const btnCopySubject = el('button', { class: 'btn btnSmall', type: 'button', text: 'Copy Subject' });
    btnCopySubject.addEventListener('click', async () => {
      await safeCopy(subj.value || '');
      toast('Copied subject');
    });

    const btnCopyBodyRaw = el('button', { class: 'btn btnSmall btnGhost', type: 'button', text: 'Copy Body (raw)' });
    btnCopyBodyRaw.addEventListener('click', async () => {
      await safeCopy(tokensToRealLines(body.value || ''));
      toast('Copied body');
    });

    const toolbar = el('div', { class: 'draftToolbar' }, [
      el('div', { class: 'draftLeft' }, [
        varMenu,
        modeChip
      ]),
      el('div', { class: 'row' }, [btnCopyBodyExcel, btnCopySubject, btnCopyBodyRaw])
    ]);

    /* Preview */
    const previewText = el('div', { class: 'help', style: 'white-space:pre-wrap; color: var(--text)' });
    const previewCard = el('div', { class: 'card', style: 'border-radius:16px; box-shadow:none' }, [
      el('div', { class: 'cardBody' }, [
        el('div', { class: 'label', text: 'Preview (sample values)' }),
        el('div', { style: 'height:10px' }),
        previewText
      ])
    ]);

    /* Layout */
    const leftPane = el('div', {}, [
      toolbar,
      el('div', { class: 'field' }, [el('div', { class: 'label', text: 'Subject' }), subj]),
      el('div', { class: 'field', style: 'margin-top:10px' }, [
        el('div', { class: 'label', text: 'Body' }),
        el('div', { class: 'draftEditor' }, [
          body,
          el('div', { class: 'help', style: 'margin-top:10px' }, [
            '‚ÄúCopy Body (for Excel)‚Äù keeps all lines inside a single Excel cell. ',
            'In token mode press ',
            el('span', { class: 'kbd', text: 'Enter' }),
            ' to insert ',
            el('span', { class: 'kbd', text: '\\n' }),
            '. Use ',
            el('span', { class: 'kbd', text: 'Shift+Enter' }),
            ' for a real line break.'
          ])
        ])
      ]),
      el('div', { style: 'margin-top:10px' }, [previewCard])
    ]);

    const rightPane = el('div', {}, [
      el('div', { class: 'card', style: 'border-radius:16px; box-shadow:none' }, [
        el('div', { class: 'cardHead' }, [
          el('div', {}, [
            el('h2', { text: 'Where to use this' }),
            el('p', { text: 'Paste drafts into task creation, task editing, or Excel templates.' })
          ]),
          el('span', { class: 'chip', text: state.role })
        ]),
        el('div', { class: 'cardBody' }, [
          el('div', { class: 'help', html: `
            <div><b>Start email</b>: used when a task starts (immediate or scheduled).</div>
            <div style="margin-top:8px"><b>Completion email</b>: replies in the same thread (reply-all) when possible.</div>
            <div style="margin-top:8px"><b>Offline XLSX</b>: use Excel-safe body to keep multi-line content inside one cell.</div>
          `})
        ])
      ]),
      el('div', { class: 'card', style: 'border-radius:16px; box-shadow:none' }, [
        el('div', { class: 'cardHead' }, [
          el('div', {}, [
            el('h2', { text: 'Fields available' }),
            el('p', { text: 'Same placeholders work across tasks, exports, and templates.' })
          ]),
          el('span', { class: 'chip', text: 'Template vars' })
        ]),
        el('div', { class: 'cardBody' }, [
          el('div', { class: 'help', html: VARS.map(v =>
            `<div style="margin:6px 0"><span class="mono" style="font-weight:900">${v.key}</span> ‚Äî ${v.desc}</div>`
          ).join('') })
        ])
      ])
    ]);

    const split = el('div', { class: 'cosStudioSplit' }, [leftPane, rightPane]);

    renderVarList();
    updatePreview();

    mount.appendChild(el('div', { class: 'gridMax' }, [
      card('Studio', 'Draft emails safely (old UI feel). Optimized for Excel and templates.', null, split)
    ]));
  }

  window.__cos_mountStudio = render;
  if (state.uid && state.activeView === 'studio') render();
})();
</script>
<script>
/* =========================
 ComplianceOS ‚Äî Part 8/8 (OLD-UI methodology)
 Ops & Reports (Partner/Manager)
 - Old UI: cards + grids + tables + OK-required modal
 - New backend endpoints preserved
 ========================= */
(() => {
  'use strict';

  const {
    state,
    apiJson,
    apiForm,
    downloadBase64,
    dmyToYmd,
    todayYmdIST,
    toast
  } = window.__cos;

  const mount = document.getElementById('viewMount');

  /* ---------- Styles (modal + ops split) ---------- */
  const STYLE_ID = 'cosOldUiPart8Style';
  if (!document.getElementById(STYLE_ID)) {
    const st = document.createElement('style');
    st.id = STYLE_ID;
    st.textContent = `
      .cosOpsSplit{
 display:grid;
 grid-template-columns: minmax(340px, 1.05fr) minmax(340px, .95fr);
 gap: 14px;
 align-items:start;
 }
 @media (max-width: 980px){
 .cosOpsSplit{ grid-template-columns: 1fr; }
 }

      /* Old UI modal */
      .cosModalOverlay{
        position: fixed;
        inset: 0;
        z-index: 260;
        background: rgba(0,0,0,.52);
        display:none;
        place-items:center;
        padding: 18px;
      }
      .cosModalOverlay.show{ display:grid; }
      .cosModal{
        width: min(680px, 94vw);
        border-radius: 18px;
        border: 1px solid var(--border);
        background: var(--panelSolid);
        box-shadow: var(--shadow-md);
        overflow:hidden;
      }
      .cosModalHead{
        padding: 14px 14px 10px;
        border-bottom: 1px solid var(--border);
        display:flex;
        justify-content:space-between;
        gap:10px;
        align-items:flex-start;
      }
      .cosModalTitle{ font-weight: 950; }
      .cosModalBody{ padding: 14px; }
      .cosModalActions{
        padding: 0 14px 14px;
        display:flex;
        justify-content:flex-end;
        gap: 10px;
        flex-wrap:wrap;
      }

      /* TableWrap (if Part 3 didn't inject, this is harmless) */
      .tableWrap{
        overflow-x:auto;
        overflow-y:hidden;
        border-radius:14px;
        border:1px solid var(--border);
        background: color-mix(in srgb, var(--panel2) 75%, transparent);
      }
      table{ width:100%; border-collapse: collapse; min-width: 980px; }
      th,td{
        padding:12px 12px;
        border-bottom:1px solid color-mix(in srgb, var(--border) 70%, transparent);
        font-size:13px;
        vertical-align:top;
        font-weight:650;
      }
      th{
        background: color-mix(in srgb, var(--panelSolid) 92%, transparent);
        text-align:left;
        font-weight:950;
      }
    `;
    document.head.appendChild(st);
  }

  /* ---------- Helpers ---------- */
  const el = (tag, attrs = {}, children = []) => {
    const n = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs || {})) {
      if (k === 'class') n.className = v;
      else if (k === 'text') n.textContent = v;
      else if (k === 'html') n.innerHTML = v;
      else if (k === 'style') n.setAttribute('style', String(v));
      else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
      else if (v === false || v === null || v === undefined) continue;
      else n.setAttribute(k, String(v));
    }
    for (const c of (children || [])) n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
    return n;
  };

  function card(title, subtitle, rightNode, bodyNode) {
    return el('div', { class: 'card' }, [
      el('div', { class: 'cardHead' }, [
        el('div', {}, [el('h2', { text: title }), el('p', { text: subtitle || '' })]),
        rightNode || el('div')
      ]),
      el('div', { class: 'cardBody' }, [bodyNode || el('div')])
    ]);
  }

  function chip(text) {
    return el('span', { class: 'chip', text: String(text || '') });
  }

  /* ---------- OK-required modal ---------- */
  const okModal = (() => {
    let overlay = document.getElementById('cosOkModalOverlay');
    if (!overlay) {
      overlay = el('div', { class: 'cosModalOverlay', id: 'cosOkModalOverlay' });
      const panel = el('div', { class: 'cosModal' }, [
        el('div', { class: 'cosModalHead' }, [
          el('div', {}, [
            el('div', { class: 'cosModalTitle', id: 'cosOkTitle', text: 'Message' }),
            el('div', { class: 'help', id: 'cosOkSub', style: 'margin-top:6px' })
          ]),
          chip('OK required')
        ]),
        el('div', { class: 'cosModalBody', id: 'cosOkBody' }),
        el('div', { class: 'cosModalActions' }, [
          el('button', { class: 'btn btnPrimary', id: 'cosOkBtn', type: 'button', text: 'OK' })
        ])
      ]);
      overlay.appendChild(panel);
      document.body.appendChild(overlay);
    }

    const title = () => document.getElementById('cosOkTitle');
    const sub = () => document.getElementById('cosOkSub');
    const body = () => document.getElementById('cosOkBody');
    const btn = () => document.getElementById('cosOkBtn');

    function show({ title: t, sub: s, bodyHtml }) {
      return new Promise((resolve) => {
        title().textContent = t || 'Message';
        sub().textContent = s || '';
        body().innerHTML = bodyHtml || '';
        overlay.classList.add('show');

        const done = () => {
          overlay.classList.remove('show');
          btn().onclick = null;
          resolve(true);
        };
        btn().onclick = done;
        setTimeout(() => btn().focus(), 0);
      });
    }

    return { show };
  })();

  /* ---------- Ops State (cached admin data) ---------- */
  const opsState = {
    from: '01-01-2026',
    to: '31-12-2026',
    includeAudit: true,
    monthYmd: todayYmdIST(),
    updateLimit: 600,
    workerImportPassword: '',

    team: [],
    settings: null,
    cal: null,
  };

  function canUseOps() {
    return state.isPartner || state.isManager;
  }

  function mountLocked() {
    mount.innerHTML = '';
    mount.appendChild(el('div', { class: 'gridMax' }, [
      card('Ops & Reports', 'This area is available to PARTNER and MANAGER roles only.', chip(state.role),
        el('div', { class: 'help', html: `
          <div>Your current role is <b>${state.role}</b>.</div>
          <div style="margin-top:8px">If you should have access, ask a partner to update your role.</div>
        ` })
      )
    ]));
  }

  /* ---------- Data loads (partner-only admin) ---------- */
  async function loadSettings() {
    const r = await apiJson('/settings_get', {});
    if (!r.ok) throw new Error(r.error || 'settings_get failed');
    opsState.settings = r.data || {};
  }

  async function loadCalendarSettings() {
    const r = await apiJson('/settings_calendar_get', {});
    if (!r.ok) throw new Error(r.error || 'settings_calendar_get failed');
    opsState.cal = r.data || {};
  }

  async function loadTeam() {
    const r = await apiJson('/users_list', {});
    if (!r.ok) throw new Error(r.error || 'users_list failed');
    opsState.team = r.users || [];
  }

  async function ensureAdminDataLoaded() {
    if (!state.isPartner) return;
    // light caching: only load missing
    if (!opsState.settings) { try { await loadSettings(); } catch {} }
    if (!opsState.cal) { try { await loadCalendarSettings(); } catch {} }
    if (!opsState.team?.length) { try { await loadTeam(); } catch {} }
  }

  /* ---------- Panels ---------- */
  function importPanel() {
    const btnTpl = el('button', { class: 'btn', type: 'button', text: 'Download Import Template (XLSX)' });
    btnTpl.onclick = async () => {
      const r = await apiJson('/exports_myClientsTemplateXlsx', {});
      if (!r.ok) return toast(`Template failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({
        fileName: r.fileName || 'Client_Tasks_Import_Template.xlsx',
        base64: r.base64,
        mime: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      });
      toast('Template downloaded');
    };

    const file = el('input', { class: 'input', type: 'file', accept: '.xlsx' });
    file.style.padding = '12px';

    const pwd = el('input', { class: 'input', type: 'password', placeholder: 'Import password (associates only, if enabled)' });
    pwd.addEventListener('input', () => opsState.workerImportPassword = pwd.value);

    const btnImport = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Import XLSX' });
    btnImport.onclick = async () => {
      const f = file.files?.[0];
      if (!f) return toast('Select an XLSX file', 3600);

      const fd = new FormData();
      fd.append('file', f, f.name);
      if (pwd.value.trim()) fd.append('importPassword', pwd.value.trim());

      const r = await apiForm('/tasks_bulkimportxlsx', fd);
      if (!r.ok) return toast(`Import failed: ${r.error || JSON.stringify(r)}`, 9000);

      await okModal.show({
        title: 'Import complete',
        sub: 'Review your tasks',
        bodyHtml: `
          <div class="help">Created <b>${r.created || 0}</b> tasks.</div>
          <div class="help" style="margin-top:8px">Series created: <b>${r.seriesCreated || 0}</b>.</div>
        `
      });

      toast('Imported');
      document.getElementById('navWork')?.click();
    };

    return el('div', { class: 'cosGrid' }, [
      el('div', { class: 'cosCol12 row', style: 'justify-content:space-between; align-items:center' }, [
        chip('XLSX Import'),
        btnTpl
      ]),
      el('div', { class: 'cosCol12 help', html: `Upload an Excel file to create tasks. Start emails may send immediately if a task‚Äôs start date is today; otherwise scheduled by backend.` }),
      el('div', { class: 'cosCol12 field' }, [el('div', { class: 'label', text: 'XLSX file' }), file]),
      el('div', { class: 'cosCol6 field' }, [el('div', { class: 'label', text: 'Import password (only if required)' }), pwd]),
      el('div', { class: 'cosCol12 row', style: 'justify-content:flex-end' }, [btnImport]),
    ]);
  }

  function exportsPanel() {
    const from = el('input', { class: 'input', value: opsState.from, placeholder: 'From (DD-MM-YYYY)' });
    const to = el('input', { class: 'input', value: opsState.to, placeholder: 'To (DD-MM-YYYY)' });

    const includeAudit = el('select', { class: 'select' }, [
      el('option', { value: 'true', text: 'Include history (AuditLogs)' }),
      el('option', { value: 'false', text: 'Tasks only' })
    ]);
    includeAudit.value = opsState.includeAudit ? 'true' : 'false';

    from.addEventListener('input', () => opsState.from = from.value);
    to.addEventListener('input', () => opsState.to = to.value);
    includeAudit.addEventListener('change', () => opsState.includeAudit = (includeAudit.value === 'true'));

    const btnFirmX = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Firm range XLSX' });
    btnFirmX.onclick = async () => {
      try { dmyToYmd(from.value.trim()); dmyToYmd(to.value.trim()); } catch (e) { return toast(e.message, 7000); }
      const r = await apiJson('/exports_firmRangeWithHistoryXlsx', {
        fromDmy: from.value.trim(),
        toDmy: to.value.trim(),
        includeAudit: includeAudit.value === 'true'
      });
      if (!r.ok) return toast(`Export failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({
        fileName: r.fileName,
        base64: r.base64,
        mime: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      });
      toast('Downloaded XLSX');
    };

    const btnFirmP = el('button', { class: 'btn', type: 'button', text: 'Firm range PDF' });
    btnFirmP.onclick = async () => {
      try { dmyToYmd(from.value.trim()); dmyToYmd(to.value.trim()); } catch (e) { return toast(e.message, 7000); }
      const r = await apiJson('/reports_firmRangePdf', { fromDmy: from.value.trim(), toDmy: to.value.trim() });
      if (!r.ok) return toast(`PDF failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({ fileName: r.fileName, base64: r.base64, mime: r.mime || 'application/pdf' });
      toast('Downloaded PDF');
    };

    async function quick(mode) {
      const r = await apiJson('/exports_quickXlsx', { mode });
      if (!r.ok) return toast(`Quick export failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({
        fileName: r.fileName,
        base64: r.base64,
        mime: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      });
      toast('Downloaded XLSX');
    }

    const btnDailyPdf = el('button', { class: 'btn', type: 'button', text: 'Daily digest PDF' });
    btnDailyPdf.onclick = async () => {
      const r = await apiJson('/reports_dailyDigestPdf', {});
      if (!r.ok) return toast(`Daily PDF failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({ fileName: r.fileName, base64: r.base64, mime: r.mime || 'application/pdf' });
      toast('Downloaded PDF');
    };

    const month = el('input', { class: 'input', value: opsState.monthYmd, placeholder: 'YYYY-MM-DD (any date in month)' });
    month.addEventListener('input', () => opsState.monthYmd = month.value);

    const btnMonthlyPdf = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Monthly PDF' });
    btnMonthlyPdf.onclick = async () => {
      const r = await apiJson('/reports_monthlyPdf', { monthYmd: month.value.trim() || todayYmdIST() });
      if (!r.ok) return toast(`Monthly PDF failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({ fileName: r.fileName, base64: r.base64, mime: r.mime || 'application/pdf' });
      toast('Downloaded PDF');
    };

    return el('div', { class: 'cosGrid' }, [
      el('div', { class: 'cosCol12 help' }, [
        'Firm range exports can include history. Quick exports are useful for next 7/15/30, overdue, approval pending.'
      ]),
      el('div', { class: 'cosCol4 field' }, [el('div', { class: 'label', text: 'From' }), from]),
      el('div', { class: 'cosCol4 field' }, [el('div', { class: 'label', text: 'To' }), to]),
      el('div', { class: 'cosCol4 field' }, [el('div', { class: 'label', text: 'History' }), includeAudit]),
      el('div', { class: 'cosCol12 row', style: 'justify-content:flex-end; flex-wrap:wrap' }, [btnFirmX, btnFirmP]),
      el('div', { class: 'cosCol12 row', style: 'justify-content:flex-end; flex-wrap:wrap' }, [
        el('button', { class: 'btn btnSmall', type: 'button', text: 'Next 7 days', onclick: () => quick('NEXT_7') }),
        el('button', { class: 'btn btnSmall', type: 'button', text: 'Next 15 days', onclick: () => quick('NEXT_15') }),
        el('button', { class: 'btn btnSmall', type: 'button', text: 'Next 30 days', onclick: () => quick('NEXT_30') }),
        el('button', { class: 'btn btnSmall', type: 'button', text: 'Overdue', onclick: () => quick('OVERDUE') }),
        el('button', { class: 'btn btnSmall', type: 'button', text: 'Approval pending', onclick: () => quick('APPROVAL_PENDING') }),
      ]),
      el('div', { class: 'cosCol12 row', style: 'justify-content:flex-end; flex-wrap:wrap' }, [btnDailyPdf]),
      el('div', { class: 'cosCol6 field' }, [el('div', { class: 'label', text: 'Month (any date in month)' }), month]),
      el('div', { class: 'cosCol6 row', style: 'align-items:flex-end; justify-content:flex-end' }, [btnMonthlyPdf]),
    ]);
  }

  function offlineUpdatePanel() {
    const btnTemplate = el('button', { class: 'btn', type: 'button', text: 'Download Update Template (XLSX)' });
    btnTemplate.onclick = async () => {
      const r = await apiJson('/exports_tasksUpdateTemplateXlsx', {});
      if (!r.ok) return toast(`Template failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({
        fileName: r.fileName || 'Tasks_Update_Template.xlsx',
        base64: r.base64,
        mime: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      });
      toast('Template downloaded');
    };

    const limit = el('input', { class: 'input', type: 'number', min: '10', max: '1200', value: String(opsState.updateLimit) });
    limit.addEventListener('input', () => opsState.updateLimit = Number(limit.value || 600));

    const btnExport = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Export tasks for update (XLSX)' });
    btnExport.onclick = async () => {
      const r = await apiJson('/exports_tasksExportForUpdateXlsx', { limitTasks: opsState.updateLimit });
      if (!r.ok) return toast(`Export failed: ${r.error || JSON.stringify(r)}`, 9000);
      downloadBase64({
        fileName: r.fileName || 'tasks_export_for_update.xlsx',
        base64: r.base64,
        mime: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      });
      toast('Exported');
    };

    const file = el('input', { class: 'input', type: 'file', accept: '.xlsx' });
    file.style.padding = '12px';

    const btnUpload = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Upload updates XLSX' });
    btnUpload.onclick = async () => {
      const f = file.files?.[0];
      if (!f) return toast('Select an XLSX file', 3600);

      const fd = new FormData();
      fd.append('file', f, f.name);

      const r = await apiForm('/tasks_bulkupdate_from_xlsx', fd);
      if (!r.ok) return toast(`Update upload failed: ${r.error || JSON.stringify(r)}`, 9000);

      const errList = (r.errors || [])
        .slice(0, 50)
        .map(e => `<div class="help">Row ${e.row}: ${e.taskId || ''} ‚Äî ${e.error}</div>`)
        .join('');

      await okModal.show({
        title: 'Offline update complete',
        sub: 'Results',
        bodyHtml: `
          <div class="help">Updated: <b>${r.updatedCount || 0}</b></div>
          <div class="help" style="margin-top:6px">Skipped: <b>${r.skippedCount || 0}</b></div>
          ${errList ? `<div style="margin-top:12px; font-weight:950">Errors (first 50)</div>${errList}` : `<div class="help" style="margin-top:10px">No errors.</div>`}
        `
      });

      toast('Updates applied');
      window.__cos_mountView?.('work');
    };

    return el('div', { class: 'cosGrid' }, [
      el('div', { class: 'cosCol12 help' }, [
        'Workflow: Export tasks ‚Üí edit offline ‚Üí upload to update existing tasks. The XLSX contains TaskId (required).'
      ]),
      el('div', { class: 'cosCol12 row', style: 'justify-content:flex-end; flex-wrap:wrap' }, [
        btnTemplate,
        el('div', { class: 'field', style: 'min-width:180px' }, [el('div', { class: 'label', text: 'Export limit' }), limit]),
        btnExport
      ]),
      el('div', { class: 'cosCol12 field' }, [el('div', { class: 'label', text: 'Upload updates XLSX' }), file]),
      el('div', { class: 'cosCol12 row', style: 'justify-content:flex-end' }, [btnUpload]),
      el('div', { class: 'cosCol12 help' }, ['Offline updates record audit logs per task. Completion emails follow status-change rules.'])
    ]);
  }

  function partnerAdminPanel() {
    if (!state.isPartner) {
      return el('div', { class: 'help', html: `
        <div style="font-weight:950;color:var(--text)">Partner admin</div>
        <div style="margin-top:8px">Team & settings are partner-only. Managers can use imports/exports/offline updates.</div>
      `});
    }

    const btnReload = el('button', { class: 'btn btnSmall', type: 'button', text: 'Reload admin data' });
    btnReload.onclick = async () => {
      try {
        await Promise.all([loadSettings(), loadCalendarSettings(), loadTeam()]);
        toast('Admin data loaded');
        render();
      } catch (e) {
        toast(`Load failed: ${e.message || String(e)}`, 9000);
      }
    };

    /* Digest settings */
    const digestEmails = el('textarea', { class: 'textarea', style: 'min-height: 90px' });
    const windowDays = el('input', { class: 'input', type: 'number', min: '1', value: '30' });
    const sendToAssignees = el('select', { class: 'select' }, [
      el('option', { value: 'true', text: 'Send to assignees' }),
      el('option', { value: 'false', text: 'Do not send to assignees' })
    ]);
    const lastRun = el('input', { class: 'input', disabled: true });

    if (opsState.settings) {
      digestEmails.value = (opsState.settings.dailyInternalEmails || []).join('; ');
      windowDays.value = String(opsState.settings.dailyWindowDays || 30);
      sendToAssignees.value = (opsState.settings.sendDailyToAssignees === false) ? 'false' : 'true';
      lastRun.value = opsState.settings.lastDailyRunYmd || '';
    }

    const btnSaveDigest = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Save digest settings' });
    btnSaveDigest.onclick = async () => {
      const r = await apiJson('/settings_update', {
        dailyInternalEmails: digestEmails.value,
        dailyWindowDays: Number(windowDays.value || 30),
        sendDailyToAssignees: sendToAssignees.value === 'true'
      });
      if (!r.ok) return toast(`Save failed: ${r.error || JSON.stringify(r)}`, 9000);
      toast('Saved');
      await loadSettings();
      render();
    };

    const digestCard = card('Daily digest settings', 'Controls internal summary emails and firm window days.', btnReload,
      el('div', { class: 'cosGrid' }, [
        el('div', { class: 'cosCol12 field' }, [el('div', { class: 'label', text: 'Internal emails' }), digestEmails]),
        el('div', { class: 'cosCol4 field' }, [el('div', { class: 'label', text: 'Window days' }), windowDays]),
        el('div', { class: 'cosCol4 field' }, [el('div', { class: 'label', text: 'Assignees' }), sendToAssignees]),
        el('div', { class: 'cosCol4 field' }, [el('div', { class: 'label', text: 'Last run' }), lastRun]),
        el('div', { class: 'cosCol12 row', style: 'justify-content:flex-end' }, [btnSaveDigest])
      ])
    );

    /* Calendar settings */
    const startHH = el('input', { class: 'input', type: 'number', min: '0', max: '23' });
    const endHH = el('input', { class: 'input', type: 'number', min: '0', max: '23' });
    const tz = el('input', { class: 'input', value: 'Asia/Kolkata' });

    if (opsState.cal) {
      startHH.value = String(opsState.cal.startHH ?? 10);
      endHH.value = String(opsState.cal.endHH ?? 12);
      tz.value = opsState.cal.timeZone || 'Asia/Kolkata';
    }

    const btnSaveCal = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Save calendar settings' });
    btnSaveCal.onclick = async () => {
      const r = await apiJson('/settings_calendar_update', {
        startHH: Number(startHH.value || 10),
        endHH: Number(endHH.value || 12),
        timeZone: String(tz.value || 'Asia/Kolkata').trim()
      });
      if (!r.ok) return toast(`Save failed: ${r.error || JSON.stringify(r)}`, 9000);
      toast('Saved');
      await loadCalendarSettings();
      render();
    };

    const calCard = card('Calendar settings', 'Controls calendar event time window.', null,
      el('div', { class: 'cosGrid' }, [
        el('div', { class: 'cosCol4 field' }, [el('div', { class: 'label', text: 'Start hour (0‚Äì23)' }), startHH]),
        el('div', { class: 'cosCol4 field' }, [el('div', { class: 'label', text: 'End hour (0‚Äì23)' }), endHH]),
        el('div', { class: 'cosCol4 field' }, [el('div', { class: 'label', text: 'Timezone' }), tz]),
        el('div', { class: 'cosCol12 row', style: 'justify-content:flex-end' }, [btnSaveCal])
      ])
    );

    /* Associate import password */
    const p1 = el('input', { class: 'input', type: 'password', placeholder: 'New password (leave empty to remove)' });
    const p2 = el('input', { class: 'input', type: 'password', placeholder: 'Confirm password' });

    const btnSavePass = el('button', { class: 'btn btnPrimary', type: 'button', text: 'Save' });
    btnSavePass.onclick = async () => {
      if (p1.value !== p2.value) return toast('Passwords do not match', 6000);
      const r = await apiJson('/settings_workerImportPassword_set', { password: p1.value || '' });
      if (!r.ok) return toast(`Save failed: ${r.error || JSON.stringify(r)}`, 9000);
      toast(r.enabled ? 'Password enabled' : 'Password removed');
      p1.value = ''; p2.value = '';
    };

    const passCard = card('Associate import password', 'If enabled, associates must enter this to import XLSX (stored as PBKDF2 hash).', null,
      el('div', { class: 'cosGrid' }, [
        el('div', { class: 'cosCol6 field' }, [el('div', { class: 'label', text: 'Password' }), p1]),
        el('div', { class: 'cosCol6 field' }, [el('div', { class: 'label', text: 'Confirm' }), p2]),
        el('div', { class: 'cosCol12 row', style: 'justify-content:flex-end' }, [btnSavePass])
      ])
    );

    /* Team management */
    const btnReloadTeam = el('button', { class: 'btn btnSmall', type: 'button', text: 'Reload team' });
    btnReloadTeam.onclick = async () => {
      try { await loadTeam(); toast('Team loaded'); render(); }
      catch (e) { toast(`Team load failed: ${e.message || String(e)}`, 9000); }
    };

    const teamBody = el('tbody');
    const users = opsState.team || [];

    if (!users.length) {
      teamBody.appendChild(el('tr', {}, [
        el('td', { colspan: '6', class: 'help', style: 'padding:14px', text: 'No team data loaded yet. Click ‚ÄúReload admin data‚Äù.' })
      ]));
    } else {
      users.forEach(u => {
        const name = el('input', { class: 'input', value: u.displayName || '', placeholder: 'Display name' });
        const role = el('select', { class: 'select' }, [
          el('option', { value: 'PARTNER', text: 'PARTNER' }),
          el('option', { value: 'MANAGER', text: 'MANAGER' }),
          el('option', { value: 'ASSOCIATE', text: 'ASSOCIATE' }),
        ]);
        role.value = (u.role || 'ASSOCIATE');

        const active = el('select', { class: 'select' }, [
          el('option', { value: 'true', text: 'active' }),
          el('option', { value: 'false', text: 'inactive' })
        ]);
        active.value = (u.active === false) ? 'false' : 'true';

        const mgr = el('input', { class: 'input', value: u.managerEmail || '', placeholder: 'manager@firm.com (optional)' });

        const btnSaveRole = el('button', { class: 'btn btnSmall btnPrimary', type: 'button', text: 'Save role' });
        btnSaveRole.onclick = async () => {
          const r = await apiJson('/users_setrole', { uid: u.uid, role: role.value, active: active.value === 'true' });
          if (!r.ok) return toast(`Save failed: ${r.error || JSON.stringify(r)}`, 9000);
          toast('Role saved');
          await loadTeam();
          render();
        };

        const btnSaveMgr = el('button', { class: 'btn btnSmall', type: 'button', text: 'Save manager' });
        btnSaveMgr.onclick = async () => {
          const r = await apiJson('/users_setmanager', { uid: u.uid, managerEmail: mgr.value.trim() });
          if (!r.ok) return toast(`Save failed: ${r.error || JSON.stringify(r)}`, 9000);
          toast('Manager saved');
          await loadTeam();
          render();
        };

        const btnSaveName = el('button', { class: 'btn btnSmall btnGhost', type: 'button', text: 'Save name' });
        btnSaveName.onclick = async () => {
          const r = await apiJson('/users_setdisplayname', { uid: u.uid, displayName: name.value.trim() });
          if (!r.ok) return toast(`Save failed: ${r.error || JSON.stringify(r)}`, 9000);
          toast('Name saved');
          await loadTeam();
          render();
        };

        const tr = el('tr');
        tr.appendChild(el('td', { html: `<b>${(u.email || u.uid || '').replaceAll('<','&lt;')}</b><div class="help" style="margin-top:6px">UID shown only in admin tools.</div>` }));
        tr.appendChild(el('td', {}, [name]));
        tr.appendChild(el('td', {}, [role]));
        tr.appendChild(el('td', {}, [active]));
        tr.appendChild(el('td', {}, [mgr]));
        tr.appendChild(el('td', { style: 'white-space:nowrap' }, [
          el('div', { class: 'row', style: 'justify-content:flex-end' }, [btnSaveRole, btnSaveMgr, btnSaveName])
        ]));

        teamBody.appendChild(tr);
      });
    }

    const teamTable = el('div', { class: 'tableWrap' }, [
      el('table', {}, [
        el('thead', {}, [
          el('tr', {}, [
            el('th', { text: 'User' }),
            el('th', { text: 'Name' }),
            el('th', { text: 'Role' }),
            el('th', { text: 'Active' }),
            el('th', { text: 'Manager Email' }),
            el('th', { text: 'Actions' })
          ])
        ]),
        teamBody
      ])
    ]);

    const teamCard = card('Team', 'Manage roles, manager mapping, and display names.', btnReloadTeam, teamTable);

    /* Role migration */
    const btnDry = el('button', { class: 'btn btnSmall', type: 'button', text: 'Dry run migration (WORKER‚ÜíASSOCIATE)' });
    btnDry.onclick = async () => {
      const r = await apiJson('/roles_migrate_worker_to_associate', { dryRun: true, limit: 800 });
      if (!r.ok) return toast(`Migration dry-run failed: ${r.error || JSON.stringify(r)}`, 9000);
      await okModal.show({
        title: 'Migration dry run',
        sub: 'WORKER ‚Üí ASSOCIATE',
        bodyHtml: `
          <div class="help">Found: <b>${r.found || 0}</b></div>
          <div class="help" style="margin-top:8px">Sample:</div>
          <pre style="white-space:pre-wrap; font-family: var(--mono); font-size:12px; color: var(--muted); margin:10px 0 0">${JSON.stringify(r.sample || [], null, 2)}</pre>
        `
      });
    };

    const btnRun = el('button', { class: 'btn btnSmall btnPrimary', type: 'button', text: 'Run migration' });
    btnRun.onclick = async () => {
      if (!confirm('Run migration? This will update users.role WORKER ‚Üí ASSOCIATE.')) return;
      const r = await apiJson('/roles_migrate_worker_to_associate', { dryRun: false, limit: 800 });
      if (!r.ok) return toast(`Migration failed: ${r.error || JSON.stringify(r)}`, 9000);
      toast(`Migrated: ${r.updated || 0}`);
      await loadTeam();
      render();
    };

    const migCard = card('Role migration', 'One-time helper: convert legacy WORKER roles into ASSOCIATE.', null,
      el('div', { class: 'row', style: 'justify-content:flex-end; flex-wrap:wrap' }, [btnDry, btnRun])
    );

    return el('div', { style: 'display:flex; flex-direction:column; gap:14px' }, [
      digestCard,
      calCard,
      passCard,
      teamCard,
      migCard
    ]);
  }

  /* ---------- Render ---------- */
  async function render() {
    if (!mount) return;
    mount.innerHTML = '';
    if (!state.uid) return;

    if (!canUseOps()) return mountLocked();

    await ensureAdminDataLoaded();

    const stack = el('div', { style: 'display:flex; flex-direction:column; gap:14px' }, [
  card('Import', 'Create tasks from Excel with templates and validations.', chip(state.role), importPanel()),
  card('Exports & Reports', 'XLSX + PDF options for all report screens.', null, exportsPanel()),
  card('Offline updates', 'Export ‚Üí edit ‚Üí upload to update tasks in bulk with audit logs.', null, offlineUpdatePanel()),
  card('Admin', 'Team + settings + migration tools (Partner-only).', state.isPartner ? chip('Partner') : chip('Manager'), partnerAdminPanel())
]);

mount.appendChild(el('div', { class: 'gridMax' }, [
  card(
    'Ops & Reports',
    'Old UI operations desk (cards + forms) with the new backend actions.',
    chip('Server exports'),
    stack
  )
]));
  }

  window.__cos_mountOps = render;

  if (state.uid && state.activeView === 'ops') render();
})();
</script>